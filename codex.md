# AI客服人工监管坐席工作台需求文档 (PRD)

## 版本说明
- **版本号**：1.0
- **发布日期**：2025年11月24日
- **编写人**：[你的名字]
- **审批人**：[相关人员]
- **相关项目**：AI客服系统，人工监管模块

## 背景与目标
随着跨境独立站电商的持续增长，Fiido 基于 Shopify (`www.fiido.com`) 搭建的欧洲独立站在售十余款 E-bike（C11/C11 Pro/C21、T1 Pro/T2、Titan、Air、Nomads 等），需要覆盖售前配置咨询、订单履约、物流通关、电池维保、退款换货以及法规合规等复杂场景。AI 客服可承接 70%+ 的常规咨询，但对高价值订单、欧洲本地法规、技术故障等仍需人工坐席实时接管。因此需开发独立的 **AI 客服人工监管坐席工作台**，衔接现有 AI 会话引擎与人工坐席，实现对 EU 用户对话的实时监控、跨团队干预、订单级工单追踪与知识回流，以保证海外用户体验与品牌合规。

## 目标
1. 聚合客户画像、订单、物流、支付和设备诊断数据，支持欧洲多语言、多币种、多站点的用户背景洞察。
2. 结合 AI 监控规则、手动分配与队列管理，支持对 `bot_active → pending_manual → manual_live → closed` 会话状态的实时接管。
3. 自动生成与 E-bike 订单绑定的工单，支撑跨团队协作、配件调拨、RMA 流程，并形成可追溯审计链路。
4. 通过运营分析与知识库回流，持续优化 AI 答复质量、坐席效率、发货/售后 SLA，确保企业级交付与法规合规。

---

## 约束、规范与限制

> 本章节需与 `prd/02_约束与原则/CONSTRAINTS_AND_PRINCIPLES.md`、`prd/02_约束与原则/TECHNICAL_CONSTRAINTS.md`、`prd/02_约束与原则/coze.md` 以及 `CLAUDE.md` 中的强制要求保持一致，一切开发先行遵循这些文档。

- **核心接口铁律**  
  - 不得修改 `/api/chat`、`/api/chat/stream`、`/api/conversation/new` 的 Coze 调用逻辑和返回结构，只允许在调用前做状态检查或日志。  
  - 会话隔离必须通过 `/api/conversation/new` 获取 `conversation_id` 后再调用 AI。

- **Coze API 调用规范**  
  - 所有 Workflow Chat 请求均使用 SSE 流（`async_http_client.stream`），逐条解析 `type == "answer"`；禁止 `response.json()`。  
  - 请求 payload 必须包含 `workflow_id/app_id/additional_messages`，并透传 `session_name`、`conversation_id`。  
  - 允许新增 SSE 事件类型，但不得更改 `type: message/done` 的格式。

- **OAuth + JWT 鉴权**  
  - 强制使用 `token_manager` 依据 `session_name` 生成 token，禁止硬编码或共用 token。  
  - 本地环境所有 httpx Client 必须 `trust_env=False` 以避开系统 SOCKS 代理。  
  - 需要遵守 1h~24h 的 token 过期策略，并实现刷新/缓存。

- **状态机与人工接管**  
  - 会话状态仅允许 `bot_active → pending_manual → manual_live → bot_active/closed/after_hours_email` 流转；人工接管期间 AI 请求需返回 409。  
  - `sessionStore`、`regulator` 的扩展需保持失败不影响 AI 主流程。

- **新增接口与模块**  
  - 人工坐席相关接口（如 `/api/sessions`, `/api/manual/messages`）可自定义，但不可占用现有路由。  
  - 新的 SSE 事件、会话字段、工单模型需保持向后兼容。

- **开发流程约束（见 CLAUDE.md）**  
  - 每个全新模块须先在 `docs/` 下编写实施方案，经确认后才能开发。  
  - 开发前需阅读全部约束文档、运行基线测试、评估是否涉及 Coze API。  
  - 合并前必须确保旧功能通过回归测试，且未新增未授权依赖。

- **企业部署限制**  
  - 参照 `prd/06_企业部署/ENTERPRISE_DEPLOYMENT_PRD.md`，未来需支持企业内网代理、自定义 CA、审计导出，现阶段需预留配置入口。

---

## 功能需求

### 1. 客户信息与业务上下文
- **1.1 客户画像**
  - 展示客户姓名、邮箱、电话、所在国家/城市、语言偏好、支付货币，以及来源渠道（Shopify 独立站/门户活动/亚马逊/经销商）。
  - 提示 GDPR 同意状态、营销订阅状态、是否加入 VIP 车友会，支持脱敏视图。
- **1.2 订单与设备**
  - 同步最近 3 个 Shopify 订单：订单号、产品（C11/C11 Pro/C21、T1 Pro/T2、Titan、Air 等）、SKU/配置、颜色、订单金额（含 VAT）、折扣、支付方式、关税/运费、发货仓。
  - 展示物流轨迹（跨境清关节点、承运商、追踪号、保险）、车辆 VIN、电池型号/序列号（如 48V 14.5Ah 可拆卸电池）、电机功率、辅助模式、固件版本、激活时间。
- **1.3 对话历史**
  - 展示 AI/人工的完整历史、知识库命中（参考“知识库模板”中的 FAQ 主题：售前参数、合法性、物流、订单操作、售后保修、常见故障、配件适配等）、用户情绪评分，可按站点、渠道、产品搜索。

### 2. 实时对话监控与干预
- **2.1 队列与状态管理**
  - 对话状态与现有系统保持一致：`bot_active / pending_manual / manual_live / closed / after_hours_email`。
  - 列表支持按优先级、等待时长、国家、订单金额排序；默认展示“待接入”“服务中”“全部”三个视图，与现有 Dashboard 对齐。
- **2.2 干预触发规则**
  - AI 无法理解、NPS 低、关键字（battery failure、customs、return）、高价值订单（>€2000）、VIP 客户、法规敏感词等触发 pending_manual。
  - 支持按产品线/站点配置规则，记录触发来源、模型置信度；针对 Shopify 大促、预售、缺货、清仓等状态可临时调高优先级。
- **2.3 接入与协同**
  - 坐席可一键接入 pending_manual 会话，或在 manual_live 状态下请求转接。
  - 支持填写接入原因、预估处理时长、转接目标团队（售前/售后/技术/合规）。
- **2.4 聊天能力**
  - 支持多语言切换、翻译（英/德/法/意/西）、快捷短语（售前报价、物流说明、VAT/关税解释、CE 认证、保修信息、FAQ 模板）、消息草稿 AI 推荐。
  - 提供一键插入订单信息、物流追踪链接、退货地址模板。

### 3. 工单与跨团队协作
- **3.1 工单模型**
  - 工单字段：工单号、关联会话、订单号、车型、国家、问题分类（售前配置/订单修改/物流异常/售后维修/合规申诉）、优先级、SLA、当前负责人、关联附件（发票、关税凭证、照片）。
  - 自动拉取 AI 分析摘要、客户诉求、AI 处理结论，坐席只需补充人工判断。
- **3.2 流程与流转**
  - 支持跨部门指派（欧洲售前、深圳售后、配件仓、合规），记录时间线与责任人。
  - 工单状态：`待接单 → 处理中 → 待客户 → 已解决 → 已关闭`，并与会话状态联动。
- **3.3 通知与协作**
  - 支持 @同事 / 评论、上传维修报告、同步 Slack/企业微信 通知。
  - 工单与配件库存、RMA 系统对接，自动同步物流单号或维修单。

### 4. AI 表现与运营分析
- **4.1 AI 质量**
  - 统计分国家/语言/车型的 AI 命中率、平均响应时长、误判原因，评估规则触发效果。
  - 对人工接管的会话，分析 AI 已处理环节与最终结论差异，生成学习任务。
- **4.2 坐席效率**
  - 输出接入率、平均等待时间、服务时长、转接率、一次解决率、工单 SLA 达成率。
- **4.3 客户体验**
  - 汇总售前转化（询单转订单率）、售后满意度（CSAT/NPS）、退货率、合规投诉率。

### 5. 知识库与学习回路
- **5.1 E-bike 主题知识库**
  - 以“知识库模板”Excel 为基础，结构化整理 FAQ 主题（售前产品参数、售前对比、发货物流、合法性/认证、支付/费用、订单操作、退换货、售后保修、常见故障、日常维护、配件适配、App 使用等），并按车型（C 系列/T 系列/M/N/轻量折叠/Air 等）与市场（EU/UK）分类。
  - 每条知识条目包含：主题、提问、答案、关键信息（如电池可拆卸、最大承重 120kg、液压碟刹、轮胎规格 700×40C）、适用车型、适用国家、是否允许 AI 自动引用、最后审核人。
  - 支持多语言内容与站点差异（EU/UK/US），支持审批后同步至 AI Prompt。
- **5.2 回流机制**
  - 工单关闭时，坐席可选择 “沉淀为知识” 并标记可复用等级、适用国家、适用车型；自动生成符合知识库模板字段的草稿，进入知识管理员审批。
  - AI 团队定期审核人工反馈，更新模型或提示词，记录版本；若为 Shopify 后台配置或独立站促销信息，需关联到 CMS/公告系统并设置到期时间。

### 6. 安全、权限与合规
- **6.1 权限模型**
  - 支持角色：坐席、组长、运营、技术、合规、仓储；每个角色控制对订单、支付、VIN、电池等数据的读写权限。
  - 接入 SSO（Azure AD/Okta），并支持排班、状态同步（在线/离线）。
- **6.2 数据与合规**
  - 全链路 TLS，加密存储敏感字段（支付、地址、VIN）。
  - 日志可追溯，满足 GDPR、EU Battery Regulation、CE 合规；支持导出审计报表。

---

## 技术需求

- **平台兼容性**：首要支持 Web（桌面 1440px 及平板 1024px），保持现有 Vue3 + Vite 架构；移动视图展示精简队列与通知。
- **实时数据**：会话、统计、工单使用 WebSocket/Server-Sent Events 推送；前端每 5s 轮询作为兜底（已在 Dashboard 实现 auto refresh）。
- **系统集成**：与 AI Bot、订单 OMS、物流追踪、RMA、仓储、支付、CRM（Salesforce/HubSpot）、Slack/企业微信、知识库（Confluence/Notion）对接。
- **可观测性**：暴露 Prometheus 指标（请求量、队列长度、接入成功率），告警到 On-call；提供慢查询、接口追踪。
- **性能指标**：支持 500 并发坐席、每日 5k+ 会话、P95 交互延迟 < 1s；工单创建延迟 < 3s。

---

## 用户界面设计（UI）

- **总体布局**：保持现有工作台结构 —— 顶部为坐席信息与统计（待接入、服务中、总会话、平均等待）；左侧为会话列表与搜索；右侧为会话详情、聊天区域与客户/工单信息 Tabs。
- **核心界面**：
  - **会话列表**：卡片展示头像/昵称、国家旗帜、订单金额标签、状态、等待时间、分配坐席；支持批量筛选、抢单。
  - **会话详情**：上方显示客户与订单、工单状态；中部聊天区支持 AI/人工/用户消息区分、系统事件（接入、转接、释放）。
  - **侧边栏 Tabs**：客户信息、订单 & 物流、工单、知识库推荐，支持展开/折叠。
  - **工单面板**：在聊天右上角可快速创建/查看工单，支持关联附件上传。
- **响应式**：>1280px 展示双栏；1024px 以下自动叠放，优先显示队列 + 聊天，客户/工单折叠为 Drawer。

---

## 风险与挑战

1. **跨境法规**：需满足各国数据主权、VAT/关税/电池法规的披露要求，涉及多系统对接。
2. **AI 误判**：若干预规则不准确会造成坐席负载剧增，需要持续调优触发策略。
3. **性能与可用性**：旺季订单与促销可能导致会话暴增，需提前压测并构建降级方案（只读队列、暂停知识库推送）。
4. **多语言支持**：翻译、快捷短语、知识库版本管理需要专人维护，否则影响客户体验。

---

## 建议与后续开发步骤

> 注：以下事项将作为后续对 Claude 的指令输入，确保执行前先完成相应方案与审批。

1. **约束自查**：按“约束、规范与限制”章节逐条自检现有实现，重点确认 httpx `trust_env=False`、会话隔离、人工接管状态阻断、token_manager 调用等是否已经落地，如未完成需在近期补齐。  
2. **能力验收**：对当前 Vue3 工作台已完成的登录、会话列表、接入/转接/释放、消息发送、自动刷新等能力进行验收记录，更新至 `prd/05_验收与记录`，确保产品与实现同步。  
3. **工单与知识库方案**：在 `docs/` 目录为“工单全流程”“E-bike 知识库回流”分别编写实施方案，涵盖需求背景、接口设计、SLA、审批流程，经评审通过后再启动开发。  
4. **API 与后端扩展**：基于 `prd/03_技术方案` 和 `agent_workbench` 现状，规划 `/api/sessions`、`/api/manual/messages`、`/api/sessions/{id}/transfer` 等接口的增强项（字段、权限、推送），保证与前端存储模型一致。  
5. **监控与性能**：补齐 Prometheus 指标、日志、压测计划，预留企业部署所需的代理/自定义 CA 配置，以应对 EU 旺季峰值。  
6. **上线节奏**：按 CLAUDE 流程执行“方案 → 审核 → 开发 → 回归 → 验收”，每个阶段完成后更新 `FINAL_SUMMARY.txt` 与 `CHANGELOG_DETAIL.md`，形成可追溯的交付节奏。

---

## 结论
通过聚焦 E-bike 跨境业务特性，本工作台将以现有 Vue3 Dashboard 能力为基础，强化客户画像、队列接入、工单协作和知识回流，确保 AI+人工协同满足欧洲用户对售前咨询、物流通关、售后维保的要求。后续迭代将围绕工单全流程、数据分析和合规能力展开，支撑企业级部署与持续运营。
