# 企业级部署答疑文档

> 创建时间: 2025-11-24
> 版本: v1.0
> 适用范围: Fiido 智能客服系统企业部署

---

## 目录

1. [本地开发 vs 云端部署](#1-本地开发-vs-云端部署)
2. [域名配置与独立站嵌入](#2-域名配置与独立站嵌入)
3. [完整部署架构](#3-完整部署架构)
4. [成本估算](#4-成本估算)
5. [迁移清单](#5-迁移清单)

---

## 1. 本地开发 vs 云端部署

### 1.1 核心原理

**可以在本地完成所有功能开发，云端部署时只需改配置文件！**

```
阶段1（本地开发）              阶段2（云端部署）
─────────────────              ─────────────────
Backend代码                    Backend代码（完全相同）
Frontend代码                   Frontend代码（完全相同）
Redis                   →      Redis（相同配置）
Nginx配置                      Nginx配置（域名改了）
自签名证书                      Let's Encrypt证书

功能: 100%相同                 功能: 100%相同
差异: 仅环境配置                差异: 仅环境配置
```

### 1.2 部署策略（两阶段）

#### **阶段1：本地开发（1-2周）** ✅ 当前阶段

**在本地服务器完成：**
- ✅ Redis 数据持久化（v2.3.6 已完成）
- ⏳ 坐席认证系统（JWT）
- ⏳ HTTPS 本地测试（自签名证书）
- ⏳ 前端嵌入 SDK 开发
- ⏳ 完整功能测试

**运行环境：**
```bash
Backend:  http://localhost:8000
Frontend: http://localhost:5173
Redis:    redis://localhost:6379/0
```

**优势：**
- 开发调试方便
- 不产生云服务器费用
- 可以完整测试所有功能

**技术要点：**
```bash
# 本地可以使用 localhost Redis
REDIS_URL=redis://localhost:6379/0

# 本地可以用自签名证书测试 HTTPS
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout localhost.key -out localhost.crt
```

#### **阶段2：云端部署（第3周）** ⏳ 开发完成后

**必须部署到公网服务器，因为：**

1. **独立站集成需要公网访问**
   - 客户网站需要加载您的 SDK：`<script src="https://kefu.yourdomain.com/sdk/fiido-kefu.js">`
   - iframe 嵌入需要公网 URL

2. **HTTPS 证书需要真实域名**
   - Let's Encrypt 只能给真实域名签发证书
   - 自签名证书浏览器会警告

3. **客户无法访问您的本地服务器**
   - 除非您的本地服务器有公网 IP + 域名（成本更高）

**部署方案：**
```nginx
# 需要真实域名，例如：
server_name kefu.fiido.com;

# 需要真实 SSL 证书
ssl_certificate /etc/letsencrypt/live/kefu.fiido.com/fullchain.pem;
```

### 1.3 本地开发能做到什么程度？

**答案：除了"客户无法访问"外，其他100%完整！**

您在本地可以实现：
- ✅ 完整的坐席认证系统
- ✅ Redis 数据持久化
- ✅ HTTPS 加密通信（自签名证书，功能一样）
- ✅ 前端嵌入 SDK（在本地HTML测试）
- ✅ 所有 API 接口
- ✅ 坐席工作台完整功能
- ✅ 用户端聊天界面
- ✅ 回归测试全部通过

**唯一限制：**
- ❌ 外部客户无法访问（没有公网域名）
- ❌ Let's Encrypt 证书无法签发（需要真实域名）
- ❌ 第三方网站无法嵌入您的SDK（跨域问题）

### 1.4 功能对比表

| 功能模块 | 阶段1（本地） | 阶段2（云端） | 代码是否相同 |
|---------|-------------|-------------|-------------|
| AI 对话 | ✅ 本地测试 | ✅ 公网访问 | ✅ 完全相同 |
| 会话隔离 | ✅ 完整功能 | ✅ 完整功能 | ✅ 完全相同 |
| Redis 持久化 | ✅ 本地Redis | ✅ 云Redis | ✅ 完全相同 |
| 坐席认证 | ✅ JWT登录 | ✅ JWT登录 | ✅ 完全相同 |
| 人工接管 | ✅ 完整流程 | ✅ 完整流程 | ✅ 完全相同 |
| HTTPS | ⚠️ 自签名 | ✅ 真实证书 | ✅ 配置微调 |
| 前端嵌入SDK | ⚠️ 本地测试 | ✅ 公网嵌入 | ✅ URL不同 |

---

## 2. 域名配置与独立站嵌入

### 2.1 架构理解

```
您的架构：
┌─────────────────────┐
│ 您的独立站            │  ← 客户访问的主网站
│ www.fiido.com       │     (例如 Shopify/WordPress)
│                     │
│ [商品页面]           │
│ [关于我们]           │
│ [联系我们]           │
│                     │
│  ┌───────────────┐  │
│  │ 💬 AI客服窗口  │  │  ← 嵌入的客服系统
│  │ (iframe/SDK)  │  │     (来自 kefu.fiido.com)
│  └───────────────┘  │
└─────────────────────┘
```

### 2.2 kefu.fiido.com 是什么？

**这是您客服系统的独立服务器地址！**

```
主站：www.fiido.com          客服站：kefu.fiido.com
├── 商品展示                 ├── Backend API (8000端口)
├── 购物车                   ├── 用户端前端 (聊天界面)
├── 结账页面                 ├── 坐席工作台
├── 博客                     ├── Redis 数据库
                            └── Nginx 反向代理
```

### 2.3 为什么需要单独的域名？

1. **技术隔离** - 客服系统独立运行，不影响主站
2. **跨域安全** - HTTPS + CORS 配置需要明确域名
3. **负载分离** - 客服系统流量不占用主站资源
4. **灵活部署** - 可以单独升级维护

### 2.4 嵌入到独立站的方式

#### **方式1：iframe 嵌入**（推荐，最简单）

在您的独立站任意页面添加：

```html
<!-- 在 www.fiido.com 的任意页面添加 -->
<iframe
  src="https://kefu.fiido.com/embed?shop=yourshop"
  style="position:fixed;bottom:20px;right:20px;width:380px;height:520px;border:none;z-index:9999;"
  allow="clipboard-write"
></iframe>
```

**原理：**
```
用户访问: www.fiido.com/products
         ↓
页面加载: <iframe src="https://kefu.fiido.com/embed">
         ↓
聊天窗口显示在页面右下角
         ↓
用户点击后与 kefu.fiido.com 的后端通信
```

#### **方式2：JS SDK 嵌入**（更灵活）

```html
<!-- 在 www.fiido.com 的 <head> 或 <body> 添加 -->
<script>
  window.FiidoKefuConfig = {
    serverUrl: 'https://kefu.fiido.com',  // 客服系统地址
    position: 'bottom-right',
    theme: 'light'
  };
</script>
<script src="https://kefu.fiido.com/sdk/fiido-kefu.js"></script>
```

**原理：**
```
www.fiido.com 页面加载
         ↓
执行 fiido-kefu.js
         ↓
动态创建聊天窗口 DOM
         ↓
连接到 kefu.fiido.com/api
```

### 2.5 完整的 Nginx 配置

```nginx
# /etc/nginx/sites-available/fiido-kefu

# 客服系统服务器配置
server {
    listen 443 ssl http2;
    server_name kefu.fiido.com;  # ← 客服系统域名

    # SSL 证书（Let's Encrypt 免费申请）
    ssl_certificate /etc/letsencrypt/live/kefu.fiido.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kefu.fiido.com/privkey.pem;

    # 允许您的主站跨域访问（关键！）
    add_header Access-Control-Allow-Origin "https://www.fiido.com";
    add_header Access-Control-Allow-Credentials "true";

    # 后端 API
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;  # SSE长连接
    }

    # 前端静态文件
    location / {
        root /var/www/fiido-kefu/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # SDK 脚本
    location /sdk {
        root /var/www/fiido-kefu/sdk;
        add_header Cache-Control "public, max-age=3600";
    }

    # 坐席工作台
    location /agent {
        alias /var/www/fiido-kefu/agent-workbench/dist;
        try_files $uri $uri/ /agent/index.html;
    }
}

# HTTP 自动跳转 HTTPS
server {
    listen 80;
    server_name kefu.fiido.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 3. 完整部署架构

### 3.1 推荐方案：**全部部署到云端**

```
云服务器（例如阿里云 2核4G）
├── Backend (FastAPI)           ← 后端代码
├── Frontend (Vue3 构建后)       ← 前端静态文件
├── Agent Workbench (Vue3)      ← 坐席工作台
├── Redis                       ← 数据库
└── Nginx                       ← 反向代理
```

### 3.2 为什么全部部署？

#### **优势对比**

| 方案 | 后端云端 | 前端云端 | Redis云端 | 优势 | 劣势 |
|------|---------|---------|-----------|------|------|
| **全部云端**（推荐） | ✅ | ✅ | ✅ | 统一管理、速度快、稳定 | 服务器配置稍高 |
| 后端云端+前端本地 | ✅ | ❌ | ✅ | 省带宽 | 跨域复杂、慢 |
| 仅后端云端 | ✅ | ❌ | ❌ | 成本低 | Redis网络延迟、不稳定 |

#### **详细说明**

**1. Backend 必须云端** ✅
```
原因：
- 独立站需要调用 API（www.fiido.com → kefu.fiido.com/api）
- 必须有公网访问
- 必须有 HTTPS 证书
```

**2. Frontend 建议云端** ✅✅
```
原因：
- 用户加载速度快（CDN 加速）
- 与 Backend 同域名，无跨域问题
- 部署简单（npm run build → 上传）

部署方式：
cd frontend
npm run build
# 生成 dist/ 目录，上传到服务器
scp -r dist/* user@server:/var/www/fiido-kefu/frontend/
```

**3. Redis 建议云端** ✅✅
```
原因：
- Backend 和 Redis 在同一服务器，延迟 < 1ms
- 数据安全（云服务器有备份）
- 如果 Redis 在本地，Backend 在云端：
  - 网络延迟高（50-100ms）
  - 需要开放 Redis 端口（安全风险）

云端 Redis 方案：
方案A：服务器自建 Redis（免费）
方案B：阿里云 Redis（¥20/月起，托管服务）
```

**4. Nginx 必须云端** ✅
```
原因：
- 处理 HTTPS 证书
- 反向代理 Backend
- 托管 Frontend 静态文件
```

### 3.3 推荐的完整部署架构图

```
┌────────────────────────────────────────────┐
│ 云服务器 (kefu.fiido.com)                   │
│ ┌────────────────────────────────────────┐ │
│ │ Nginx (443/80)                         │ │
│ │ ├─ SSL证书（Let's Encrypt）             │ │
│ │ ├─ 静态文件（Frontend dist/）           │ │
│ │ └─ 反向代理 → Backend:8000             │ │
│ └────────────────────────────────────────┘ │
│                                            │
│ ┌────────────────────────────────────────┐ │
│ │ Backend (8000)                         │ │
│ │ - FastAPI                              │ │
│ │ - Python 3.10+                         │ │
│ │ - OAuth Token Manager                  │ │
│ └────────────────────────────────────────┘ │
│                                            │
│ ┌────────────────────────────────────────┐ │
│ │ Redis (6379)                           │ │
│ │ - 会话数据                              │ │
│ │ - 持久化存储                            │ │
│ └────────────────────────────────────────┘ │
└────────────────────────────────────────────┘
         ↑
         │ HTTPS 请求
         │
┌────────────────────────────────────────────┐
│ 独立站 (www.fiido.com)                      │
│ <iframe src="https://kefu.fiido.com">     │
└────────────────────────────────────────────┘
```

---

## 4. 成本估算

### 4.1 单台云服务器（全部署）

```
组件成本：
- 2核4G 云服务器: ¥100-200/月（阿里云/腾讯云）
- 域名: ¥50-100/年
- SSL证书: 免费（Let's Encrypt）
- Redis: 免费（自建）或 ¥20/月（云Redis）

总计: ¥100-220/月
```

### 4.2 流量成本

```
- 公网带宽: 1-5Mbps（已包含在服务器费用中）
- 额外流量: 通常免费额度足够
- CDN加速（可选）: ¥0.2-0.5/GB
```

### 4.3 扩展成本

```
日活 < 1000:  单台服务器 ¥100-220/月
日活 1000-5000: 增加1台服务器 + 负载均衡 ¥300-500/月
日活 > 5000: 集群部署 + 云Redis ¥1000+/月
```

---

## 5. 迁移清单

### 5.1 第二阶段只需改动的配置

#### **1. .env 文件** - 仅改 URL

```bash
# 本地开发 (.env)
HOST=0.0.0.0
PORT=8000
REDIS_URL=redis://localhost:6379/0

# ↓↓↓ 云端部署 (.env) - 功能完全一样 ↓↓↓
HOST=0.0.0.0
PORT=8000
REDIS_URL=redis://localhost:6379/0  # 或云Redis地址
```

#### **2. Nginx 配置** - 仅改域名

```nginx
# 本地开发
server_name localhost;
ssl_certificate /path/to/localhost.crt;  # 自签名

# ↓↓↓ 云端部署 - 仅改这两行 ↓↓↓
server_name kefu.fiido.com;  # 真实域名
ssl_certificate /etc/letsencrypt/live/kefu.fiido.com/fullchain.pem;  # 真实证书
```

#### **3. 前端 API 地址** - 仅改 URL

```typescript
// 本地开发 (frontend/.env)
VITE_API_BASE_URL=http://localhost:8000

// ↓↓↓ 云端部署 ↓↓↓
VITE_API_BASE_URL=https://kefu.fiido.com
```

### 5.2 迁移步骤（10步搞定）

```bash
# 第二阶段云端部署 - 10步搞定

1. 购买云服务器（阿里云/腾讯云）
   - 配置：2核4G Ubuntu 20.04
   - 费用：¥100-200/月

2. 注册域名（例如 kefu.fiido.com）
   - 费用：¥50-100/年

3. 域名解析指向服务器IP
   - A记录：kefu.fiido.com → 你的服务器IP

4. 安装 Docker + Docker Compose（可选）
   sudo apt update
   sudo apt install docker.io docker-compose

5. 上传代码到服务器
   git clone https://github.com/yourusername/fiido-kefu.git
   cd fiido-kefu

6. 修改 .env 配置（改域名）
   vim .env
   # 将 localhost 改为 kefu.fiido.com

7. 安装 Nginx + 申请 SSL 证书
   sudo apt install nginx certbot python3-certbot-nginx
   sudo certbot --nginx -d kefu.fiido.com

8. 修改 Nginx 配置（改域名）
   sudo vim /etc/nginx/sites-available/fiido-kefu
   # 将 localhost 改为 kefu.fiido.com

9. 启动服务
   # Backend
   python3 backend.py &

   # 或使用 systemd（推荐）
   sudo systemctl enable fiido-kefu
   sudo systemctl start fiido-kefu

10. 测试访问
    curl https://kefu.fiido.com/api/health

✅ 代码一行不改！功能100%相同！
```

### 5.3 环境变量管理（推荐实践）

为了让迁移更简单，可以在第一阶段就做好准备：

```bash
# .env.local（本地开发）
ENVIRONMENT=development
DOMAIN=localhost
API_URL=http://localhost:8000
FRONTEND_URL=http://localhost:5173

# .env.production（云端部署）- 只改这个文件
ENVIRONMENT=production
DOMAIN=kefu.fiido.com
API_URL=https://kefu.fiido.com
FRONTEND_URL=https://kefu.fiido.com
```

这样第二阶段只需要：
```bash
# 云端服务器
cp .env.local .env.production  # 复制配置
vim .env.production             # 改域名
python3 backend.py              # 启动（读取.env.production）
```

---

## 6. 部署架构对比

### 6.1 单机部署（初期）

```
用户浏览器 → Nginx(443) → Backend(8000)
                       → Frontend静态文件
                       → Redis(6379)
```

**适用**: 日活 < 1000，单服务器
**成本**: ¥100-220/月

### 6.2 分布式部署（扩展）

```
用户 → CDN → 负载均衡 → Backend集群（多台）
                     → Redis集群（主从）
                     → 日志服务
                     → 监控系统
```

**适用**: 日活 > 1000，需要高可用
**成本**: ¥500-1000/月

---

## 7. 常见问题 FAQ

### Q1: 本地开发能做到什么程度？

**A**: 除了"外部客户无法访问"外，所有功能都可以在本地完整实现和测试。包括：
- ✅ 坐席认证系统
- ✅ Redis 数据持久化
- ✅ HTTPS（自签名证书）
- ✅ 前端嵌入 SDK（本地测试）
- ✅ 所有 API 和业务逻辑

### Q2: 第二阶段需要改代码吗？

**A**: 不需要！只需要改配置文件：
- .env（改域名和 Redis 地址）
- Nginx 配置（改域名和 SSL 证书路径）
- 前端环境变量（改 API 地址）

代码 100% 不变，功能 100% 相同。

### Q3: 为什么需要单独的客服域名？

**A**:
1. **技术隔离**：客服系统独立，不影响主站
2. **跨域安全**：HTTPS + CORS 需要明确域名
3. **负载分离**：客服流量不占用主站资源
4. **灵活部署**：可以单独升级维护

### Q4: 云端部署必须全部部署吗？

**A**:
- **必须云端**：Backend（API 服务）、Nginx（反向代理）
- **强烈推荐**：Frontend（速度快）、Redis（延迟低）
- **可选**：CDN（流量大时）

建议全部部署到一台云服务器，成本低且管理简单。

### Q5: 独立站如何嵌入客服窗口？

**A**: 有两种方式：

**方式1（推荐）**：iframe 嵌入
```html
<iframe src="https://kefu.fiido.com/embed"></iframe>
```

**方式2**：JS SDK 嵌入
```html
<script src="https://kefu.fiido.com/sdk/fiido-kefu.js"></script>
```

### Q6: 一台服务器能支持多少用户？

**A**:
- 2核4G 服务器：日活 < 1000 用户
- 4核8G 服务器：日活 1000-5000 用户
- 更高配置或集群：日活 > 5000 用户

### Q7: Redis 必须用云服务吗？

**A**: 不是必须的：
- **方案A**：服务器自建 Redis（免费，推荐初期使用）
- **方案B**：阿里云 Redis（¥20/月起，托管服务，更稳定）

初期建议自建，流量大了再考虑云 Redis。

### Q8: SSL 证书怎么获取？

**A**: 使用 Let's Encrypt 免费证书：
```bash
sudo certbot --nginx -d kefu.fiido.com
```
自动申请、配置、续期，完全免费！

---

## 8. 总结

### 关键要点

1. **本地开发可以实现 100% 功能**，只是客户无法访问
2. **云端部署只需改配置文件**，代码完全不动
3. **推荐全部部署到云端**，成本低（¥100-220/月）且管理简单
4. **客服系统需要独立域名**（kefu.fiido.com），通过 iframe/SDK 嵌入到主站
5. **迁移只需 10 步**，代码一行不改

### 开发流程

```
阶段1（1-2周）：本地开发所有功能
         ↓
阶段2（1-2天）：上传代码 + 改配置 + 申请证书
         ↓
阶段3（持续）：嵌入独立站 + 正式上线
```

---

**文档版本**: v1.0
**最后更新**: 2025-11-24
**维护者**: Fiido AI 客服开发团队
