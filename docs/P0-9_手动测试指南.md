# P0-9 输入控制逻辑 - 手动测试指南

## 📋 测试准备

### 1. 启动后端服务

```bash
cd /home/yzh/AI客服/鉴权
python3 backend.py
```

确保看到以下输出：
```
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 2. 启动前端服务

```bash
cd /home/yzh/AI客服/鉴权/frontend
npm run dev
```

确保看到以下输出：
```
  ➜  Local:   http://localhost:5173/
  ➜  Network: http://192.168.x.x:5173/
```

### 3. 打开浏览器

访问 `http://localhost:5173/`

---

## 🧪 测试场景

### 场景 1: 正常 AI 对话（bot_active 状态）

#### 测试步骤：

1. **打开聊天面板**
   - 点击右下角的浮动聊天按钮
   - 聊天面板从右侧滑出

2. **查看初始状态**
   - 顶部应该显示 "Fiido 客服"
   - 状态栏应该显示 "🤖 AI服务中"（绿色背景）
   - 输入框 placeholder: "请输入您的问题..."
   - 输入框应该是**可用的**（非灰色）

3. **发送消息**
   - 在输入框输入: "你好"
   - 点击发送按钮（或按 Enter）

4. **验证结果**
   - ✅ 应该看到 AI 正在思考的动画（三个跳动的点）
   - ✅ 几秒后应该收到 AI 的回复
   - ✅ 消息显示在左侧，有 AI 头像
   - ✅ 用户消息显示在右侧

**通过标准**: AI 正常回复，消息显示正确

---

### 场景 2: 触发转人工（切换到 pending_manual 状态）

#### 测试步骤：

1. **打开气泡菜单**
   - 点击输入框左侧的紫色圆形按钮（+图标）
   - 应该看到3个选项向上弹出：
     - "转人工"
     - "清除对话"
     - "新建对话"

2. **点击转人工**
   - 点击第一个"转人工"按钮
   - 应该弹出确认对话框: "确定要转接人工客服吗？"
   - 点击"确定"

3. **验证状态变化**
   - ✅ 应该看到弹窗提示: "✅ 已转接人工客服，请稍候..."
   - ✅ 状态栏变为 "⏳ 等待人工接入..."（黄色背景，带脉动动画）
   - ✅ 聊天记录中添加系统消息: "正在为您转接人工客服，请稍候..."
   - ✅ 输入框 placeholder 变为: "等待人工接入..."
   - ✅ 输入框下方出现黄色等待提示条（带⏳图标和脉动动画）
   - ✅ 输入框仍然**可用**（但发送消息会被阻止）

4. **测试消息发送阻止**
   - 在输入框输入: "测试消息"
   - 点击发送

5. **验证阻止行为**
   - ✅ 应该立即看到系统消息: "正在为您转接人工客服，请稍候..."
   - ✅ **不会**调用 AI 接口
   - ✅ 消息不会被发送到后端

**通过标准**:
- 状态正确变为 pending_manual
- 等待提示显示正确
- 消息发送被阻止

---

### 场景 3: 模拟坐席接入（切换到 manual_live 状态）

#### 准备工作：

打开新的终端窗口，运行以下命令模拟坐席接入：

```bash
# 获取当前会话ID（查看浏览器控制台输出，例如: session_xxx）
# 或者使用固定的测试会话ID

SESSION_ID="<你的会话ID>"  # 替换为实际的会话ID

# 坐席接入
curl -X POST http://localhost:8000/api/sessions/${SESSION_ID}/takeover \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "agent_manual_test",
    "agent_name": "测试客服"
  }'
```

**如何获取会话ID**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 查找类似这样的日志: "✅ 会话初始化成功, Conversation ID: ..."
4. 会话ID通常以 "session_" 开头

#### 测试步骤：

1. **运行坐席接入命令**（如上所示）

2. **验证状态变化**（在浏览器中观察，**等待最多2秒**）
   - ⏱️ 系统每2秒自动轮询一次状态
   - ✅ 控制台输出: "🔄 状态轮询: pending_manual → manual_live"
   - ✅ 状态栏变为 "👤 人工客服 - 测试客服"（蓝色背景）
   - ✅ 状态点变为蓝色，带闪烁动画
   - ✅ 聊天记录中添加系统消息: "客服【测试客服】已接入，正在为您服务"
   - ✅ 输入框 placeholder 变为: "向客服发送消息..."
   - ✅ 黄色等待提示条**消失**
   - ✅ 输入框保持**可用**

**重要提示**:
- ⏱️ 状态更新可能有**最多2秒的延迟**（轮询间隔）
- 🔄 系统会在 pending_manual 或 manual_live 状态下**自动轮询**
- ⏸️ 恢复到 bot_active 状态后会**自动停止轮询**

3. **发送用户消息**
   - 在输入框输入: "你好，我有问题需要咨询"
   - 点击发送

4. **验证消息发送**
   - ✅ 用户消息立即显示在右侧
   - ✅ 控制台输出: "✅ 人工模式消息已发送"
   - ✅ **不会**看到 AI 的回复（因为是人工模式）

**通过标准**:
- 状态正确变为 manual_live
- 坐席信息显示正确
- 用户消息通过 `/api/manual/messages` 发送

---

### 场景 4: 模拟坐席回复

#### 测试步骤：

打开终端，运行以下命令模拟坐席发送消息：

```bash
SESSION_ID="<你的会话ID>"

# 坐席发送消息
curl -X POST http://localhost:8000/api/manual/messages \
  -H "Content-Type: application/json" \
  -d '{
    "session_name": "'${SESSION_ID}'",
    "role": "agent",
    "content": "您好！我是测试客服，很高兴为您服务。请问有什么可以帮助您的？",
    "agent_info": {
      "agent_id": "agent_manual_test",
      "agent_name": "测试客服"
    }
  }'
```

#### 验证结果（在浏览器中观察）：

- ✅ 几秒后（SSE 推送延迟）应该看到坐席消息出现在左侧
- ✅ 消息背景为浅蓝色（#EFF6FF）
- ✅ 左侧有蓝色边框（3px）
- ✅ 头像为紫色渐变，显示 👤 图标
- ✅ 消息头部显示 "测试客服" + 蓝色"人工"标签
- ✅ 消息内容正确显示
- ✅ 控制台输出: "📨 收到人工消息: agent ..."

**通过标准**: 人工消息正确接收和渲染

---

### 场景 5: 释放会话（恢复 bot_active 状态）

#### 测试步骤：

打开终端，运行以下命令释放会话：

```bash
SESSION_ID="<你的会话ID>"

# 释放会话
curl -X POST http://localhost:8000/api/sessions/${SESSION_ID}/release \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "agent_manual_test",
    "reason": "resolved"
  }'
```

#### 验证结果（在浏览器中观察）：

1. **状态变化**
   - ✅ 状态栏恢复为 "🤖 AI服务中"（绿色背景）
   - ✅ 聊天记录中添加系统消息: "人工服务已结束，AI 助手已接管对话"
   - ✅ 输入框 placeholder 恢复为: "请输入您的问题..."
   - ✅ 输入框保持可用

2. **测试 AI 对话恢复**
   - 在输入框输入: "现在能对话了吗"
   - 点击发送

3. **验证 AI 回复**
   - ✅ 应该看到 AI 思考动画
   - ✅ 几秒后收到 AI 的回复
   - ✅ AI 消息显示在左侧，白色背景，灰色边框

**通过标准**:
- 状态正确恢复为 bot_active
- AI 对话功能恢复正常

---

### 场景 6: 输入框禁用测试（closed 状态）

**注意**: 此功能暂未完全实现，需要后端支持关闭会话的接口。

当会话状态为 `closed` 时：
- 输入框应该变为**灰色禁用状态**
- placeholder 显示: "会话已关闭"
- 发送按钮也应该禁用

---

## 🎯 完整测试流程

推荐按以下顺序完整测试一遍：

```
1. 打开聊天面板
   ↓
2. 发送 AI 消息（验证 bot_active）
   ↓
3. 点击"转人工"（验证 pending_manual）
   ↓
4. 尝试发送消息（验证消息被阻止）
   ↓
5. 运行坐席接入命令（验证 manual_live）
   ↓
6. 发送用户消息（验证人工消息接口）
   ↓
7. 运行坐席回复命令（验证人工消息渲染）
   ↓
8. 运行释放会话命令（验证恢复 bot_active）
   ↓
9. 发送 AI 消息（验证 AI 对话恢复）
```

---

## 🐛 常见问题排查

### 问题 1: 状态栏不显示

**可能原因**: StatusBar 组件未正确集成

**检查**:
```bash
# 查看 ChatPanel.vue 是否包含 StatusBar
grep -n "StatusBar" frontend/src/components/ChatPanel.vue
```

**预期**: 应该看到 `import StatusBar` 和 `<StatusBar />`

---

### 问题 2: 转人工按钮点击无反应

**可能原因**: canEscalate 计算属性返回 false

**检查**:
1. 打开浏览器控制台
2. 输入: `chatStore.canEscalate`
3. 应该返回 `true`（当状态为 bot_active 时）

**如果返回 false**: 检查当前会话状态
```javascript
chatStore.sessionStatus  // 应该是 'bot_active'
```

---

### 问题 3: SSE 事件未收到

**可能原因**: SSE 连接未建立或后端未推送

**检查**:
1. 打开浏览器 Network 标签
2. 筛选 "EventStream" 类型
3. 应该看到 `/api/chat/stream` 连接处于 "pending" 状态

**如果没有连接**:
- 检查是否发送过消息
- 检查后端是否正常运行

---

### 问题 4: 人工消息样式不对

**可能原因**: ChatMessage 组件未正确更新

**检查**:
```bash
# 查看 ChatMessage.vue 是否支持 agent 角色
grep -n "isAgent" frontend/src/components/ChatMessage.vue
```

**预期**: 应该看到 `isAgent` 计算属性定义

---

### 问题 5: 输入框 placeholder 不变化

**可能原因**: computed 属性未正确绑定

**检查**:
```bash
# 查看 ChatPanel.vue 是否定义 inputPlaceholder
grep -n "inputPlaceholder" frontend/src/components/ChatPanel.vue
```

**预期**: 应该看到 computed 定义和模板绑定 `:placeholder="inputPlaceholder"`

---

## 📊 测试检查清单

手动测试完成后，请勾选以下项目：

### 基础功能
- [ ] TypeScript 类型检查通过
- [ ] 后端服务正常启动
- [ ] 前端服务正常启动
- [ ] 浏览器控制台无错误

### 场景 1: bot_active
- [ ] 状态栏显示 "AI服务中"
- [ ] 输入框可用
- [ ] AI 对话正常工作
- [ ] 消息渲染正确

### 场景 2: pending_manual
- [ ] 转人工按钮可用
- [ ] 状态栏变为 "等待人工接入"
- [ ] 黄色等待提示显示
- [ ] placeholder 更新
- [ ] 消息发送被阻止

### 场景 3: manual_live
- [ ] 坐席接入命令成功
- [ ] 状态栏显示坐席名称
- [ ] placeholder 更新为 "向客服发送消息"
- [ ] 用户消息通过人工接口发送

### 场景 4: 坐席回复
- [ ] 人工消息正确接收
- [ ] 蓝色主题样式正确
- [ ] 坐席名称显示
- [ ] "人工"标签显示

### 场景 5: 释放会话
- [ ] 释放命令成功
- [ ] 状态恢复为 bot_active
- [ ] AI 对话恢复正常

### 用户体验
- [ ] 状态切换流畅无卡顿
- [ ] 动画效果正常
- [ ] 消息滚动正常
- [ ] 输入框自动聚焦

---

## 🎬 测试视频录制建议

如果需要录制测试视频，建议包含以下内容：

1. **开场**: 显示项目 README 和功能说明
2. **启动服务**: 展示后端和前端启动过程
3. **场景演示**: 按照上述6个场景逐一演示
4. **问题排查**: 展示如何使用控制台和 Network 标签调试
5. **总结**: 展示所有测试通过的截图

---

## 📞 技术支持

如果测试过程中遇到问题：

1. **查看日志**:
   - 后端日志: 终端中运行 `python3 backend.py` 的窗口
   - 前端日志: 浏览器控制台（F12 → Console）

2. **查看文档**:
   - `docs/P0-9_输入控制逻辑_完成总结.md` - 实现细节
   - `prd/IMPLEMENTATION_TASKS_v1.0.md` - 需求说明
   - `prd/CONSTRAINTS_AND_PRINCIPLES.md` - 技术约束

3. **运行自动化测试**:
```bash
cd /home/yzh/AI客服/鉴权
python3 tests/test_p09_input_control.py
```

---

**文档版本**: v1.0
**创建日期**: 2025-11-21
**最后更新**: 2025-11-21
**维护者**: Claude Code
