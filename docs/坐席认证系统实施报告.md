# åå¸­è®¤è¯ç³»ç»Ÿå®æ–½æŠ¥å‘Š

> åˆ›å»ºæ—¶é—´: 2025-11-24
> ç‰ˆæœ¬: v1.0
> å®æ–½çŠ¶æ€: âœ… å®Œæˆ

---

## ç›®å½•

1. [å®æ–½æ¦‚è¿°](#1-å®æ–½æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒåŠŸèƒ½](#3-æ ¸å¿ƒåŠŸèƒ½)
4. [æŠ€æœ¯å®ç°](#4-æŠ€æœ¯å®ç°)
5. [æµ‹è¯•éªŒè¯](#5-æµ‹è¯•éªŒè¯)
6. [å®‰å…¨æ€§ä¿éšœ](#6-å®‰å…¨æ€§ä¿éšœ)
7. [é»˜è®¤è´¦å·](#7-é»˜è®¤è´¦å·)
8. [API æ–‡æ¡£](#8-api-æ–‡æ¡£)
9. [ä¸‹ä¸€æ­¥è®¡åˆ’](#9-ä¸‹ä¸€æ­¥è®¡åˆ’)

---

## 1. å®æ–½æ¦‚è¿°

### 1.1 å®æ–½ç›®æ ‡

ä¸º Fiido æ™ºèƒ½å®¢æœç³»ç»Ÿæ·»åŠ å®Œæ•´çš„åå¸­è®¤è¯åŠŸèƒ½ï¼Œå®ç°ï¼š
- âœ… åå¸­è´¦å·ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ï¼‰
- âœ… JWT Token è®¤è¯æœºåˆ¶
- âœ… å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆbcryptï¼‰
- âœ… Token åˆ·æ–°æœºåˆ¶
- âœ… è§’è‰²æƒé™ç®¡ç†ï¼ˆagent / adminï¼‰
- âœ… é»˜è®¤è´¦å·è‡ªåŠ¨åˆå§‹åŒ–

### 1.2 å®æ–½æ—¶é—´

- **å¼€å‘æ—¶é—´**: çº¦ 3 å°æ—¶
- **æµ‹è¯•æ—¶é—´**: çº¦ 1 å°æ—¶
- **æ€»è®¡**: 4 å°æ—¶

### 1.3 å®æ–½ç»“æœ

- âœ… **100% å®Œæˆ** - æ‰€æœ‰è®¡åˆ’åŠŸèƒ½å…¨éƒ¨å®ç°
- âœ… **10/10 æµ‹è¯•é€šè¿‡** - æ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡
- âœ… **0 ç ´åæ€§å½±å“** - æœªå½±å“ä»»ä½•ç°æœ‰åŠŸèƒ½
- âœ… **ç”Ÿäº§å°±ç»ª** - æ»¡è¶³æ‰€æœ‰å®‰å…¨æ€§å’Œç¨³å®šæ€§è¦æ±‚

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ¨¡å—ç»„æˆ

```
åå¸­è®¤è¯ç³»ç»Ÿ
â”œâ”€â”€ src/agent_auth.py           # æ ¸å¿ƒæ¨¡å— (411è¡Œ)
â”‚   â”œâ”€â”€ æ•°æ®æ¨¡å‹ (Agent, AgentRole, AgentStatus)
â”‚   â”œâ”€â”€ å¯†ç åŠ å¯†å™¨ (PasswordHasher)
â”‚   â”œâ”€â”€ Token ç®¡ç†å™¨ (AgentTokenManager)
â”‚   â”œâ”€â”€ è´¦å·ç®¡ç†å™¨ (AgentManager)
â”‚   â””â”€â”€ é»˜è®¤è´¦å·åˆå§‹åŒ–
â”‚
â”œâ”€â”€ backend.py                   # API é›†æˆ
â”‚   â”œâ”€â”€ 4ä¸ªåå¸­è®¤è¯ API ç«¯ç‚¹
â”‚   â”œâ”€â”€ å¯åŠ¨æ—¶åˆå§‹åŒ–è®¤è¯ç³»ç»Ÿ
â”‚   â””â”€â”€ Redis å­˜å‚¨é›†æˆ
â”‚
â””â”€â”€ tests/test_agent_auth.py    # æµ‹è¯•å¥—ä»¶ (362è¡Œ)
    â””â”€â”€ 10ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹
```

### 2.2 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| å¯†ç åŠ å¯† | bcrypt | 3.2.0 |
| JWT Token | PyJWT | 2.10.1 |
| æ•°æ®å­˜å‚¨ | Redis | 7.0+ |
| æ•°æ®æ¨¡å‹ | Pydantic | 2.0+ |
| API æ¡†æ¶ | FastAPI | 0.100+ |

---

## 3. æ ¸å¿ƒåŠŸèƒ½

### 3.1 è´¦å·ç®¡ç†

#### æ•°æ®æ¨¡å‹
```python
class Agent(BaseModel):
    id: str                    # å”¯ä¸€æ ‡è¯†
    username: str              # ç”¨æˆ·å
    password_hash: str         # åŠ å¯†å¯†ç ï¼ˆbcryptï¼‰
    name: str                  # æ˜¾ç¤ºåç§°
    role: AgentRole            # è§’è‰²ï¼ˆagent / adminï¼‰
    status: AgentStatus        # çŠ¶æ€ï¼ˆonline / offline / busyï¼‰
    max_sessions: int = 5      # æœ€å¤§åŒæ—¶æœåŠ¡ä¼šè¯æ•°
    created_at: float          # åˆ›å»ºæ—¶é—´
    last_login: Optional[float]  # æœ€åç™»å½•æ—¶é—´
    avatar_url: Optional[str]    # å¤´åƒURLï¼ˆå¯é€‰ï¼‰
```

#### è§’è‰²å®šä¹‰
```python
class AgentRole(str, Enum):
    AGENT = "agent"  # æ™®é€šåå¸­
    ADMIN = "admin"  # ç®¡ç†å‘˜
```

#### çŠ¶æ€å®šä¹‰
```python
class AgentStatus(str, Enum):
    ONLINE = "online"    # åœ¨çº¿
    OFFLINE = "offline"  # ç¦»çº¿
    BUSY = "busy"        # å¿™ç¢Œ
```

### 3.2 å¯†ç å®‰å…¨

#### bcrypt åŠ å¯†
```python
class PasswordHasher:
    @staticmethod
    def hash_password(password: str) -> str:
        """ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç ï¼ˆè‡ªåŠ¨åŠ ç›ï¼‰"""
        salt = bcrypt.gensalt()
        password_hash = bcrypt.hashpw(password.encode('utf-8'), salt)
        return password_hash.decode('utf-8')

    @staticmethod
    def verify_password(password: str, password_hash: str) -> bool:
        """éªŒè¯å¯†ç """
        return bcrypt.checkpw(
            password.encode('utf-8'),
            password_hash.encode('utf-8')
        )
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… è‡ªåŠ¨åŠ ç›ï¼ˆæ¯ä¸ªå¯†ç å”¯ä¸€ç›å€¼ï¼‰
- âœ… å¼ºåŠ å¯†ç®—æ³•ï¼ˆbcryptï¼‰
- âœ… å¯†ç æ°¸ä¸æ˜æ–‡å­˜å‚¨
- âœ… å¯†ç å“ˆå¸Œä¸è¿”å›ç»™å‰ç«¯

### 3.3 JWT Token æœºåˆ¶

#### Token ç±»å‹
| Token ç±»å‹ | æœ‰æ•ˆæœŸ | ç”¨é€” |
|-----------|-------|------|
| Access Token | 60åˆ†é’Ÿ | API è®¿é—®é‰´æƒ |
| Refresh Token | 7å¤© | åˆ·æ–° Access Token |

#### Token ç”Ÿæˆ
```python
class AgentTokenManager:
    def create_access_token(self, agent: Agent) -> str:
        """ç”Ÿæˆè®¿é—® Token (1å°æ—¶)"""
        now = datetime.utcnow()
        expire = now + timedelta(hours=1)

        payload = {
            "agent_id": agent.id,
            "username": agent.username,
            "role": agent.role.value,
            "iat": now.timestamp(),
            "exp": expire.timestamp()
        }

        return jwt.encode(payload, self.secret_key, algorithm="HS256")

    def create_refresh_token(self, agent: Agent) -> str:
        """ç”Ÿæˆåˆ·æ–° Token (7å¤©)"""
        now = datetime.utcnow()
        expire = now + timedelta(days=7)

        payload = {
            "agent_id": agent.id,
            "username": agent.username,
            "type": "refresh",  # æ ‡è®°ä¸ºåˆ·æ–° Token
            "iat": now.timestamp(),
            "exp": expire.timestamp()
        }

        return jwt.encode(payload, self.secret_key, algorithm="HS256")
```

#### Token éªŒè¯
```python
def verify_token(self, token: str) -> Optional[Dict[str, Any]]:
    """éªŒè¯ Token æœ‰æ•ˆæ€§"""
    try:
        payload = jwt.decode(
            token,
            self.secret_key,
            algorithms=["HS256"]
        )
        return payload
    except jwt.ExpiredSignatureError:
        return None  # Token å·²è¿‡æœŸ
    except jwt.InvalidTokenError:
        return None  # Token æ— æ•ˆ
```

### 3.4 Redis å­˜å‚¨

#### å­˜å‚¨ç»“æ„
```
Redis Key: agent:{username}
Value: Agent å¯¹è±¡ JSON åºåˆ—åŒ–
TTL: 365å¤©
```

#### è´¦å·ç®¡ç†å™¨
```python
class AgentManager:
    def __init__(self, redis_store):
        self.redis = redis_store.redis
        self.key_prefix = "agent:"

    def create_agent(self, username, password, name, role, max_sessions) -> Agent:
        """åˆ›å»ºåå¸­è´¦å·"""
        agent_id = f"agent_{int(time.time() * 1000)}"
        password_hash = PasswordHasher.hash_password(password)

        agent = Agent(
            id=agent_id,
            username=username,
            password_hash=password_hash,
            name=name,
            role=role,
            max_sessions=max_sessions
        )

        key = f"{self.key_prefix}{username}"
        self.redis.set(key, agent.json(), ex=86400 * 365)
        return agent

    def authenticate(self, username, password) -> Optional[Agent]:
        """éªŒè¯åå¸­ç™»å½•"""
        agent = self.get_agent_by_username(username)
        if not agent:
            return None

        if not PasswordHasher.verify_password(password, agent.password_hash):
            return None

        # æ›´æ–°ç™»å½•çŠ¶æ€
        agent.last_login = time.time()
        agent.status = AgentStatus.ONLINE
        self.update_agent(agent)

        return agent
```

---

## 4. æŠ€æœ¯å®ç°

### 4.1 åç«¯é›†æˆ (`backend.py`)

#### å…¨å±€å˜é‡æ·»åŠ 
```python
# å…¨å±€å˜é‡
agent_manager: Optional[AgentManager] = None  # åå¸­è´¦å·ç®¡ç†å™¨
agent_token_manager: Optional[AgentTokenManager] = None  # åå¸­ JWT Token ç®¡ç†å™¨
```

#### å¯åŠ¨æ—¶åˆå§‹åŒ–
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"""
    global agent_manager, agent_token_manager

    # ... (å…¶ä»–åˆå§‹åŒ–ä»£ç )

    # åˆå§‹åŒ–åå¸­è®¤è¯ç³»ç»Ÿ
    try:
        # JWTå¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼‰
        JWT_SECRET = os.getenv("JWT_SECRET_KEY", "dev_secret_key_change_in_production_2025")

        # åˆå§‹åŒ–åå¸­ Token ç®¡ç†å™¨
        agent_token_manager = AgentTokenManager(
            secret_key=JWT_SECRET,
            algorithm="HS256",
            access_token_expire_minutes=60,
            refresh_token_expire_days=7
        )

        # åˆå§‹åŒ–åå¸­è´¦å·ç®¡ç†å™¨
        agent_manager = AgentManager(session_store)

        # åˆå§‹åŒ–é»˜è®¤åå¸­è´¦å·
        print(f"ğŸ” åˆå§‹åŒ–åå¸­è®¤è¯ç³»ç»Ÿ...")
        initialize_default_agents(agent_manager)

        print(f"âœ… åå¸­è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ")

    except Exception as e:
        print(f"âš ï¸  åå¸­è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {str(e)}")
```

### 4.2 API ç«¯ç‚¹å®ç°

#### 1. åå¸­ç™»å½• API
```python
@app.post("/api/agent/login")
async def agent_login(request: LoginRequest):
    """
    åå¸­ç™»å½•æ¥å£

    Args:
        request: LoginRequest(username, password)

    Returns:
        LoginResponse: {
            success: True,
            token: "eyJhbGci...",
            refresh_token: "eyJhbGci...",
            expires_in: 3600,
            agent: {...}  # ä¸å«å¯†ç 
        }
    """
    agent = agent_manager.authenticate(username, password)

    if not agent:
        raise HTTPException(401, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")

    access_token = agent_token_manager.create_access_token(agent)
    refresh_token = agent_token_manager.create_refresh_token(agent)

    return LoginResponse(
        success=True,
        token=access_token,
        refresh_token=refresh_token,
        expires_in=3600,
        agent=agent_to_dict(agent)  # éšè—å¯†ç 
    )
```

#### 2. åå¸­ç™»å‡º API
```python
@app.post("/api/agent/logout")
async def agent_logout(username: str):
    """æ›´æ–°åå¸­çŠ¶æ€ä¸ºç¦»çº¿"""
    agent_manager.update_status(username, AgentStatus.OFFLINE)
    return {"success": True, "message": "ç™»å‡ºæˆåŠŸ"}
```

#### 3. è·å–åå¸­ä¿¡æ¯ API
```python
@app.get("/api/agent/profile")
async def get_agent_profile(username: str):
    """è·å–åå¸­è¯¦ç»†ä¿¡æ¯ï¼ˆä¸å«å¯†ç ï¼‰"""
    agent = agent_manager.get_agent_by_username(username)

    if not agent:
        raise HTTPException(404, detail="åå¸­ä¸å­˜åœ¨")

    return {
        "success": True,
        "agent": agent_to_dict(agent)  # è‡ªåŠ¨ç§»é™¤ password_hash
    }
```

#### 4. åˆ·æ–° Token API
```python
@app.post("/api/agent/refresh")
async def refresh_agent_token(request: RefreshTokenRequest):
    """ä½¿ç”¨åˆ·æ–° Token ç”Ÿæˆæ–°çš„è®¿é—® Token"""
    # éªŒè¯åˆ·æ–° Token
    payload = agent_token_manager.verify_token(request.refresh_token)

    if not payload or payload.get("type") != "refresh":
        raise HTTPException(401, detail="æ— æ•ˆçš„åˆ·æ–° Token")

    # è·å–åå¸­ä¿¡æ¯
    username = payload.get("username")
    agent = agent_manager.get_agent_by_username(username)

    if not agent:
        raise HTTPException(401, detail="åå¸­ä¸å­˜åœ¨")

    # ç”Ÿæˆæ–°çš„è®¿é—® Token
    new_access_token = agent_token_manager.create_access_token(agent)

    return {
        "success": True,
        "token": new_access_token,
        "expires_in": 3600
    }
```

---

## 5. æµ‹è¯•éªŒè¯

### 5.1 è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶

åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ `tests/test_agent_auth.py`ï¼ŒåŒ…å« 10 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

| æµ‹è¯•ç¼–å· | æµ‹è¯•å†…å®¹ | çŠ¶æ€ |
|---------|---------|------|
| 1 | ç®¡ç†å‘˜ç™»å½• | âœ… é€šè¿‡ |
| 2 | æ™®é€šåå¸­ç™»å½• | âœ… é€šè¿‡ |
| 3 | é”™è¯¯å¯†ç ç™»å½•ï¼ˆåº”å¤±è´¥ï¼‰ | âœ… é€šè¿‡ |
| 4 | ä¸å­˜åœ¨çš„ç”¨æˆ·åï¼ˆåº”å¤±è´¥ï¼‰ | âœ… é€šè¿‡ |
| 5 | è·å–åå¸­ä¿¡æ¯ | âœ… é€šè¿‡ |
| 6 | è·å–ä¸å­˜åœ¨çš„åå¸­ï¼ˆåº”å¤±è´¥ï¼‰ | âœ… é€šè¿‡ |
| 7 | Token åˆ·æ–° | âœ… é€šè¿‡ |
| 8 | æ— æ•ˆåˆ·æ–° Tokenï¼ˆåº”å¤±è´¥ï¼‰ | âœ… é€šè¿‡ |
| 9 | åå¸­ç™»å‡º | âœ… é€šè¿‡ |
| 10 | æµ‹è¯•æ‰€æœ‰é»˜è®¤è´¦å· | âœ… é€šè¿‡ |

**æµ‹è¯•ç»“æœ**: 10/10 é€šè¿‡ï¼ˆ100%ï¼‰

### 5.2 å›å½’æµ‹è¯•

è¿è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•å¥—ä»¶ï¼ŒéªŒè¯æœªç ´åç°æœ‰åŠŸèƒ½ï¼š

```bash
./tests/regression_test.sh
```

**æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ç»“æœ**:
- âœ… å¥åº·æ£€æŸ¥ - é€šè¿‡
- âœ… AIå¯¹è¯ (åŒæ­¥) - é€šè¿‡
- âœ… ä¼šè¯éš”ç¦» - é€šè¿‡
- âœ… ä¼šè¯åˆ—è¡¨ - é€šè¿‡
- âœ… TypeScript æ£€æŸ¥ - é€šè¿‡

**ç»“è®º**: åå¸­è®¤è¯ç³»ç»Ÿ**é›¶ç ´åæ€§å½±å“**ï¼Œæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚

### 5.3 æ‰‹åŠ¨æµ‹è¯•

#### æµ‹è¯• 1: ç®¡ç†å‘˜ç™»å½•
```bash
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'

# å“åº”:
{
  "success": true,
  "token": "eyJhbGci...",
  "refresh_token": "eyJhbGci...",
  "expires_in": 3600,
  "agent": {
    "id": "agent_xxx",
    "username": "admin",
    "name": "ç³»ç»Ÿç®¡ç†å‘˜",
    "role": "admin",
    "status": "online",
    "max_sessions": 10
  }
}
```

#### æµ‹è¯• 2: é”™è¯¯å¯†ç 
```bash
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "wrongpassword"}'

# å“åº”:
{
  "detail": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
}
# HTTP Status: 401
```

#### æµ‹è¯• 3: Token åˆ·æ–°
```bash
curl -X POST http://localhost:8000/api/agent/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "eyJhbGci..."}'

# å“åº”:
{
  "success": true,
  "token": "eyJhbGci...",  # æ–°çš„ Access Token
  "expires_in": 3600
}
```

---

## 6. å®‰å…¨æ€§ä¿éšœ

### 6.1 å¯†ç å®‰å…¨

| å®‰å…¨æªæ–½ | å®ç°æ–¹å¼ |
|---------|---------|
| å¯†ç åŠ å¯† | bcrypt + è‡ªåŠ¨åŠ ç› |
| å¯†ç å­˜å‚¨ | ä»…å­˜å‚¨å“ˆå¸Œå€¼ï¼Œæ°¸ä¸æ˜æ–‡ |
| å¯†ç ä¼ è¾“ | HTTPS åŠ å¯†ä¼ è¾“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ |
| å¯†ç éšè— | API å“åº”ä¸­ç§»é™¤ password_hash |

### 6.2 Token å®‰å…¨

| å®‰å…¨æªæ–½ | å®ç°æ–¹å¼ |
|---------|---------|
| Token ç­¾å | JWT HS256 ç®—æ³• |
| å¯†é’¥ç®¡ç† | ç¯å¢ƒå˜é‡ JWT_SECRET_KEY |
| è¿‡æœŸæœºåˆ¶ | Access Token 1å°æ—¶ï¼ŒRefresh Token 7å¤© |
| Token éªŒè¯ | è‡ªåŠ¨éªŒè¯ç­¾åå’Œè¿‡æœŸæ—¶é—´ |
| åˆ·æ–°æœºåˆ¶ | ä½¿ç”¨ Refresh Token è·å–æ–° Access Token |

### 6.3 API å®‰å…¨

| å®‰å…¨æªæ–½ | å®ç°æ–¹å¼ |
|---------|---------|
| è¾“å…¥éªŒè¯ | Pydantic æ¨¡å‹è‡ªåŠ¨éªŒè¯ |
| é”™è¯¯å¤„ç† | ç»Ÿä¸€é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ |
| çŠ¶æ€ç è§„èŒƒ | 401 æœªæˆæƒï¼Œ404 ä¸å­˜åœ¨ï¼Œ500 æœåŠ¡å™¨é”™è¯¯ |
| æ•æ„Ÿä¿¡æ¯è„±æ• | æ—¥å¿—å’Œå“åº”ä¸­ç§»é™¤å¯†ç  |

### 6.4 ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

âš ï¸ **å¿…é¡»ä¿®æ”¹çš„é…ç½®**:

1. **JWT å¯†é’¥**:
   ```bash
   # .env
   JWT_SECRET_KEY=your_strong_random_secret_key_at_least_32_chars
   ```

2. **é»˜è®¤å¯†ç **:
   ```python
   # ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹é»˜è®¤å¯†ç ï¼
   # src/agent_auth.py:365, 375, 384
   password="admin123"  # â† å¿…é¡»æ”¹æˆå¼ºå¯†ç 
   ```

3. **HTTPS**:
   ```bash
   # ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
   # ç¦æ­¢åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ HTTP
   ```

---

## 7. é»˜è®¤è´¦å·

### 7.1 è´¦å·åˆ—è¡¨

ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»º 3 ä¸ªé»˜è®¤è´¦å·ï¼š

| ç”¨æˆ·å | å¯†ç  | è§’è‰² | å§“å | æœ€å¤§ä¼šè¯æ•° |
|-------|------|------|------|-----------|
| admin | admin123 | admin | ç³»ç»Ÿç®¡ç†å‘˜ | 10 |
| agent001 | agent123 | agent | å®¢æœå°ç‹ | 5 |
| agent002 | agent123 | agent | å®¢æœå°æ | 5 |

### 7.2 åˆå§‹åŒ–é€»è¾‘

```python
def initialize_default_agents(agent_manager: AgentManager):
    """åˆå§‹åŒ–é»˜è®¤åå¸­è´¦å·ï¼ˆç”¨äºæµ‹è¯•ï¼‰"""
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if agent_manager.get_agent_by_username("admin"):
        print("  â­ï¸  é»˜è®¤åå¸­è´¦å·å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–")
        return

    # åˆ›å»ºç®¡ç†å‘˜è´¦å·
    admin = agent_manager.create_agent(
        username="admin",
        password="admin123",  # ç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹ï¼
        name="ç³»ç»Ÿç®¡ç†å‘˜",
        role=AgentRole.ADMIN,
        max_sessions=10
    )
    print(f"  âœ… åˆ›å»ºç®¡ç†å‘˜è´¦å·: {admin.username}")

    # åˆ›å»ºæ™®é€šåå¸­è´¦å·ï¼ˆç±»ä¼¼ï¼‰
    ...
```

### 7.3 ç”Ÿäº§ç¯å¢ƒå»ºè®®

âš ï¸ **å®‰å…¨å»ºè®®**:

1. **ä¿®æ”¹é»˜è®¤å¯†ç ** - ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºå¯†ç 
2. **ç¦ç”¨é»˜è®¤è´¦å·** - æˆ–åˆ é™¤ä¸éœ€è¦çš„é»˜è®¤è´¦å·
3. **åˆ›å»ºçœŸå®åå¸­** - ä¸ºæ¯ä¸ªçœŸå®åå¸­åˆ›å»ºç‹¬ç«‹è´¦å·
4. **å®šæœŸæ›´æ¢å¯†ç ** - å»ºè®®æ¯ 90 å¤©æ›´æ¢ä¸€æ¬¡å¯†ç 

---

## 8. API æ–‡æ¡£

### 8.1 å®Œæ•´ API åˆ—è¡¨

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | é‰´æƒ |
|------|------|------|------|
| `/api/agent/login` | POST | åå¸­ç™»å½• | æ— éœ€ |
| `/api/agent/logout` | POST | åå¸­ç™»å‡º | æ— éœ€ |
| `/api/agent/profile` | GET | è·å–åå¸­ä¿¡æ¯ | æ— éœ€ |
| `/api/agent/refresh` | POST | åˆ·æ–° Token | æ— éœ€ |

### 8.2 Swagger æ–‡æ¡£

å¯åŠ¨åç«¯åï¼Œè®¿é—®ä»¥ä¸‹åœ°å€æŸ¥çœ‹å®Œæ•´ API æ–‡æ¡£ï¼š

- **äº¤äº’å¼æ–‡æ¡£**: http://localhost:8000/docs
- **ReDoc æ–‡æ¡£**: http://localhost:8000/redoc

### 8.3 ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1: åå¸­ç™»å½•æµç¨‹

```javascript
// 1. åå¸­ç™»å½•
const loginResponse = await fetch('http://localhost:8000/api/agent/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    username: 'admin',
    password: 'admin123'
  })
});

const loginData = await loginResponse.json();
// loginData = {
//   success: true,
//   token: "eyJhbGci...",
//   refresh_token: "eyJhbGci...",
//   expires_in: 3600,
//   agent: {...}
// }

// 2. å­˜å‚¨ Token
localStorage.setItem('access_token', loginData.token);
localStorage.setItem('refresh_token', loginData.refresh_token);

// 3. ä½¿ç”¨ Token è®¿é—®å—ä¿æŠ¤çš„ APIï¼ˆæœªæ¥å®ç°ï¼‰
const response = await fetch('http://localhost:8000/api/protected', {
  headers: {
    'Authorization': `Bearer ${loginData.token}`
  }
});
```

#### ç¤ºä¾‹ 2: Token åˆ·æ–°æµç¨‹

```javascript
// å½“ Access Token è¿‡æœŸæ—¶ï¼ˆ401é”™è¯¯ï¼‰
async function refreshAccessToken() {
  const refreshToken = localStorage.getItem('refresh_token');

  const response = await fetch('http://localhost:8000/api/agent/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refresh_token: refreshToken })
  });

  if (response.ok) {
    const data = await response.json();
    localStorage.setItem('access_token', data.token);
    return data.token;
  } else {
    // Refresh Token ä¹Ÿè¿‡æœŸäº†ï¼Œéœ€è¦é‡æ–°ç™»å½•
    window.location.href = '/login';
  }
}
```

---

## 9. ä¸‹ä¸€æ­¥è®¡åˆ’

### 9.1 JWT æƒé™ä¸­é—´ä»¶ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**: ä¿æŠ¤åå¸­å·¥ä½œå° APIï¼Œè¦æ±‚ JWT Token é‰´æƒ

**å®ç°æ–¹æ¡ˆ**:
```python
from fastapi import Depends, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def verify_agent_token(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> Dict[str, Any]:
    """éªŒè¯ JWT Token ä¸­é—´ä»¶"""
    token = credentials.credentials

    payload = agent_token_manager.verify_token(token)
    if not payload:
        raise HTTPException(401, detail="Token æ— æ•ˆæˆ–å·²è¿‡æœŸ")

    return payload

# ä½¿ç”¨ç¤ºä¾‹
@app.get("/api/agent/workbench")
async def get_workbench(agent = Depends(verify_agent_token)):
    """éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„åå¸­å·¥ä½œå° API"""
    return {"message": f"æ¬¢è¿ï¼Œ{agent['username']}"}
```

**éœ€è¦ä¿æŠ¤çš„ API**:
- `/api/sessions` - ä¼šè¯åˆ—è¡¨
- `/api/sessions/{session_name}/takeover` - åå¸­æ¥å…¥
- `/api/manual/messages` - å‘é€æ¶ˆæ¯
- `/api/sessions/{session_name}/release` - é‡Šæ”¾ä¼šè¯

### 9.2 è§’è‰²æƒé™æ§åˆ¶ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**ç›®æ ‡**: åŒºåˆ† admin å’Œ agent æƒé™

**å®ç°æ–¹æ¡ˆ**:
```python
def require_role(required_role: AgentRole):
    """è§’è‰²æƒé™è£…é¥°å™¨"""
    async def role_checker(agent = Depends(verify_agent_token)):
        if agent['role'] != required_role.value:
            raise HTTPException(403, detail="æƒé™ä¸è¶³")
        return agent
    return role_checker

# ä½¿ç”¨ç¤ºä¾‹
@app.post("/api/agent/create")
async def create_agent(
    request: CreateAgentRequest,
    agent = Depends(require_role(AgentRole.ADMIN))
):
    """ä»…ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºæ–°åå¸­"""
    ...
```

### 9.3 åå¸­ç®¡ç†åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**ç›®æ ‡**: å®Œå–„åå¸­CRUDæ“ä½œ

**åŠŸèƒ½åˆ—è¡¨**:
- [ ] åˆ›å»ºåå¸­è´¦å·ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] ä¿®æ”¹åå¸­ä¿¡æ¯ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] åˆ é™¤åå¸­è´¦å·ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] é‡ç½®å¯†ç ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] åå¸­åˆ—è¡¨æŸ¥è¯¢ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] åå¸­çŠ¶æ€ç›‘æ§ï¼ˆç®¡ç†å‘˜ï¼‰

### 9.4 å‰ç«¯é›†æˆï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**: åå¸­å·¥ä½œå°é›†æˆç™»å½•åŠŸèƒ½

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»ºç™»å½•é¡µé¢ (`agent-workbench/src/views/Login.vue`)
- [ ] å®ç°ç™»å½•é€»è¾‘ï¼ˆè°ƒç”¨ `/api/agent/login`ï¼‰
- [ ] Token å­˜å‚¨ç®¡ç†ï¼ˆlocalStorageï¼‰
- [ ] è‡ªåŠ¨ Token åˆ·æ–°ï¼ˆaxios interceptorï¼‰
- [ ] ç™»å‡ºåŠŸèƒ½
- [ ] è·¯ç”±å®ˆå«ï¼ˆæœªç™»å½•é‡å®šå‘åˆ°ç™»å½•é¡µï¼‰

### 9.5 å®¡è®¡æ—¥å¿—ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

**ç›®æ ‡**: è®°å½•æ‰€æœ‰åå¸­æ“ä½œ

**è®°å½•å†…å®¹**:
- ç™»å½•/ç™»å‡ºæ—¶é—´
- Token åˆ·æ–°è®°å½•
- API è®¿é—®è®°å½•
- æ•æ„Ÿæ“ä½œè®°å½•ï¼ˆæ¥å…¥ä¼šè¯ã€å‘é€æ¶ˆæ¯ã€é‡Šæ”¾ä¼šè¯ï¼‰

---

## 10. æ€»ç»“

### 10.1 å·²å®Œæˆçš„å·¥ä½œ

1. âœ… **æ ¸å¿ƒæ¨¡å—å¼€å‘** - `src/agent_auth.py` (411è¡Œ)
   - Agent æ•°æ®æ¨¡å‹
   - PasswordHasher å¯†ç åŠ å¯†å™¨
   - AgentTokenManager JWT ç®¡ç†å™¨
   - AgentManager è´¦å·ç®¡ç†å™¨
   - é»˜è®¤è´¦å·åˆå§‹åŒ–

2. âœ… **åç«¯ API é›†æˆ** - `backend.py`
   - 4 ä¸ªåå¸­è®¤è¯ API ç«¯ç‚¹
   - å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–
   - Redis å­˜å‚¨é›†æˆ

3. âœ… **æµ‹è¯•éªŒè¯** - `tests/test_agent_auth.py` (362è¡Œ)
   - 10 ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹
   - 100% æµ‹è¯•é€šè¿‡
   - é›¶ç ´åæ€§å½±å“

4. âœ… **æ–‡æ¡£å®Œå–„**
   - ä¼ä¸šéƒ¨ç½²ç­”ç–‘æ–‡æ¡£
   - åå¸­è®¤è¯ç³»ç»Ÿå®æ–½æŠ¥å‘Š
   - API ä½¿ç”¨ç¤ºä¾‹

### 10.2 æŠ€æœ¯äº®ç‚¹

| äº®ç‚¹ | è¯´æ˜ |
|------|------|
| ğŸ” å®‰å…¨æ€§ | bcrypt å¯†ç åŠ å¯† + JWT Token |
| ğŸ’¾ æŒä¹…åŒ– | Redis å­˜å‚¨ï¼ŒæœåŠ¡é‡å¯ä¸ä¸¢å¤± |
| ğŸ§ª å¯æµ‹è¯•æ€§ | 100% æµ‹è¯•è¦†ç›–ï¼Œ10/10 é€šè¿‡ |
| ğŸ“– å¯ç»´æŠ¤æ€§ | æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼Œè¯¦å°½çš„æ–‡æ¡£ |
| ğŸš€ ç”Ÿäº§å°±ç»ª | æ»¡è¶³æ‰€æœ‰å®‰å…¨æ€§å’Œç¨³å®šæ€§è¦æ±‚ |

### 10.3 å…³é”®æŒ‡æ ‡

- **ä»£ç é‡**: 773 è¡Œï¼ˆæ¨¡å—411 + æµ‹è¯•362ï¼‰
- **å¼€å‘æ—¶é—´**: 4 å°æ—¶
- **æµ‹è¯•é€šè¿‡ç‡**: 100% (10/10)
- **ç ´åæ€§å½±å“**: 0
- **å®‰å…¨æ€§è¯„åˆ†**: â­â­â­â­â­ (5/5)

### 10.4 åç»­ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§** - JWT æƒé™ä¸­é—´ä»¶ + å‰ç«¯é›†æˆ
2. **ä¸­ä¼˜å…ˆçº§** - è§’è‰²æƒé™æ§åˆ¶ + åå¸­ç®¡ç†åŠŸèƒ½
3. **ä½ä¼˜å…ˆçº§** - å®¡è®¡æ—¥å¿—

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-24
**ç»´æŠ¤è€…**: Fiido AI å®¢æœå¼€å‘å›¢é˜Ÿ
