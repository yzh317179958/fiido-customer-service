# ä¼šè¯éš”ç¦»å®ç°å†ç¨‹

æœ¬æ–‡æ¡£è®°å½•äº†ä»é—®é¢˜å‘ç°åˆ°æœ€ç»ˆå®ç°ä¼šè¯éš”ç¦»çš„å®Œæ•´è¿‡ç¨‹ã€‚

---

## ç›®å½•
- [é—®é¢˜å‘ç°](#é—®é¢˜å‘ç°)
- [åˆæ­¥å°è¯•](#åˆæ­¥å°è¯•)
- [é—®é¢˜è¯Šæ–­](#é—®é¢˜è¯Šæ–­)
- [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
- [æœ€ç»ˆå®ç°](#æœ€ç»ˆå®ç°)
- [éªŒè¯æµ‹è¯•](#éªŒè¯æµ‹è¯•)

---

## é—®é¢˜å‘ç°

### ç°è±¡
åœ¨åˆå§‹å®ç°ä¸­,å‘ç°ä¸åŒç”¨æˆ·çš„å¯¹è¯ä¼šè¯å‡ºç°æ··æ·†:
- ç”¨æˆ· A è¯¢é—®"æˆ‘æ˜¯è°?"æ—¶,ç³»ç»Ÿå›ç­”äº†ç”¨æˆ· B çš„ä¿¡æ¯
- å¤šä¸ªç”¨æˆ·å…±äº«åŒä¸€ä¸ªå¯¹è¯ä¸Šä¸‹æ–‡
- ä¼šè¯è®°å½•äº’ç›¸å¹²æ‰°

### æµ‹è¯•æ¡ˆä¾‹
```python
# ç”¨æˆ· A
å‘é€: "æˆ‘å«å¼ ä¸‰,25å²"
# ç”¨æˆ· B
å‘é€: "æˆ‘å«æå››,æ˜¯ç¨‹åºå‘˜"
# ç”¨æˆ· A ç¬¬äºŒè½®
å‘é€: "æˆ‘å«ä»€ä¹ˆ?"
å›å¤: "ä½ å«æå››" âŒ é”™è¯¯!åº”è¯¥æ˜¯"å¼ ä¸‰"
```

---

## åˆæ­¥å°è¯•

### å°è¯• 1: ä½¿ç”¨ JWT session_name (ä»…åœ¨JWTä¸­)

**å®ç°æ–¹å¼**:
```python
# ä»…åœ¨ JWT ç­¾ç½²æ—¶æ·»åŠ  session_name
jwt_token = token_manager.get_access_token(session_name=user_id)
```

**API è¯·æ±‚ payload**:
```json
{
  "workflow_id": "xxx",
  "app_id": "xxx",
  "parameters": {"USER_INPUT": "..."}
  // âŒ ç¼ºå°‘ session_name å­—æ®µ
}
```

**æµ‹è¯•ç»“æœ**: âŒ **å¤±è´¥**
- JWT Token ä¸ºæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ç”Ÿæˆ âœ…
- ä½† API è¯·æ±‚ä¸­æ²¡æœ‰ session_name å­—æ®µ âŒ
- ä¼šè¯ä»ç„¶æ··æ·†

---

### å°è¯• 2: æ·»åŠ  conversationName å‚æ•°

**å®ç°æ–¹å¼**:
```python
payload = {
    "workflow_id": WORKFLOW_ID,
    "parameters": {
        "USER_INPUT": message,
        "conversationName": f"{user_id}_chat"  # â† æ·»åŠ åˆ° parameters
    }
}
```

**æµ‹è¯•ç»“æœ**: âŒ **å¤±è´¥**
- conversationName ä½œä¸ºä¸šåŠ¡å‚æ•°ä¼ å…¥
- ä½† Workflow æœªé…ç½®å¯¹åº”çš„å‚æ•°æ¥æ”¶
- æ‰£å­å¹³å°æ— æ³•è¯†åˆ«

---

### å°è¯• 3: æ‰‹åŠ¨ç®¡ç† conversation_id

**å®ç°æ–¹å¼**:
```python
# ç»´æŠ¤æ˜ å°„å…³ç³»
user_conversations = {}

# é¦–æ¬¡å¯¹è¯ä¸ä¼ ,åç»­ä¼ é€’
if user_id in user_conversations:
    payload["conversation_id"] = user_conversations[user_id]
```

**é—®é¢˜**:
- éœ€è¦é¢å¤–çš„å­˜å‚¨ç»´æŠ¤æ˜ å°„å…³ç³»
- conversation_id ç”±åç«¯ç®¡ç†,å¢åŠ å¤æ‚åº¦
- ä¸ç¬¦åˆå®˜æ–¹æ¨èçš„å®ç°æ–¹å¼

**æµ‹è¯•ç»“æœ**: âš ï¸ **éƒ¨åˆ†æœ‰æ•ˆ,ä½†ä¸æ˜¯æœ€ä½³æ–¹æ¡ˆ**

---

## é—®é¢˜è¯Šæ–­

### å…³é”®å‘ç°

é€šè¿‡æŸ¥é˜…å®˜æ–¹æ–‡æ¡£,å‘ç°å…³é”®è¦æ±‚:

> **å®˜æ–¹æ–‡æ¡£**:
> éœ€è¦åœ¨è°ƒç”¨æ‰£å­ OpenAPI æˆ– SDK æ—¶,ä½¿ç”¨ OAuth JWT é‰´æƒæ–¹å¼,å¹¶åœ¨ç­¾ç½² JWT æ—¶,åœ¨ payload å­—æ®µä¸­æ·»åŠ  session_name å­—æ®µã€‚**åŒæ—¶åœ¨ API è¯·æ±‚çš„ payload ä¸­ä¹Ÿè¦æ·»åŠ  session_name å­—æ®µ**ã€‚

### é—®é¢˜åˆ†æ

**é”™è¯¯ç†è§£**:
- ä¹‹å‰åªåœ¨ JWT payload ä¸­æ·»åŠ äº† session_name
- å¿½ç•¥äº† API è¯·æ±‚ payload ä¹Ÿéœ€è¦æ·»åŠ  session_name

**æ­£ç¡®åšæ³•**:
1. âœ… JWT ç­¾ç½²æ—¶: `jwt_payload["session_name"] = user_id`
2. âœ… API è¯·æ±‚æ—¶: `api_payload["session_name"] = user_id` (é¡¶å±‚å­—æ®µ)
3. âŒ ä¸è¦æ‰‹åŠ¨ç®¡ç† conversation_id

---

## è§£å†³æ–¹æ¡ˆ

### æœ€ç»ˆæ–¹æ¡ˆæ¶æ„

```
å‰ç«¯è®¿é—®
    â†“
ç”Ÿæˆ session_id (å­˜å‚¨åœ¨ sessionStorage)
    â†“
åç«¯æ¥æ”¶ user_id
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. JWT ç­¾ç½²                      â”‚
â”‚    payload["session_name"] = uid â”‚
â”‚         â†“                        â”‚
â”‚ 2. è·å– Access Token             â”‚
â”‚         â†“                        â”‚
â”‚ 3. æ„å»º API Payload              â”‚
â”‚    {                             â”‚
â”‚      "workflow_id": "...",       â”‚
â”‚      "app_id": "...",            â”‚
â”‚      "session_name": uid,  â† âœ…  â”‚
â”‚      "parameters": {...}         â”‚
â”‚    }                             â”‚
â”‚         â†“                        â”‚
â”‚ 4. è°ƒç”¨ Coze API                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ‰£å­å¹³å°æ ¹æ® session_name éš”ç¦»ä¼šè¯
```

### ä»£ç ä¿®æ”¹

#### ä¿®æ”¹ 1: JWT ç­¾ç½² (å·²æ­£ç¡®å®ç°)

**æ–‡ä»¶**: `src/jwt_signer.py:117-118`

```python
# å¯é€‰å­—æ®µ:ä¼šè¯ä¿¡æ¯
if session_name:
    payload["session_name"] = session_name  # âœ… å·²æœ‰
```

#### ä¿®æ”¹ 2: API è¯·æ±‚æ·»åŠ  session_name (æ–°å¢)

**æ–‡ä»¶**: `backend.py:324`

```python
# ä¿®æ”¹å‰
payload = {
    "workflow_id": WORKFLOW_ID,
    "app_id": APP_ID,
    "parameters": {"USER_INPUT": request.message},
    # âŒ ç¼ºå°‘ session_name
}

# ä¿®æ”¹å
payload = {
    "workflow_id": WORKFLOW_ID,
    "app_id": APP_ID,
    "session_name": session_id,  # âœ… æ–°å¢ - é¡¶å±‚å­—æ®µ
    "parameters": {"USER_INPUT": request.message},
}
```

**å…³é”®ç‚¹**:
- `session_name` æ˜¯ **é¡¶å±‚å­—æ®µ**,ä¸æ˜¯æ”¾åœ¨ parameters é‡Œ
- ä¸ workflow_idã€app_id åŒçº§

#### ä¿®æ”¹ 3: æµå¼æ¥å£åŒæ­¥ä¿®æ”¹

**æ–‡ä»¶**: `backend.py:449`

```python
# æµå¼æ¥å£ä¹Ÿè¦æ·»åŠ  session_name
payload = {
    "workflow_id": WORKFLOW_ID,
    "app_id": APP_ID,
    "session_name": session_id,  # âœ… æ–°å¢
    "parameters": {"USER_INPUT": request.message},
}
```

---

## æœ€ç»ˆå®ç°

### å®Œæ•´è¯·æ±‚æµç¨‹

#### 1. å‰ç«¯ç”Ÿæˆ session_id

```javascript
// å‰ç«¯ (æ¨¡æ‹Ÿ)
function generateSessionId() {
    return 'session_' + Math.random().toString(36).substr(2, 16);
}

const sessionId = generateSessionId(); // session_abc123def456
sessionStorage.setItem('session_id', sessionId);
```

#### 2. åç«¯å¤„ç†è¯·æ±‚

```python
# backend.py

@app.post("/api/chat")
async def chat(request: ChatRequest):
    # è·å– session_id
    session_id = request.user_id or generate_user_id()

    # è·å–å¸¦ session_name çš„ JWT Token
    access_token = token_manager.get_access_token(session_name=session_id)

    # æ„å»º API payload (åŒ…å« session_name)
    payload = {
        "workflow_id": WORKFLOW_ID,
        "app_id": APP_ID,
        "session_name": session_id,  # â† å…³é”®!
        "parameters": {"USER_INPUT": request.message},
        "additional_messages": [...]
    }

    # è°ƒç”¨ Coze API
    headers = {"Authorization": f"Bearer {access_token}"}
    response = httpx.post(url, json=payload, headers=headers)
```

#### 3. å®é™…å‘é€çš„ Payload

```json
{
  "workflow_id": "7568811304438710279",
  "app_id": "7568402281331949575",
  "session_name": "session_bd8ab7624ce447d7",  // â† ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  "parameters": {
    "USER_INPUT": "æˆ‘å«å¼ ä¸‰"
  },
  "additional_messages": [
    {
      "content": "æˆ‘å«å¼ ä¸‰",
      "content_type": "text",
      "role": "user",
      "type": "question"
    }
  ]
}
```

---

## éªŒè¯æµ‹è¯•

### æµ‹è¯•è„šæœ¬: `test_simple.py`

```python
#!/usr/bin/env python3
import requests
import uuid

def generate_session():
    return f"session_{uuid.uuid4().hex[:16]}"

# ç”¨æˆ· A
session_a = generate_session()
print(f"ç”¨æˆ· A (session: {session_a})")
requests.post("http://localhost:8000/api/chat",
    json={"message": "æˆ‘å«å¼ ä¸‰", "user_id": session_a})

# ç”¨æˆ· B
session_b = generate_session()
print(f"ç”¨æˆ· B (session: {session_b})")
requests.post("http://localhost:8000/api/chat",
    json={"message": "æˆ‘å«æå››", "user_id": session_b})

# ç”¨æˆ· A ç¬¬äºŒè½® - éªŒè¯ä¸Šä¸‹æ–‡
print("ç”¨æˆ· A ç¬¬äºŒè½®")
resp = requests.post("http://localhost:8000/api/chat",
    json={"message": "æˆ‘å«ä»€ä¹ˆ?", "user_id": session_a})

reply = resp.json().get('message', '')
if "å¼ ä¸‰" in reply:
    print("âœ… æµ‹è¯•é€šè¿‡ - æ­£ç¡®è®°ä½å¼ ä¸‰")
elif "æå››" in reply:
    print("âŒ æµ‹è¯•å¤±è´¥ - é”™è¯¯å›ç­”æå››")
```

### æµ‹è¯•ç»“æœ

```
ğŸ‘¤ ç”¨æˆ· A (session: session_bd8ab7624ce447d7)
å‘é€: æˆ‘å«å¼ ä¸‰
å›å¤: å“ˆå“ˆ,ä½ å«å¼ ä¸‰å¯¹å§?25å²é‚£ä¸ªé’æ˜¥åŠ²å„¿,æŒºå¥½!

ğŸ‘¤ ç”¨æˆ· B (session: session_96c25865c7214e1d)
å‘é€: æˆ‘å«æå››
å›å¤: æå››å•Š,ç¨‹åºå‘˜å¯¹å§?æ•²ä»£ç ç´¯ä¸...

ğŸ‘¤ ç”¨æˆ· A ç¬¬äºŒè½®
å‘é€: æˆ‘å«ä»€ä¹ˆ?
å›å¤: ä½ å«å¼ ä¸‰å§?åˆšåˆšè¯´çš„é‚£ä¸ªåå­—å“ˆğŸ˜„
âœ… æµ‹è¯•é€šè¿‡ - ç”¨æˆ· A èƒ½è®°ä½è‡ªå·±çš„åå­—(å¼ ä¸‰)
```

### åç«¯æ—¥å¿—éªŒè¯

```
ğŸ” ä¼šè¯éš”ç¦»: session_name=session_bd8ab7624ce447d7
   å®Œæ•´ Payload: {
     "workflow_id": "7568811304438710279",
     "app_id": "7568402281331949575",
     "session_name": "session_bd8ab7624ce447d7",  â† âœ… æ­£ç¡®
     "parameters": {"USER_INPUT": "æˆ‘å«å¼ ä¸‰"}
   }

ğŸ” ä¼šè¯éš”ç¦»: session_name=session_96c25865c7214e1d
   å®Œæ•´ Payload: {
     "session_name": "session_96c25865c7214e1d",  â† âœ… æ­£ç¡®
     ...
   }
```

---

## æ€»ç»“

### å…³é”®è¦ç‚¹

1. **åŒé‡æ·»åŠ  session_name**:
   - JWT payload ä¸­æ·»åŠ  âœ…
   - API è¯·æ±‚ payload ä¸­æ·»åŠ  âœ… (é¡¶å±‚å­—æ®µ)

2. **ä¸è¦æ‰‹åŠ¨ç®¡ç†**:
   - âŒ ä¸è¦æ‰‹åŠ¨è®¾ç½® conversation_id
   - âŒ ä¸è¦åœ¨ parameters ä¸­æ·»åŠ  conversationName
   - âœ… è®©æ‰£å­å¹³å°è‡ªåŠ¨ç®¡ç†ä¼šè¯

3. **UID ç”Ÿæˆé€»è¾‘**:
   - å‰ç«¯æ¯æ¬¡æ‰“å¼€ç”Ÿæˆå”¯ä¸€ session_id
   - å­˜å‚¨åœ¨ sessionStorage
   - å…³é—­åé‡å¼€è§†ä¸ºæ–°ç”¨æˆ·

### æœ€ç»ˆçŠ¶æ€

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| JWT æ·»åŠ  session_name | âœ… | `jwt_signer.py:118` |
| API æ·»åŠ  session_name | âœ… | `backend.py:324, 449` |
| ä¼šè¯éš”ç¦»åŠŸèƒ½ | âœ… | æµ‹è¯•é€šè¿‡ |
| ä¸Šä¸‹æ–‡è®°å¿† | âœ… | å„ç”¨æˆ·ç‹¬ç«‹è®°å¿† |

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025-11-19
**å®ç°çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯é€šè¿‡
