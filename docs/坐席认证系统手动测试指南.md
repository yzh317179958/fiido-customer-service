# 坐席认证系统 - 手动测试指南

> 创建时间: 2025-11-24
> 适用版本: v2.3.7+
> 测试环境: 开发环境 (本地)

---

## 📋 目录

1. [测试前准备](#1-测试前准备)
2. [测试 1: 坐席登录](#测试-1-坐席登录)
3. [测试 2: 错误密码登录](#测试-2-错误密码登录)
4. [测试 3: 获取坐席信息](#测试-3-获取坐席信息)
5. [测试 4: Token 刷新](#测试-4-token-刷新)
6. [测试 5: 坐席登出](#测试-5-坐席登出)
7. [测试 6: 测试所有默认账号](#测试-6-测试所有默认账号)
8. [常见问题](#常见问题)

---

## 1. 测试前准备

### 1.1 检查后端是否运行

```bash
# 检查后端进程
ps aux | grep "python3 backend.py"

# 如果未运行，启动后端
cd /home/yzh/AI客服/鉴权
python3 backend.py
```

**预期输出**:
```
============================================================
🚀 Fiido 智能客服后端服务初始化
============================================================
🔐 鉴权模式: OAUTH_JWT
...
🔐 初始化坐席认证系统...
  ⏭️  默认坐席账号已存在，跳过初始化
✅ 坐席认证系统初始化成功
   Token过期时间: 60分钟
   刷新Token过期: 7天
============================================================
```

### 1.2 检查后端健康状态

```bash
curl http://localhost:8000/api/health
```

**预期输出**:
```json
{
  "status": "healthy",
  "timestamp": 1763974000.123
}
```

✅ 如果看到上述输出，说明后端运行正常，可以开始测试！

---

## 测试 1: 坐席登录

### 目标
验证管理员账号可以正常登录，获取 Access Token 和 Refresh Token。

### 步骤

#### 1.1 使用 admin 账号登录

```bash
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}' \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "success": true,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 3600,
    "agent": {
        "id": "agent_1763973603632",
        "username": "admin",
        "name": "系统管理员",
        "role": "admin",
        "status": "online",
        "max_sessions": 10,
        "created_at": 1763973603.8021133,
        "last_login": 1763974123.456,
        "avatar_url": null
    }
}
```

#### 1.2 验证要点

✅ **必须检查**:
- [ ] `success` 为 `true`
- [ ] `token` 是长字符串（约 230+ 字符）
- [ ] `refresh_token` 是长字符串
- [ ] `expires_in` 为 `3600`（1小时 = 3600秒）
- [ ] `agent.username` 为 `"admin"`
- [ ] `agent.role` 为 `"admin"`
- [ ] `agent.status` 为 `"online"`（登录后自动更新）
- [ ] **不包含** `password_hash` 字段（已隐藏）

#### 1.3 保存 Token 供后续测试

```bash
# 将 token 保存到环境变量（Linux/Mac）
export ACCESS_TOKEN="eyJhbGci..."  # 复制上面输出的 token
export REFRESH_TOKEN="eyJhbGci..."  # 复制上面输出的 refresh_token

# 验证保存成功
echo $ACCESS_TOKEN
```

---

## 测试 2: 错误密码登录

### 目标
验证系统正确拒绝错误密码，并返回 401 错误。

### 步骤

#### 2.1 使用错误密码登录

```bash
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "wrongpassword"}' \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "detail": "用户名或密码错误"
}
```

**HTTP 状态码**: 401 Unauthorized

#### 2.2 使用不存在的用户名

```bash
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "nonexistent", "password": "password123"}' \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "detail": "用户名或密码错误"
}
```

**HTTP 状态码**: 401 Unauthorized

#### 2.3 验证要点

✅ **必须检查**:
- [ ] 两种情况都返回相同的错误信息（不暴露用户是否存在）
- [ ] HTTP 状态码为 401
- [ ] 错误信息为 `"用户名或密码错误"`

---

## 测试 3: 获取坐席信息

### 目标
验证可以查询坐席的详细信息，且密码哈希不返回。

### 步骤

#### 3.1 查询 admin 坐席信息

```bash
curl -X GET "http://localhost:8000/api/agent/profile?username=admin" \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "success": true,
    "agent": {
        "id": "agent_1763973603632",
        "username": "admin",
        "name": "系统管理员",
        "role": "admin",
        "status": "online",
        "max_sessions": 10,
        "created_at": 1763973603.8021133,
        "last_login": 1763974123.456,
        "avatar_url": null
    }
}
```

#### 3.2 查询不存在的坐席

```bash
curl -X GET "http://localhost:8000/api/agent/profile?username=nonexistent" \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "detail": "坐席不存在"
}
```

**HTTP 状态码**: 404 Not Found

#### 3.3 验证要点

✅ **必须检查**:
- [ ] 成功查询返回完整的坐席信息
- [ ] **不包含** `password_hash` 字段
- [ ] 不存在的坐席返回 404 错误
- [ ] 可以查询任意坐席（包括 agent001, agent002）

---

## 测试 4: Token 刷新

### 目标
验证使用 Refresh Token 可以获取新的 Access Token。

### 步骤

#### 4.1 使用 Refresh Token 刷新

```bash
# 使用之前保存的 REFRESH_TOKEN
curl -X POST http://localhost:8000/api/agent/refresh \
  -H "Content-Type: application/json" \
  -d "{\"refresh_token\": \"$REFRESH_TOKEN\"}" \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "success": true,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 3600
}
```

#### 4.2 使用无效的 Refresh Token

```bash
curl -X POST http://localhost:8000/api/agent/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "invalid_token_12345"}' \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "detail": "无效的刷新 Token"
}
```

**HTTP 状态码**: 401 Unauthorized

#### 4.3 验证要点

✅ **必须检查**:
- [ ] 使用有效 Refresh Token 可以获取新的 Access Token
- [ ] 新 Token 和旧 Token 不同（已刷新）
- [ ] `expires_in` 为 3600 秒
- [ ] 无效 Refresh Token 返回 401 错误

---

## 测试 5: 坐席登出

### 目标
验证坐席登出后状态更新为离线。

### 步骤

#### 5.1 登出 admin 坐席

```bash
curl -X POST "http://localhost:8000/api/agent/logout?username=admin" \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "success": true,
    "message": "登出成功"
}
```

#### 5.2 验证状态已更新

```bash
curl -X GET "http://localhost:8000/api/agent/profile?username=admin" \
  | python3 -m json.tool
```

**预期输出**:
```json
{
    "success": true,
    "agent": {
        "id": "agent_1763973603632",
        "username": "admin",
        "name": "系统管理员",
        "role": "admin",
        "status": "offline",  // ← 状态已更新为 offline
        ...
    }
}
```

#### 5.3 验证要点

✅ **必须检查**:
- [ ] 登出响应 `success` 为 `true`
- [ ] 登出后坐席状态变为 `"offline"`
- [ ] Token 仍然有效（未失效）

---

## 测试 6: 测试所有默认账号

### 目标
验证所有 3 个默认账号都可以正常登录。

### 步骤

#### 6.1 测试 admin 账号

```bash
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}' \
  | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"✅ {data['agent']['username']} ({data['agent']['role']}) - 登录成功\" if data.get('success') else f\"❌ 登录失败\")"
```

**预期输出**: `✅ admin (admin) - 登录成功`

#### 6.2 测试 agent001 账号

```bash
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "agent001", "password": "agent123"}' \
  | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"✅ {data['agent']['username']} ({data['agent']['role']}) - 登录成功，姓名: {data['agent']['name']}\" if data.get('success') else f\"❌ 登录失败\")"
```

**预期输出**: `✅ agent001 (agent) - 登录成功，姓名: 客服小王`

#### 6.3 测试 agent002 账号

```bash
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "agent002", "password": "agent123"}' \
  | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"✅ {data['agent']['username']} ({data['agent']['role']}) - 登录成功，姓名: {data['agent']['name']}\" if data.get('success') else f\"❌ 登录失败\")"
```

**预期输出**: `✅ agent002 (agent) - 登录成功，姓名: 客服小李`

#### 6.4 验证要点

✅ **必须检查**:
- [ ] 所有 3 个默认账号都可以登录
- [ ] admin 角色为 `"admin"`
- [ ] agent001 和 agent002 角色为 `"agent"`
- [ ] 姓名正确（系统管理员、客服小王、客服小李）

---

## 常见问题

### Q1: 执行 curl 命令后返回 "Could not resolve host"

**原因**: 后端未启动或端口错误

**解决方案**:
```bash
# 1. 检查后端是否运行
ps aux | grep "python3 backend.py"

# 2. 如果未运行，启动后端
cd /home/yzh/AI客服/鉴权
python3 backend.py

# 3. 等待看到 "坐席认证系统初始化成功" 后再测试
```

---

### Q2: 返回 "坐席认证系统未初始化"

**原因**: 后端启动时 Redis 不可用或初始化失败

**解决方案**:
```bash
# 1. 检查 Redis 是否运行
redis-cli ping
# 预期输出: PONG

# 2. 如果 Redis 未运行，启动 Redis
sudo systemctl start redis
# 或
redis-server &

# 3. 重启后端
pkill -f "python3 backend.py"
python3 backend.py
```

---

### Q3: Token 刷新失败，返回 422 错误

**原因**: 请求格式错误（旧版本问题，已修复）

**解决方案**:
确保使用最新版本的 backend.py，Token 刷新接口需要 JSON Body：
```bash
# ✅ 正确格式
curl -X POST http://localhost:8000/api/agent/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "eyJhbGci..."}'

# ❌ 错误格式
curl -X POST "http://localhost:8000/api/agent/refresh?refresh_token=eyJhbGci..."
```

---

### Q4: 如何查看 Token 的内容？

**方案**: 使用 JWT 解码工具

**在线解码**:
1. 访问 https://jwt.io/
2. 将 Token 粘贴到 "Encoded" 框
3. 查看解码后的内容

**命令行解码**:
```bash
# 安装 jq（如果未安装）
sudo apt install jq

# 解码 Access Token
echo "eyJhbGci..." | cut -d. -f2 | base64 -d 2>/dev/null | jq .

# 预期输出:
# {
#   "agent_id": "agent_1763973603632",
#   "username": "admin",
#   "role": "admin",
#   "iat": 1763974123,
#   "exp": 1763977723
# }
```

---

### Q5: 默认账号的密码可以修改吗？

**答案**: 可以，但目前需要通过 Python 代码修改

**临时方案**（未来会添加 API）:
```bash
# 1. 进入 Python 交互模式
python3

# 2. 执行以下代码
>>> from src.agent_auth import PasswordHasher, AgentManager
>>> from src.redis_session_store import RedisSessionStore
>>>
>>> redis_store = RedisSessionStore()
>>> agent_manager = AgentManager(redis_store)
>>>
>>> # 获取坐席
>>> agent = agent_manager.get_agent_by_username("admin")
>>>
>>> # 修改密码
>>> agent.password_hash = PasswordHasher.hash_password("new_password_123")
>>>
>>> # 保存
>>> agent_manager.update_agent(agent)
>>>
>>> print("密码已修改！")
>>> exit()

# 3. 测试新密码
curl -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "new_password_123"}'
```

---

## 自动化测试

如果你想快速测试所有功能，可以运行自动化测试套件：

```bash
cd /home/yzh/AI客服/鉴权
python3 tests/test_agent_auth.py
```

**预期输出**:
```
============================================================
      Fiido AI客服 - 坐席认证系统测试
============================================================

✓ 后端服务运行正常 (http://localhost:8000)

============================================================
测试 1: 管理员登录
============================================================
✅ 管理员登录成功
   用户名: admin
   角色: admin
   Token 长度: 236 字符
   过期时间: 3600 秒

...

============================================================
            测试结果汇总
============================================================
通过: 11
失败: 0
总计: 10

============================================================
          所有测试通过！
============================================================
```

---

## 测试检查清单

完成所有测试后，请检查以下项目：

- [ ] admin 账号可以正常登录
- [ ] agent001 账号可以正常登录
- [ ] agent002 账号可以正常登录
- [ ] 错误密码被正确拒绝（401 错误）
- [ ] 不存在的用户名被正确拒绝（401 错误）
- [ ] 可以查询坐席信息
- [ ] 坐席信息不包含密码哈希
- [ ] Token 刷新功能正常
- [ ] 无效 Token 被正确拒绝
- [ ] 坐席登出后状态更新为离线
- [ ] 自动化测试 10/10 通过

✅ **如果所有项目都打勾，说明坐席认证系统工作正常！**

---

**文档版本**: v1.0
**最后更新**: 2025-11-24
**维护者**: Fiido AI 客服开发团队
