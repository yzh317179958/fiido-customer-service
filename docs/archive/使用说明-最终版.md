# Fiido 智能客服系统 - 使用说明（最终版）

## ✅ 已完成的功能

### 1. 完整的聊天界面
- ✅ 完全模仿 Fiido.com 官网设计风格
- ✅ Montserrat 字体
- ✅ 黑白配色方案
- ✅ 流式消息显示
- ✅ Markdown 渲染支持
- ✅ 响应式设计

### 2. 会话管理
- ✅ **Session 隔离** - 不同标签页/浏览器独立会话
- ✅ **Conversation 管理** - 对话历史保留
- ✅ **新对话功能** - 清空历史，创建新 conversation
- ✅ **新会话功能** - 完全重置，生成新 session

### 3. 后端集成
- ✅ FastAPI 后端服务
- ✅ OAuth+JWT 鉴权
- ✅ Coze Workflow API
- ✅ 流式响应支持
- ✅ Token 自动管理

---

## 🚀 启动步骤

### 1. 启动后端

```bash
cd /home/yzh/AI客服/鉴权
python3 backend.py
```

**期望输出：**
```
============================================================
🚀 Fiido 智能客服后端服务初始化
============================================================
🔐 鉴权模式: OAUTH_JWT
🌐 API Base: https://api.coze.com
📱 App ID: 7568402281331949575
🔄 Workflow ID: 7568811304438710279
💬 多轮对话: 已启用
✅ OAuth+JWT 鉴权初始化成功
✅ JWTOAuthApp 初始化成功 (用于 Chat SDK)
============================================================

INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

### 2. 访问前端

**本地访问：**
```
http://localhost:8000
```

**局域网访问：**
```
http://192.168.x.x:8000
```

---

## 💡 功能使用说明

### 主页面

打开页面后，您会看到：
1. **Fiido 官网风格的导航栏**
2. **Hero 视频背景区域**
3. **产品展示卡片**
4. **右下角悬浮的客服按钮**（带动画效果）

### 客服聊天功能

#### 1. 打开聊天窗口

点击右下角的黑色圆形按钮，或点击任何"咨询客服"按钮。

#### 2. 发送消息

在输入框输入问题，按回车或点击发送按钮。

**示例问题：**
- "你好"
- "Fiido 有哪些产品？"
- "C11 Pro 的价格是多少？"
- "请介绍一下 M1 Pro"

#### 3. 查看历史对话

刷新页面后，之前的对话记录会被保留（基于 conversation_id）。

#### 4. 新对话功能 🆕

1. 点击聊天标题栏右侧的 **三个点按钮**
2. 选择 **"新对话"**
3. 确认后：
   - ✅ 当前对话记录被清空
   - ✅ 创建新的 conversation_id
   - ✅ Session_id 保持不变（还是同一个用户）
   - ✅ 显示欢迎屏幕

**使用场景：**
- 想要开始一个全新的话题
- 不希望 AI 记住之前的对话内容

#### 5. 新会话功能 🔄

1. 点击聊天标题栏右侧的 **三个点按钮**
2. 选择 **"新会话"**
3. 确认后：
   - ✅ 页面刷新
   - ✅ 生成新的 session_id
   - ✅ 生成新的 conversation_id
   - ✅ 相当于完全重置

**使用场景：**
- 模拟不同用户访问系统
- 完全清空所有会话数据

---

## 🧪 测试场景

### 测试 1: 基本对话

```
1. 点击右下角客服按钮
2. 发送："你好"
3. 发送："Fiido 有哪些产品？"
4. 发送："C11 Pro 多少钱？"
```

**期望结果：** AI 能够正常回答，并保持上下文。

---

### 测试 2: 对话历史保留

```
1. 发送："我叫张三"
2. 发送："我在深圳工作"
3. 刷新页面（F5）
4. 点击客服按钮
5. 发送："我叫什么名字？在哪里工作？"
```

**期望结果：** AI 回答 "张三" 和 "深圳" ✅

**原理：** conversation_id 保存在 sessionStorage，刷新页面后复用。

---

### 测试 3: 会话隔离

**浏览器 A（正常模式）：**
```
1. 打开 http://localhost:8000
2. 点击客服按钮
3. 发送："我叫张三"
4. 发送："我喜欢蓝色"
```

**浏览器 B（隐私模式/新窗口）：**
```
1. 打开 http://localhost:8000
2. 点击客服按钮
3. 发送："我叫李四"
4. 发送："我喜欢红色"
```

**回到浏览器 A：**
```
5. 发送："我叫什么？喜欢什么颜色？"
```

**期望结果：** AI 回答 "张三" 和 "蓝色" ✅

**浏览器 B：**
```
6. 发送："我叫什么？喜欢什么颜色？"
```

**期望结果：** AI 回答 "李四" 和 "红色" ✅

**原理：** 不同浏览器/标签页有不同的 session_id。

---

### 测试 4: 新对话功能

```
1. 发送："我叫张三，我喜欢蓝色"
2. 点击三个点按钮 → 选择"新对话"
3. 确认
4. 发送："我叫什么名字？喜欢什么颜色？"
```

**期望结果：** AI 回答 "您还没告诉我" ✅

**原理：**
- 清空了前端的聊天记录
- 创建了新的 conversation_id
- Session_id 保持不变

---

### 测试 5: 新会话功能

```
1. 发送："我叫张三"
2. 点击三个点按钮 → 选择"新会话"
3. 确认（页面刷新）
4. 点击客服按钮
5. 发送："我叫什么？"
```

**期望结果：** AI 回答 "您还没告诉我" ✅

**原理：**
- sessionStorage 被清空
- 生成新的 session_id
- 生成新的 conversation_id
- 相当于全新的用户

---

## 🔍 调试技巧

### 1. 查看浏览器控制台

按 **F12** 打开开发者工具，切换到 **Console** 标签页。

**正常日志示例：**
```
🆕 生成新会话 ID: session_1732000000000_abc123
✅ Bot 配置加载成功: {name: 'Fiido 客服', ...}
🔗 API Base URL: http://localhost:8000
💬 使用 Conversation ID: 7574309574817136693
```

**新对话日志：**
```
🆕 创建新对话...
✅ 新对话已创建: 7574312345678901234
```

### 2. 查看后端日志

```bash
# 实时查看
tail -f /home/yzh/AI客服/鉴权/backend.log

# 查看最近 50 行
tail -50 /home/yzh/AI客服/鉴权/backend.log
```

**关键日志：**
```
🔐 流式会话隔离: session_name=session_xxx
💬 流式接口使用 Conversation: 7574309574817136693
✅ 新对话已创建: 7574312345678901234 (session: session_xxx)
```

### 3. 查看 sessionStorage

在浏览器控制台输入：
```javascript
sessionStorage
```

**应该看到：**
```
fiido_session_id: "session_1732000000000_abc123"
fiido_conversation_id: "7574309574817136693"
```

---

## 📋 核心概念

### Session (会话)

- **定义：** 用户的身份标识
- **存储位置：** 浏览器 sessionStorage
- **生命周期：** 标签页关闭前一直有效
- **格式：** `session_时间戳_随机字符串`
- **作用：** 实现多用户隔离

**示例：**
```
session_1732000123456_a1b2c3d4e5
```

### Conversation (对话)

- **定义：** 一次完整的对话上下文
- **存储位置：** 浏览器 sessionStorage + Coze 服务器
- **生命周期：** 直到调用"新对话"或"新会话"
- **格式：** Coze 生成的唯一 ID
- **作用：** 保留历史消息，让 AI 记住之前说过的话

**示例：**
```
7574309574817136693
```

### 三者关系

```
用户 A (session_A)
  ├── Conversation 1 (对话 1: 咨询产品)
  ├── Conversation 2 (对话 2: 售后问题)
  └── Conversation 3 (对话 3: 价格询问)

用户 B (session_B)
  ├── Conversation 4 (对话 1: 购买咨询)
  └── Conversation 5 (对话 2: 配送问题)
```

---

## ⚙️ 技术架构

```
前端 (Fiido 风格 UI)
    ↓ HTTP API
后端 (FastAPI)
    ├─ OAuth+JWT 鉴权
    ├─ Token 管理 (session_name)
    └─ Conversation 管理
        ↓ Coze API
Coze 平台 (Workflow 执行)
```

### 会话隔离实现

```
前端生成 session_id
    ↓
后端将 session_id 作为 session_name 写入 JWT
    ↓
Coze 根据 session_name 隔离不同用户
```

### 对话历史实现

```
前端请求创建新 Conversation
    ↓
后端调用 Coze API: conversations.create()
    ↓
返回 conversation_id
    ↓
前端存储在 sessionStorage
    ↓
每次发消息时携带 conversation_id
    ↓
Coze 保留该 conversation 的历史上下文
```

---

## 🎨 设计风格

完全模仿 Fiido.com 官网：

### 配色方案
- **主色：** 黑色 (#000, #1a1a1a)
- **背景：** 白色 (#fff)
- **边框：** 浅灰 (#e0e0e0, #f0f0f0)
- **强调色：** 红色 (#d32f2f, #ff4757)
- **渐变：** 用户头像使用紫粉渐变

### 字体
- **主字体：** Montserrat (Google Fonts)
- **字重：** 400 (常规), 600 (半粗), 700 (粗体)

### 组件风格
- **按钮：** 黑色背景，白色文字，圆角 4px
- **输入框：** 圆角 25px，浅灰边框
- **消息气泡：** 圆角 12px，带阴影
- **动画：** 流畅的 cubic-bezier 缓动

---

## 📁 文件结构

```
/home/yzh/AI客服/鉴权/
├── backend.py                     # FastAPI 后端服务
├── index2.html                    # 前端页面（最终版）
├── .env                           # 环境变量配置
├── private_key.pem                # OAuth 私钥
├── fiido2.png                     # 客服头像
├── backend.log                    # 运行日志
├── 使用说明-最终版.md             # 本文档
└── 使用指南.md                    # 旧版指南
```

---

## ✅ 功能检查清单

部署前请确认：

- [ ] 后端启动成功（端口 8000）
- [ ] 日志显示"JWTOAuthApp 初始化成功"
- [ ] 浏览器能访问 http://localhost:8000
- [ ] 可以打开聊天窗口
- [ ] 可以正常发送和接收消息
- [ ] 刷新页面后对话历史保留
- [ ] 点击"新对话"能清空历史
- [ ] 点击"新会话"能完全重置
- [ ] 不同浏览器的会话互相隔离

---

## 🎉 完成！

您的 Fiido 智能客服系统已经完全部署成功！

**主要特点：**
- ✅ 完全模仿 Fiido.com 官网设计
- ✅ 支持会话隔离（多用户独立对话）
- ✅ 支持对话历史（刷新后保留）
- ✅ 支持新对话功能（清空历史）
- ✅ 支持新会话功能（完全重置）
- ✅ 流式响应（打字机效果）
- ✅ Markdown 渲染
- ✅ 响应式设计

如有任何问题，请查看：
1. 浏览器控制台（F12）
2. 后端日志（backend.log）
3. 本使用说明的调试技巧部分
