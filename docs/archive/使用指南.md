# Fiido 智能客服系统 - 使用指南

## 🚀 快速启动

### 1. 启动后端服务

```bash
cd /home/yzh/AI客服/鉴权

# 启动后端（自动重载模式）
python3 backend.py
```

**期望输出：**
```
============================================================
🚀 Fiido 智能客服后端服务初始化
============================================================
🔐 鉴权模式: OAUTH_JWT
🌐 API Base: https://api.coze.com
📱 App ID: 7568402281331949575
🔄 Workflow ID: 7568811304438710279
💬 多轮对话: 已启用
✅ OAuth+JWT 鉴权初始化成功
✅ JWTOAuthApp 初始化成功 (用于 Chat SDK)
============================================================

INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 2. 访问前端页面

打开浏览器访问：
```
http://localhost:8000
```

你会看到一个紫色渐变背景的欢迎页面，包含三个按钮。

---

## 💬 如何使用

### 第一步：开始对话

1. 点击 **"💬 开始对话"** 按钮
2. 聊天窗口会从右下角弹出
3. 在输入框中输入消息，例如："你好"

### 功能按钮说明

#### 🆕 新对话
- **作用**：清空当前对话历史，创建新的 conversation
- **场景**：同一个用户想要重新开始对话（历史清空）
- **会话 ID**：保持不变（还是同一个用户）

**示例：**
```
1. 发送："我叫张三"
2. 点击"新对话"
3. 发送："我叫什么？"
4. 机器人回答："您还没告诉我" ✅ (历史已清空)
```

#### 🔄 新会话
- **作用**：完全重置，生成新的 session_id（相当于换一个用户）
- **场景**：模拟不同用户访问系统
- **效果**：页面会刷新，所有数据清空

**示例：**
```
1. 发送："我叫张三"
2. 点击"新会话"（页面刷新）
3. 发送："我叫什么？"
4. 机器人回答："您还没告诉我" ✅ (完全重置)
```

---

## 🧪 测试场景

### 测试 1: 基本对话测试

```
1. 点击"开始对话"
2. 发送："你好"
3. 发送："Fiido 有哪些产品？"
4. 发送："C11 Pro 的价格是多少？"
```

**期望**：机器人能够正常回答，并保持上下文。

---

### 测试 2: 会话隔离测试

**目标**：验证不同用户的对话不会互相干扰

**步骤：**

1. **浏览器 A（正常模式）**
   ```
   - 打开 http://localhost:8000
   - 点击"开始对话"
   - 发送："我叫张三，今年 25 岁"
   - 发送："我的名字是什么？"
   - 机器人应该回答："张三" ✅
   ```

2. **浏览器 B（隐私模式/新标签页）**
   ```
   - 打开 http://localhost:8000
   - 点击"开始对话"
   - 发送："我叫李四，今年 30 岁"
   - 发送："我的名字是什么？"
   - 机器人应该回答："李四" ✅
   ```

3. **回到浏览器 A**
   ```
   - 发送："我多大了？"
   - 机器人应该回答："25 岁" ✅
   ```

**结论**：两个浏览器的对话完全隔离，互不干扰！

---

### 测试 3: 对话历史保留测试

**目标**：验证对话历史是否正确保留

**步骤：**

```
1. 发送："我叫张三"
2. 发送："我在深圳工作"
3. 发送："我想买一辆电动车"
4. 刷新页面（F5）
5. 点击"开始对话"
6. 发送："我叫什么名字？在哪里工作？"
```

**期望**：机器人能够记住"张三"和"深圳" ✅

---

### 测试 4: 新对话功能测试

**目标**：验证"新对话"按钮能够清空历史

**步骤：**

```
1. 发送："我叫张三，我喜欢蓝色"
2. 点击"🆕 新对话"按钮
3. 点击"开始对话"
4. 发送："我叫什么名字？喜欢什么颜色？"
```

**期望**：机器人回答"您还没告诉我" ✅

---

### 测试 5: 新会话功能测试

**目标**：验证"新会话"按钮能够完全重置

**步骤：**

```
1. 发送："我叫张三"
2. 点击"🔄 新会话"按钮（会弹出确认框）
3. 确认 → 页面刷新
4. 点击"开始对话"
5. 发送："我叫什么？"
```

**期望**：机器人回答"您还没告诉我" ✅

---

## 🔍 调试技巧

### 查看浏览器控制台

1. 按 **F12** 打开开发者工具
2. 切换到 **Console** 标签页
3. 查看日志输出：

```
🔐 当前会话 ID: session_1731996123456_abc123
✅ Coze Chat SDK 初始化成功
🔑 请求 SDK token...
✅ SDK token 获取成功
💬 打开聊天窗口
```

### 查看后端日志

```bash
# 方法 1: 实时查看日志
tail -f /home/yzh/AI客服/鉴权/backend.log

# 方法 2: 查看最近 50 行
tail -50 /home/yzh/AI客服/鉴权/backend.log
```

**关键日志：**
```
🔑 为 Chat SDK 生成 token (session: session_xxx)
✅ 新对话已创建: 7574309574817136693 (session: session_xxx)
```

---

## ❌ 常见问题

### 问题 1: 点击"开始对话"没有反应

**原因**：Chat SDK 未正确加载

**解决方法：**
1. 打开浏览器控制台（F12）
2. 查看是否有 JavaScript 错误
3. 检查网络请求，确保 SDK CDN 可以访问：
   ```
   https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.15/libs/cn/index.js
   ```

### 问题 2: Token 获取失败

**错误信息**：`❌ SDK token 生成失败`

**解决方法：**
1. 检查后端是否正常运行
2. 检查 `.env` 文件配置：
   ```bash
   cat .env | grep COZE_OAUTH
   ```
3. 确认私钥文件存在：
   ```bash
   ls -la private_key.pem
   ```

### 问题 3: 聊天窗口打开但无法发送消息

**可能原因**：
- Workflow ID 配置错误
- Token 权限不足

**解决方法：**
1. 检查环境变量：
   ```bash
   cat .env | grep WORKFLOW_ID
   ```
2. 查看后端日志中的错误信息

### 问题 4: 浏览器跨域错误

**错误信息**：`CORS policy: No 'Access-Control-Allow-Origin'`

**解决方法**：
- 后端已配置 CORS，允许所有来源
- 如果仍有问题，检查 `backend.py` 中的 CORS 配置

---

## 📊 系统架构

```
┌─────────────────────┐
│   浏览器前端        │
│  (Chat SDK 渲染)    │
│                     │
│  - 生成 session_id  │
│  - 管理对话状态     │
│  - 显示聊天界面     │
└──────────┬──────────┘
           │
           │ HTTP API
           │
┌──────────▼──────────┐
│   FastAPI 后端      │
│                     │
│  - OAuth+JWT 鉴权   │
│  - Token 管理       │
│  - Conversation API │
└──────────┬──────────┘
           │
           │ Coze API
           │
┌──────────▼──────────┐
│   Coze 平台         │
│                     │
│  - Workflow 执行    │
│  - 会话隔离         │
│  - 对话历史         │
└─────────────────────┘
```

---

## 🎯 核心概念

### Session (会话)
- **定义**：用户的身份标识
- **存储**：浏览器 sessionStorage
- **生命周期**：标签页关闭前一直有效
- **格式**：`session_1731996123456_abc123`

### Conversation (对话)
- **定义**：一次完整的对话上下文
- **作用**：保留历史消息
- **管理**：由 Coze SDK 自动管理
- **ID 示例**：`7574309574817136693`

### Session Name (会话名称)
- **定义**：JWT Token 中的标识字段
- **作用**：实现多用户隔离
- **值**：等于 session_id

---

## 📝 API 接口

### 1. GET /api/health
健康检查

```bash
curl http://localhost:8000/api/health
```

### 2. POST /api/token/sdk
获取 Chat SDK 的 token

```bash
curl -X POST http://localhost:8000/api/token/sdk \
  -H "Content-Type: application/json" \
  -d '{"session_id": "test_session"}'
```

### 3. POST /api/conversation/new
创建新对话

```bash
curl -X POST http://localhost:8000/api/conversation/new \
  -H "Content-Type: application/json" \
  -d '{"session_id": "test_session"}'
```

---

## 🛠️ 开发提示

### 修改欢迎消息

编辑 `.env` 文件：
```bash
COZE_BOT_WELCOME=欢迎使用 Fiido 智能客服！
```

### 修改 SDK 配置

编辑 `index_chat_sdk.html` 中的 `componentProps`：
```javascript
componentProps: {
    title: 'Fiido 智能客服',
    icon: 'http://localhost:8000/fiido2.png',
}
```

---

## 📦 文件说明

```
/home/yzh/AI客服/鉴权/
├── backend.py              # FastAPI 后端服务
├── index_chat_sdk.html     # Chat SDK 前端页面
├── .env                    # 环境变量配置
├── private_key.pem         # OAuth 私钥
├── fiido2.png              # 客服头像
├── backend.log             # 运行日志
└── 使用指南.md             # 本文档
```

---

## ✅ 启动检查清单

- [ ] 后端启动成功（8000 端口）
- [ ] 日志显示"JWTOAuthApp 初始化成功"
- [ ] 浏览器能访问 http://localhost:8000
- [ ] 控制台显示"Coze Chat SDK 初始化成功"
- [ ] 点击"开始对话"能打开聊天窗口
- [ ] 能够正常发送和接收消息

---

## 🎉 完成！

现在您可以开始使用 Fiido 智能客服系统了！

如有问题，请查看：
- 浏览器控制台（F12）
- 后端日志（backend.log）
- 本使用指南的"常见问题"部分
