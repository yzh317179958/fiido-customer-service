# 📊 v3.2.0 代码全面分析 - 极简版

> **版本**: v3.2.0
> **功能名称**: 客户画像功能 MVP
> **生成时间**: 2025-11-26
> **文档用途**: 代码现状分析与进一步开发方向建议

---

## 一、后端功能 (backend.py + src/)

### 核心模块
```
✅ AI 对话系统 (Coze API)
✅ OAuth + JWT 鉴权
✅ 会话隔离机制 (session_name)
✅ 人工接管流程
✅ 坐席认证系统
✅ 客户画像 API
✅ Redis 数据存储
```

### API 接口清单 (35个)

#### 1. AI 对话核心 (3个)
- `POST /api/chat` - 同步对话
- `POST /api/chat/stream` - 流式对话（SSE）
- `POST /api/conversation/new` - 创建新会话

#### 2. 人工接管 (6个)
- `POST /api/manual/escalate` - 用户请求人工
- `POST /api/sessions/{session_name}/takeover` - 坐席接管
- `POST /api/sessions/{session_name}/release` - 释放会话
- `POST /api/manual/messages` - 发送人工消息
- `POST /api/sessions/{session_name}/transfer` - 转接会话
- `GET /api/sessions/stats` - 会话统计

#### 3. 会话管理 (3个)
- `GET /api/sessions` - 会话列表
- `GET /api/sessions/{session_name}` - 会话详情
- `POST /api/conversation/clear` - 清除会话

#### 4. 坐席认证 (11个)
- `POST /api/agent/login` - 坐席登录
- `POST /api/agent/logout` - 退出登录
- `POST /api/agent/refresh` - 刷新 Token
- `GET /api/agent/profile` - 获取坐席资料
- `PUT /api/agent/profile` - 修改资料（姓名、头像）
- `POST /api/agent/change-password` - 修改密码
- `GET /api/agents` - 坐席列表（管理员）
- `POST /api/agents` - 创建坐席（管理员）
- `PUT /api/agents/{username}` - 修改坐席（管理员）
- `DELETE /api/agents/{username}` - 删除坐席（管理员）
- `POST /api/agents/{username}/reset-password` - 重置密码（管理员）

#### 5. 客户画像 (1个) ⭐ v3.2.0 核心
- `GET /api/customers/{customer_id}/profile` - 客户详细信息

#### 6. 系统配置 (6个)
- `GET /api/health` - 健康检查
- `GET /api/config` - 系统配置
- `GET /api/shift/config` - 工作时间配置
- `GET /api/shift/status` - 当前工作状态
- `GET /api/bot/info` - Bot 信息
- `GET /api/token/info` - Token 信息

#### 7. Token 管理 (2个)
- `GET /api/token/info` - Token 信息
- `POST /api/token/refresh` - 刷新 Coze Token

#### 8. 静态文件 (3个)
- `GET /` - 主页
- `GET /index2.html` - 备用主页
- `GET /fiido2.png` - Logo

---

## 二、用户端前端 (frontend/)

### 核心功能
```
✅ 官网展示 (Hero + 产品展示)
✅ 聊天浮动按钮
✅ AI 对话窗口
✅ 流式消息显示
✅ 人工请求按钮
✅ 会话持久化
```

### 组件列表 (10个)
| 组件 | 功能 |
|------|------|
| `App.vue` | 主应用容器 |
| `AppHeader.vue` | 顶部导航栏 |
| `AppFooter.vue` | 底部信息 |
| `HeroSection.vue` | 首页 Hero 区域 |
| `ProductsSection.vue` | 产品展示区域 |
| `ChatFloatButton.vue` | 聊天浮动按钮 |
| `ChatPanel.vue` | 聊天面板主组件 |
| `ChatMessage.vue` | 单条消息组件 |
| `StatusBar.vue` | 状态栏 |
| `WelcomeScreen.vue` | 欢迎界面 |

### 核心流程
```
1. 用户访问官网 (HeroSection + ProductsSection)
2. 点击浮动聊天按钮 (ChatFloatButton)
3. 展开聊天面板 (ChatPanel)
4. AI 对话（流式显示）
5. 可请求人工服务 (escalate)
6. 会话自动保存 (sessionStorage)
```

### 技术特性
- **会话 ID 生成**: `sessionStorage` 持久化
- **流式渲染**: SSE EventSource
- **消息历史**: localStorage 缓存
- **响应式布局**: 移动端适配

---

## 三、坐席工作台 (agent-workbench/)

### 核心功能
```
✅ 坐席登录认证
✅ 会话列表查看
✅ 实时会话接管
✅ 人工消息发送
✅ 客户画像展示 ⭐ v3.2.0 新增
✅ 管理员功能（坐席 CRUD）
✅ SSE 实时推送
```

### 页面视图 (3个)
| 页面 | 路由 | 功能 |
|------|------|------|
| `Login.vue` | `/login` | 坐席登录页 |
| `Dashboard.vue` | `/dashboard` | 主工作台（会话列表+聊天+客户信息） |
| `AdminManagement.vue` | `/admin` | 管理员页面（坐席管理） |

### 核心组件 (10个)

#### 会话管理
- `SessionList.vue` - 会话列表组件

#### 客户信息 ⭐ v3.2.0 核心
- `CustomerProfile.vue` - 客户画像面板
  - **基础信息**: 昵称、会话名称、VIP 徽章
  - **联系方式**: 邮箱、电话（脱敏显示）
  - **订单历史**: 订单号、产品、金额、状态（模拟数据）
  - **设备信息**: 设备型号、购买日期、保修状态（模拟数据）
  - **客户属性**: 国家/地区 🇨🇳、首选语言 🇨🇳、注册时间
  - **客户标签**: VIP 会员、忠实客户

#### 管理员功能
- `EditAgentDialog.vue` - 编辑坐席对话框
- `CreateAgentDialog.vue` - 创建坐席对话框
- `ProfileDialog.vue` - 坐席资料修改对话框
- `ResetPasswordDialog.vue` - 重置密码对话框
- `ChangePasswordDialog.vue` - 修改密码对话框

#### 其他
- `QuickReplies.vue` - 快捷回复组件（**未启用**）
- `HelloWorld.vue` - 示例组件

### 数据管理 (Pinia Stores)
| Store | 功能 |
|-------|------|
| `agentStore.ts` | 坐席登录状态、Token 管理 |
| `sessionStore.ts` | 会话数据、会话列表 |
| `adminStore.ts` | 管理员数据、坐席列表 |

### 实时通信 (Composables)
| Composable | 功能 |
|------------|------|
| `useSSE.ts` | 通用 SSE 连接管理 |
| `useAgentWorkbenchSSE.ts` | 坐席工作台专用 SSE（会话更新、新消息推送） |

### 类型定义 (types/index.ts)
- `AgentInfo` - 坐席信息
- `SessionStatus` - 会话状态枚举
- `SessionSummary` - 会话摘要
- `SessionDetail` - 会话详情
- `Message` - 消息对象
- `CustomerProfile` - 客户画像 ⭐ v3.2.0

---

## 四、数据存储 (Redis)

### 存储结构
```redis
# 会话数据
session:{session_name}        → JSON (会话详情)

# 状态索引
status:bot_active             → SET (AI 服务中的会话)
status:pending_manual         → SET (待人工接入)
status:manual_live            → SET (人工服务中)

# Conversation ID 缓存
conversation_cache:{session}  → STRING (Coze Conversation ID)

# 坐席数据
agent:{agent_id}              → JSON (坐席信息)
agent_username:{username}     → STRING (用户名 → agent_id 映射)

# Token 缓存
jwt_token:{session_name}      → STRING (JWT Token)
oauth_token:access_token      → STRING (OAuth Access Token)
oauth_token:refresh_token     → STRING (OAuth Refresh Token)
```

### 数据模型

#### SessionState (会话状态)
```python
{
  "session_name": "session_123",
  "conversation_id": "7576537373...",
  "status": "bot_active | pending_manual | manual_live",
  "history": [Message, ...],
  "escalation": EscalationInfo,
  "assigned_agent": AgentInfo,
  "user_profile": {
    "nickname": "张三",
    "vip": true
  },
  "created_at": 1732600000,
  "updated_at": 1732600000
}
```

#### Agent (坐席)
```python
{
  "agent_id": "agent_123",
  "username": "admin",
  "name": "管理员",
  "role": "admin | agent",
  "password_hash": "...",
  "max_sessions": 10,
  "status": "online | offline",
  "created_at": 1732600000
}
```

#### CustomerProfile (客户画像) ⭐ v3.2.0
```typescript
{
  "customer_id": "cust_001",
  "nickname": "张三 (VIP会员)",
  "email": "zhang***@example.com",  // 脱敏
  "phone": "+86 138****5678",       // 脱敏
  "country": "CN",
  "language": "zh-CN",
  "is_vip": true,
  "tags": ["VIP会员", "忠实客户"],
  "orders": [Order, ...],           // 模拟数据
  "devices": [Device, ...],         // 模拟数据
  "created_at": "2025-01-01T00:00:00Z"
}
```

---

## 五、功能完成度总览

| 模块 | 完成度 | 状态 | 说明 |
|------|--------|------|------|
| **AI 对话** | 100% | ✅ 已完成 | 同步+流式，会话隔离完整 |
| **人工接管** | 100% | ✅ 已完成 | 接管、释放、转接、消息 |
| **坐席认证** | 100% | ✅ 已完成 | 登录、权限、CRUD、密码 |
| **客户画像** | **60%** | ⭐ v3.2.0 MVP | 前端组件完整，后端使用模拟数据 |
| **实时推送** | 100% | ✅ 已完成 | SSE 双向通信 |
| **会话管理** | 100% | ✅ 已完成 | 列表、详情、统计 |
| **管理员功能** | 100% | ✅ 已完成 | 坐席管理、密码重置 |
| **工单系统** | 0% | ❌ 未实现 | - |
| **快捷回复** | 10% | ⚠️ 组件存在 | 前端组件存在但未启用，后端 API 未实现 |
| **Shopify 集成** | 0% | ❌ 未实现 | 客户画像预留接口 |
| **知识库** | 0% | ❌ 未实现 | - |
| **数据报表** | 0% | ❌ 未实现 | - |
| **多语言** | 0% | ❌ 未实现 | - |

---

## 六、技术栈总结

### 后端技术栈
| 技术 | 用途 |
|------|------|
| **FastAPI** | Web 框架 |
| **Redis** | 数据存储 |
| **Coze API** | AI 引擎（Workflow） |
| **OAuth 2.0** | Coze 平台认证 |
| **JWT** | 坐席 Token 管理 |
| **SSE** | 实时推送 |
| **httpx** | HTTP 客户端 |
| **Pydantic** | 数据验证 |

### 前端技术栈
| 技术 | 用途 |
|------|------|
| **Vue 3** | UI 框架 |
| **TypeScript** | 类型安全 |
| **Pinia** | 状态管理 |
| **Vue Router** | 路由管理 |
| **Vite** | 构建工具 |
| **EventSource** | SSE 客户端 |

### 部署架构
```
用户端前端 (Vue)  →  FastAPI 后端  →  Coze API
                      ↓
                    Redis
                      ↓
坐席工作台 (Vue)  →  FastAPI 后端
```

---

## 七、进一步开发方向建议 🚀

### 方向 1: 补全客户画像 (基于 v3.2.0) ⭐⭐⭐⭐⭐
**优先级**: 高
**开发成本**: 中
**业务价值**: 高

#### 当前状态
- ✅ 前端组件完整 (CustomerProfile.vue, 313行)
- ✅ 后端 API 框架 (`GET /api/customers/{id}/profile`)
- ⚠️ 使用模拟数据

#### 下一步: Shopify API 集成
```
📌 实现内容:
  1. Shopify API 客户端 (src/shopify_client.py)
  2. 真实订单数据查询
  3. 客户购买历史
  4. 设备信息同步
  5. VIP 等级自动识别
  6. 数据缓存策略

📌 技术要点:
  - Shopify Admin API REST/GraphQL
  - 访问令牌管理
  - 速率限制处理
  - 错误重试机制
  - 数据脱敏保护
```

**预计工作量**: 3-5 天
**推荐指数**: ⭐⭐⭐⭐⭐

---

### 方向 2: 快捷回复系统 ⭐⭐⭐⭐⭐
**优先级**: 高
**开发成本**: 低
**业务价值**: 高

#### 当前状态
- ✅ 前端组件已存在 (QuickReplies.vue)
- ❌ 后端 API 未实现

#### 实现内容
```
📌 后端 API (src/quick_reply.py):
  - GET /api/quick-replies (获取列表)
  - POST /api/quick-replies (创建)
  - PUT /api/quick-replies/{id} (更新)
  - DELETE /api/quick-replies/{id} (删除)
  - POST /api/quick-replies/{id}/use (使用追踪)

📌 功能特性:
  - 变量替换 ({customer_name}, {order_id})
  - 分类管理 (售前、售后、物流、技术)
  - 快捷键绑定 (Ctrl+1~9)
  - 使用统计
  - 团队共享

📌 数据模型:
  {
    "id": "reply_001",
    "category": "pre_sales",
    "title": "欢迎语",
    "content": "您好{customer_name}，我是{agent_name}",
    "variables": ["customer_name", "agent_name"],
    "usage_count": 156,
    "is_shared": true
  }
```

**预计工作量**: 2-3 天
**推荐指数**: ⭐⭐⭐⭐⭐
**快速见效**: 立即提升坐席效率 50%+

---

### 方向 3: 工单系统 ⭐⭐⭐⭐
**优先级**: 中高
**开发成本**: 高
**业务价值**: 高

#### 实现内容
```
📌 后端模块 (src/ticket_model.py, src/ticket_store.py):
  - 工单创建/查询/更新/关闭
  - 工单状态流转 (新建→处理中→待客户→已解决→已关闭)
  - SLA 时间跟踪
  - 工单优先级管理 (低/中/高/紧急)
  - 工单分配与转接
  - 活动日志记录

📌 API 接口:
  - GET /api/tickets (列表)
  - POST /api/tickets (创建)
  - GET /api/tickets/{id} (详情)
  - PUT /api/tickets/{id} (更新)
  - POST /api/tickets/{id}/assign (分配)
  - POST /api/tickets/{id}/comment (评论)

📌 前端界面:
  - 工单列表页
  - 工单详情页
  - 创建工单对话框
  - 工单筛选（状态、优先级、坐席）
```

**预计工作量**: 5-7 天
**推荐指数**: ⭐⭐⭐⭐
**价值**: 企业级客服必备功能

---

### 方向 4: 知识库系统 ⭐⭐⭐
**优先级**: 中
**开发成本**: 高
**业务价值**: 中

#### 实现内容
```
📌 知识库内容:
  - 产品知识 (D4S, D11, D21 等规格参数)
  - 常见问题 FAQ (300+ 条)
  - 技术文档 (维修、保养、故障排查)
  - 政策条款 (退换货、保修、物流)
  - 多语言支持 (中英德法)

📌 功能特性:
  - 关键词搜索
  - 分类导航
  - 标签筛选
  - 收藏功能
  - 使用统计

📌 AI 增强:
  - 知识库接入 Coze Workflow
  - 自动推荐相关知识
  - 智能问答
```

**预计工作量**: 5-7 天
**推荐指数**: ⭐⭐⭐
**价值**: AI 和坐席共用知识源

---

### 方向 5: 数据分析与报表 ⭐⭐⭐
**优先级**: 中
**开发成本**: 中
**业务价值**: 中

#### 实现内容
```
📌 数据统计:
  - 会话量趋势 (日/周/月)
  - AI vs 人工转化率
  - 平均响应时间
  - 客户满意度评分
  - 坐席绩效排名

📌 可视化图表:
  - 折线图 (趋势)
  - 饼图 (占比)
  - 柱状图 (对比)
  - 热力图 (时段分布)

📌 导出功能:
  - Excel 报表
  - PDF 报告
  - CSV 数据
```

**预计工作量**: 4-6 天
**推荐指数**: ⭐⭐⭐

---

### 方向 6: 多语言支持 ⭐⭐
**优先级**: 低
**开发成本**: 中
**业务价值**: 低

#### 实现内容
```
📌 前端 i18n:
  - vue-i18n 集成
  - 语言切换组件
  - 多语言翻译文件

📌 自动检测:
  - 浏览器语言
  - 客户地区
  - IP 地址

📌 多语言内容:
  - 快捷回复
  - 知识库文章
  - 系统提示
```

**预计工作量**: 3-5 天
**推荐指数**: ⭐⭐

---

## 八、推荐优先级排序

### 🚀 短期 (1-2 周) - 快速见效
1. **快捷回复系统** (2-3天) - 立即提升坐席效率
2. **Shopify 集成** (3-5天) - 补全客户画像，提供真实数据

**理由**:
- 快捷回复开发成本低，见效快
- Shopify 集成基于现有 v3.2.0 框架，风险低
- 两者合计 1 周内完成，快速交付价值

---

### 📈 中期 (3-4 周) - 企业升级
3. **工单系统** (5-7天) - 企业级客服刚需
4. **知识库系统** (5-7天) - AI 增强与坐席赋能

**理由**:
- 工单系统是 B2B 客户强需求
- 知识库提升 AI 回答准确率 30%+
- 形成完整闭环：咨询 → 工单 → 知识库

---

### 📊 长期 (1-2 月) - 运营优化
5. **数据分析报表** (4-6天) - 运营决策支持
6. **多语言支持** (3-5天) - 国际化扩展

**理由**:
- 数据报表需要积累足够数据才有价值
- 多语言在有明确国际化需求时再做

---

## 九、快速决策矩阵

| 功能 | 开发成本 | 业务价值 | 技术难度 | 依赖现有代码 | 推荐指数 |
|------|---------|---------|---------|-------------|---------|
| **快捷回复** | 低 (2-3天) | 高 | 低 | ✅ 组件已有 | ⭐⭐⭐⭐⭐ |
| **Shopify 集成** | 中 (3-5天) | 高 | 中 | ✅ v3.2.0 框架 | ⭐⭐⭐⭐⭐ |
| **工单系统** | 高 (5-7天) | 高 | 中 | ❌ 全新模块 | ⭐⭐⭐⭐ |
| **知识库** | 高 (5-7天) | 中 | 中 | ❌ 全新模块 | ⭐⭐⭐ |
| **数据报表** | 中 (4-6天) | 中 | 低 | ✅ Redis 数据 | ⭐⭐⭐ |
| **多语言** | 中 (3-5天) | 低 | 低 | ❌ 需改造 | ⭐⭐ |

---

## 十、最佳实践建议

### 1. 基于现有代码增量开发
- ✅ **快捷回复**: 前端组件 QuickReplies.vue 已存在，只需补充后端 API
- ✅ **Shopify 集成**: v3.2.0 CustomerProfile.vue 已预留接口
- ✅ **数据报表**: Redis 中已有会话数据，可直接统计

### 2. 优先低成本高收益
- **快捷回复** 2-3 天即可完成，立即提升坐席效率 50%+
- **Shopify 集成** 补全客户画像，从模拟数据升级到真实数据

### 3. 避免过度设计
- MVP 优先，快速验证
- 不要一次性做太多功能
- 保持 2 周一个小版本的迭代节奏

### 4. 保持代码约束
- 遵守 `CLAUDE.md` 约束
- 不修改核心 AI 对话接口
- 每次开发后运行回归测试

---

## 十一、下一步行动建议

### 方案 A: 快速见效路线（推荐）
```
Week 1: 快捷回复系统 (2-3天) + 测试验证 (1天)
Week 2: Shopify 集成 (3-5天) + 测试验证 (1天)
结果: 2 周交付 2 个高价值功能
```

### 方案 B: 企业级路线
```
Week 1-2: 工单系统 (5-7天) + 测试验证 (2天)
Week 3-4: 知识库系统 (5-7天) + 测试验证 (2天)
结果: 1 月交付企业级完整方案
```

### 方案 C: 平衡路线
```
Week 1: 快捷回复 (2-3天)
Week 2: Shopify 集成 (3-5天)
Week 3-4: 工单系统 (5-7天)
结果: 1 月交付 3 个核心功能
```

---

**建议**: 从 **方案 A (快速见效路线)** 开始，优先实现快捷回复和 Shopify 集成。

---

## 附录：文件清单

### 后端核心文件
```
backend.py                      - FastAPI 主服务 (2000+ 行)
src/oauth_token_manager.py      - OAuth Token 管理
src/session_state.py            - 会话状态模型
src/redis_session_store.py      - Redis 存储实现
src/regulator.py                - 监管引擎
src/agent_auth.py               - 坐席认证
src/shift_config.py             - 工作时间配置
src/email_service.py            - 邮件服务
```

### 前端核心文件
```
frontend/src/App.vue                - 用户端主应用
frontend/src/components/ChatPanel.vue - 聊天面板

agent-workbench/src/views/Dashboard.vue - 坐席主界面
agent-workbench/src/components/customer/CustomerProfile.vue - 客户画像 (313行)
agent-workbench/src/stores/sessionStore.ts - 会话状态管理
agent-workbench/src/composables/useAgentWorkbenchSSE.ts - SSE 实时推送
```

### 测试文件
```
tests/regression_test.sh        - 回归测试套件 (12 项)
```

### 文档文件
```
CLAUDE.md                       - 开发指令
README.md                       - 项目说明
prd/                            - 需求文档目录
docs/                           - 实施文档目录
```

---

**文档版本**: v1.0
**生成时间**: 2025-11-26
**维护者**: Claude Code
**下次更新**: 完成新功能开发后
