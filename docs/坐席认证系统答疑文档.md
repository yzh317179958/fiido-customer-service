# 坐席认证系统 - 答疑文档

> 创建时间: 2025-11-24
> 版本: v1.0
> 适用人员: 开发人员、运维人员、产品经理

---

## 目录

1. [Token 机制详解](#1-token-机制详解)
2. [系统功能与使用流程](#2-系统功能与使用流程)
3. [账号管理机制](#3-账号管理机制)
4. [安全机制详解](#4-安全机制详解)
5. [常见问题](#5-常见问题)

---

## 1. Token 机制详解

### 1.1 Token 是什么？

**Token 不是本地随机创建的，而是服务器根据登录信息自动生成的身份凭证。**

**类比生活场景**：就像去银行办业务：
- 你在前台用身份证登记（输入用户名密码）
- 银行验证身份后，给你一个**排队号码牌**（这就是 Token）
- 号码牌是银行打印机自动生成的，有时间限制（1小时后失效）
- 拿着号码牌就能办业务，不用每次出示身份证

### 1.2 Token 生成原理

```python
# 1. JWT 密钥（服务器的"签名笔"）
JWT_SECRET = os.getenv("JWT_SECRET_KEY", "dev_secret_key...")

# 2. 登录时，服务器用密钥生成 Token
token = jwt.encode({
    "agent_id": "agent_123",
    "username": "admin",
    "role": "admin",
    "iat": "签发时间",
    "exp": "1小时后过期"
}, JWT_SECRET, algorithm="HS256")

# 3. 生成结果：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 1.3 Token 包含的信息

| 字段 | 说明 | 示例值 |
|------|------|--------|
| agent_id | 坐席唯一标识 | agent_1763973603632 |
| username | 用户名 | admin |
| role | 角色 | admin / agent |
| iat | 签发时间 | 1763974123 |
| exp | 过期时间 | 1763977723 (1小时后) |

### 1.4 Token 类型

| Token 类型 | 有效期 | 用途 |
|-----------|-------|------|
| Access Token | 1小时 | 访问 API 的身份凭证 |
| Refresh Token | 7天 | 刷新 Access Token（续期用） |

### 1.5 为什么 Token 安全？

- **密钥签名**：Token 用服务器密钥签名，无法伪造
- **时效性**：Token 有过期时间，过期自动失效
- **无状态**：服务器不存储 Token，通过签名验证真伪

---

## 2. 系统功能与使用流程

### 2.1 功能列表

#### 当前已实现功能

| 功能 | API 接口 | 说明 |
|------|---------|------|
| 坐席登录 | POST /api/agent/login | 输入用户名密码，获取Token |
| 坐席登出 | POST /api/agent/logout | 退出登录，状态变为离线 |
| 查询坐席信息 | GET /api/agent/profile | 查看坐席详细信息 |
| 刷新Token | POST /api/agent/refresh | Token快过期时自动续期 |

#### 计划中的功能

| 功能 | 说明 | 优先级 |
|------|------|-------|
| JWT 权限中间件 | 保护坐席工作台 API | 高 |
| 修改密码 | 坐席自己修改密码 | 中 |
| 创建坐席 | 管理员创建新坐席账号 | 中 |
| 删除坐席 | 管理员删除坐席账号 | 中 |
| 坐席列表 | 管理员查看所有坐席 | 中 |
| 审计日志 | 记录登录/登出操作 | 低 |

### 2.2 完整使用流程

```
用户（坐席工作台）                服务器（后端）                 Redis

1. 打开坐席工作台
   ↓
2. 输入用户名密码
   (admin / admin123)
   ↓
3. POST /api/agent/login ─────→ 查询账号
                                ↓
                              验证密码（bcrypt）
                                ↓
                              生成 Token
                                ↓
4. ←───────────────────────── 返回 Token + 坐席信息
   ↓
5. 存储 Token 到 localStorage
   ↓
6. 访问工作台功能
   GET /api/sessions ─────────→ 验证 Token
   Header: Bearer token          ↓
                              Token 有效？✅
                                ↓
7. ←───────────────────────── 返回会话列表
   ↓
8. 1小时后 Token 过期
   GET /api/sessions ─────────→ Token 过期！
                              返回 401
9. ←─────────────────────────
   ↓
10. 自动刷新 Token
    POST /api/agent/refresh ──→ 验证 Refresh Token
                                ↓
                              生成新 Access Token
11. ←───────────────────────── 返回新 Token
    ↓
    存储新 Token，重试请求

12. 7天后 Refresh Token 过期
    → 必须重新登录
```

### 2.3 典型使用场景

#### 场景1：坐席上班登录

```
早上9点：
1. 客服小王打开坐席工作台网页
2. 看到登录页面，输入：
   - 用户名：agent001
   - 密码：agent123
3. 点击"登录"按钮
4. 系统验证成功，跳转到工作台首页
5. 小王可以看到待处理的客户会话列表
6. 小王的状态自动变为"在线"
```

#### 场景2：Token 自动刷新（用户无感知）

```
下午2点（登录5小时后）：
1. 小王的 Access Token 已经过期多次
2. 前端自动用 Refresh Token 刷新
3. 小王完全不知道，继续正常工作
```

#### 场景3：下班登出

```
下午6点：
1. 小王点击"登出"按钮
2. 系统调用 /api/agent/logout
3. 小王的状态变为"离线"
4. Token 失效，跳转回登录页面
```

---

## 3. 账号管理机制

### 3.1 默认账号

系统启动时自动创建3个默认账号：

| 用户名 | 密码 | 角色 | 姓名 | 最大会话数 |
|-------|------|------|------|-----------|
| admin | admin123 | admin | 系统管理员 | 10 |
| agent001 | agent123 | agent | 客服小王 | 5 |
| agent002 | agent123 | agent | 客服小李 | 5 |

**⚠️ 生产环境必须修改默认密码！**

### 3.2 账号存储方式

账号数据存储在 Redis 数据库中：

```
Redis Key: agent:{username}
Value: JSON 格式的账号数据
TTL: 365天

示例：
Key: agent:admin
Value: {
  "id": "agent_1763973603632",
  "username": "admin",
  "password_hash": "$2b$12$abcd1234...",
  "name": "系统管理员",
  "role": "admin",
  "status": "online",
  "max_sessions": 10,
  "created_at": 1763973603.8,
  "last_login": 1763974123.4
}
```

### 3.3 密码验证流程

```python
# 用户登录：username="admin", password="admin123"

# 1. 从 Redis 获取账号
agent = redis.get("agent:admin")
# → {"password_hash": "$2b$12$abcd1234..."}

# 2. 用 bcrypt 验证密码
is_valid = bcrypt.checkpw(
    "admin123".encode(),           # 用户输入的明文密码
    "$2b$12$abcd1234...".encode()  # 数据库中的加密密码
)
# → True（密码正确）或 False（密码错误）

# 3. 密码正确时
if is_valid:
    # 生成 Token
    # 更新 last_login 时间
    # 状态变为 online
    # 返回成功响应
```

### 3.4 如何创建新账号

#### 方法1：修改代码（开发环境）

编辑 `src/agent_auth.py` 的 `initialize_default_agents` 函数添加新账号。

#### 方法2：Python 脚本创建

```python
# 创建新坐席账号
python3 <<EOF
from src.agent_auth import AgentManager, AgentRole
from src.redis_session_store import RedisSessionStore

redis_store = RedisSessionStore()
agent_manager = AgentManager(redis_store)

agent = agent_manager.create_agent(
    username="agent003",
    password="secure_password_123",
    name="客服小张",
    role=AgentRole.AGENT,
    max_sessions=5
)
print(f"✅ 创建成功: {agent.username}")
EOF
```

#### 方法3：管理界面创建（待实现）

未来将在坐席工作台实现管理员界面，支持图形化创建、修改、删除坐席。

### 3.5 如何修改密码

```python
# 修改坐席密码
python3 <<EOF
from src.agent_auth import AgentManager, PasswordHasher
from src.redis_session_store import RedisSessionStore

redis_store = RedisSessionStore()
agent_manager = AgentManager(redis_store)

# 获取坐席
agent = agent_manager.get_agent_by_username("admin")

# 修改密码
agent.password_hash = PasswordHasher.hash_password("new_strong_password")

# 保存
agent_manager.update_agent(agent)
print("✅ 密码已修改")
EOF
```

---

## 4. 安全机制详解

### 4.1 密码安全

| 安全措施 | 实现方式 | 说明 |
|---------|---------|------|
| 加密存储 | bcrypt + 自动加盐 | 即使数据库泄露也无法还原明文 |
| 传输安全 | HTTPS | 防止网络窃听 |
| 响应隐藏 | 移除 password_hash | API 永不返回密码 |

**bcrypt 加密特点**：
- 每个密码有独特的盐值（salt）
- 相同密码加密结果也不同
- 慢速算法，暴力破解需要几千年

### 4.2 Token 安全

| 安全措施 | 实现方式 | 说明 |
|---------|---------|------|
| 签名算法 | JWT HS256 | 防止 Token 被伪造 |
| 密钥管理 | 环境变量 | 不硬编码在代码中 |
| 短期有效 | 1小时过期 | 即使泄露也很快失效 |
| 刷新机制 | Refresh Token | 7天内可续期 |

### 4.3 API 安全

| 安全措施 | 实现方式 | 说明 |
|---------|---------|------|
| 输入验证 | Pydantic 模型 | 防止注入攻击 |
| 错误隐藏 | 统一错误信息 | 不暴露用户是否存在 |
| 状态码规范 | 401/404/500 | 清晰的错误类型 |

---

## 5. 常见问题

### Q1: Token 是每次请求都要发送吗？

**是的**。Token 需要放在每个请求的 Header 中：

```javascript
fetch('/api/sessions', {
  headers: {
    'Authorization': 'Bearer eyJhbGci...'
  }
})
```

### Q2: Token 过期了怎么办？

前端会自动用 Refresh Token 刷新。如果 Refresh Token 也过期（7天后），需要重新登录。

### Q3: 忘记密码怎么办？

目前需要联系管理员手动修改。未来会实现"密码重置"功能。

### Q4: 能看到谁在线吗？

可以查询坐席的 `status` 字段：
```bash
curl "http://localhost:8000/api/agent/profile?username=admin"
# → {"agent": {"status": "online"}}
```

### Q5: 同一账号能多处登录吗？

**可以**。当前设计允许多处登录，每次登录会更新 `last_login` 时间。

### Q6: 管理员和普通坐席有什么区别？

目前只有 `role` 字段不同，权限控制功能待实现。未来：
- **admin**：可以创建/删除坐席、查看所有数据
- **agent**：只能操作自己的会话

### Q7: Token 泄露了怎么办？

Token 有效期只有1小时，即使泄露也很快失效。如果担心，可以：
1. 重启后端服务（生成新的 JWT 密钥）
2. 或手动修改环境变量中的 JWT_SECRET_KEY

### Q8: 生产环境需要改什么？

**必须修改**：
1. JWT 密钥（至少32字符强随机密钥）
2. 默认账号密码
3. 启用 HTTPS

### Q9: 数据会丢失吗？

不会。账号数据存储在 Redis 中，TTL 设置为365天。建议定期备份 Redis 数据。

### Q10: 如何查看 Token 内容？

```bash
# 在线解码：https://jwt.io/

# 命令行解码
echo "eyJhbGci..." | cut -d. -f2 | base64 -d 2>/dev/null | python3 -m json.tool
```

---

## 6. 数据流示意图

```
┌──────────────────────────────────────────────────────────────┐
│                     坐席认证系统架构                            │
└──────────────────────────────────────────────────────────────┘

┌─────────────┐          ┌─────────────┐          ┌─────────────┐
│  前端页面    │          │   后端服务   │          │    Redis    │
│ (工作台)     │          │  (FastAPI)  │          │   数据库     │
└─────────────┘          └─────────────┘          └─────────────┘
      │                         │                         │
      │ 1. 登录请求              │                         │
      │ POST /api/agent/login   │                         │
      ├────────────────────────>│                         │
      │                         │ 2. 查询账号              │
      │                         ├────────────────────────>│
      │                         │<────────────────────────┤
      │                         │ 3. bcrypt验证密码       │
      │                         │ 4. JWT生成Token         │
      │                         │ 5. 更新状态              │
      │                         ├────────────────────────>│
      │ 6. 返回Token            │                         │
      │<────────────────────────┤                         │
      │                         │                         │
      │ 7. 访问API              │                         │
      │ Header: Bearer token    │                         │
      ├────────────────────────>│                         │
      │                         │ 8. 验证Token            │
      │                         │ 9. 查询数据              │
      │                         ├────────────────────────>│
      │                         │<────────────────────────┤
      │ 10. 返回数据            │                         │
      │<────────────────────────┤                         │
```

---

## 7. 总结

**一句话概括**：
坐席认证系统是一个完整的"门禁系统"——只有持有正确"工作证"（Token）的员工（坐席）才能进入办公室（工作台），"工作证"由前台（后端）在验证身份（密码）后颁发，有效期1小时，到期可以续期7天，7天后必须重新登记。

**核心组件**：
- 密码加密：bcrypt
- 身份凭证：JWT Token
- 数据存储：Redis
- API 框架：FastAPI

---

**文档版本**: v1.0
**最后更新**: 2025-11-24
**维护者**: Fiido AI 客服开发团队
