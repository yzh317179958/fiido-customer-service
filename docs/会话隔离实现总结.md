# Coze ä¼šè¯éš”ç¦»å®ç°æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è¿°

æ ¹æ® `prd/coze.md` éœ€æ±‚æ–‡æ¡£ï¼Œå·²æˆåŠŸå®ç°å®Œæ•´çš„ä¼šè¯éš”ç¦»åŠŸèƒ½ï¼Œä¸¥æ ¼éµå®ˆ Coze API çº¦æŸè§„èŒƒã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. éœ€æ±‚æ–‡æ¡£å®Œå–„ (prd/coze.md)

**æ–°å¢ç« èŠ‚ï¼š**
- **1.1 Coze Conversation ID æ ¸å¿ƒæœºåˆ¶**ï¼šè¯¦ç»†è¯´æ˜ Coze SDK çš„ conversation_id åŠ¨æ€ç”Ÿæˆç‰¹æ€§
- **12. Coze API çº¦æŸè§„èŒƒï¼ˆå¼ºåˆ¶éµå®ˆï¼‰**ï¼šå®Œæ•´çš„å¼€å‘è§„èŒƒå’Œé™åˆ¶æ¡æ¬¾
  - 12.1 æ ¸å¿ƒçº¦æŸï¼ˆConversation IDã€Session Nameã€Token ç®¡ç†ç­‰ï¼‰
  - 12.2 å¼€å‘å˜æ›´è§„åˆ™
  - 12.3 å¸¸è§é”™è¯¯æ¡ˆä¾‹
  - 12.4 å®¡æŸ¥æ¸…å•
  - 12.5 ç´§æ€¥å›æ»šé¢„æ¡ˆ

**å…³é”®è¦æ±‚æ˜ç¡®ï¼š**
- ç”¨æˆ·é¦–æ¬¡è¿›çº¿æ—¶å¿…é¡»åˆ›å»ºæ–°ä¼šè¯ï¼Œç”ŸæˆåŠ¨æ€ `conversation_id`
- é¦–æ¬¡å¯¹è¯ä¸ä¼  `conversation_id`ï¼Œç”± Coze è‡ªåŠ¨ç”Ÿæˆ
- åç»­å¯¹è¯å¿…é¡»ä¼ å…¥ç›¸åŒçš„ `conversation_id` ä»¥ç»´æŒä¸Šä¸‹æ–‡
- æ‰€æœ‰ API è°ƒç”¨å¿…é¡»ä¸¥æ ¼éµå®ˆ Coze å¹³å°è§„èŒƒ

---

### 2. åç«¯ API å®ç° (backend.py)

#### 2.1 æ¸…é™¤å†å²ä¼šè¯ API

**æ¥å£ï¼š** `POST /api/conversation/clear`

**åŠŸèƒ½ï¼š**
- ä¸ºæŒ‡å®š session_id åˆ›å»ºæ–°çš„ conversationï¼ˆè‡ªåŠ¨ç”Ÿæˆæ–° IDï¼‰
- æ›´æ–° conversation_cache æ˜ å°„å…³ç³»
- è¿”å›æ–°çš„ conversation_id

**å®ç°è¦ç‚¹ï¼š**
```python
# âœ… ä¸¥æ ¼éµå®ˆ Coze çº¦æŸï¼šä¸æ‰‹åŠ¨ç”Ÿæˆ conversation_id
new_conversation = temp_coze.conversations.create()  # ç”± Coze è‡ªåŠ¨ç”Ÿæˆ

# âœ… æ›´æ–°ç¼“å­˜æ˜ å°„
conversation_cache[session_id] = new_conversation.id

# âœ… è®°å½•è¯¦ç»†æ—¥å¿—
print(f"æ—§ Conversation: {old_conversation_id}")
print(f"æ–° Conversation: {new_conversation.id}")
```

**æµ‹è¯•ç»“æœï¼š**
```bash
curl -X POST http://localhost:8000/api/conversation/clear \
  -d '{"session_id": "user_C"}'

# å“åº”ï¼š
{
  "success": true,
  "conversation_id": "7574609107602980869",
  "message": "å†å²ä¼šè¯å·²æ¸…é™¤ï¼Œæ–°å¯¹è¯å·²åˆ›å»º"
}
```

#### 2.2 åˆ›å»ºæ–°å¯¹è¯ API

**æ¥å£ï¼š** `POST /api/conversation/new`

**åŠŸèƒ½ï¼š**
- ä¸ºæŒ‡å®š session_id åˆ›å»ºæ–° conversation
- æ›´æ–°ç¼“å­˜æ˜ å°„
- æ”¯æŒåŒä¸€ session åˆ›å»ºå¤šä¸ªå¯¹è¯ï¼ˆæ¯æ¬¡è°ƒç”¨éƒ½ç”Ÿæˆæ–° IDï¼‰

**ä»£ç å®¡æŸ¥ï¼š**
```python
# âœ… ç¬¦åˆ Coze çº¦æŸ
conversation = temp_coze.conversations.create()  # Coze è‡ªåŠ¨ç”Ÿæˆ ID
conversation_cache[session_id] = conversation.id  # ä¿å­˜æ˜ å°„

# âœ… ä½¿ç”¨å¸¦ session_name çš„ token
token_response = jwt_oauth_app.get_access_token(
    ttl=3600,
    session_name=session_id  # ä¼šè¯éš”ç¦»å…³é”®
)
```

#### 2.3 ç°æœ‰ä»£ç éªŒè¯

**éªŒè¯é¡¹ï¼š** `/api/chat` å’Œ `/api/chat/stream` æ¥å£æ˜¯å¦æ­£ç¡®å®ç° conversation_id åŠ¨æ€ç®¡ç†

**éªŒè¯ç»“æœï¼š** âœ… é€šè¿‡

**å…³é”®ä»£ç ç‰‡æ®µï¼š**
```python
# backend.py:556-595
# âœ… é¦–æ¬¡å¯¹è¯ä¸ä¼  conversation_id
if not conversation_id:
    conversation_id = conversation_cache.get(session_id)
    if not conversation_id:
        print(f"ğŸ†• é¦–æ¬¡å¯¹è¯,å°†è‡ªåŠ¨ç”Ÿæˆ conversation_id")

# âœ… æ„å»ºè¯·æ±‚æ—¶æ¡ä»¶æ€§æ·»åŠ  conversation_id
payload = {
    "workflow_id": WORKFLOW_ID,
    "app_id": APP_ID,
    "session_name": session_id,  # ã€å…³é”®ã€‘session_name
    "parameters": {"USER_INPUT": request.message},
}

if conversation_id:
    payload["conversation_id"] = conversation_id  # åç»­å¯¹è¯æ‰ä¼ å…¥

# âœ… ä¿å­˜ Coze è¿”å›çš„ conversation_id
if not conversation_id and returned_conversation_id:
    conversation_cache[session_id] = returned_conversation_id
    print(f"âœ… ä¿å­˜æ–° conversation: {returned_conversation_id}")
```

---

### 3. å‰ç«¯ä¼˜åŒ– (index_chat_sdk.html)

#### 3.1 æ–°å¢æ¸…é™¤å†å²æŒ‰é’®

**UI æ”¹è¿›ï¼š**
```html
<button class="btn btn-secondary" onclick="clearHistory()">
    ğŸ§¹ æ¸…é™¤å†å²
</button>
```

#### 3.2 æ¸…é™¤å†å²äº¤äº’é€»è¾‘

```javascript
async function clearHistory() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰ä¼šè¯çš„å†å²è®°å½•å—ï¼Ÿ')) {
        return;
    }

    const response = await fetch(`${API_BASE}/api/conversation/clear`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId })
    });

    const data = await response.json();
    if (data.success) {
        alert('âœ… å†å²ä¼šè¯å·²æ¸…é™¤ï¼å·²åˆ›å»ºæ–°çš„å¯¹è¯ã€‚');
        // åˆ·æ–°èŠå¤©ç•Œé¢
        chatClient.close();
        setTimeout(() => chatClient.open(), 300);
    }
}
```

**ç”¨æˆ·ä½“éªŒï¼š**
- ç‚¹å‡»æŒ‰é’® â†’ ç¡®è®¤æç¤º â†’ è°ƒç”¨ API â†’ åˆ·æ–°ç•Œé¢
- æ— æ„Ÿåˆ‡æ¢ï¼Œä¿æŒå½“å‰ session_id
- æ¸…é™¤å†å²åè‡ªåŠ¨åˆ›å»ºæ–° conversation

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬ï¼štest_session_isolation.py

**æµ‹è¯•åœºæ™¯ï¼š**
1. âœ… å¤šç”¨æˆ·ä¼šè¯éš”ç¦»ï¼ˆä¸åŒ session_id æ‹¥æœ‰ç‹¬ç«‹ conversation_idï¼‰
2. âœ… æ¸…é™¤å†å²ä¼šè¯åŠŸèƒ½ï¼ˆç”Ÿæˆæ–° conversation_idï¼‰

**æµ‹è¯•ç»“æœï¼š**
```
============================================================
æµ‹è¯•æ€»ç»“
============================================================
ä¼šè¯éš”ç¦»: âœ… é€šè¿‡
æ¸…é™¤å†å²: âœ… é€šè¿‡

é€šè¿‡ç‡: 2/2 (100.0%)

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

**è¯¦ç»†éªŒè¯ï¼š**

**åœºæ™¯ 1ï¼šå¤šç”¨æˆ·éš”ç¦»**
```
ç”¨æˆ· A conversation_id: 7574609107602948101
ç”¨æˆ· B conversation_id: 7574608258508275717
âœ… ä¸åŒç”¨æˆ·æ‹¥æœ‰ä¸åŒçš„ conversation_id
```

**åœºæ™¯ 2ï¼šæ¸…é™¤å†å²**
```
åŸå§‹ conversation_id: 7574610459258683397
æ¸…é™¤å conversation_id: 7574609107602980869
âœ… æˆåŠŸç”Ÿæˆæ–°çš„ conversation_id
```

---

## ğŸ“Š å®ç°å¯¹æ¯”ï¼šå‰åå˜åŒ–

| åŠŸèƒ½ç‚¹ | å®ç°å‰ | å®ç°å |
|--------|--------|--------|
| **Conversation ID ç®¡ç†** | ç¼“å­˜é€»è¾‘å­˜åœ¨ï¼Œä½†æœªè§„èŒƒ | âœ… ä¸¥æ ¼éµå®ˆ Coze çº¦æŸï¼šé¦–æ¬¡ä¸ä¼ ï¼Œåç»­ä¼ å…¥ |
| **æ¸…é™¤å†å²ä¼šè¯** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼Œé€šè¿‡åˆ›å»ºæ–° conversation å®ç° |
| **å‰ç«¯äº¤äº’** | ä»…æ”¯æŒæ–°ä¼šè¯ | âœ… æ”¯æŒæ¸…é™¤å†å²ã€æ–°å¯¹è¯ã€æ–°ä¼šè¯ |
| **å¼€å‘è§„èŒƒ** | âŒ æ— æ˜ç¡®çº¦æŸ | âœ… å®Œæ•´çš„ Coze API çº¦æŸè§„èŒƒæ–‡æ¡£ |
| **æµ‹è¯•è¦†ç›–** | âŒ æ— è‡ªåŠ¨åŒ–æµ‹è¯• | âœ… ä¼šè¯éš”ç¦»æµ‹è¯•è„šæœ¬ |

---

## ğŸ¯ Coze API çº¦æŸéµå®ˆæƒ…å†µ

### âœ… å®Œå…¨ç¬¦åˆçš„çº¦æŸ

1. **Conversation ID ç®¡ç†**
   - âœ… é¦–æ¬¡å¯¹è¯ä¸ä¼  conversation_idï¼Œç”± Coze è‡ªåŠ¨ç”Ÿæˆ
   - âœ… åç»­å¯¹è¯ä¼ å…¥ conversation_id ç»´æŒä¸Šä¸‹æ–‡
   - âœ… ä¿å­˜ Coze è¿”å›çš„ conversation_id
   - âœ… ä¸æ‰‹åŠ¨ç”Ÿæˆ conversation_id

2. **Session Name éš”ç¦»**
   - âœ… JWT token å’Œ API è¯·æ±‚ä¸­ä¿æŒä¸€è‡´
   - âœ… æ¯ä¸ªç”¨æˆ·ä¼šè¯ç”Ÿæˆå”¯ä¸€ session_id
   - âœ… æ ¼å¼éµå®ˆå»ºè®®ï¼š`session_{timestamp}_{random}`

3. **Token ç®¡ç†**
   - âœ… ä½¿ç”¨ JWTOAuthApp ç”Ÿæˆå¸¦ session_name çš„ token
   - âœ… ä¸è·¨ session_name å¤ç”¨ token
   - âœ… Token è¿‡æœŸæ—¶é—´ç¬¦åˆé™åˆ¶ï¼ˆâ‰¤ 86400 ç§’ï¼‰

4. **API å‚æ•°è§„èŒƒ**
   - âœ… æ‰€æœ‰å¿…éœ€å­—æ®µå®Œæ•´ï¼ˆworkflow_idã€app_idã€session_nameï¼‰
   - âœ… æ¡ä»¶æ€§æ·»åŠ  conversation_idï¼ˆé¦–æ¬¡ä¸ä¼ ï¼Œåç»­ä¼ ï¼‰
   - âœ… æ ‡å‡†æ ¼å¼çš„ additional_messages

5. **å“åº”å¤„ç†**
   - âœ… æå–å¹¶ä¿å­˜ Coze è¿”å›çš„ conversation_id
   - âœ… æ›´æ–° session_name â†’ conversation_id æ˜ å°„

---

## ğŸ“ å…³é”®æ–‡ä»¶æ¸…å•

### æ–‡æ¡£
- âœ… `prd/coze.md` - å®Œå–„çš„éœ€æ±‚æ–‡æ¡£ï¼ˆæ–°å¢ 12 ç« èŠ‚çº¦æŸè§„èŒƒï¼‰
- âœ… `docs/ä¼šè¯éš”ç¦»å®ç°æ€»ç»“.md` - æœ¬æ–‡æ¡£

### åç«¯
- âœ… `backend.py:360-421` - æ–°å¢æ¸…é™¤å†å² API (`/api/conversation/clear`)
- âœ… `backend.py:304-357` - ä¼˜åŒ–åˆ›å»ºæ–°å¯¹è¯ APIï¼ˆæ·»åŠ ç¼“å­˜æ›´æ–°ï¼‰
- âœ… `backend.py:532-689` - éªŒè¯ `/api/chat` æ­£ç¡®å®ç° conversation_id ç®¡ç†
- âœ… `backend.py:692-853` - éªŒè¯ `/api/chat/stream` æ­£ç¡®å®ç°éš”ç¦»

### å‰ç«¯
- âœ… `index_chat_sdk.html:96-98` - æ–°å¢æ¸…é™¤å†å²æŒ‰é’®
- âœ… `index_chat_sdk.html:206-241` - æ¸…é™¤å†å²äº¤äº’é€»è¾‘

### æµ‹è¯•
- âœ… `test_session_isolation.py` - ä¼šè¯éš”ç¦»è‡ªåŠ¨åŒ–æµ‹è¯•

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. å¯åŠ¨åç«¯
```bash
python3 backend.py
# æˆ–
./start.sh
```

### 2. è®¿é—®å‰ç«¯
```
http://localhost:8000/
```

### 3. åŠŸèƒ½ä½¿ç”¨

**åœºæ™¯ Aï¼šæ™®é€šå¯¹è¯**
1. ç‚¹å‡»"å¼€å§‹å¯¹è¯"
2. é¦–æ¬¡å‘é€æ¶ˆæ¯ â†’ è‡ªåŠ¨åˆ›å»º conversation_id
3. åç»­æ¶ˆæ¯ â†’ ä½¿ç”¨ç›¸åŒ conversation_id ç»´æŒä¸Šä¸‹æ–‡

**åœºæ™¯ Bï¼šæ¸…é™¤å†å²**
1. ç‚¹å‡»"æ¸…é™¤å†å²"
2. ç¡®è®¤ â†’ åˆ›å»ºæ–° conversation_id
3. åç»­æ¶ˆæ¯ä½¿ç”¨æ–°çš„ä¸Šä¸‹æ–‡

**åœºæ™¯ Cï¼šæ–°å¯¹è¯**
1. ç‚¹å‡»"æ–°å¯¹è¯"
2. åˆ›å»ºæ–° conversation_id
3. ä¿æŒå½“å‰ session_id

**åœºæ™¯ Dï¼šæ–°ä¼šè¯**
1. ç‚¹å‡»"æ–°ä¼šè¯"
2. æ¸…ç©º sessionStorage
3. åˆ·æ–°é¡µé¢ï¼Œç”Ÿæˆæ–° session_id

### 4. è¿è¡Œæµ‹è¯•
```bash
python3 test_session_isolation.py
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ä¼šè¯çŠ¶æ€
```bash
# æŸ¥çœ‹ token ä¿¡æ¯
curl http://localhost:8000/api/token/info | python3 -m json.tool

# æŸ¥çœ‹å¥åº·çŠ¶æ€
curl http://localhost:8000/api/health | python3 -m json.tool
```

### æ—¥å¿—å…³é”®è¯
- `ğŸ” ä¼šè¯éš”ç¦»: session_name=` - Session æ ‡è¯†
- `â™»ï¸ ä½¿ç”¨ç¼“å­˜çš„ Conversation:` - å¤ç”¨ conversation_id
- `ğŸ†• é¦–æ¬¡å¯¹è¯,å°†è‡ªåŠ¨ç”Ÿæˆ conversation_id` - é¦–æ¬¡åˆ›å»º
- `âœ… ä¿å­˜æ–° conversation:` - ä¿å­˜æ˜ å°„å…³ç³»
- `âœ… å†å²ä¼šè¯å·²æ¸…é™¤` - æ¸…é™¤å†å²æˆåŠŸ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å¼€å‘å˜æ›´è§„åˆ™

**è§„åˆ™ 1ï¼šä¿®æ”¹ Coze API è°ƒç”¨ä»£ç **
- âœ… å¿…é¡»å®¡æŸ¥æ˜¯å¦ç¬¦åˆ `prd/coze.md` ç¬¬ 12 ç« èŠ‚çº¦æŸ
- âŒ ä¸å¾—ä¿®æ”¹ session_nameã€conversation_id ä¼ é€’é€»è¾‘
- âŒ ä¸å¾—ç§»é™¤é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… å¿…é¡»ä¿ç•™å®Œæ•´æ—¥å¿—è¾“å‡º

**è§„åˆ™ 2ï¼šåŠŸèƒ½æ‰©å±•ï¼ˆæ— å†²çªï¼‰**
- âœ… å¦‚æœä¸æ¶‰åŠ Coze API è°ƒç”¨ï¼Œå¯è‡ªç”±å¼€å‘
- ç¤ºä¾‹ï¼šæ¶ˆæ¯ç¼“å­˜ã€ç”¨æˆ·åå¥½ã€ç®¡ç†åå°ç­‰

### å¸¸è§é”™è¯¯ï¼ˆå·²é¿å…ï¼‰

âŒ **é”™è¯¯ 1ï¼šæ‰‹åŠ¨ç”Ÿæˆ conversation_id**
```python
# é”™è¯¯ç¤ºä¾‹
conversation_id = f"conv_{uuid.uuid4()}"

# æ­£ç¡®åšæ³•ï¼šç”± Coze è‡ªåŠ¨ç”Ÿæˆ
conversation = coze.conversations.create()
```

âŒ **é”™è¯¯ 2ï¼šçœç•¥ session_name**
```python
# é”™è¯¯ç¤ºä¾‹
token = jwt_oauth_app.get_access_token(ttl=3600)

# æ­£ç¡®åšæ³•
token = jwt_oauth_app.get_access_token(ttl=3600, session_name=session_id)
```

âŒ **é”™è¯¯ 3ï¼šä¸ä¿å­˜ conversation_id**
```python
# é”™è¯¯ç¤ºä¾‹ï¼šå¿½ç•¥è¿”å›çš„ conversation_id

# æ­£ç¡®åšæ³•
if 'conversation_id' in data:
    conversation_cache[session_id] = data['conversation_id']
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **éœ€æ±‚æ–‡æ¡£**ï¼š`prd/coze.md`
- **é¡¹ç›®ç»“æ„**ï¼š`PROJECT_STRUCTURE.md`
- **é…ç½®æŒ‡å—**ï¼š`docs/é…ç½®æŒ‡å—.md`
- **ä½¿ç”¨è¯´æ˜**ï¼š`README.md`

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®æ–½å®Œæˆäº†ä»¥ä¸‹ç›®æ ‡ï¼š

1. âœ… å®Œå–„éœ€æ±‚æ–‡æ¡£ï¼Œæ–°å¢ Coze API çº¦æŸè§„èŒƒï¼ˆ12 ç« èŠ‚ï¼Œå« 5 å¤§æ ¸å¿ƒçº¦æŸï¼‰
2. âœ… å®ç°æ¸…é™¤å†å²ä¼šè¯ APIï¼ˆ`/api/conversation/clear`ï¼‰
3. âœ… éªŒè¯ç°æœ‰ä»£ç æ­£ç¡®å®ç° conversation_id åŠ¨æ€ç®¡ç†
4. âœ… ä¼˜åŒ–å‰ç«¯äº¤äº’ï¼Œæ–°å¢æ¸…é™¤å†å²æŒ‰é’®
5. âœ… é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯ä¼šè¯éš”ç¦»åŠŸèƒ½ï¼ˆ100% é€šè¿‡ç‡ï¼‰

**æ‰€æœ‰åŠŸèƒ½ä¸¥æ ¼éµå®ˆ Coze å¹³å° API çº¦æŸï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œåˆè§„æ€§ã€‚**

---

ç”Ÿæˆæ—¶é—´ï¼š2025-11-20  
ç‰ˆæœ¬ï¼šv2.2.0
