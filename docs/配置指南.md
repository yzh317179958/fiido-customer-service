# 配置指南

本文档提供 Fiido 智能客服系统的完整配置说明。

---

## 目录
- [环境变量配置](#环境变量配置)
- [Coze 工作流配置](#coze-工作流配置)
- [OAuth 密钥配置](#oauth-密钥配置)
- [验证配置](#验证配置)

---

## 环境变量配置

### 创建 .env 文件

在项目根目录创建 `.env` 文件:

```bash
# Coze API 配置
COZE_API_BASE=https://api.coze.com

# 鉴权模式 (固定为 OAUTH_JWT)
COZE_AUTH_MODE=OAUTH_JWT

# Workflow ID (从 Coze 平台获取)
COZE_WORKFLOW_ID=7568811304438710279

# App ID (从 Coze 平台获取)
COZE_APP_ID=7568402281331949575

# OAuth 配置
COZE_OAUTH_CLIENT_ID=1147548140378
COZE_OAUTH_PUBLIC_KEY_ID=lunGzVer4yes0LLkUW2M4rhMIZJJyvMTKZbnTsjySJs
COZE_OAUTH_PRIVATE_KEY_FILE=./private_key.pem

# 客服配置 (可选)
COZE_BOT_NAME=Fiido 产品顾问
COZE_BOT_ICON_URL=
COZE_BOT_DESCRIPTION=Fiido 智能客服助手
COZE_BOT_WELCOME=您好！我是Fiido智能客服助手,很高兴为您服务。

# 服务器配置
HOST=0.0.0.0
PORT=8000

# 超时配置
HTTP_TIMEOUT_CONNECT=10.0
HTTP_TIMEOUT_READ=30.0
```

### 配置说明

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| `COZE_API_BASE` | Coze API 地址 | `https://api.coze.com` (国际版)<br>`https://api.coze.cn` (国内版) |
| `COZE_WORKFLOW_ID` | 工作流 ID | 从 Coze 平台复制 |
| `COZE_APP_ID` | 应用 ID | 从 Coze 平台复制 |
| `COZE_OAUTH_CLIENT_ID` | OAuth Client ID | 从 OAuth 应用获取 |
| `COZE_OAUTH_PUBLIC_KEY_ID` | 公钥指纹 | 从 OAuth 应用获取 |
| `COZE_OAUTH_PRIVATE_KEY_FILE` | 私钥文件路径 | `./private_key.pem` |

---

## Coze 工作流配置

### 1. 创建对话流

1. 登录 [Coze 平台](https://www.coze.com)
2. 创建新的**对话流**应用 (不是智能体)
3. 配置对话流节点

### 2. 工作流结构

推荐的最简结构:

```
开始
  ↓
[大模型节点]
  - 接收用户输入: {{USER_INPUT}}
  - 输出: AI 回复
  ↓
结束
```

**重要提示**:
- ✅ 使用应用对话流,不要使用智能体
- ✅ 大模型节点接收 `{{USER_INPUT}}` 变量
- ❌ 不需要添加"创建会话节点"
- ❌ 不需要配置 conversationName 参数

### 3. 发布工作流

1. 点击右上角"发布"
2. 选择"API 调用"
3. 复制 **Workflow ID**
4. 将 Workflow ID 填入 `.env` 文件的 `COZE_WORKFLOW_ID`

---

## OAuth 密钥配置

### 1. 创建 OAuth 应用

1. 进入 Coze 平台 → **开放平台** → **OAuth 应用**
2. 创建新应用
3. 选择鉴权方式: **JWT**

### 2. 生成密钥对

#### 方式 A: 使用平台生成 (推荐)

1. 在 OAuth 应用中点击"生成密钥对"
2. 下载私钥文件 `private_key.pem`
3. 复制公钥指纹 (Public Key ID)

#### 方式 B: 手动生成

```bash
# 生成 RSA 私钥
openssl genrsa -out private_key.pem 2048

# 生成公钥
openssl rsa -in private_key.pem -pubout -out public_key.pem

# 查看公钥内容 (需要上传到 Coze 平台)
cat public_key.pem
```

### 3. 配置密钥

将 `private_key.pem` 放在项目根目录,并在 `.env` 中配置:

```bash
COZE_OAUTH_PRIVATE_KEY_FILE=./private_key.pem
```

### 4. 获取 Client ID 和 Public Key ID

从 OAuth 应用页面复制:
- **Client ID** → `COZE_OAUTH_CLIENT_ID`
- **Public Key ID** (公钥指纹) → `COZE_OAUTH_PUBLIC_KEY_ID`

---

## 验证配置

### 1. 测试 JWT 生成

```bash
python3 src/jwt_signer.py
```

**期望输出**:
```
🔐 JWT 签名工具
==================================================
✅ JWT 生成成功！

JWT Token:
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Imx1bkd6VmVyNHll...

📄 JWT Payload:
{
  "iss": "1147548140378",
  "aud": "api.coze.com",
  "iat": 1700000000,
  "exp": 1700003600,
  "jti": "a1b2c3d4-...",
  "session_name": "test_user_001"
}

⏰ 令牌有效期: 3600 秒 (60 分钟)
```

### 2. 启动后端服务

```bash
python3 backend.py
```

**期望输出**:
```
============================================================
🚀 Fiido 智能客服后端服务初始化
============================================================
🔐 鉴权模式: OAUTH_JWT
🌐 API Base: https://api.coze.com
📱 App ID: 7568402281331949575
🔄 Workflow ID: 7568811304438710279
💬 多轮对话: 已启用
✅ OAuth+JWT 鉴权初始化成功
============================================================

INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

### 3. 健康检查

```bash
curl http://localhost:8000/api/health
```

**期望响应**:
```json
{
  "status": "healthy",
  "coze_connected": true,
  "workflow_id": "7568811304438710279",
  "app_id": "7568402281331949575",
  "auth_mode": "OAUTH_JWT",
  "session_isolation": true,
  "token_info": {
    "total_sessions": 1,
    "sessions": {
      "default": {
        "is_valid": true,
        "expires_at": "2025-11-19T15:00:00",
        "token_preview": "czs_0MRlXj7fjoRB..."
      }
    }
  }
}
```

### 4. 测试会话隔离

```bash
python3 tests/test_simple.py
```

**期望输出**:
```
👤 用户 A (session: session_abc123...)
发送: 我叫张三
回复: 张三,25岁,年轻有活力啊...

👤 用户 B (session: session_def456...)
发送: 我叫李四
回复: 李四程序员,厉害啊...

👤 用户 A 第二轮
发送: 我叫什么?
回复: 你叫张三吧?...
✅ 测试通过 - 用户 A 能记住自己的名字(张三)
```

---

## 常见问题

### Q1: 提示 "COZE_WORKFLOW_ID 环境变量未设置"

**解决方案**:
1. 确认 `.env` 文件存在于项目根目录
2. 检查 `.env` 文件中是否有 `COZE_WORKFLOW_ID=...`
3. 重启后端服务

### Q2: 提示 "OAuth+JWT 初始化失败"

**可能原因**:
1. 私钥文件路径错误
2. Client ID 或 Public Key ID 配置错误
3. 网络无法访问 Coze API

**解决方案**:
```bash
# 检查私钥文件是否存在
ls -la private_key.pem

# 测试 JWT 生成
python3 src/jwt_signer.py

# 检查网络连接
curl https://api.coze.com
```

### Q3: 会话隔离不生效

**检查清单**:
1. ✅ 确认 `backend.py:324` 中添加了 `"session_name": session_id`
2. ✅ 确认 `backend.py:449` 流式接口也添加了 session_name
3. ✅ 运行测试: `python3 tests/test_simple.py`
4. ✅ 查看后端日志确认 payload 包含 session_name

---

**文档更新时间**: 2025-11-19
