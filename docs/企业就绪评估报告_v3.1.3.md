# Fiido æ™ºèƒ½å®¢æœç³»ç»Ÿ - ä¼ä¸šçº§éƒ¨ç½²å°±ç»ªè¯„ä¼°æŠ¥å‘Š v3.1.3

**è¯„ä¼°æ—¥æœŸ**: 2025-11-25
**å½“å‰ç‰ˆæœ¬**: v3.1.3
**è¯„ä¼°äºº**: Claude Code

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

### æ€»ä½“è¯„ä¼°

| ç»´åº¦ | å¾—åˆ† | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| **æ ¸å¿ƒåŠŸèƒ½å®Œæˆåº¦** | 98% | âœ… ä¼˜ç§€ | P0+P1 æ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨å®Œæˆ |
| **ç”Ÿäº§éƒ¨ç½²å°±ç»ªåº¦** | 60% | âš ï¸ ä¸­ç­‰ | ç¼ºå°‘å…³é”®éƒ¨ç½²é…ç½® |
| **å®‰å…¨æ€§ä¸åˆè§„æ€§** | 70% | âš ï¸ ä¸­ç­‰ | å·²æœ‰åŸºç¡€å®‰å…¨ï¼Œéœ€åŠ å›º |
| **å¯ç»´æŠ¤æ€§** | 50% | âš ï¸ è¾ƒä½ | ç¼ºå°‘æ—¥å¿—ç›‘æ§ç³»ç»Ÿ |
| **æ€§èƒ½ä¸ç¨³å®šæ€§** | 75% | âœ… è‰¯å¥½ | å·²ä¼˜åŒ–å¹¶å‘å’Œå®æ—¶æ€§ |

**ç»¼åˆè¯„çº§**: **B çº§ - æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œéœ€è¡¥å……ç”Ÿäº§é…ç½®**

### å…³é”®å‘ç°

âœ… **ä¼˜åŠ¿**:
- æ ¸å¿ƒ AI å¯¹è¯åŠŸèƒ½å®Œæ•´ä¸”ç¨³å®šï¼ˆä¼šè¯éš”ç¦»ã€å¤šè½®å¯¹è¯ï¼‰
- äººå·¥æ¥ç®¡æµç¨‹å®Œå–„ï¼ˆ5 ç§çŠ¶æ€ã€é˜²æŠ¢å•æœºåˆ¶ï¼‰
- åå¸­è®¤è¯ç³»ç»Ÿä¼ä¸šçº§ï¼ˆJWT + bcrypt + æƒé™ç®¡ç†ï¼‰
- Redis æ•°æ®æŒä¹…åŒ–å·²å®ç°ï¼ˆ24 å°æ—¶ TTLï¼‰
- å‰ç«¯ç”¨æˆ·ä½“éªŒä¼˜ç§€ï¼ˆVue 3 + SSE å®æ—¶æ¨é€ï¼‰

ğŸ”´ **é˜»å¡ç”Ÿäº§éƒ¨ç½²çš„å…³é”®ç¼ºå¤±**:
1. **HTTPS + Nginx éƒ¨ç½²é…ç½®** - æ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œ
2. **å‰ç«¯åµŒå…¥ SDK** - æ— æ³•é›†æˆåˆ° Fiido ç‹¬ç«‹ç«™
3. **Docker å®¹å™¨åŒ–** - ç¯å¢ƒä¸ä¸€è‡´ï¼Œéƒ¨ç½²å›°éš¾

ğŸŸ  **å¼ºçƒˆå»ºè®®è¡¥å……**:
1. **ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ** - æ— æ³•è¿½æº¯ç”Ÿäº§é—®é¢˜
2. **ç›‘æ§ä¸å‘Šè­¦** - æ— æ³•æ„ŸçŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€
3. **å®‰å…¨åŠ å›º** - å­˜åœ¨ CSRFã€XSS ç­‰é£é™©

### æ¨èä¸Šçº¿æ—¶é—´

- **æœ€å¿«ä¸Šçº¿**: P0 å®Œæˆå **1-2 å‘¨**ï¼ˆä»…è¡¥å……éƒ¨ç½²é…ç½®ï¼‰
- **ç¨³å¥ä¸Šçº¿**: P0 + P1 å®Œæˆå **2-3 å‘¨**ï¼ˆåŒ…å«å®‰å…¨åŠ å›ºï¼‰

---

## âœ… å·²å®ŒæˆåŠŸèƒ½æ¸…å• (v3.1.3)

### æ ¸å¿ƒ AI å¯¹è¯åŠŸèƒ½ (100%)

| åŠŸèƒ½æ¨¡å— | å®Œæˆç‰ˆæœ¬ | æµ‹è¯•çŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| AI æ™ºèƒ½å¯¹è¯ | v2.0.0 | âœ… 12/12 é€šè¿‡ | åŸºäº Coze Workflow API |
| ä¼šè¯éš”ç¦» | v2.2.0 | âœ… å·²éªŒè¯ | session_name + conversation_id åŒé‡éš”ç¦» |
| å¤šè½®å¯¹è¯ | v2.0.0 | âœ… å·²éªŒè¯ | conversation_id ä¿æŒä¸Šä¸‹æ–‡ |
| æµå¼å“åº” | v2.1.0 | âœ… å·²éªŒè¯ | SSE é€å­—æ˜¾ç¤º |
| OAuth+JWT é‰´æƒ | v2.0.0 | âœ… å·²éªŒè¯ | Token è‡ªåŠ¨ç®¡ç†å’Œç¼“å­˜ |

### äººå·¥æ¥ç®¡åŠŸèƒ½ (100%)

| åŠŸèƒ½æ¨¡å— | å®Œæˆç‰ˆæœ¬ | æµ‹è¯•çŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| 5 ç§ä¼šè¯çŠ¶æ€ | v2.3.0 | âœ… 12/12 é€šè¿‡ | bot_active, pending_manual, manual_live, closed, after_hours_email |
| äººå·¥å‡çº§æ¥å£ | v2.3.0 | âœ… å·²éªŒè¯ | POST /api/manual/escalate |
| åå¸­æ¥å…¥ï¼ˆé˜²æŠ¢å•ï¼‰ | v2.3.2 | âœ… å·²éªŒè¯ | POST /api/sessions/{id}/takeover |
| äººå·¥æ¶ˆæ¯å†™å…¥ | v2.3.0 | âœ… å·²éªŒè¯ | POST /api/manual/messages |
| ä¼šè¯é‡Šæ”¾ | v2.3.0 | âœ… å·²éªŒè¯ | POST /api/sessions/{id}/release |
| ä¼šè¯è½¬æ¥ | v2.3.2 | âœ… å·²éªŒè¯ | POST /api/sessions/{id}/transfer |
| SSE å®æ—¶æ¨é€ | v2.3.0 | âœ… å·²éªŒè¯ | äººå·¥æ¶ˆæ¯ã€çŠ¶æ€å˜åŒ–å®æ—¶é€šçŸ¥ |

### ç›‘ç®¡ä¸æ™ºèƒ½å‡çº§ (100%)

| åŠŸèƒ½æ¨¡å— | å®Œæˆç‰ˆæœ¬ | æµ‹è¯•çŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| å…³é”®è¯æ£€æµ‹ | v2.3.0 | âœ… å·²éªŒè¯ | 7 ä¸ªé»˜è®¤å…³é”®è¯ |
| AI å¤±è´¥è®¡æ•° | v2.3.0 | âœ… å·²éªŒè¯ | è¿ç»­å¤±è´¥ 3 æ¬¡è‡ªåŠ¨å‡çº§ |
| VIP ç”¨æˆ·æ£€æµ‹ | v3.1.0 | âœ… å·²éªŒè¯ | user_profile.vip å­—æ®µ |
| å·¥ä½œæ—¶é—´é…ç½® | v2.3.2 | âœ… å·²éªŒè¯ | ShiftConfig (09:00-18:00) |
| éå·¥ä½œæ—¶é—´é‚®ä»¶ | v2.3.2 | âœ… å·²éªŒè¯ | SMTP é‚®ä»¶é€šçŸ¥ |

### åå¸­è®¤è¯ä¸ç®¡ç† (100%)

| åŠŸèƒ½æ¨¡å— | å®Œæˆç‰ˆæœ¬ | æµ‹è¯•çŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| JWT æƒé™ä¸­é—´ä»¶ | v3.1.1 | âœ… 7/7 é€šè¿‡ | verify_agent_token, require_admin, require_agent |
| å¯†ç åŠ å¯†å­˜å‚¨ | v2.3.7 | âœ… å·²éªŒè¯ | bcrypt åŠ å¯† |
| åå¸­ç™»å½•/ç™»å‡º | v2.3.7 | âœ… å·²éªŒè¯ | POST /api/agent/login |
| Token åˆ·æ–° | v2.3.7 | âœ… å·²éªŒè¯ | POST /api/agent/refresh |
| ç®¡ç†å‘˜ CRUD åå¸­ | v3.1.1 | âœ… 7/7 é€šè¿‡ | GET/POST/PUT/DELETE /api/agents |
| ç®¡ç†å‘˜é‡ç½®å¯†ç  | v3.1.1 | âœ… å·²éªŒè¯ | POST /api/agents/{username}/reset-password |
| åå¸­ä¿®æ”¹å¯†ç  | v3.1.2 | âœ… 6/7 é€šè¿‡ | POST /api/agent/change-password |
| åå¸­ä¿®æ”¹èµ„æ–™ | v3.1.3 | âœ… 8/8 é€šè¿‡ | PUT /api/agent/profile |

### åå¸­å·¥ä½œå° (100%)

| åŠŸèƒ½æ¨¡å— | å®Œæˆç‰ˆæœ¬ | æµ‹è¯•çŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| ä¼šè¯åˆ—è¡¨æŸ¥è¯¢ | v2.3.2 | âœ… 12/12 é€šè¿‡ | GET /api/sessions |
| ä¼šè¯ç»Ÿè®¡ä¿¡æ¯ | v2.3.2 | âœ… 12/12 é€šè¿‡ | GET /api/sessions/stats |
| å†å²æ¶ˆæ¯å›å¡« | v2.3.2 | âœ… å·²éªŒè¯ | åˆ·æ–°è‡ªåŠ¨åŠ è½½å†å² |
| å®æ—¶æ¶ˆæ¯æ¨é€ | v2.3.2 | âœ… å·²éªŒè¯ | SSE è½®è¯¢åŒæ­¥ |
| Fiido å“ç‰Œè®¾è®¡ | v2.3.3 | âœ… å·²éªŒè¯ | å®Œæ•´ UI è¿˜åŸ |

### æ•°æ®æŒä¹…åŒ– (100%)

| åŠŸèƒ½æ¨¡å— | å®Œæˆç‰ˆæœ¬ | æµ‹è¯•çŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| Redis ä¼šè¯å­˜å‚¨ | v2.3.6 | âœ… å·²éªŒè¯ | è¿æ¥æ±  50ï¼ŒTTL 24h |
| æœåŠ¡å™¨é‡å¯æ¢å¤ | v2.3.6 | âœ… å·²éªŒè¯ | æ•°æ®ä¸ä¸¢å¤± |
| é™çº§ç­–ç•¥ | v2.3.6 | âœ… å·²éªŒè¯ | Redis å¤±è´¥é™çº§åˆ°å†…å­˜ |
| å¥åº·æ£€æŸ¥ | v2.3.6 | âœ… å·²éªŒè¯ | å†…å­˜ä½¿ç”¨ã€ä¼šè¯æ•°ç›‘æ§ |

### ç”¨æˆ·ç«¯å‰ç«¯ (100%)

| åŠŸèƒ½æ¨¡å— | å®Œæˆç‰ˆæœ¬ | æµ‹è¯•çŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| Vue 3 æ¡†æ¶ | v2.1.0 | âœ… TypeScript é€šè¿‡ | Pinia çŠ¶æ€ç®¡ç† |
| Fiido å®˜ç½‘è®¾è®¡ | v2.1.0 | âœ… å·²éªŒè¯ | å®Œå…¨å¤åˆ» fiido.com |
| æµå¼ AI å“åº” | v2.1.0 | âœ… å·²éªŒè¯ | é€å­—æ˜¾ç¤º |
| Markdown æ¸²æŸ“ | v2.1.0 | âœ… å·²éªŒè¯ | å¯Œæ–‡æœ¬æ¶ˆæ¯ |
| æ°”æ³¡èœå• | v2.2.0 | âœ… å·²éªŒè¯ | æ¸…é™¤å¯¹è¯ã€æ–°å»ºä¼šè¯ã€è½¬äººå·¥ |
| çŠ¶æ€æ æ˜¾ç¤º | v2.3.3 | âœ… å·²éªŒè¯ | å®æ—¶æ˜¾ç¤ºä¼šè¯çŠ¶æ€ |
| å±€åŸŸç½‘è®¿é—® | v2.1.0 | âœ… å·²éªŒè¯ | http://192.168.x.x:5173 |

---

## âŒ ç¼ºå¤±åŠŸèƒ½åˆ†æ

### P0 çº§ - é˜»å¡ç”Ÿäº§éƒ¨ç½² (3 é¡¹)

#### P0-1: HTTPS + Nginx éƒ¨ç½²é…ç½® ğŸ”´ è‡´å‘½

**å½“å‰çŠ¶æ€**: âŒ æœªå®ç°

**é£é™©ç­‰çº§**: ğŸ”´ **è‡´å‘½** - æ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œ

**é—®é¢˜æè¿°**:
1. åç«¯æœåŠ¡ä½¿ç”¨ HTTP æ˜æ–‡ä¼ è¾“ï¼Œç”¨æˆ·æ•°æ®ï¼ˆåŒ…æ‹¬å¯†ç ã€ä¼šè¯å†…å®¹ï¼‰æœªåŠ å¯†
2. ç°ä»£æµè§ˆå™¨å¼ºåˆ¶ HTTPSï¼ˆå¦‚ Chrome æ ‡è®° HTTP ä¸º"ä¸å®‰å…¨"ï¼‰
3. Cookie æ— æ³•è®¾ç½® Secure æ ‡å¿—ï¼Œæ˜“è¢«ä¸­é—´äººæ”»å‡»
4. æ— æ³•æ»¡è¶³ Fiido ç‹¬ç«‹ç«™çš„å®‰å…¨è¦æ±‚ï¼ˆç‹¬ç«‹ç«™å¿…é¡» HTTPSï¼‰

**ä¸šåŠ¡å½±å“**:
- âŒ æ— æ³•éƒ¨ç½²åˆ°å…¬ç½‘åŸŸåï¼ˆå¦‚ https://chat.fiido.comï¼‰
- âŒ ç”¨æˆ·å¯†ç å’ŒèŠå¤©è®°å½•æ˜æ–‡ä¼ è¾“ï¼Œä¸¥é‡å®‰å…¨éšæ‚£
- âŒ æµè§ˆå™¨å®‰å…¨è­¦å‘Šå½±å“ç”¨æˆ·ä¿¡ä»»åº¦
- âŒ ä¸ç¬¦åˆ GDPRã€PCI-DSS ç­‰åˆè§„è¦æ±‚

**å®æ–½æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ A: Nginx åå‘ä»£ç†ï¼ˆæ¨èï¼‰**

```nginx
# /etc/nginx/sites-available/fiido-chat
upstream backend {
    server 127.0.0.1:8000;
    keepalive 64;
}

server {
    listen 443 ssl http2;
    server_name chat.fiido.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/chat.fiido.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chat.fiido.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # åå‘ä»£ç†åˆ° FastAPI åç«¯
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE é•¿è¿æ¥æ”¯æŒ
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå‰ç«¯ï¼‰
    location / {
        root /var/www/fiido-chat/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # åå¸­å·¥ä½œå°
    location /agent/ {
        root /var/www/fiido-chat/agent-workbench/dist;
        try_files $uri $uri/ /agent/index.html;
    }
}

# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name chat.fiido.com;
    return 301 https://$server_name$request_uri;
}
```

**å®æ–½æ­¥éª¤**:
1. ç”³è¯· SSL è¯ä¹¦ï¼ˆLet's Encrypt å…è´¹ï¼‰
2. å®‰è£… Nginx
3. åˆ›å»ºä¸Šè¿°é…ç½®æ–‡ä»¶
4. æ„å»ºå‰ç«¯ç”Ÿäº§ç‰ˆæœ¬
5. ä¿®æ”¹å‰ç«¯ API_BASE_URL ä¸ºç›¸å¯¹è·¯å¾„
6. æµ‹è¯•éªŒè¯

**æ–¹æ¡ˆ B: Cloudflare + HTTP åç«¯ï¼ˆç®€åŒ–æ–¹æ¡ˆï¼‰**

```
ç”¨æˆ·æµè§ˆå™¨ --HTTPS--> Cloudflare CDN --HTTP--> åç«¯æœåŠ¡å™¨
```

**ä¼˜åŠ¿**: æ— éœ€é…ç½® SSL è¯ä¹¦ï¼ŒCloudflare è‡ªåŠ¨å¤„ç†
**åŠ£åŠ¿**: åç«¯åˆ° Cloudflare ä»æ˜¯ HTTPï¼ˆé€‚åˆå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰

**å·¥ä½œé‡ä¼°ç®—**: 1-2 å¤©

**éªŒæ”¶æ ‡å‡†**:
- [ ] æµè§ˆå™¨åœ°å€æ æ˜¾ç¤ºç»¿è‰²é”å›¾æ ‡
- [ ] æ‰€æœ‰ API è¯·æ±‚ä½¿ç”¨ HTTPS
- [ ] SSE é•¿è¿æ¥åœ¨ HTTPS ä¸‹æ­£å¸¸å·¥ä½œ
- [ ] å‰ç«¯é¡µé¢æ­£å¸¸åŠ è½½é™æ€èµ„æº

---

#### P0-2: å‰ç«¯åµŒå…¥ SDK ğŸ”´ è‡´å‘½

**å½“å‰çŠ¶æ€**: âŒ æœªå®ç°

**é£é™©ç­‰çº§**: ğŸ”´ **è‡´å‘½** - æ— æ³•é›†æˆåˆ° Fiido ç‹¬ç«‹ç«™

**é—®é¢˜æè¿°**:
1. å½“å‰å‰ç«¯åªèƒ½ä½œä¸ºç‹¬ç«‹é¡µé¢è®¿é—®ï¼ˆhttp://localhost:5173ï¼‰
2. æ— æ³•åµŒå…¥åˆ° Fiido å®˜ç½‘ï¼ˆhttps://www.fiido.comï¼‰é¡µé¢ä¸­
3. å®¢æˆ·å¿…é¡»è·³è½¬åˆ°æ–°é¡µé¢ä½¿ç”¨å®¢æœï¼Œä½“éªŒå‰²è£‚

**ä¸šåŠ¡å½±å“**:
- âŒ æ— æ³•å®ç°"æµ®åŠ¨å®¢æœæŒ‰é’®"åµŒå…¥å®˜ç½‘
- âŒ ç”¨æˆ·å¿…é¡»ç¦»å¼€è´­ç‰©é¡µé¢æ‰èƒ½å’¨è¯¢ï¼Œé™ä½è½¬åŒ–ç‡
- âŒ æ— æ³•åœ¨äº§å“è¯¦æƒ…é¡µç›´æ¥è¯¢é—®å•†å“ä¿¡æ¯
- âŒ ä¸ç¬¦åˆç°ä»£ç”µå•†å®¢æœçš„ç”¨æˆ·ä½“éªŒæ ‡å‡†

**å®æ–½æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ A: iframe åµŒå…¥æ–¹æ¡ˆï¼ˆæ¨è - å¿«é€Ÿå®ç°ï¼‰**

1. **åˆ›å»ºåµŒå…¥ SDK** (`frontend/public/embed.js`):

```javascript
(function() {
  // SDK é…ç½®
  const CHAT_URL = 'https://chat.fiido.com';
  const BUTTON_SIZE = '60px';

  // åˆ›å»ºæµ®åŠ¨æŒ‰é’®
  const button = document.createElement('div');
  button.id = 'fiido-chat-button';
  button.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: ${BUTTON_SIZE};
    height: ${BUTTON_SIZE};
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  button.innerHTML = `<svg width="30" height="30" fill="white">...</svg>`;
  document.body.appendChild(button);

  // åˆ›å»º iframe å®¹å™¨
  const chatPanel = document.createElement('div');
  chatPanel.id = 'fiido-chat-panel';
  chatPanel.style.cssText = `
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 420px;
    height: 600px;
    display: none;
    z-index: 9998;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    overflow: hidden;
  `;

  const iframe = document.createElement('iframe');
  iframe.src = CHAT_URL;
  iframe.style.cssText = `
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 12px;
  `;
  chatPanel.appendChild(iframe);
  document.body.appendChild(chatPanel);

  // ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤º
  button.addEventListener('click', function() {
    const isVisible = chatPanel.style.display === 'block';
    chatPanel.style.display = isVisible ? 'none' : 'block';
  });

  // ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯ï¼ˆå…³é—­é¢æ¿ï¼‰
  window.addEventListener('message', function(e) {
    if (e.origin !== CHAT_URL) return;
    if (e.data === 'close-chat') {
      chatPanel.style.display = 'none';
    }
  });
})();
```

2. **Fiido å®˜ç½‘é›†æˆ** (åœ¨ `<head>` ä¸­æ·»åŠ ):

```html
<!-- Fiido æ™ºèƒ½å®¢æœ -->
<script src="https://chat.fiido.com/embed.js" async></script>
```

**ä¼˜åŠ¿**:
- âœ… å¿«é€Ÿå®ç°ï¼ˆ1-2 å¤©ï¼‰
- âœ… æ— éœ€ä¿®æ”¹ç°æœ‰å‰ç«¯ä»£ç 
- âœ… æ ·å¼éš”ç¦»ï¼ˆä¸å—å®˜ç½‘ CSS å½±å“ï¼‰
- âœ… æ”¯æŒè·¨åŸŸé€šä¿¡ï¼ˆpostMessageï¼‰

**åŠ£åŠ¿**:
- âš ï¸ æ¯æ¬¡æ‰“å¼€éœ€è¦é‡æ–°åŠ è½½ iframe
- âš ï¸ å ç”¨è¾ƒå¤šå†…å­˜

**æ–¹æ¡ˆ B: Web Components SDKï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰**

```javascript
// fiido-chat.js
class FiidoChat extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: 'open' });
    // ... å°† Vue åº”ç”¨æ‰“åŒ…ä¸º Web Component
  }
}
customElements.define('fiido-chat', FiidoChat);
```

**é›†æˆæ–¹å¼**:
```html
<script src="https://chat.fiido.com/fiido-chat.js"></script>
<fiido-chat api-url="https://chat.fiido.com"></fiido-chat>
```

**ä¼˜åŠ¿**:
- âœ… åŸç”Ÿæµè§ˆå™¨æ”¯æŒ
- âœ… æ€§èƒ½æ›´å¥½ï¼ˆæ—  iframe å¼€é”€ï¼‰
- âœ… æ ·å¼å®Œå…¨éš”ç¦»ï¼ˆShadow DOMï¼‰

**åŠ£åŠ¿**:
- âš ï¸ éœ€è¦é‡æ„ Vue åº”ç”¨ï¼ˆ3-5 å¤©ï¼‰
- âš ï¸ æµè§ˆå™¨å…¼å®¹æ€§è¦æ±‚ï¼ˆéœ€ polyfillï¼‰

**å·¥ä½œé‡ä¼°ç®—**:
- æ–¹æ¡ˆ A (iframe): 1-2 å¤©
- æ–¹æ¡ˆ B (Web Components): 3-5 å¤©

**éªŒæ”¶æ ‡å‡†**:
- [ ] åœ¨ Fiido å®˜ç½‘ä»»æ„é¡µé¢æ˜¾ç¤ºæµ®åŠ¨å®¢æœæŒ‰é’®
- [ ] ç‚¹å‡»æŒ‰é’®å¼¹å‡ºèŠå¤©é¢æ¿
- [ ] èŠå¤©åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼ˆAI å¯¹è¯ã€äººå·¥æ¥ç®¡ï¼‰
- [ ] å…³é—­é¢æ¿ä¸å½±å“å®˜ç½‘åŠŸèƒ½
- [ ] æ”¯æŒç§»åŠ¨ç«¯è‡ªé€‚åº”

---

#### P0-3: Docker å®¹å™¨åŒ–éƒ¨ç½² ğŸ”´ ä¸¥é‡

**å½“å‰çŠ¶æ€**: âŒ æœªå®ç°

**é£é™©ç­‰çº§**: ğŸŸ  **ä¸¥é‡** - ç¯å¢ƒä¸ä¸€è‡´ï¼Œéƒ¨ç½²å›°éš¾

**é—®é¢˜æè¿°**:
1. ç¼ºå°‘ Dockerfile å’Œ docker-compose.yml
2. æ‰‹åŠ¨éƒ¨ç½²ä¾èµ–ç¯å¢ƒé…ç½®ï¼ˆPythonã€Node.jsã€Redisï¼‰
3. å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒå¯èƒ½ä¸ä¸€è‡´
4. æ— æ³•å¿«é€Ÿæ‰©å®¹ï¼ˆæ°´å¹³æ‰©å±•ï¼‰

**ä¸šåŠ¡å½±å“**:
- âš ï¸ éƒ¨ç½²æµç¨‹å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™
- âš ï¸ æ— æ³•å¿«é€Ÿå›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
- âš ï¸ æ— æ³•ä½¿ç”¨ Kubernetes ç­‰å®¹å™¨ç¼–æ’å·¥å…·
- âš ï¸ CI/CD æµç¨‹éš¾ä»¥è‡ªåŠ¨åŒ–

**å®æ–½æ–¹æ¡ˆ**:

**åˆ›å»º Dockerfile**:

```dockerfile
# /home/yzh/AIå®¢æœ/é‰´æƒ/Dockerfile
FROM python:3.10-slim

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–
RUN pip3 install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["python3", "backend.py"]
```

**åˆ›å»º docker-compose.yml**:

```yaml
version: '3.8'

services:
  # Redis æœåŠ¡
  redis:
    image: redis:7-alpine
    container_name: fiido-redis
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped

  # åç«¯æœåŠ¡
  backend:
    build: .
    container_name: fiido-backend
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379/0
      - HOST=0.0.0.0
      - PORT=8000
    env_file:
      - .env
    depends_on:
      - redis
    restart: unless-stopped
    volumes:
      - ./private_key.pem:/app/private_key.pem:ro

  # å‰ç«¯ï¼ˆç”¨æˆ·ç«¯ï¼‰
  frontend:
    image: node:18-alpine
    container_name: fiido-frontend
    working_dir: /app
    command: sh -c "npm install && npm run build && npx serve -s dist -l 5173"
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
    restart: unless-stopped

  # åå¸­å·¥ä½œå°
  agent-workbench:
    image: node:18-alpine
    container_name: fiido-agent-workbench
    working_dir: /app
    command: sh -c "npm install && npm run build && npx serve -s dist -l 5174"
    ports:
      - "5174:5174"
    volumes:
      - ./agent-workbench:/app
    restart: unless-stopped

volumes:
  redis-data:
```

**éƒ¨ç½²å‘½ä»¤**:

```bash
# 1. æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# 2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend

# 4. åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# 5. å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬æ•°æ®ï¼‰
docker-compose down -v
```

**ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆä½¿ç”¨ Nginxï¼‰**:

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: fiido-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./frontend/dist:/usr/share/nginx/html/frontend:ro
      - ./agent-workbench/dist:/usr/share/nginx/html/agent:ro
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    # ... (åŒä¸Š)
    expose:
      - "8000"  # ä»…å†…éƒ¨è®¿é—®ï¼Œä¸å¯¹å¤–æš´éœ²

  redis:
    # ... (åŒä¸Š)
    expose:
      - "6379"  # ä»…å†…éƒ¨è®¿é—®
```

**å·¥ä½œé‡ä¼°ç®—**: 1-2 å¤©

**éªŒæ”¶æ ‡å‡†**:
- [ ] ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆ`docker-compose up -d`ï¼‰
- [ ] åç«¯ã€å‰ç«¯ã€Redis å®¹å™¨æ­£å¸¸è¿è¡Œ
- [ ] å®¹å™¨é—´ç½‘ç»œé€šä¿¡æ­£å¸¸
- [ ] æ•°æ®æŒä¹…åŒ–åˆ° Docker volume
- [ ] æœåŠ¡é‡å¯åæ•°æ®ä¸ä¸¢å¤±

---

### P1 çº§ - å¼ºçƒˆå»ºè®® (4 é¡¹)

#### P1-1: ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ ğŸŸ  ä¸¥é‡

**å½“å‰çŠ¶æ€**: âŒ ä»…ä½¿ç”¨ `print()` å’Œ `console.log()`

**é£é™©ç­‰çº§**: ğŸŸ  **ä¸¥é‡** - æ— æ³•è¿½æº¯ç”Ÿäº§é—®é¢˜

**é—®é¢˜æè¿°**:
1. æ—¥å¿—æ— ç»“æ„åŒ–ï¼ˆçº¯æ–‡æœ¬ï¼‰ï¼Œéš¾ä»¥æŸ¥è¯¢å’Œåˆ†æ
2. æ—¥å¿—æ— æŒä¹…åŒ–ï¼ˆé‡å¯ä¸¢å¤±ï¼‰
3. æ—¥å¿—æ— åˆ†çº§ï¼ˆERROR/WARN/INFO æ··åœ¨ä¸€èµ·ï¼‰
4. æ—¥å¿—æ— è½®è½¬ï¼ˆç£ç›˜å æ»¡ï¼‰

**ä¸šåŠ¡å½±å“**:
- âš ï¸ ç”Ÿäº§ç¯å¢ƒå‡ºé—®é¢˜æ— æ³•å¿«é€Ÿå®šä½
- âš ï¸ æ— æ³•ç»Ÿè®¡é”™è¯¯ç‡ã€å“åº”æ—¶é—´ç­‰æŒ‡æ ‡
- âš ï¸ æ— æ³•å®¡è®¡ç”¨æˆ·æ“ä½œï¼ˆåˆè§„è¦æ±‚ï¼‰

**å®æ–½æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ: ä½¿ç”¨ Python logging + JSON æ ¼å¼**

```python
# src/logger.py
import logging
import json
import sys
from datetime import datetime

class JSONFormatter(logging.Formatter):
    def format(self, record):
        log_obj = {
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno
        }

        # æ·»åŠ é¢å¤–å­—æ®µ
        if hasattr(record, 'user_id'):
            log_obj['user_id'] = record.user_id
        if hasattr(record, 'session_name'):
            log_obj['session_name'] = record.session_name
        if hasattr(record, 'agent_id'):
            log_obj['agent_id'] = record.agent_id

        # æ·»åŠ å¼‚å¸¸ä¿¡æ¯
        if record.exc_info:
            log_obj['exception'] = self.formatException(record.exc_info)

        return json.dumps(log_obj, ensure_ascii=False)

def setup_logger(name: str = "fiido-chat") -> logging.Logger:
    logger = logging.getLogger(name)
    logger.setLevel(logging.INFO)

    # æ§åˆ¶å°è¾“å‡º
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(JSONFormatter())
    logger.addHandler(console_handler)

    # æ–‡ä»¶è¾“å‡ºï¼ˆæŒ‰æ—¥æœŸè½®è½¬ï¼‰
    from logging.handlers import TimedRotatingFileHandler
    file_handler = TimedRotatingFileHandler(
        filename='logs/fiido-chat.log',
        when='midnight',
        interval=1,
        backupCount=30  # ä¿ç•™ 30 å¤©
    )
    file_handler.setFormatter(JSONFormatter())
    logger.addHandler(file_handler)

    return logger

# å…¨å±€ logger
logger = setup_logger()
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# backend.py
from src.logger import logger

@app.post("/api/chat")
async def chat(request: ChatRequest):
    logger.info(
        "æ”¶åˆ°AIå¯¹è¯è¯·æ±‚",
        extra={
            "user_id": request.user_id,
            "message_length": len(request.message)
        }
    )

    try:
        # ... ä¸šåŠ¡é€»è¾‘
        logger.info(
            "AIå“åº”æˆåŠŸ",
            extra={
                "user_id": request.user_id,
                "response_length": len(final_message)
            }
        )
    except Exception as e:
        logger.error(
            "AIå¯¹è¯å¤±è´¥",
            extra={"user_id": request.user_id},
            exc_info=True
        )
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**:

```json
{
  "timestamp": "2025-11-25T10:30:45.123Z",
  "level": "INFO",
  "logger": "fiido-chat",
  "message": "æ”¶åˆ°AIå¯¹è¯è¯·æ±‚",
  "module": "backend",
  "function": "chat",
  "line": 753,
  "user_id": "session_abc123",
  "message_length": 15
}
```

**æ—¥å¿—æŸ¥è¯¢**:

```bash
# æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æ—¥å¿—
cat logs/fiido-chat.log | jq 'select(.user_id == "session_abc123")'

# æŸ¥è¯¢é”™è¯¯æ—¥å¿—
cat logs/fiido-chat.log | jq 'select(.level == "ERROR")'

# ç»Ÿè®¡é”™è¯¯ç‡
cat logs/fiido-chat.log | jq -s 'group_by(.level) | map({level: .[0].level, count: length})'
```

**å·¥ä½œé‡ä¼°ç®—**: 2-3 å¤©

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰ `print()` æ›¿æ¢ä¸º `logger.info/error/warning()`
- [ ] æ—¥å¿—åŒ…å«å…³é”®å­—æ®µï¼ˆuser_id, session_name, agent_idï¼‰
- [ ] æ—¥å¿—æ–‡ä»¶æŒ‰å¤©è½®è½¬ï¼Œä¿ç•™ 30 å¤©
- [ ] å¯é€šè¿‡ jq å·¥å…·å¿«é€ŸæŸ¥è¯¢å’Œåˆ†æ

---

#### P1-2: ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ ğŸŸ  ä¸¥é‡

**å½“å‰çŠ¶æ€**: âŒ æ— ç›‘æ§

**é£é™©ç­‰çº§**: ğŸŸ  **ä¸¥é‡** - æ— æ³•æ„ŸçŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€

**é—®é¢˜æè¿°**:
1. ä¸çŸ¥é“ç³»ç»Ÿæ˜¯å¦æ­£å¸¸è¿è¡Œ
2. æ— æ³•æ„ŸçŸ¥ API å“åº”æ—¶é—´å˜æ…¢
3. æ— æ³•æ„ŸçŸ¥é”™è¯¯ç‡ä¸Šå‡
4. Redis å†…å­˜æ»¡äº†ä¸çŸ¥é“

**ä¸šåŠ¡å½±å“**:
- âš ï¸ ç³»ç»ŸæŒ‚äº†å®¢æˆ·æŠ•è¯‰æ‰çŸ¥é“
- âš ï¸ æ€§èƒ½ä¸‹é™ç”¨æˆ·æµå¤±
- âš ï¸ æ— æ³•è¿›è¡Œå®¹é‡è§„åˆ’

**å®æ–½æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ A: Prometheus + Grafanaï¼ˆæ¨è - å¼€æºå…è´¹ï¼‰**

```python
# å®‰è£…ä¾èµ–
pip3 install prometheus-client

# src/metrics.py
from prometheus_client import Counter, Histogram, Gauge, generate_latest
from prometheus_client import CollectorRegistry
import time

registry = CollectorRegistry()

# è¯·æ±‚è®¡æ•°å™¨
request_count = Counter(
    'fiido_chat_requests_total',
    'æ€»è¯·æ±‚æ•°',
    ['method', 'endpoint', 'status'],
    registry=registry
)

# å“åº”æ—¶é—´ç›´æ–¹å›¾
request_duration = Histogram(
    'fiido_chat_request_duration_seconds',
    'APIå“åº”æ—¶é—´',
    ['method', 'endpoint'],
    registry=registry
)

# SSE è¿æ¥æ•°
sse_connections = Gauge(
    'fiido_chat_sse_connections',
    'å½“å‰SSEè¿æ¥æ•°',
    registry=registry
)

# Redis å†…å­˜ä½¿ç”¨
redis_memory = Gauge(
    'fiido_chat_redis_memory_bytes',
    'Rediså†…å­˜ä½¿ç”¨é‡',
    registry=registry
)
```

**é›†æˆåˆ° FastAPI**:

```python
# backend.py
from src.metrics import (
    request_count, request_duration, sse_connections,
    redis_memory, registry
)
from prometheus_client import generate_latest

@app.middleware("http")
async def prometheus_middleware(request: Request, call_next):
    start_time = time.time()

    response = await call_next(request)

    duration = time.time() - start_time

    # è®°å½•æŒ‡æ ‡
    request_count.labels(
        method=request.method,
        endpoint=request.url.path,
        status=response.status_code
    ).inc()

    request_duration.labels(
        method=request.method,
        endpoint=request.url.path
    ).observe(duration)

    return response

@app.get("/metrics")
async def metrics():
    """Prometheus æŒ‡æ ‡ç«¯ç‚¹"""
    # æ›´æ–° Redis å†…å­˜æŒ‡æ ‡
    if session_store:
        health = session_store.check_health()
        redis_memory.set(health.get('used_memory_bytes', 0))

    return Response(
        content=generate_latest(registry),
        media_type="text/plain"
    )
```

**Prometheus é…ç½®** (`prometheus.yml`):

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'fiido-chat'
    static_configs:
      - targets: ['backend:8000']
```

**Grafana ä»ªè¡¨ç›˜**:

```json
{
  "panels": [
    {
      "title": "API è¯·æ±‚ QPS",
      "targets": [
        {
          "expr": "rate(fiido_chat_requests_total[1m])"
        }
      ]
    },
    {
      "title": "API P99 å“åº”æ—¶é—´",
      "targets": [
        {
          "expr": "histogram_quantile(0.99, rate(fiido_chat_request_duration_seconds_bucket[5m]))"
        }
      ]
    },
    {
      "title": "é”™è¯¯ç‡",
      "targets": [
        {
          "expr": "sum(rate(fiido_chat_requests_total{status=~\"5..\"}[1m])) / sum(rate(fiido_chat_requests_total[1m]))"
        }
      ]
    },
    {
      "title": "SSE è¿æ¥æ•°",
      "targets": [
        {
          "expr": "fiido_chat_sse_connections"
        }
      ]
    }
  ]
}
```

**å‘Šè­¦è§„åˆ™** (`alert.rules.yml`):

```yaml
groups:
  - name: fiido-chat
    interval: 30s
    rules:
      # API é”™è¯¯ç‡è¿‡é«˜
      - alert: HighErrorRate
        expr: |
          sum(rate(fiido_chat_requests_total{status=~"5.."}[5m])) / sum(rate(fiido_chat_requests_total[5m])) > 0.05
        for: 5m
        annotations:
          summary: "API é”™è¯¯ç‡è¶…è¿‡ 5%"

      # API å“åº”æ—¶é—´è¿‡é•¿
      - alert: SlowAPI
        expr: |
          histogram_quantile(0.99, rate(fiido_chat_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        annotations:
          summary: "API P99 å“åº”æ—¶é—´è¶…è¿‡ 2 ç§’"

      # Redis å†…å­˜ä½¿ç”¨è¿‡é«˜
      - alert: RedisMemoryHigh
        expr: fiido_chat_redis_memory_bytes > 400000000
        for: 5m
        annotations:
          summary: "Redis å†…å­˜ä½¿ç”¨è¶…è¿‡ 400MBï¼ˆé™åˆ¶ 512MBï¼‰"
```

**æ–¹æ¡ˆ B: Sentryï¼ˆé”™è¯¯ç›‘æ§ - SaaSï¼‰**

```python
# å®‰è£… Sentry SDK
pip3 install sentry-sdk[fastapi]

# backend.py
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn="https://xxx@sentry.io/xxx",
    traces_sample_rate=0.1,  # é‡‡æ · 10% çš„è¯·æ±‚
    environment="production",
    integrations=[FastApiIntegration()]
)

# è‡ªåŠ¨æ•è·æ‰€æœ‰å¼‚å¸¸
@app.exception_handler(Exception)
async def sentry_exception_handler(request: Request, exc: Exception):
    sentry_sdk.capture_exception(exc)
    raise exc
```

**å·¥ä½œé‡ä¼°ç®—**:
- æ–¹æ¡ˆ A (Prometheus): 3-4 å¤©
- æ–¹æ¡ˆ B (Sentry): 1 å¤©

**éªŒæ”¶æ ‡å‡†**:
- [ ] Grafana ä»ªè¡¨ç›˜æ˜¾ç¤º QPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- [ ] é”™è¯¯ç‡è¶…è¿‡ 5% è‡ªåŠ¨å‘é€å‘Šè­¦é‚®ä»¶
- [ ] API å“åº”æ—¶é—´è¶…è¿‡ 2 ç§’è‡ªåŠ¨å‘Šè­¦
- [ ] Redis å†…å­˜ä½¿ç”¨å®æ—¶ç›‘æ§

---

#### P1-3: å®‰å…¨åŠ å›º ğŸŸ  ä¸¥é‡

**å½“å‰çŠ¶æ€**: âš ï¸ åŸºç¡€å®‰å…¨ï¼Œå­˜åœ¨æ¼æ´

**é£é™©ç­‰çº§**: ğŸŸ  **ä¸¥é‡** - å­˜åœ¨ CSRFã€XSSã€æ³¨å…¥æ”»å‡»é£é™©

**å·²å®ç°å®‰å…¨æªæ–½**:
- âœ… å¯†ç  bcrypt åŠ å¯†
- âœ… JWT Token è®¤è¯
- âœ… CORS é…ç½®ï¼ˆä½†è¿‡äºå®½æ¾ï¼‰
- âœ… æ•æ„Ÿä¿¡æ¯ä¸æš´éœ²ï¼ˆå¯†ç ä¸è¿”å›ï¼‰

**ç¼ºå¤±å®‰å…¨æªæ–½**:
1. âŒ CORS ç™½åå•ï¼ˆå½“å‰ `allow_origins=["*"]` å…è®¸ä»»ä½•åŸŸï¼‰
2. âŒ é€Ÿç‡é™åˆ¶ï¼ˆæ— é˜² DDoS æœºåˆ¶ï¼‰
3. âŒ è¾“å…¥éªŒè¯ï¼ˆSQL æ³¨å…¥ã€XSS é£é™©ï¼‰
4. âŒ CSRF ä¿æŠ¤
5. âŒ æ•æ„Ÿæ“ä½œå®¡è®¡æ—¥å¿—

**å®æ–½æ–¹æ¡ˆ**:

**1. CORS ç™½åå•é…ç½®**:

```python
# backend.py
ALLOWED_ORIGINS = os.getenv("ALLOWED_ORIGINS", "").split(",")

app.add_middleware(
    CORSMiddleware,
    allow_origins=ALLOWED_ORIGINS if ALLOWED_ORIGINS else [
        "https://www.fiido.com",
        "https://chat.fiido.com",
        "http://localhost:5173",  # å¼€å‘ç¯å¢ƒ
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**.env é…ç½®**:
```bash
# ç”Ÿäº§ç¯å¢ƒ
ALLOWED_ORIGINS=https://www.fiido.com,https://chat.fiido.com

# å¼€å‘ç¯å¢ƒ
ALLOWED_ORIGINS=http://localhost:5173,http://192.168.1.100:5173
```

**2. é€Ÿç‡é™åˆ¶**:

```python
# å®‰è£…ä¾èµ–
pip3 install slowapi

# backend.py
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

@app.post("/api/chat")
@limiter.limit("20/minute")  # æ¯åˆ†é’Ÿæœ€å¤š 20 æ¬¡è¯·æ±‚
async def chat(request: ChatRequest):
    pass

@app.post("/api/agent/login")
@limiter.limit("5/minute")  # ç™»å½•æ¥å£æ›´ä¸¥æ ¼é™åˆ¶
async def agent_login(request: LoginRequest):
    pass
```

**3. è¾“å…¥éªŒè¯ä¸è¿‡æ»¤**:

```python
# å®‰è£…ä¾èµ–
pip3 install bleach

# src/security.py
import bleach
import re

def sanitize_input(text: str, max_length: int = 1000) -> str:
    """æ¸…ç†ç”¨æˆ·è¾“å…¥ï¼Œé˜²æ­¢ XSS"""
    # é•¿åº¦é™åˆ¶
    text = text[:max_length]

    # HTML è½¬ä¹‰
    text = bleach.clean(text, tags=[], strip=True)

    # ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼ˆé˜²æ­¢ SQL æ³¨å…¥ï¼‰
    text = re.sub(r'[<>"\']', '', text)

    return text.strip()

def validate_session_id(session_id: str) -> bool:
    """éªŒè¯ session_id æ ¼å¼"""
    # åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
    return bool(re.match(r'^[a-zA-Z0-9_-]{1,100}$', session_id))
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# backend.py
from src.security import sanitize_input, validate_session_id

@app.post("/api/chat")
async def chat(request: ChatRequest):
    # éªŒè¯ session_id
    if not validate_session_id(request.user_id):
        raise HTTPException(400, "Invalid session_id format")

    # æ¸…ç†ç”¨æˆ·è¾“å…¥
    message = sanitize_input(request.message, max_length=2000)

    # ... åç»­é€»è¾‘
```

**4. CSRF ä¿æŠ¤**:

```python
# å®‰è£…ä¾èµ–
pip3 install fastapi-csrf-protect

# backend.py
from fastapi_csrf_protect import CsrfProtect
from fastapi_csrf_protect.exceptions import CsrfProtectError

@app.exception_handler(CsrfProtectError)
def csrf_protect_exception_handler(request: Request, exc: CsrfProtectError):
    return JSONResponse(
        status_code=403,
        content={"detail": "CSRF token validation failed"}
    )

@app.post("/api/manual/messages")
async def manual_message(
    request: dict,
    csrf_protect: CsrfProtect = Depends()
):
    csrf_protect.validate_csrf(request)  # éªŒè¯ CSRF token
    # ... ä¸šåŠ¡é€»è¾‘
```

**5. æ•æ„Ÿæ“ä½œå®¡è®¡æ—¥å¿—**:

```python
# src/audit.py
from src.logger import logger

def audit_log(action: str, user_id: str, details: dict):
    """è®°å½•æ•æ„Ÿæ“ä½œ"""
    logger.warning(
        f"å®¡è®¡: {action}",
        extra={
            "event_type": "audit",
            "action": action,
            "user_id": user_id,
            **details
        }
    )

# ä½¿ç”¨ç¤ºä¾‹
@app.delete("/api/agents/{username}")
async def delete_agent(username: str, admin: Dict = Depends(require_admin)):
    audit_log(
        action="delete_agent",
        user_id=admin.get("username"),
        details={"target_username": username}
    )
    # ... åˆ é™¤é€»è¾‘
```

**å·¥ä½œé‡ä¼°ç®—**: 2-3 å¤©

**éªŒæ”¶æ ‡å‡†**:
- [ ] CORS ä»…å…è®¸ç™½åå•åŸŸåè®¿é—®
- [ ] API è¯·æ±‚é€Ÿç‡é™åˆ¶ç”Ÿæ•ˆï¼ˆè¶…è¿‡é™åˆ¶è¿”å› 429ï¼‰
- [ ] ç”¨æˆ·è¾“å…¥è‡ªåŠ¨æ¸…ç†ï¼Œæ—  XSS æ¼æ´
- [ ] æ•æ„Ÿæ“ä½œæœ‰å®¡è®¡æ—¥å¿—ï¼ˆåˆ é™¤åå¸­ã€ä¿®æ”¹å¯†ç ç­‰ï¼‰
- [ ] é€šè¿‡ OWASP ZAP å®‰å…¨æ‰«æï¼ˆæ— é«˜å±æ¼æ´ï¼‰

---

#### P1-4: é”™è¯¯å¤„ç†æ”¹è¿› ğŸŸ  ä¸­ç­‰

**å½“å‰çŠ¶æ€**: âš ï¸ åŸºç¡€é”™è¯¯å¤„ç†ï¼Œç”¨æˆ·ä½“éªŒå·®

**é—®é¢˜æè¿°**:
1. é”™è¯¯æ¶ˆæ¯ä¸å‹å¥½ï¼ˆç›´æ¥è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼‰
2. é”™è¯¯ç ä¸ç»Ÿä¸€ï¼ˆHTTP 500 / 400 / 409 æ··ç”¨ï¼‰
3. é”™è¯¯æœªåˆ†ç±»ï¼ˆç½‘ç»œé”™è¯¯ã€ä¸šåŠ¡é”™è¯¯ã€ç³»ç»Ÿé”™è¯¯ï¼‰

**å®æ–½æ–¹æ¡ˆ**:

**1. ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼**:

```python
# src/errors.py
from enum import Enum

class ErrorCode(str, Enum):
    # å®¢æˆ·ç«¯é”™è¯¯ (4xx)
    INVALID_INPUT = "INVALID_INPUT"
    UNAUTHORIZED = "UNAUTHORIZED"
    FORBIDDEN = "FORBIDDEN"
    NOT_FOUND = "NOT_FOUND"
    RATE_LIMIT = "RATE_LIMIT_EXCEEDED"

    # ä¸šåŠ¡é”™è¯¯ (4xx)
    SESSION_IN_MANUAL_MODE = "SESSION_IN_MANUAL_MODE"
    ALREADY_TAKEN = "ALREADY_TAKEN"
    USERNAME_EXISTS = "USERNAME_EXISTS"
    OLD_PASSWORD_INCORRECT = "OLD_PASSWORD_INCORRECT"

    # æœåŠ¡å™¨é”™è¯¯ (5xx)
    INTERNAL_ERROR = "INTERNAL_ERROR"
    COZE_API_ERROR = "COZE_API_ERROR"
    REDIS_ERROR = "REDIS_ERROR"

class AppException(Exception):
    def __init__(
        self,
        code: ErrorCode,
        message: str,
        status_code: int = 400,
        details: dict = None
    ):
        self.code = code
        self.message = message
        self.status_code = status_code
        self.details = details or {}

# å…¨å±€å¼‚å¸¸å¤„ç†å™¨
@app.exception_handler(AppException)
async def app_exception_handler(request: Request, exc: AppException):
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "error": {
                "code": exc.code,
                "message": exc.message,
                "details": exc.details
            }
        }
    )
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# backend.py
from src.errors import AppException, ErrorCode

@app.post("/api/chat")
async def chat(request: ChatRequest):
    # ä¸šåŠ¡é”™è¯¯
    if session_state.status == SessionStatus.MANUAL_LIVE:
        raise AppException(
            code=ErrorCode.SESSION_IN_MANUAL_MODE,
            message="å½“å‰ä¼šè¯æ­£åœ¨äººå·¥æœåŠ¡ä¸­ï¼Œè¯·ç¨å€™",
            status_code=409,
            details={"session_status": "manual_live"}
        )

    try:
        # ... Coze API è°ƒç”¨
    except httpx.TimeoutException:
        raise AppException(
            code=ErrorCode.COZE_API_ERROR,
            message="AI æœåŠ¡æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åé‡è¯•",
            status_code=503
        )
    except Exception as e:
        # æœªçŸ¥é”™è¯¯
        logger.error("æœªçŸ¥é”™è¯¯", exc_info=True)
        raise AppException(
            code=ErrorCode.INTERNAL_ERROR,
            message="ç³»ç»Ÿå†…éƒ¨é”™è¯¯",
            status_code=500
        )
```

**å‰ç«¯é”™è¯¯å¤„ç†**:

```typescript
// frontend/src/api/chat.ts
try {
  const response = await fetch('/api/chat', { ... })
  const data = await response.json()

  if (!response.ok) {
    const error = data.error

    // æ ¹æ®é”™è¯¯ç æ˜¾ç¤ºå‹å¥½æç¤º
    switch (error.code) {
      case 'SESSION_IN_MANUAL_MODE':
        showToast('æ­£åœ¨äººå·¥æœåŠ¡ä¸­ï¼Œè¯·ç¨å€™')
        break
      case 'RATE_LIMIT_EXCEEDED':
        showToast('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•')
        break
      default:
        showToast(error.message)
    }
  }
} catch (e) {
  showToast('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ')
}
```

**å·¥ä½œé‡ä¼°ç®—**: 2 å¤©

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰é”™è¯¯è¿”å›ç»Ÿä¸€æ ¼å¼
- [ ] é”™è¯¯ç æ˜ç¡®åˆ†ç±»ï¼ˆå®¢æˆ·ç«¯/ä¸šåŠ¡/æœåŠ¡å™¨ï¼‰
- [ ] å‰ç«¯æ˜¾ç¤ºå‹å¥½é”™è¯¯æç¤ºï¼ˆä¸æ˜¾ç¤ºæŠ€æœ¯ç»†èŠ‚ï¼‰
- [ ] é”™è¯¯æ—¥å¿—åŒ…å«å®Œæ•´å †æ ˆä¿¡æ¯

---

### P2 çº§ - å¯é€‰ä¼˜åŒ– (5 é¡¹)

#### P2-1: æ€§èƒ½ä¼˜åŒ–

- å‰ç«¯è™šæ‹Ÿæ»šåŠ¨ï¼ˆå†å²æ¶ˆæ¯ > 100 æ¡ï¼‰
- Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼ˆåå¸­åˆ—è¡¨ã€ä¼šè¯ç»Ÿè®¡ï¼‰
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ·»åŠ ç´¢å¼•ï¼‰
- é™æ€èµ„æº CDN åŠ é€Ÿ

**å·¥ä½œé‡**: 3-5 å¤©

---

#### P2-2: é«˜çº§ç›‘æ§

- APM æ€§èƒ½ç›‘æ§ï¼ˆDatadog/New Relicï¼‰
- ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆGoogle Analyticsï¼‰
- é”™è¯¯å›æ”¾ï¼ˆLogRocket/FullStoryï¼‰

**å·¥ä½œé‡**: 2-3 å¤©

---

#### P2-3: å†å²æ•°æ®æŸ¥è¯¢

- ä¼šè¯å†å²æŸ¥è¯¢ API
- æ¶ˆæ¯å…¨æ–‡æœç´¢ï¼ˆElasticsearchï¼‰
- æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼ˆCSV/Excelï¼‰

**å·¥ä½œé‡**: 5-7 å¤©

---

#### P2-4: å¤šè¯­è¨€æ”¯æŒ

- i18n å›½é™…åŒ–ï¼ˆä¸­æ–‡/è‹±æ–‡/å¾·æ–‡/æ³•æ–‡ï¼‰
- å‰ç«¯è¯­è¨€åˆ‡æ¢
- åç«¯å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯

**å·¥ä½œé‡**: 3-5 å¤©

---

#### P2-5: ç§»åŠ¨ç«¯é€‚é…

- å“åº”å¼å¸ƒå±€ä¼˜åŒ–
- è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
- PWAï¼ˆç¦»çº¿ä½¿ç”¨ï¼‰

**å·¥ä½œé‡**: 2-3 å¤©

---

## ğŸ“‹ å¼€å‘ä¼˜å…ˆçº§ä¸æ—¶é—´è¡¨

### é˜¶æ®µ 1: ç”Ÿäº§éƒ¨ç½²åŸºç¡€ï¼ˆ1-2 å‘¨ï¼‰

**ç›®æ ‡**: æ»¡è¶³æœ€ä½ç”Ÿäº§éƒ¨ç½²è¦æ±‚

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | è´Ÿè´£äºº | çŠ¶æ€ |
|------|--------|--------|--------|------|
| HTTPS + Nginx é…ç½® | P0 | 1-2 å¤© | DevOps | âŒ å¾…å¼€å§‹ |
| å‰ç«¯åµŒå…¥ SDK (iframe) | P0 | 1-2 å¤© | å‰ç«¯ | âŒ å¾…å¼€å§‹ |
| Docker å®¹å™¨åŒ– | P0 | 1-2 å¤© | DevOps | âŒ å¾…å¼€å§‹ |
| ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ | P1 | 2-3 å¤© | åç«¯ | âŒ å¾…å¼€å§‹ |

**é‡Œç¨‹ç¢‘**:
- âœ… é€šè¿‡ 12/12 å›å½’æµ‹è¯•
- âœ… HTTPS éƒ¨ç½²æˆåŠŸ
- âœ… å‰ç«¯æˆåŠŸåµŒå…¥ Fiido å®˜ç½‘
- âœ… æ—¥å¿—æŒä¹…åŒ–å¹¶å¯æŸ¥è¯¢

---

### é˜¶æ®µ 2: å®‰å…¨ä¸ç›‘æ§ï¼ˆ2-3 å‘¨ï¼‰

**ç›®æ ‡**: æå‡ç³»ç»Ÿç¨³å®šæ€§å’Œå®‰å…¨æ€§

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | è´Ÿè´£äºº | çŠ¶æ€ |
|------|--------|--------|--------|------|
| Prometheus ç›‘æ§ | P1 | 3-4 å¤© | åç«¯ | âŒ å¾…å¼€å§‹ |
| Grafana ä»ªè¡¨ç›˜ | P1 | 1 å¤© | DevOps | âŒ å¾…å¼€å§‹ |
| å®‰å…¨åŠ å›ºï¼ˆCORS/é€Ÿç‡é™åˆ¶ï¼‰ | P1 | 2-3 å¤© | åç«¯ | âŒ å¾…å¼€å§‹ |
| é”™è¯¯å¤„ç†æ”¹è¿› | P1 | 2 å¤© | å…¨æ ˆ | âŒ å¾…å¼€å§‹ |

**é‡Œç¨‹ç¢‘**:
- âœ… Grafana æ˜¾ç¤ºå®æ—¶æŒ‡æ ‡
- âœ… å‘Šè­¦é‚®ä»¶æ­£å¸¸å‘é€
- âœ… é€šè¿‡ OWASP å®‰å…¨æ‰«æ

---

### é˜¶æ®µ 3: å¯é€‰ä¼˜åŒ–ï¼ˆæŒ‰éœ€ï¼‰

**ç›®æ ‡**: æå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | çŠ¶æ€ |
|------|--------|--------|------|
| æ€§èƒ½ä¼˜åŒ– | P2 | 3-5 å¤© | âŒ å¾…å¼€å§‹ |
| é«˜çº§ç›‘æ§ | P2 | 2-3 å¤© | âŒ å¾…å¼€å§‹ |
| å†å²æ•°æ®æŸ¥è¯¢ | P2 | 5-7 å¤© | âŒ å¾…å¼€å§‹ |
| å¤šè¯­è¨€æ”¯æŒ | P2 | 3-5 å¤© | âŒ å¾…å¼€å§‹ |

---

## ğŸ’° æˆæœ¬ä¼°ç®—

### å¼€å‘æˆæœ¬

| é˜¶æ®µ | äººå¤© | æˆæœ¬ï¼ˆæŒ‰ Â¥1000/å¤©ï¼‰ |
|------|------|---------------------|
| é˜¶æ®µ 1 (P0) | 7-9 å¤© | Â¥7,000 - Â¥9,000 |
| é˜¶æ®µ 2 (P1) | 8-10 å¤© | Â¥8,000 - Â¥10,000 |
| é˜¶æ®µ 3 (P2) | 15-20 å¤© | Â¥15,000 - Â¥20,000 |
| **æ€»è®¡** | **30-39 å¤©** | **Â¥30,000 - Â¥39,000** |

### è¿ç»´æˆæœ¬ï¼ˆæœˆï¼‰

| é¡¹ç›® | é…ç½® | æˆæœ¬ï¼ˆæœˆï¼‰ |
|------|------|-----------|
| æœåŠ¡å™¨ | 4C8Gï¼ˆé˜¿é‡Œäº‘ï¼‰ | Â¥300 |
| Redis | 1GBï¼ˆäº‘æ•°æ®åº“ï¼‰ | Â¥100 |
| SSL è¯ä¹¦ | Let's Encrypt | Â¥0 |
| åŸŸå | chat.fiido.com | Â¥50 |
| CDN æµé‡ | 100GB | Â¥50 |
| Sentryï¼ˆé”™è¯¯ç›‘æ§ï¼‰ | æ ‡å‡†ç‰ˆ | $26 (Â¥180) |
| **æ€»è®¡** | - | **Â¥680/æœˆ** |

---

## âš ï¸ é£é™©è¯„ä¼°

### é«˜é£é™© ğŸ”´

| é£é™©é¡¹ | å½±å“ | å¯èƒ½æ€§ | åº”å¯¹æªæ–½ |
|--------|------|--------|----------|
| æ—  HTTPS éƒ¨ç½² | æ•°æ®æ³„éœ²ã€æ— æ³•ä¸Šçº¿ | 100% | **å¿…é¡»å®æ–½** P0-1 |
| æ— å‰ç«¯åµŒå…¥ SDK | æ— æ³•é›†æˆå®˜ç½‘ | 100% | **å¿…é¡»å®æ–½** P0-2 |
| æ— æ—¥å¿—ç³»ç»Ÿ | é—®é¢˜æ— æ³•è¿½æº¯ | 80% | **å¼ºçƒˆå»ºè®®** P1-1 |
| æ— ç›‘æ§å‘Šè­¦ | æ•…éšœæ„ŸçŸ¥å»¶è¿Ÿ | 70% | **å¼ºçƒˆå»ºè®®** P1-2 |

### ä¸­é£é™© ğŸŸ 

| é£é™©é¡¹ | å½±å“ | å¯èƒ½æ€§ | åº”å¯¹æªæ–½ |
|--------|------|--------|----------|
| æ€§èƒ½é—®é¢˜ | ç”¨æˆ·ä½“éªŒä¸‹é™ | 40% | è´Ÿè½½æµ‹è¯• + P2-1 ä¼˜åŒ– |
| å®‰å…¨æ¼æ´ | æ•°æ®æ³„éœ²ã€æ”»å‡» | 30% | **å»ºè®®å®æ–½** P1-3 |
| Docker éƒ¨ç½²å¤æ‚ | éƒ¨ç½²å¤±è´¥ | 20% | å®Œå–„æ–‡æ¡£ + æµ‹è¯•ç¯å¢ƒéªŒè¯ |

### ä½é£é™© ğŸŸ¢

| é£é™©é¡¹ | å½±å“ | å¯èƒ½æ€§ | åº”å¯¹æªæ–½ |
|--------|------|--------|----------|
| æµè§ˆå™¨å…¼å®¹æ€§ | éƒ¨åˆ†ç”¨æˆ·æ— æ³•ä½¿ç”¨ | 10% | æµ‹è¯•ä¸»æµæµè§ˆå™¨ |
| Redis å†…å­˜ä¸è¶³ | é™çº§åˆ°å†…å­˜å­˜å‚¨ | 5% | ç›‘æ§ + è‡ªåŠ¨å‘Šè­¦ |

---

## âœ… ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥

#### å®‰å…¨æ€§
- [ ] æ‰€æœ‰æ¥å£ä½¿ç”¨ HTTPS
- [ ] CORS é…ç½®ç™½åå•ï¼ˆç§»é™¤ `allow_origins=["*"]`ï¼‰
- [ ] é€Ÿç‡é™åˆ¶å·²å¯ç”¨ï¼ˆé˜² DDoSï¼‰
- [ ] è¾“å…¥éªŒè¯å·²å®æ–½ï¼ˆé˜² XSS/SQL æ³¨å…¥ï¼‰
- [ ] æ•æ„Ÿä¿¡æ¯ä¸è¿”å›ï¼ˆå¯†ç  hashã€ç§é’¥ï¼‰
- [ ] JWT å¯†é’¥å·²æ›´æ¢ï¼ˆéé»˜è®¤å€¼ï¼‰
- [ ] Redis å¯†ç å·²è®¾ç½®

#### å¯é æ€§
- [ ] å›å½’æµ‹è¯• 12/12 é€šè¿‡
- [ ] Redis è¿æ¥æ± é…ç½®ï¼ˆmax_connections=50ï¼‰
- [ ] HTTP è¶…æ—¶é…ç½®ï¼ˆconnect=10s, read=30sï¼‰
- [ ] é™çº§ç­–ç•¥æµ‹è¯•ï¼ˆRedis å¤±è´¥æ—¶ï¼‰
- [ ] æ—¥å¿—è½®è½¬é…ç½®ï¼ˆä¿ç•™ 30 å¤©ï¼‰
- [ ] ç›‘æ§å‘Šè­¦å·²é…ç½®

#### æ€§èƒ½
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆ100 å¹¶å‘ç”¨æˆ·ï¼‰
- [ ] SSE è¿æ¥æ•°é™åˆ¶ï¼ˆæ¯ç”¨æˆ· 3 ä¸ªï¼‰
- [ ] Redis å†…å­˜é™åˆ¶ï¼ˆmaxmemory=512mbï¼‰
- [ ] é™æ€èµ„æº CDN åŠ é€Ÿ
- [ ] å‰ç«¯è™šæ‹Ÿæ»šåŠ¨ï¼ˆ> 100 æ¡æ¶ˆæ¯ï¼‰

#### è¿ç»´
- [ ] Docker é•œåƒæ„å»ºæˆåŠŸ
- [ ] docker-compose ä¸€é”®å¯åŠ¨
- [ ] å¤‡ä»½ç­–ç•¥ï¼ˆRedis RDB + AOFï¼‰
- [ ] å›æ»šæ–¹æ¡ˆï¼ˆä¿ç•™ 3 ä¸ªç‰ˆæœ¬ï¼‰
- [ ] ç›‘æ§ä»ªè¡¨ç›˜å¯è®¿é—®
- [ ] å‘Šè­¦é€šçŸ¥æ¸ é“é…ç½®ï¼ˆé‚®ä»¶/é’‰é’‰ï¼‰

---

## ğŸ“Š è¡¥å……åŠŸèƒ½éœ€æ±‚å»ºè®®

åŸºäºä¼ä¸šéƒ¨ç½²éœ€æ±‚å’Œ Fiido ä¸šåŠ¡åœºæ™¯ï¼Œå»ºè®®è¡¥å……ä»¥ä¸‹åŠŸèƒ½ï¼š

### æ–°å¢ P1 åŠŸèƒ½

#### 1. ä¼šè¯è¶…æ—¶è‡ªåŠ¨å…³é—­ â­ **å»ºè®®æ–°å¢**

**åœºæ™¯**: ç”¨æˆ·é•¿æ—¶é—´æœªæ´»åŠ¨ï¼Œä¼šè¯å ç”¨èµ„æº

**å®æ–½**:
```python
# src/session_timeout.py
IDLE_TIMEOUT = 1800  # 30 åˆ†é’Ÿæ— æ´»åŠ¨è‡ªåŠ¨å…³é—­

async def check_idle_sessions():
    while True:
        await asyncio.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

        current_time = time.time()
        sessions = await session_store.list_all()

        for session in sessions:
            if session.status == SessionStatus.BOT_ACTIVE:
                idle_time = current_time - session.updated_at

                if idle_time > IDLE_TIMEOUT:
                    session.transition_status(SessionStatus.CLOSED)
                    await session_store.save(session)
                    logger.info(f"ä¼šè¯è¶…æ—¶å…³é—­: {session.session_name}")
```

**å·¥ä½œé‡**: 1 å¤©

---

#### 2. åå¸­å·¥ä½œé‡ç»Ÿè®¡ â­ **å»ºè®®æ–°å¢**

**åœºæ™¯**: ç®¡ç†å‘˜éœ€è¦æŸ¥çœ‹æ¯ä¸ªåå¸­çš„å·¥ä½œé‡

**å®æ–½**:
```python
@app.get("/api/admin/agent-stats")
async def get_agent_stats(admin: Dict = Depends(require_admin)):
    """
    è¿”å›ï¼š
    - æ¯ä¸ªåå¸­ä»Šæ—¥æ¥å¾…ä¼šè¯æ•°
    - å¹³å‡å“åº”æ—¶é—´
    - å¹³å‡æœåŠ¡æ—¶é•¿
    - å®¢æˆ·æ»¡æ„åº¦ï¼ˆå¦‚æœæœ‰è¯„ä»·åŠŸèƒ½ï¼‰
    """
    pass
```

**å·¥ä½œé‡**: 2 å¤©

---

#### 3. è‡ªåŠ¨åˆ†é…åå¸­ â­ **å»ºè®®æ–°å¢**

**åœºæ™¯**: pending_manual ä¼šè¯è‡ªåŠ¨åˆ†é…ç»™ç©ºé—²åå¸­

**å®æ–½**:
```python
# src/auto_assign.py
async def auto_assign_agent(session_name: str):
    """
    æ ¹æ®ç­–ç•¥è‡ªåŠ¨åˆ†é…åå¸­ï¼š
    1. ä¼˜å…ˆåˆ†é…ç©ºé—²åå¸­
    2. å…¶æ¬¡åˆ†é…å½“å‰ä¼šè¯æ•°æœ€å°‘çš„åå¸­
    3. è€ƒè™‘åå¸­æŠ€èƒ½æ ‡ç­¾ï¼ˆVIP å®¢æˆ·ä¼˜å…ˆé«˜çº§åå¸­ï¼‰
    """
    pass
```

**å·¥ä½œé‡**: 2-3 å¤©

---

### æ–°å¢ P2 åŠŸèƒ½

#### 4. å®¢æˆ·æ»¡æ„åº¦è¯„ä»· â­ **å»ºè®®æ–°å¢**

**åœºæ™¯**: ä¼šè¯ç»“æŸåï¼Œç”¨æˆ·å¯ä»¥è¯„ä»·åå¸­æœåŠ¡

**å®æ–½**:
```python
@app.post("/api/sessions/{session_name}/rate")
async def rate_session(
    session_name: str,
    rating: int,  # 1-5 æ˜Ÿ
    comment: str
):
    """ä¿å­˜è¯„ä»·åˆ°ä¼šè¯è®°å½•"""
    pass
```

**å·¥ä½œé‡**: 2 å¤©

---

#### 5. å¸¸è§é—®é¢˜å¿«æ·å›å¤ â­ **å»ºè®®æ–°å¢**

**åœºæ™¯**: åå¸­å¯ä»¥å¿«é€Ÿæ’å…¥é¢„è®¾å›å¤

**å®æ–½**:
```python
# åå¸­å·¥ä½œå°æ·»åŠ å¿«æ·å›å¤é¢æ¿
quickReplies = [
  { id: 1, text: "æ‚¨å¥½ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼" },
  { id: 2, text: "è¯·ç¨ç­‰ï¼Œæˆ‘å¸®æ‚¨æŸ¥è¯¢ä¸€ä¸‹" },
  { id: 3, text: "æ„Ÿè°¢æ‚¨çš„è€å¿ƒç­‰å¾…" },
  // ...
]
```

**å·¥ä½œé‡**: 1 å¤©

---

## ğŸ¯ æ€»ç»“ä¸å»ºè®®

### å½“å‰ç³»ç»Ÿè¯„ä»·

Fiido æ™ºèƒ½å®¢æœç³»ç»Ÿ v3.1.3 **æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å®ç°**ï¼ŒåŒ…æ‹¬ï¼š
- âœ… AI æ™ºèƒ½å¯¹è¯ï¼ˆä¼šè¯éš”ç¦»ã€å¤šè½®å¯¹è¯ï¼‰
- âœ… äººå·¥æ¥ç®¡æµç¨‹ï¼ˆ5 ç§çŠ¶æ€ã€é˜²æŠ¢å•ï¼‰
- âœ… åå¸­è®¤è¯ä¸ç®¡ç†ï¼ˆJWT + bcrypt + RBACï¼‰
- âœ… æ•°æ®æŒä¹…åŒ–ï¼ˆRedis + é™çº§ç­–ç•¥ï¼‰
- âœ… å®æ—¶æ¶ˆæ¯æ¨é€ï¼ˆSSEï¼‰
- âœ… ç”¨æˆ·ç«¯å’Œåå¸­å·¥ä½œå°å‰ç«¯

**åŠŸèƒ½å®Œæˆåº¦**: 98%ï¼ˆP0+P1 æ ¸å¿ƒåŠŸèƒ½ï¼‰
**ç”Ÿäº§å°±ç»ªåº¦**: 60%ï¼ˆç¼ºå°‘éƒ¨ç½²é…ç½®å’Œç›‘æ§ï¼‰

---

### ä¼˜å…ˆçº§å»ºè®®

#### ç¬¬ 1 å‘¨ï¼ˆå¿…é¡»å®Œæˆï¼‰
1. âœ… **HTTPS + Nginx éƒ¨ç½²** - å®‰å…¨åŸºç¡€
2. âœ… **å‰ç«¯åµŒå…¥ SDK** - ä¸šåŠ¡éœ€æ±‚
3. âœ… **Docker å®¹å™¨åŒ–** - æ ‡å‡†åŒ–éƒ¨ç½²

**ç›®æ ‡**: ç³»ç»Ÿå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼Œå¹¶åµŒå…¥ Fiido å®˜ç½‘

---

#### ç¬¬ 2 å‘¨ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰
1. âœ… **ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ** - é—®é¢˜è¿½æº¯
2. âœ… **Prometheus ç›‘æ§** - ç³»ç»Ÿå¥åº·
3. âœ… **å®‰å…¨åŠ å›º** - CORS + é€Ÿç‡é™åˆ¶

**ç›®æ ‡**: ç³»ç»Ÿç¨³å®šæ€§å’Œå®‰å…¨æ€§è¾¾åˆ°ä¼ä¸šæ ‡å‡†

---

#### ç¬¬ 3 å‘¨åŠä»¥åï¼ˆå¯é€‰ï¼‰
1. é”™è¯¯å¤„ç†æ”¹è¿›
2. æ€§èƒ½ä¼˜åŒ–
3. ä¼šè¯è¶…æ—¶è‡ªåŠ¨å…³é—­
4. åå¸­å·¥ä½œé‡ç»Ÿè®¡
5. å¤šè¯­è¨€æ”¯æŒ

**ç›®æ ‡**: æå‡ç”¨æˆ·ä½“éªŒå’Œè¿è¥æ•ˆç‡

---

### æœ€ç»ˆå»ºè®®

**Q: ç³»ç»Ÿç°åœ¨èƒ½å¦ç›´æ¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼Ÿ**

**A**: âŒ **ä¸èƒ½** - å¿…é¡»å®Œæˆ P0 çº§åŠŸèƒ½ï¼ˆHTTPS + åµŒå…¥ SDK + Dockerï¼‰

**Q: éœ€è¦å¤šä¹…å¯ä»¥ä¸Šçº¿ï¼Ÿ**

**A**: âœ… **1-2 å‘¨** - å®Œæˆ P0 çº§åŠŸèƒ½åå³å¯ä¸Šçº¿

**Q: æœ€ä½é¢„ç®—éœ€è¦å¤šå°‘ï¼Ÿ**

**A**: âœ… **Â¥7,000 - Â¥9,000**ï¼ˆå¼€å‘ï¼‰ + **Â¥680/æœˆ**ï¼ˆè¿ç»´ï¼‰

**Q: æœ‰å“ªäº›åŠŸèƒ½éœ€è¦è¡¥å……ï¼Ÿ**

**A**: å»ºè®®æ–°å¢ 3 ä¸ª P1 åŠŸèƒ½ï¼š
1. ä¼šè¯è¶…æ—¶è‡ªåŠ¨å…³é—­
2. åå¸­å·¥ä½œé‡ç»Ÿè®¡
3. è‡ªåŠ¨åˆ†é…åå¸­

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ç”Ÿæˆæ—¥æœŸ**: 2025-11-25
**ä¸‹æ¬¡è¯„ä¼°**: å®Œæˆ P0 åŠŸèƒ½å
