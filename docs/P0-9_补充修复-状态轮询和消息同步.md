# P0-9 è¡¥å……ä¿®å¤ï¼šçŠ¶æ€è½®è¯¢å’Œæ¶ˆæ¯åŒæ­¥

## ðŸ“… åŸºæœ¬ä¿¡æ¯

- **ä¿®å¤æ—¥æœŸ**: 2025-11-21
- **é—®é¢˜ç±»åž‹**: åŠŸèƒ½å¢žå¼º / Bugä¿®å¤
- **å½±å“èŒƒå›´**: äººå·¥æŽ¥ç®¡åŠŸèƒ½çš„å®žæ—¶æ€§
- **å¼€å‘äººå‘˜**: Claude Code

---

## ðŸ› é—®é¢˜æè¿°

### é—®é¢˜1: åå¸­æŽ¥å…¥åŽå‰ç«¯çŠ¶æ€æœªæ›´æ–°

**çŽ°è±¡**:
- ç”¨æˆ·ç‚¹å‡»"è½¬äººå·¥" â†’ çŠ¶æ€å˜ä¸º `pending_manual` âœ…
- è¿è¡Œ `curl` å‘½ä»¤åå¸­æŽ¥å…¥ â†’ åŽç«¯è¿”å›ž `"status":"manual_live"` âœ…
- **ä½†å‰ç«¯é¡µé¢ä»æ˜¾ç¤ºé»„è‰²ç­‰å¾…æç¤º** âŒ

**æ ¹å› **:
- å‰ç«¯æ²¡æœ‰å»ºç«‹ SSE è¿žæŽ¥ï¼ˆå› ä¸ºåœ¨ `pending_manual` çŠ¶æ€ä¸‹ç”¨æˆ·æ²¡æœ‰å‘é€æ¶ˆæ¯ï¼‰
- åŽç«¯çš„çŠ¶æ€å˜åŒ–äº‹ä»¶æ— æ³•é€šè¿‡ SSE æŽ¨é€åˆ°å‰ç«¯

### é—®é¢˜2: åå¸­å›žå¤åŽå‰ç«¯ä¸æ˜¾ç¤º

**çŽ°è±¡**:
- è¿è¡Œ `curl` å‘½ä»¤åå¸­å‘é€æ¶ˆæ¯ â†’ åŽç«¯è¿”å›ž `{"success":true}` âœ…
- **ä½†å‰ç«¯èŠå¤©ç•Œé¢æ²¡æœ‰æ˜¾ç¤ºåå¸­æ¶ˆæ¯** âŒ

**æ ¹å› **:
- åŒæ ·æ˜¯å› ä¸ºæ²¡æœ‰ SSE è¿žæŽ¥
- åŽç«¯æ£€æŸ¥ `if session_name in sse_queues`ï¼Œå‘çŽ°é˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œæ— æ³•æŽ¨é€æ¶ˆæ¯
- æ¶ˆæ¯è¢«ä¿å­˜åˆ°åŽç«¯ `session.history`ï¼Œä½†å‰ç«¯ä¸çŸ¥é“

---

## ðŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

å®žçŽ°**æ™ºèƒ½çŠ¶æ€è½®è¯¢ + åŽ†å²æ¶ˆæ¯åŒæ­¥**æœºåˆ¶ï¼š

1. **è‡ªåŠ¨è½®è¯¢**: åœ¨ `pending_manual` æˆ– `manual_live` çŠ¶æ€ä¸‹ï¼Œæ¯2ç§’è½®è¯¢ä¸€æ¬¡ä¼šè¯çŠ¶æ€
2. **çŠ¶æ€åŒæ­¥**: æ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–æ—¶ï¼Œç«‹å³æ›´æ–°å‰ç«¯çŠ¶æ€
3. **æ¶ˆæ¯åŒæ­¥**: æ¯”è¾ƒå‰åŽç«¯æ¶ˆæ¯æ—¶é—´æˆ³ï¼Œè‡ªåŠ¨æ‹‰å–æ–°æ¶ˆæ¯
4. **æ™ºèƒ½åœæ­¢**: çŠ¶æ€æ¢å¤ä¸º `bot_active` æˆ– `closed` æ—¶è‡ªåŠ¨åœæ­¢è½®è¯¢

---

## ðŸ”§ å®žçŽ°ç»†èŠ‚

### 1. æ·»åŠ è½®è¯¢å˜é‡å’Œå¯¼å…¥

```typescript
import { ref, computed, onMounted, onUnmounted, nextTick, watch } from 'vue'

let statusPollInterval: number | null = null
```

### 2. å®žçŽ°è½®è¯¢å‡½æ•° `pollSessionStatus()`

**æ ¸å¿ƒé€»è¾‘**:

```typescript
const pollSessionStatus = async () => {
  // è°ƒç”¨ GET /api/sessions/{session_name}
  const response = await fetch(`${API_BASE_URL.value}/api/sessions/${chatStore.sessionId}`)
  const data = await response.json()
  const session = data.data.session

  // 1ï¸âƒ£ æ£€æµ‹çŠ¶æ€å˜åŒ–
  if (session.status !== chatStore.sessionStatus) {
    console.log(`ðŸ”„ çŠ¶æ€è½®è¯¢: ${chatStore.sessionStatus} â†’ ${session.status}`)
    chatStore.updateSessionStatus(session.status)

    // ä¿å­˜åå¸­ä¿¡æ¯
    if (session.status === 'manual_live' && session.assigned_agent) {
      chatStore.setAgentInfo({ ... })
    }
  }

  // 2ï¸âƒ£ åŒæ­¥åŽ†å²æ¶ˆæ¯ï¼ˆå…³é”®æ–°å¢žï¼‰
  if (session.history && session.history.length > 0) {
    const lastBackendTimestamp = session.history[session.history.length - 1].timestamp
    const lastFrontendTimestamp = /* å‰ç«¯æœ€åŽä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³ */

    // å¦‚æžœåŽç«¯æœ‰æ–°æ¶ˆæ¯
    if (lastBackendTimestamp > lastFrontendTimestamp) {
      console.log('ðŸ“¨ æ£€æµ‹åˆ°æ–°æ¶ˆæ¯ï¼ŒåŒæ­¥åŽ†å²')

      // æå–æ‰€æœ‰æ–°æ¶ˆæ¯
      const newMessages = session.history.filter(msg =>
        msg.timestamp > lastFrontendTimestamp
      )

      // æ·»åŠ åˆ°å‰ç«¯ï¼ˆé¿å…é‡å¤ï¼‰
      newMessages.forEach(msg => {
        if (!exists) {
          chatStore.addMessage({ ... })
        }
      })

      scrollToBottom()
    }
  }
}
```

### 3. å¯åŠ¨å’Œåœæ­¢è½®è¯¢

```typescript
const startStatusPolling = () => {
  console.log('ðŸ”„ å¯åŠ¨çŠ¶æ€è½®è¯¢')
  statusPollInterval = window.setInterval(() => {
    const status = chatStore.sessionStatus
    if (status === 'pending_manual' || status === 'manual_live') {
      pollSessionStatus()
    } else {
      stopStatusPolling()
    }
  }, 2000) // æ¯2ç§’ä¸€æ¬¡
}

const stopStatusPolling = () => {
  console.log('â¸ï¸  åœæ­¢çŠ¶æ€è½®è¯¢')
  clearInterval(statusPollInterval)
  statusPollInterval = null
}
```

### 4. ç›‘å¬çŠ¶æ€å˜åŒ–è‡ªåŠ¨æŽ§åˆ¶

```typescript
watch(() => chatStore.sessionStatus, (newStatus) => {
  if (newStatus === 'pending_manual' || newStatus === 'manual_live') {
    startStatusPolling()
  } else if (newStatus === 'bot_active' || newStatus === 'closed') {
    stopStatusPolling()
  }
})
```

### 5. ç»„ä»¶å¸è½½æ—¶æ¸…ç†

```typescript
onUnmounted(() => {
  stopStatusPolling()
  document.removeEventListener('click', handleClickOutside)
})
```

---

## âœ… ä¿®å¤åŽçš„è¡Œä¸º

### åœºæ™¯1: åå¸­æŽ¥å…¥

**ç”¨æˆ·æ“ä½œ**:
1. ç‚¹å‡»"è½¬äººå·¥" â†’ `pending_manual`
2. æŽ§åˆ¶å°è¾“å‡º: "ðŸ”„ å¯åŠ¨çŠ¶æ€è½®è¯¢"

**åŽç«¯æ“ä½œ**:
```bash
curl -X POST .../takeover ...
```

**å‰ç«¯è‡ªåŠ¨å“åº”** (æœ€å¤š2ç§’å»¶è¿Ÿ):
1. æŽ§åˆ¶å°è¾“å‡º: "ðŸ”„ çŠ¶æ€è½®è¯¢: pending_manual â†’ manual_live"
2. æŽ§åˆ¶å°è¾“å‡º: "ðŸ“¨ æ£€æµ‹åˆ°æ–°æ¶ˆæ¯ï¼ŒåŒæ­¥åŽ†å²"
3. æŽ§åˆ¶å°è¾“å‡º: "âœ… æ·»åŠ æ–°æ¶ˆæ¯: system - å®¢æœã€æµ‹è¯•å®¢æœã€‘å·²æŽ¥å…¥..."
4. çŠ¶æ€æ å˜ä¸ºè“è‰² "ðŸ‘¤ äººå·¥å®¢æœ - æµ‹è¯•å®¢æœ"
5. é»„è‰²ç­‰å¾…æç¤ºæ¶ˆå¤±
6. èŠå¤©è®°å½•æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯

### åœºæ™¯2: åå¸­å›žå¤

**åŽç«¯æ“ä½œ**:
```bash
curl -X POST .../manual/messages ...
```

**å‰ç«¯è‡ªåŠ¨å“åº”** (æœ€å¤š2ç§’å»¶è¿Ÿ):
1. æŽ§åˆ¶å°è¾“å‡º: "ðŸ“¨ æ£€æµ‹åˆ°æ–°æ¶ˆæ¯ï¼ŒåŒæ­¥åŽ†å²"
2. æŽ§åˆ¶å°è¾“å‡º: "âœ… æ·»åŠ æ–°æ¶ˆæ¯: agent - æ‚¨å¥½ï¼æˆ‘æ˜¯æµ‹è¯•å®¢æœ..."
3. åå¸­æ¶ˆæ¯å‡ºçŽ°åœ¨å·¦ä¾§ï¼ˆè“è‰²ä¸»é¢˜ï¼‰
4. æ˜¾ç¤ºåå¸­å¤´åƒã€åç§°ã€"äººå·¥"æ ‡ç­¾
5. è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

---

## ðŸ“Š æŠ€æœ¯ç»†èŠ‚

### è½®è¯¢ç­–ç•¥

| å‚æ•° | å€¼ | è¯´æ˜Ž |
|------|-----|------|
| è½®è¯¢é—´éš” | 2000ms (2ç§’) | å¹³è¡¡å®žæ—¶æ€§å’Œæ€§èƒ½ |
| è§¦å‘æ¡ä»¶ | `pending_manual` æˆ– `manual_live` | ä»…åœ¨éœ€è¦æ—¶è½®è¯¢ |
| åœæ­¢æ¡ä»¶ | `bot_active` æˆ– `closed` | è‡ªåŠ¨åœæ­¢ |
| APIè°ƒç”¨ | `GET /api/sessions/{session_name}` | èŽ·å–å®Œæ•´ä¼šè¯çŠ¶æ€ |

### æ¶ˆæ¯åŽ»é‡ç­–ç•¥

**æ—¶é—´æˆ³æ¯”è¾ƒ**:
```typescript
const exists = chatStore.messages.some(
  m => Math.abs(m.timestamp.getTime() / 1000 - msg.timestamp) < 0.1
)
```

å…è®¸ 0.1 ç§’çš„æ—¶é—´è¯¯å·®ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜å¯¼è‡´é‡å¤æ·»åŠ ã€‚

### æ€§èƒ½ä¼˜åŒ–

1. **æŒ‰éœ€è½®è¯¢**: åªåœ¨äººå·¥æŽ¥ç®¡çŠ¶æ€ä¸‹è½®è¯¢
2. **å¢žé‡åŒæ­¥**: ä»…æ‹‰å–æ–°æ¶ˆæ¯ï¼Œä¸é‡å¤å¤„ç†
3. **è‡ªåŠ¨åœæ­¢**: æ¢å¤ç¨³å®šçŠ¶æ€åŽç«‹å³åœæ­¢
4. **èµ„æºæ¸…ç†**: ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨

---

## ðŸŽ¯ æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•

çŽ°æœ‰çš„ `tests/test_p09_input_control.py` ä»ç„¶å…¨éƒ¨é€šè¿‡ï¼ˆ8/8ï¼‰ï¼Œå› ä¸ºï¼š
- è‡ªåŠ¨åŒ–æµ‹è¯•ä½¿ç”¨çš„æ˜¯ç›´æŽ¥ API è°ƒç”¨
- ä¸ä¾èµ–å‰ç«¯è½®è¯¢æœºåˆ¶

### æ‰‹åŠ¨æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**:
1. åˆ·æ–°é¡µé¢
2. ç‚¹å‡»"è½¬äººå·¥"
3. è¿è¡Œåå¸­æŽ¥å…¥å‘½ä»¤
4. **ç­‰å¾…2ç§’** â†’ çŠ¶æ€è‡ªåŠ¨æ›´æ–° âœ…
5. è¿è¡Œåå¸­å›žå¤å‘½ä»¤
6. **ç­‰å¾…2ç§’** â†’ æ¶ˆæ¯è‡ªåŠ¨æ˜¾ç¤º âœ…

**æµ‹è¯•ç»“æžœ**: âœ… æ‰€æœ‰åœºæ™¯é€šè¿‡

---

## ðŸ“ çº¦æŸéµå®ˆæƒ…å†µ

### éµå®ˆçš„çº¦æŸ

1. **çº¦æŸ1**: æœªä¿®æ”¹æ ¸å¿ƒ API æŽ¥å£ âœ…
2. **çº¦æŸ2**: æœªä¿®æ”¹ Coze API è°ƒç”¨é€»è¾‘ âœ…
3. **çº¦æŸ9**: ä½¿ç”¨ `updateSessionStatus()` æ–¹æ³•æ›´æ–°çŠ¶æ€ âœ…
4. **çº¦æŸ10**: ç³»ç»Ÿæ¶ˆæ¯ä½¿ç”¨è§„èŒƒæ ¼å¼ âœ…

### æœªå¼•å…¥æ–°çº¦æŸ

æœ¬æ¬¡ä¿®å¤æœªå‘çŽ°éœ€è¦æ–°å¢žçš„çº¦æŸã€‚

---

## ðŸš€ æœªæ¥æ”¹è¿›æ–¹å‘

### çŸ­æœŸ (P1 é˜¶æ®µ)

1. **WebSocket æ›¿ä»£**: è€ƒè™‘ä½¿ç”¨ WebSocket æ›¿ä»£è½®è¯¢ï¼Œå®žçŽ°çœŸæ­£çš„åŒå‘å®žæ—¶é€šä¿¡
2. **é‡è¿žæœºåˆ¶**: æ·»åŠ ç½‘ç»œæ–­çº¿é‡è¿žé€»è¾‘
3. **ç¦»çº¿æ¶ˆæ¯**: æ”¯æŒç¦»çº¿æ¶ˆæ¯ç¼“å­˜å’ŒåŒæ­¥

### é•¿æœŸ (P2 é˜¶æ®µ)

1. **æ¶ˆæ¯æŽ¨é€ä¼˜åŒ–**: å®žçŽ°æ›´é«˜æ•ˆçš„æ¶ˆæ¯æŽ¨é€æœºåˆ¶
2. **æ€§èƒ½ç›‘æŽ§**: æ·»åŠ è½®è¯¢æ€§èƒ½ç›‘æŽ§å’ŒæŠ¥è­¦
3. **è‡ªé€‚åº”é—´éš”**: æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´è½®è¯¢é—´éš”

---

## ðŸ“‹ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. **frontend/src/components/ChatPanel.vue**
   - å¯¼å…¥ `onUnmounted`
   - æ·»åŠ  `statusPollInterval` å˜é‡
   - å®žçŽ° `pollSessionStatus()` å‡½æ•°ï¼ˆå«æ¶ˆæ¯åŒæ­¥ï¼‰
   - å®žçŽ° `startStatusPolling()` å‡½æ•°
   - å®žçŽ° `stopStatusPolling()` å‡½æ•°
   - æ·»åŠ  `watch()` ç›‘å¬
   - æ›´æ–° `onUnmounted()` æ¸…ç†é€»è¾‘

2. **docs/P0-9_æ‰‹åŠ¨æµ‹è¯•æŒ‡å—.md**
   - æ›´æ–°åœºæ™¯3ï¼Œè¯´æ˜Ž2ç§’å»¶è¿Ÿ
   - æ·»åŠ è½®è¯¢æœºåˆ¶è¯´æ˜Ž

3. **docs/P0-9_è¡¥å……ä¿®å¤.md**
   - åˆ›å»ºæœ¬æ–‡æ¡£

### æœªä¿®æ”¹çš„æ–‡ä»¶

- `backend.py` - æ— éœ€ä¿®æ”¹
- `chatStore.ts` - æ— éœ€ä¿®æ”¹
- å…¶ä»–ç»„ä»¶ - æ— éœ€ä¿®æ”¹

---

## ðŸŽ‰ æ€»ç»“

### ä¿®å¤æˆæžœ

1. âœ… **è§£å†³äº†åå¸­æŽ¥å…¥åŽå‰ç«¯çŠ¶æ€ä¸æ›´æ–°çš„é—®é¢˜**
2. âœ… **è§£å†³äº†åå¸­å›žå¤åŽå‰ç«¯ä¸æ˜¾ç¤ºæ¶ˆæ¯çš„é—®é¢˜**
3. âœ… **å®žçŽ°äº†æ™ºèƒ½è½®è¯¢æœºåˆ¶ï¼Œå¹³è¡¡å®žæ—¶æ€§å’Œæ€§èƒ½**
4. âœ… **ä¿æŒäº†ä»£ç ç®€æ´ï¼Œæœªå¼•å…¥å¤æ‚ä¾èµ–**

### å…³é”®æŠ€æœ¯ç‚¹

1. **è½®è¯¢è€Œéžé•¿è¿žæŽ¥**: ç®€å•å¯é ï¼Œé€‚åˆå½“å‰æž¶æž„
2. **æ—¶é—´æˆ³æ¯”è¾ƒ**: é«˜æ•ˆçš„å¢žé‡åŒæ­¥ç­–ç•¥
3. **è‡ªåŠ¨æŽ§åˆ¶**: çŠ¶æ€é©±åŠ¨çš„è½®è¯¢å¯åœ
4. **èµ„æºå‹å¥½**: æŒ‰éœ€è½®è¯¢ï¼Œè‡ªåŠ¨æ¸…ç†

### ç”¨æˆ·ä½“éªŒ

- â±ï¸ **å»¶è¿Ÿ**: æœ€å¤š2ç§’ï¼ˆå¯æŽ¥å—ï¼‰
- ðŸ”„ **è‡ªåŠ¨åŒ–**: å®Œå…¨è‡ªåŠ¨ï¼Œæ— éœ€ç”¨æˆ·æ“ä½œ
- ðŸ’¾ **èµ„æº**: ä½Žå¼€é”€ï¼Œä¸å½±å“æ€§èƒ½
- ðŸŽ¯ **å¯é **: ä¸ä¾èµ– SSE è¿žæŽ¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-21
**ç»´æŠ¤è€…**: Claude Code
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯
