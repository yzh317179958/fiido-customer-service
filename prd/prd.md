# AI å®¢æœç³»ç»Ÿï¼ˆCoze æ¥å…¥ï¼‰+ AI ç›‘ç®¡ä¸äººå·¥æ¥ç®¡

## âš ï¸ å¼ºåˆ¶æ€§æŠ€æœ¯çº¦æŸ

**åœ¨é˜…è¯»æœ¬ PRD ä¹‹å‰ï¼Œè¯·åŠ¡å¿…å…ˆé˜…è¯»**ï¼š
ğŸ“˜ **[æŠ€æœ¯çº¦æŸä¸å¼€å‘åŸåˆ™æ–‡æ¡£](./TECHNICAL_CONSTRAINTS.md)**

è¯¥æ–‡æ¡£å®šä¹‰äº†ï¼š
- ğŸ”´ **Coze å¹³å°çš„ä¸å¯ç»•è¿‡é™åˆ¶**ï¼ˆSSEæµå¼å“åº”ã€JWTè®¤è¯ç­‰ï¼‰
- ğŸ”´ **æ ¸å¿ƒ API æ¥å£çš„ä¸å¯å˜çº¦æŸ**ï¼ˆ`/api/chat`, `/api/chat/stream` ç­‰ï¼‰
- âœ… **å…è®¸çš„åŠŸèƒ½æ‰©å±•æ–¹å‘**ï¼ˆä¼šè¯ç®¡ç†ã€ç›‘ç®¡å¼•æ“ç­‰ï¼‰
- ğŸ§ª **å¼ºåˆ¶æ€§æµ‹è¯•è¦æ±‚**

**æ‰€æœ‰åç»­åŠŸèƒ½å¼€å‘å¿…é¡»ä¸¥æ ¼éµå®ˆæŠ€æœ¯çº¦æŸæ–‡æ¡£ä¸­çš„è§„å®šï¼Œä¿è¯åŸæœ‰ AI å¯¹è¯åŠŸèƒ½ä¸å—ç ´å**ã€‚

### âš ï¸ Coze å¹³å°æ ¸å¿ƒçº¦æŸï¼ˆè´¯ç©¿å…¨æ–‡ï¼‰

æœ¬ PRD æ‰€æœ‰åŠŸèƒ½å¼€å‘å¿…é¡»éµå®ˆä»¥ä¸‹ **é“å¾‹**ï¼š

#### 1ï¸âƒ£ Coze API è°ƒç”¨è§„èŒƒï¼ˆä¸å¯ä¿®æ”¹ï¼‰
- âœ… **å¿…é¡»ä¿æŒ**ï¼šç°æœ‰ `/api/chat` å’Œ `/api/chat/stream` çš„ Coze API è°ƒç”¨é€»è¾‘
- âœ… **å¿…é¡»ä¿æŒ**ï¼šSSE æµå¼å“åº”æ ¼å¼å’Œè§£ææ–¹å¼
- âœ… **å¿…é¡»ä¿æŒ**ï¼šOAuth+JWT é‰´æƒæœºåˆ¶å’Œ `session_name` éš”ç¦»
- âŒ **ç¦æ­¢ä¿®æ”¹**ï¼šCoze API payload çš„å¿…éœ€å­—æ®µæ ¼å¼
- âŒ **ç¦æ­¢ä¿®æ”¹**ï¼šCoze API å“åº”çš„è§£æé€»è¾‘

#### 2ï¸âƒ£ åŠŸèƒ½æ‰©å±•åŸåˆ™
- âœ… **å…è®¸æ‰©å±•**ï¼šåœ¨ä¸ä¿®æ”¹æ ¸å¿ƒ API é€»è¾‘çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ ä¼šè¯çŠ¶æ€ç®¡ç†ã€ç›‘ç®¡å¼•æ“ç­‰åŠŸèƒ½
- âœ… **å…è®¸æ‰©å±•**ï¼šåœ¨ SSE æµä¸­æ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹ï¼ˆå¦‚ `type:'manual_message'`ã€`type:'status'`ï¼‰
- âœ… **å…è®¸æ‰©å±•**ï¼šæ·»åŠ æ–°çš„ API æ¥å£ï¼ˆå¦‚äººå·¥æ¥ç®¡æ¥å£ï¼‰ï¼Œä½†ä¸å¾—å ç”¨æˆ–ä¿®æ”¹ç°æœ‰è·¯ç”±
- âŒ **ç¦æ­¢æ›¿æ¢**ï¼šä¸å¾—ç”¨ WebSocket æ›¿æ¢æ ¸å¿ƒ AI å¯¹è¯çš„ SSE æµå¼å“åº”

#### 3ï¸âƒ£ å‘åå…¼å®¹ä¿è¯
æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»é€šè¿‡ä»¥ä¸‹æµ‹è¯•ï¼š
1. **æ ¸å¿ƒå¯¹è¯åŠŸèƒ½ä¸å—å½±å“**ï¼šç°æœ‰ AI å¯¹è¯æ¥å£åœ¨æ–°åŠŸèƒ½éƒ¨ç½²åä»æ­£å¸¸å·¥ä½œ
2. **ä¼šè¯éš”ç¦»æœºåˆ¶å®Œæ•´**ï¼š`session_name` éš”ç¦»é€»è¾‘ä¸å—ç ´å
3. **é”™è¯¯éš”ç¦»**ï¼šæ–°åŠŸèƒ½çš„å¼‚å¸¸ä¸åº”å¯¼è‡´æ ¸å¿ƒ AI å¯¹è¯åŠŸèƒ½å¤±è´¥

#### 4ï¸âƒ£ å¼€å‘å®¡æŸ¥è¦æ±‚
- ğŸ“‹ æ‰€æœ‰æ¶‰åŠ Coze API è°ƒç”¨çš„ä»£ç ä¿®æ”¹å¿…é¡»ä½¿ç”¨ `TECHNICAL_CONSTRAINTS.md` ä¸­çš„å®¡æŸ¥æ¸…å•
- ğŸ“‹ æ‰€æœ‰æ–°æ¥å£å¿…é¡»åœ¨ `api_contract.md` ä¸­å£°æ˜å¹¶æ ‡æ³¨æ˜¯å¦æ¶‰åŠ Coze API
- ğŸ“‹ å‚è€ƒ `coze.md` ç¬¬ 12 èŠ‚çš„å¼ºåˆ¶çº¦æŸè§„èŒƒ

---

## äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆPRDï¼‰

### ç‰ˆæœ¬ä¿¡æ¯
- æ–‡æ¡£ç‰ˆæœ¬ï¼šv2.2  
- æ›´æ–°æ—¶é—´ï¼š2025-02-XX  
- è´Ÿè´£äººï¼šç”¨æˆ· / Codex  
- èƒŒæ™¯ï¼šå½“å‰ç³»ç»Ÿè¿è¡Œåœ¨ FastAPI (`backend.py`) + Vue3 (`frontend/`) æ¶æ„ï¼Œæ ¸å¿ƒæ¥å£ `/api/chat` ä¸ `/api/chat/stream` å·²ä¸Šçº¿ã€‚ç°éœ€åœ¨ä¸ç ´åæ—¢æœ‰èƒ½åŠ›çš„å‰æä¸‹ï¼Œå¼•å…¥ AI ç›‘ç®¡å’Œäººå·¥æ¥ç®¡èƒ½åŠ›ï¼Œå…ˆäº¤ä»˜ MVPï¼ˆP0ï¼‰ï¼Œå†é€æ­¥æ‰©å±•ï¼ˆP1/P2ï¼‰ã€‚æœ¬ç‰ˆ PRD å·²æ ¹æ® `prd/PRD_REVIEW.md` çš„è¯„å®¡ç»“æœè°ƒæ•´ï¼Œå¼ºè°ƒæ¸è¿›å¼å®ç°ã€SSE ä¼˜å…ˆå’Œæ¥å£ç²¾ç®€ã€‚

---

## 1. ç°çŠ¶ä¸åŸºçº¿
- **åç«¯**ï¼šFastAPI å•ä½“ï¼Œ`OAuthTokenManager` è´Ÿè´£ä¸º Coze Workflow ç”Ÿæˆå¸¦ `session_name` çš„ tokenã€‚`/api/chat/stream` ä»¥ SSE è¿”å› AI å›å¤ã€‚  
- **å‰ç«¯**ï¼šVue3 + Vite + Piniaã€‚`chatStore.ts` ç®¡ç† `sessionId`ã€`conversationId`ã€`messages` ç­‰ï¼Œ`api/chat.ts` å°è£…ç°æœ‰æ¥å£ã€‚  
- **ä¼šè¯éš”ç¦»**ï¼šå‰ç«¯ `sessionStorage` ä¸­çš„ `fiido_session_id` ä½œä¸º `ChatRequest.user_id`ï¼Œåç«¯è½¬æˆ JWT `session_name`ã€‚  
- **æ¶ˆæ¯ç»“æ„**ï¼š`Message.role` ç›®å‰åŒ…æ‹¬ `user|assistant|system`ï¼Œå¯æ‰©å±•ã€‚  
- **éƒ¨ç½²çº¦æŸ**ï¼šä¸ºé™ä½å¤æ‚åº¦ï¼ŒMVP é˜¶æ®µä¸å¼•å…¥ WebSocketã€Redis ç­‰æ–°ä¾èµ–ï¼Œæœ€å¤§ç¨‹åº¦å¤ç”¨ç°æœ‰ SSE å’Œå†…å­˜èƒ½åŠ›ã€‚

---

## 2. é¡¹ç›®ç›®æ ‡ï¼ˆé˜¶æ®µåˆ’åˆ†ï¼‰
| é˜¶æ®µ | ç›®æ ‡ | å…³é”®äº§å‡º |
| --- | --- | --- |
| **P0 (MVP)** | å®ç° AI ç›‘ç®¡ + æ‰‹åŠ¨/ç³»ç»Ÿè§¦å‘äººå·¥ + äººå·¥æ¶ˆæ¯é€šé“ + å‰ç«¯çŠ¶æ€å±•ç¤º | SessionStateStoreï¼ˆå†…å­˜ç‰ˆï¼‰ã€Regulatorã€4 ä¸ªæ ¸å¿ƒ APIã€å‰ç«¯çŠ¶æ€æç¤ºã€äººå·¥æ¶ˆæ¯æµ |
| **P1** | å¼•å…¥å·¥ä½œæ—¶é—´åˆ¤æ–­ã€é‚®ä»¶é€šçŸ¥ã€åå¸­å·¥ä½œå°ã€ä¼šè¯åˆ—è¡¨ | ShiftConfigã€é‚®ä»¶æ¨¡å—ã€å·¥ä½œå°ï¼ˆå¯ç‹¬ç«‹ Vue é¡¹ç›®ï¼‰ã€åå¸­æ¥å…¥æ¥å£ |
| **P2** | èƒ½åŠ›å¢å¼º | WebSocket/Redis/ç›‘æ§/æƒ…ç»ªè¯†åˆ«/å®¡è®¡æŸ¥è¯¢ |

---

## 3. èŒƒå›´
| åŒ…å« | è¯´æ˜ |
| --- | --- |
| Vue ç”¨æˆ·ç«¯æ”¹é€  | çŠ¶æ€æç¤ºã€äººå·¥æ¶ˆæ¯æ¸²æŸ“ã€ä¼šè¯è¯¦æƒ… |
| FastAPI æ‰©å±• | SessionStateStoreã€ç›‘ç®¡é€»è¾‘ã€äººå·¥æ¥å£ã€æ—¥å¿— |
| é‚®ä»¶/å·¥ä½œæ—¶é—´ï¼ˆP1ï¼‰ | ShiftConfigã€é‚®ä»¶è§¦å‘ |
| å·¥ä½œå°ï¼ˆP1ï¼‰ | ç‹¬ç«‹ Vue å­é¡¹ç›® æˆ– åŒä¸€ä»“åº“å­ç›®å½• |

| ä¸åŒ…å« | è¯´æ˜ |
| --- | --- |
| CRM / å·¥å•ç³»ç»Ÿå¯¹æ¥ | æš‚ä¸é›†æˆå¤–éƒ¨ç³»ç»Ÿ |
| ç§»åŠ¨åå¸­ App | ä»… Web |
| WebSocket/Redisï¼ˆP0ï¼‰ | MVP ä½¿ç”¨ SSE + å†…å­˜ï¼Œåç»­å†å‡çº§ |

---

## 4. æ ¸å¿ƒæ¦‚å¿µä¸çŠ¶æ€
- `session_name`ï¼šæ²¿ç”¨ç°æœ‰ `sessionId`ã€‚  
- `conversation_id`ï¼šä½¿ç”¨ `/api/conversation/new` ç»“æœï¼Œäººå·¥æœŸé—´ä¿æŒä¸å˜ã€‚  
- `Message.role`ï¼šæ‰©å±•ä¸º `user | assistant | system | agent`ï¼Œå½“ `role='agent'` æ—¶é™„å¸¦ `agent_info`ï¼ˆåå¸­ç¼–å·/æ˜µç§°ï¼‰ã€‚  
- **ä¼šè¯çŠ¶æ€**ï¼š`bot_active` â†’ `pending_manual` â†’ `manual_live` â†’ `bot_active/closed`ï¼›éå·¥ä½œæ—¶é—´è§¦å‘ `after_hours_email`ã€‚  
- **SessionStateStore**ï¼šMVP ä½¿ç”¨å†…å­˜ dict + é”ï¼›è®°å½•æ ¸å¿ƒå­—æ®µå¹¶é™åˆ¶å†å²é•¿åº¦ï¼Œç»“æ„è§ Â§8ã€‚

---

## 5. åŠŸèƒ½éœ€æ±‚

### 5.1 ç”¨æˆ·å‰ç«¯ï¼ˆVueï¼‰
1. **çŠ¶æ€æ¡**ï¼šåœ¨èŠå¤©é¢æ¿é¡¶éƒ¨æ˜¾ç¤º `AI æœåŠ¡ä¸­` / `ç­‰å¾…äººå·¥` / `äººå·¥æ¥å…¥` / `éå·¥ä½œæ—¶é—´`ï¼Œé¢œè‰²åŒºåˆ†ã€‚  
2. **æ¶ˆæ¯æ¸²æŸ“**ï¼šå½“ `role='agent'` æ—¶ä½¿ç”¨äººå·¥å¤´åƒ/åç§°ï¼›SSE ä¸­è‹¥è¿”å› `type='manual_message'` äº¦å†™å…¥ `messages`ã€‚  
3. **è¾“å…¥è¡Œä¸º**ï¼š  
   - `bot_active`ï¼šè°ƒç”¨ç°æœ‰ `/api/chat/stream`ã€‚  
   - `manual_live`ï¼šè°ƒç”¨ `POST /api/manual/messages`ï¼ˆrole=`user`ï¼‰ï¼ŒSSE æ¨é€äººå·¥å›å¤ã€‚  
   - `pending_manual`ï¼šç¦ç”¨è¾“å…¥æˆ–æç¤ºâ€œç­‰å¾…åå¸­â€ã€‚  
4. **å†å²å›å¡«**ï¼šæ‰“å¼€é¢æ¿æˆ–åˆ·æ–°åè°ƒç”¨ `GET /api/sessions/{session_name}`ï¼ˆè‹¥å­˜åœ¨ï¼‰å¡«å…… `messages` å¹¶åŒæ­¥ `sessionStatus`ã€‚  
5. **éå·¥ä½œæ—¶é—´æç¤ºï¼ˆP1ï¼‰**ï¼šè‹¥çŠ¶æ€ä¸º `after_hours_email`ï¼Œæ˜¾ç¤ºé‚®ç®±è¯´æ˜å’Œå¯é€‰çš„è”ç³»ç”µè¯è¾“å…¥ã€‚

### 5.2 åç«¯ï¼ˆFastAPIï¼‰
1. **SessionStateStoreï¼ˆP0ï¼‰**  
   - è½»é‡æ•°æ®ç»“æ„ï¼ˆè§ Â§8ï¼‰ï¼Œæä¾› `get/save/append_history/transition`ã€‚  
   - å†…å­˜å®ç° + å®šæ—¶å†™å…¥ JSON æ–‡ä»¶å¤‡ä»½ï¼Œæ–¹ä¾¿é‡å¯æ¢å¤ã€‚  
2. **Regulatorï¼ˆP0ï¼‰**  
   - è§„åˆ™ï¼šå…³é”®è¯ã€è¿ç»­å¤±è´¥ï¼ˆAI fallback 3 æ¬¡ï¼‰ã€VIPï¼ˆparameters.vip=trueï¼‰ã€‚æƒ…ç»ªæ£€æµ‹å»¶åï¼ˆP2ï¼‰ã€‚  
   - ä¼˜å…ˆçº§ï¼šVIP > å…³é”®è¯ > è¿ç»­å¤±è´¥ã€‚  
   - è¾“å‡º `{should_escalate, reason, severity, details}`ã€‚  
3. **Chat æ¥å£æ”¹é€ ï¼ˆP0ï¼‰**  
   - è¯·æ±‚è¿›å…¥ `/api/chat` æˆ– `/api/chat/stream` å‰æ‹‰èµ· SessionStateã€‚  
   - å½“çŠ¶æ€ä¸º `manual_live` æ—¶ç«‹å³è¿”å› 409 `{success:false,error:'MANUAL_IN_PROGRESS'}`ã€‚  
   - SSE ç®¡é“å†…å¯ç©¿æ’äººå·¥äº‹ä»¶ï¼šäººå·¥æ¶ˆæ¯ç”±æœåŠ¡ç«¯æ’å…¥ SSE æµ `data: {"type":"manual_message", ...}`ï¼Œæ— éœ€ WebSocketã€‚  
4. **æ ¸å¿ƒ APIï¼ˆP0ï¼‰**  
   1. `POST /api/manual/escalate` â€” ç”¨æˆ·æˆ–ç³»ç»Ÿè§¦å‘äººå·¥ã€‚  
   2. `GET /api/sessions/{session_name}` â€” æŸ¥è¯¢ SessionStateã€‚  
   3. `POST /api/manual/messages` â€” äººå·¥é€šé“æ¶ˆæ¯ï¼ˆrole=`agent`/`user`ï¼‰ã€‚  
   4. `POST /api/sessions/{session_name}/release` â€” ç»“æŸäººå·¥ï¼Œå†™ç³»ç»Ÿæ¶ˆæ¯â€œäººå·¥ç»“æŸï¼ŒAI å·²æ¥ç®¡â€ã€‚  
5. **æ‰©å±• APIï¼ˆP1ï¼‰**  
   - `GET /api/sessions`ã€`POST /api/sessions/{session_name}/takeover`ï¼ˆå·¥ä½œå°ä½¿ç”¨ï¼‰ã€‚  
   - `POST /api/sessions/{session_name}/email`ï¼ˆé‚®ä»¶è½¬äº¤ï¼‰ã€‚  
   - `GET /api/shift/config`ï¼ˆå·¥ä½œæ—¶é—´é…ç½®ï¼‰ã€‚  
6. **æ—¥å¿—ä¸é‰´æƒ**  
   - æ‰€æœ‰çŠ¶æ€å˜æ›´å†™å…¥ `backend.log` JSON è¡Œï¼š`event`, `session_name`, `status_from`, `status_to`, `operator`, `timestamp`.  
   - äººå·¥æ¥å£ï¼ˆé™¤ç”¨æˆ·ä¾§ escalate/manual messageï¼‰éœ€ `Authorization: Bearer <JWT>`ï¼ŒJWT ä¸­åŒ…å« `role`ã€‚`src/jwt_signer.py` éœ€æ”¯æŒè‡ªå®šä¹‰ claimsã€‚  
7. **å®æ—¶æ¨é€ç­–ç•¥ï¼ˆP0ï¼‰**  
   - MVP ä¿æŒ SSEï¼š`/api/chat/stream` ç»§ç»­ä½œä¸ºå”¯ä¸€äº‹ä»¶æµã€‚äººå·¥æ¶ˆæ¯é€šè¿‡åç«¯äº‹ä»¶é˜Ÿåˆ—æ’å…¥ SSE å“åº”ï¼ˆæœåŠ¡å™¨ç«¯åœ¨ `manual_live` é˜¶æ®µç”Ÿæˆè‡ªå®šä¹‰äº‹ä»¶ï¼‰ã€‚  
   - P1+ å¯å¼•å…¥ `/ws/...` WebSocketï¼Œä¸ºå·¥ä½œå°å’Œç”¨æˆ·ç«¯åˆ†åˆ«æä¾›å®æ—¶é€šé“ã€‚

### 5.3 äººå·¥å·¥ä½œå°ï¼ˆP1ï¼‰
- ä»¥ç‹¬ç«‹ Vue å­é¡¹ç›®æˆ– `frontend` å­è·¯ç”±å®ç°ï¼Œä»£ç éš”ç¦»ã€‚  
- ä¾èµ– P1 APIï¼ˆsessions listã€takeoverã€emailï¼‰ã€‚  
- æœ€å°èƒ½åŠ›ï¼šç™»å½•ï¼ˆJWT role=agentï¼‰ã€ä¼šè¯é˜Ÿåˆ—ã€å†å²æŸ¥çœ‹ã€å‘é€äººå·¥æ¶ˆæ¯ã€ç»“æŸæ¥ç®¡ã€‚  
- åç»­èƒ½åŠ›ï¼ˆå¿«æ·çŸ­è¯­ã€æœç´¢ã€æ“ä½œå†å²ï¼‰æŒ‰ `prd/agent_workbench_tasks.md` è½åœ°ã€‚

---

## 6. ç›‘ç®¡è§¦å‘ç­–ç•¥
| ç­–ç•¥ | è¯´æ˜ | è§¦å‘ç»“æœ |
| --- | --- | --- |
| å…³é”®è¯ | å‘½ä¸­é…ç½®å…³é”®è¯ï¼ˆé»˜è®¤ï¼šäººå·¥ã€çœŸäººã€æŠ•è¯‰ã€æ— æ³•è§£å†³ï¼‰ | `pending_manual` |
| è¿ç»­å¤±è´¥ | AI å›å¤åŒ…å« fallback å…³é”®è¯ â‰¥3 æ¬¡ | `pending_manual` |
| VIP | `parameters.vip=true` æˆ–ç”¨æˆ·æ ‡ç­¾ä¸­ `vip` | ç›´æ¥ `pending_manual` |
| éå·¥ä½œæ—¶é—´ | å½“ `pending_manual` ä¸” `ShiftConfig.is_in_shift=False` | `after_hours_email`ï¼ˆP1 é‚®ä»¶ï¼‰ |
| äººå·¥å¼ºåˆ¶ | åå¸­åœ¨å·¥ä½œå°ç‚¹å‡»æ¥å…¥ï¼ˆP1ï¼‰ | ç›´æ¥ `manual_live` |

æƒ…ç»ªæ£€æµ‹ã€ä¸¥é‡æŠ•è¯‰åˆ†ç±»æ”¾å…¥ P2ã€‚

---

## 7. ä¸»è¦æµç¨‹
1. **AI æœåŠ¡**ï¼šé»˜è®¤ `bot_active`ï¼Œå‰ç«¯å‘é€æ¶ˆæ¯â†’åç«¯è°ƒç”¨ Cozeâ†’SSE æ¨é€ AI å›å¤â†’`history` è®°å½•ã€‚  
2. **è§¦å‘äººå·¥**ï¼šRegulator å‘½ä¸­ â†’ æ›´æ–°çŠ¶æ€ `pending_manual` â†’ SSE æ¨é€ `{type:'status',status:'pending_manual'}` â†’ å‰ç«¯æç¤ºã€‚  
3. **äººå·¥å¤„ç† (MVP)**ï¼šè¿ç»´æˆ–æ¨¡æ‹Ÿåå¸­è°ƒç”¨ APIï¼š  
   - `POST /api/manual/messages` role=`agent` å‘é€äººå·¥å›å¤ï¼ŒSSE æ¨é€ç»™ç”¨æˆ·ã€‚  
   - ç”¨æˆ·åœ¨ `manual_live` æ—¶è¾“å…¥ â†’ `POST /api/manual/messages` role=`user`ã€‚  
4. **ç»“æŸäººå·¥**ï¼š`POST /release` â†’ çŠ¶æ€ `manual_live -> bot_active` â†’ ç³»ç»Ÿæ¶ˆæ¯ + SSE æç¤º â†’ ç”¨æˆ·å†æ¬¡ä½¿ç”¨ `/api/chat/stream`ã€‚  
5. **éå·¥ä½œæ—¶é—´ (P1)**ï¼š`pending_manual` æ—¶åˆ¤æ–­ `ShiftConfig`ï¼›è‹¥ä¸åœ¨ç­æ¬¡ç›´æ¥ `after_hours_email` å¹¶è§¦å‘é‚®ä»¶ï¼ŒSSE æç¤ºâ€œæˆ‘ä»¬å°†é‚®ä»¶è·Ÿè¿›â€ã€‚  
6. **å·¥ä½œå°æ¥å…¥ (P1)**ï¼šåå¸­ç™»å½• â†’ `GET /api/sessions?status=pending_manual` â†’ `takeover` â†’ é€šè¿‡ `/manual/messages` ä¸ç”¨æˆ·æ²Ÿé€š â†’ `release`ã€‚

---

## 8. æ•°æ®ç»“æ„
### 8.1 SessionStateï¼ˆMVPï¼‰
```json
{
  "session_name": "session_123",
  "status": "bot_active",
  "conversation_id": "conv_xxx",
  "user_profile": {
    "nickname": "è®¿å®¢A",
    "vip": false
  },
  "history": [
    { "id": "msg1", "role": "user", "content": "ä½ å¥½", "timestamp": 1737000000 },
    { "id": "msg2", "role": "assistant", "content": "æ‚¨å¥½!", "timestamp": 1737000001 }
  ],
  "escalation": {
    "reason": "keyword",
    "details": "ç”¨æˆ·è¾“å…¥: æˆ‘æƒ³æ‰¾äººå·¥",
    "severity": "high",
    "trigger_at": 1737000300
  },
  "assigned_agent": null,
  "mail": { "sent": false },
  "ai_fail_count": 0,
  "last_manual_end_at": null
}
```
- `history` æœ€å¤šä¿ç•™ 50 æ¡ï¼Œè¶…å‡ºéƒ¨åˆ†å†™å…¥å½’æ¡£ï¼ˆåç»­å¯è½ç£ç›˜ï¼‰ã€‚  
- `user_profile` ä»…åŒ…å« `nickname`ã€`vip`ï¼Œåç»­å†æ‰©å±•ã€‚  
- `audit_trail` å¦å»ºåˆ—è¡¨å­˜å‚¨ï¼ˆ`[{status_from,status_to,operator,timestamp}]`ï¼‰ï¼Œé¿å…æ±¡æŸ“ä¸»ç»“æ„ã€‚  
- æ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ UTC æ—¶é—´æˆ³ï¼ˆç§’ï¼‰ï¼Œå‰ç«¯è´Ÿè´£æ ¼å¼åŒ–ã€‚

### 8.2 Messageï¼ˆå‰ç«¯ï¼‰
```ts
interface Message {
  id: string;
  content: string;
  role: 'user' | 'assistant' | 'system' | 'agent';
  timestamp: number; // UTC
  sender?: string;
  agent_info?: { agent_id: string; agent_name: string };
}
```

---

## 9. API åˆ—è¡¨ï¼ˆæ›´æ–°åï¼‰

| æ¥å£ | æè¿° | é˜¶æ®µ | è¯´æ˜ |
| --- | --- | --- | --- |
| `POST /api/chat` | åŒæ­¥ AI æœåŠ¡ | ç°æœ‰ | æ–°å¢çŠ¶æ€åˆ¤æ–­/ç›‘ç®¡é’©å­ |
| `POST /api/chat/stream` | SSE AI æœåŠ¡ | ç°æœ‰ | SSE ä¹Ÿæ‰¿æ‹…äººå·¥é˜¶æ®µæ¶ˆæ¯æ¨é€ |
| `POST /api/manual/escalate` | è§¦å‘äººå·¥ | P0 | Body `{session_name, reason?}` |
| `GET /api/sessions/{session_name}` | æŸ¥è¯¢ä¼šè¯ | P0 | è¿”å› `SessionState` |
| `POST /api/manual/messages` | äººå·¥é˜¶æ®µæ¶ˆæ¯ | P0 | è§’è‰² `agent/user` |
| `POST /api/sessions/{session_name}/release` | ç»“æŸäººå·¥ | P0 | å†™ç³»ç»Ÿæ¶ˆæ¯ |
| `GET /api/sessions` | ä¼šè¯åˆ—è¡¨ | P1 | å·¥ä½œå°é˜Ÿåˆ— |
| `POST /api/sessions/{session_name}/takeover` | åå¸­æ¥å…¥ | P1 | é˜²æ­¢æŠ¢æ¥ |
| `POST /api/sessions/{session_name}/email` | é‚®ä»¶è½¬äº¤ | P1 | è§¦å‘é‚®ä»¶æ¨¡å— |
| `GET /api/shift/config` | ç­æ¬¡é…ç½® | P1 | å‰ç«¯å±•ç¤º |

å“åº”ç»Ÿä¸€ä¸ºï¼š
```json
{ "success": true, "data": {...} }
{ "success": false, "error": "message", "code": "ERROR_CODE" }
```

---

## 10. éåŠŸèƒ½éœ€æ±‚
- **æ€§èƒ½**ï¼šAI æµå¼å“åº”å»¶è¿Ÿä¿æŒç°çŠ¶ï¼›äººå·¥æ¶ˆæ¯é€šè¿‡ SSE æ¨é€ï¼Œç«¯åˆ°ç«¯ â‰¤ 500msã€‚  
- **å¯é æ€§**ï¼šSessionState å†…å­˜+æ–‡ä»¶å¤‡ä»½ï¼›P2 å†åˆ‡æ¢ Redisã€‚  
- **å®‰å…¨**ï¼šäººå·¥æ¥å£å¼ºåˆ¶ JWT role æ ¡éªŒï¼ˆ`agent`/`admin`ï¼‰ã€‚  
- **æ—¥å¿—**ï¼šçŠ¶æ€å˜æ›´ã€äººå·¥æ“ä½œã€é‚®ä»¶ç»“æœå¿…é¡»å†™å…¥ JSON æ—¥å¿—ã€‚  
- **é…ç½®åŒ–**ï¼šå…³é”®è¯ã€ç­æ¬¡ã€é‚®ç®±ç­‰è¯»è‡ª `.env`ï¼Œå¹¶åœ¨ `/api/config` æˆ– `/api/shift/config` æš´éœ²åªè¯»ä¿¡æ¯ã€‚

---

## 11. éªŒæ”¶æ ‡å‡†
1. ç”¨æˆ·é€šè¿‡ç°æœ‰å‰ç«¯å¯å®Œæ•´ä½“éªŒ AI æµç¨‹ï¼Œä¸”çŠ¶æ€é»˜è®¤ `bot_active`ã€‚  
2. å½“è¾“å…¥â€œæˆ‘è¦äººå·¥â€æ—¶ï¼Œåç«¯å°†çŠ¶æ€åˆ‡æ¢åˆ° `pending_manual`ï¼Œå‰ç«¯çŠ¶æ€æ¡æ›´æ–°å¹¶ç¦æ­¢è¿›ä¸€æ­¥è°ƒç”¨ `/api/chat/stream`ã€‚  
3. è°ƒç”¨ `POST /api/manual/messages`ï¼ˆrole=`agent`ï¼‰å³å¯è®©ç”¨æˆ·ç«¯æ”¶åˆ°äººå·¥å›å¤ï¼ˆé€šè¿‡ SSEï¼‰ã€‚  
4. `GET /api/sessions/{session_name}` è¿”å›çš„å†å²åŒ…å« AIã€ç”¨æˆ·ã€äººå·¥ä¸‰ç§è§’è‰²ï¼Œé•¿åº¦æœ€å¤š 50ã€‚  
5. è°ƒç”¨ `POST /release` åçŠ¶æ€å›åˆ° `bot_active`ï¼Œå‰ç«¯æç¤ºâ€œå·²è¿”å› AIâ€ï¼Œç”¨æˆ·å†æ¬¡å‘æ¶ˆæ¯ä»èµ° AI æµç¨‹ã€‚  
6. æ—¥å¿—ä¸­å¯æ‰¾åˆ° `manual_takeover`ã€`manual_release`ã€`escalate` ç­‰äº‹ä»¶ã€‚  
7. P1 éªŒæ”¶ï¼ˆå¯é€‰ï¼‰ï¼šå½“è§¦å‘äººå·¥ä¸”è¶…å‡ºç­æ¬¡ï¼ŒçŠ¶æ€åˆ‡æ¢åˆ° `after_hours_email`ï¼Œå¹¶å‘é…ç½®é‚®ç®±å‘é€æ‘˜è¦ï¼›å·¥ä½œå°å¯é€šè¿‡ API æ¥ç®¡ä¼šè¯ã€‚

---

## 12. é£é™©ä¸è§„åˆ’
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šéœ€åœ¨ SessionStateStore ä¸­å®ç° CAS / é”ã€‚  
- **SSE ä¸äººå·¥å…±å­˜**ï¼šæœåŠ¡ç«¯éœ€è¦èƒ½åœ¨åŒä¸€è·¯å¾„æ¨é€è‡ªå®šä¹‰äº‹ä»¶ï¼Œæ³¨æ„ä¸ Coze æµå¼å›å¤çš„é¡ºåºã€‚  
- **é‡å¯æ¢å¤**ï¼šMVP é€šè¿‡æ–‡ä»¶å¿«ç…§æ¢å¤ SessionStateï¼›åç»­æ”¹ä¸º Redisã€‚  
- **å®‰å…¨**ï¼šJWT éœ€åŒ…å« `role`ï¼Œå¹¶åœ¨å·¥ä½œå°/åå°æ¥å£æ ¡éªŒã€‚  
- **æŠ€æœ¯å€º**ï¼šWebSocketã€æƒ…ç»ªæ£€æµ‹ã€Redis ç­‰æ”¾åœ¨ P2ï¼Œè§„åˆ’å®Œæˆåé€æ­¥å®ç°ã€‚

---

æœ¬ PRD å·²ç»“åˆè¯„å®¡å»ºè®®è°ƒæ•´ä¸ºâ€œå†…å­˜+SSE çš„ MVPâ€æ–¹æ¡ˆï¼Œæ˜ç¡®äº†é˜¶æ®µç›®æ ‡ã€ç®€åŒ–åçš„æ¥å£é›†åˆä»¥åŠæ•°æ®ç»“æ„çº¦æŸï¼Œä¸ºåç»­ Claude Code å¼€å‘æä¾›ç»Ÿä¸€ä¾æ®ã€‚æ›´æ–° PRD åè¯·åŒæ­¥ä»»åŠ¡æ‹†åˆ†ä¸ API æ–‡æ¡£ï¼Œä¿æŒä¸€è‡´æ€§ã€‚
