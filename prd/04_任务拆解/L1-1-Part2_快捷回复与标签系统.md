# L1-1-Part2: 快捷回复与标签系统功能需求

> **文档编号**: L1-1-Part2
> **文档版本**: v1.0
> **优先级**: P0（基础层 - 必须实现）
> **状态**: ⚠️ 设计中
> **创建时间**: 2025-01-26

---

## 📑 文档导航

- **上级文档**: [ENTERPRISE_EBIKE_SUPPORT_TASKS.md](./ENTERPRISE_EBIKE_SUPPORT_TASKS.md)
- **同级文档**:
  - 上一篇: L1-1-Part1 会话管理与筛选
  - 当前: L1-1-Part2 快捷回复与标签系统
  - 下一篇: L1-1-Part3 协作与工作台优化
- **依赖关系**: 依赖 Part1 的会话管理基础功能

---

## 🎯 Part 2 概述

### 涵盖模块

本文档包含核心客服工作台的第3-4个模块：

| 模块编号 | 模块名称 | 核心功能 |
|---------|---------|---------|
| **模块3** | 快捷回复系统 | 模板管理、变量替换、分类管理、快捷键 |
| **模块4** | 会话标签系统 | 标签分类、自动打标、批量管理、统计分析 |

### 业务价值

**当前痛点**（v3.2.0）：
- ⚠️ 快捷回复组件已存在但未启用（`QuickReplies.vue`）
- ❌ 后端API未实现
- ❌ 无会话标签功能
- ❌ 坐席重复输入常见回复，效率低

**实现后收益**：
- 📈 坐席响应速度提升 **50%**（减少重复输入）
- 📈 回复标准化率提升 **80%**（统一话术）
- 📊 会话分类准确率提升 **90%**（标签管理）
- 📊 数据分析能力提升（基于标签统计）

---

## 📋 模块3: 快捷回复系统

### 3.1 功能概述

为坐席提供可复用的回复模板，支持变量替换、分类管理和快捷键触发，大幅提升回复效率。

**参考对标**：
- 拼多多客服：支持按分类选择话术
- 京东客服：支持快捷键插入

### 3.2 功能需求

#### 3.2.1 快捷回复创建

**F3-1: 快捷回复模板结构**

每个快捷回复模板包含以下字段：

| 字段 | 类型 | 必填 | 说明 | 示例 |
|-----|------|-----|------|------|
| id | string | 是 | 唯一标识 | `reply_001` |
| title | string | 是 | 模板标题 | "欢迎语" |
| content | string | 是 | 回复内容 | "您好{customer_name}，我是{agent_name}" |
| category | string | 是 | 分类 | "greeting" |
| variables | string[] | 否 | 变量列表 | `["customer_name", "agent_name"]` |
| shortcut_key | string | 否 | 快捷键 | "Ctrl+1" |
| is_shared | boolean | 是 | 是否团队共享 | true |
| created_by | string | 是 | 创建者 | "agent_001" |
| usage_count | number | 是 | 使用次数 | 156 |
| created_at | timestamp | 是 | 创建时间 | 1735200000 |
| updated_at | timestamp | 是 | 更新时间 | 1735200000 |

**F3-2: 支持的变量**

系统预定义以下变量，自动替换：

| 变量名 | 说明 | 数据来源 | 示例值 |
|-------|------|---------|--------|
| `{customer_name}` | 客户昵称 | `user_profile.nickname` | "张三" |
| `{agent_name}` | 坐席姓名 | `agent.name` | "李客服" |
| `{order_id}` | 订单号 | Shopify订单数据 | "ORD123456" |
| `{order_status}` | 订单状态 | Shopify订单数据 | "已发货" |
| `{tracking_number}` | 物流单号 | Shopify物流数据 | "SF123456789" |
| `{product_name}` | 产品名称 | Shopify产品数据 | "Fiido D4S" |
| `{current_time}` | 当前时间 | 系统时间 | "14:30" |
| `{current_date}` | 当前日期 | 系统日期 | "2025-01-26" |

**示例模板**：
```
标题: 订单发货通知
内容: 您好{customer_name}，您的订单{order_id}已发货，物流单号：{tracking_number}，预计3-5个工作日送达。
变量: ["customer_name", "order_id", "tracking_number"]
```

**F3-3: 创建快捷回复**

**操作流程**：
1. 坐席点击"新建快捷回复"
2. 填写表单：
   - 标题（必填，最多50字符）
   - 分类（下拉选择）
   - 内容（必填，最多1000字符）
   - 插入变量（点击插入按钮）
   - 快捷键（可选，Ctrl+1~9）
   - 共享设置（仅自己/全团队）
3. 点击"保存"

**权限要求**：
- 普通坐席：可创建个人快捷回复
- 管理员：可创建团队共享快捷回复

#### 3.2.2 快捷回复分类

**F3-4: 预定义分类**

| 分类ID | 分类名称 | 使用场景 | 示例模板 |
|-------|---------|---------|---------|
| `greeting` | 欢迎语 | 接入会话时 | "您好，我是XX客服，很高兴为您服务" |
| `pre_sales` | 售前咨询 | 产品咨询 | "Fiido D4S续航50公里，最高时速25km/h" |
| `after_sales` | 售后服务 | 退换货、维修 | "请您提供订单号，我帮您查询..." |
| `logistics` | 物流查询 | 查询物流 | "您的订单已发货，物流单号..." |
| `technical` | 技术支持 | 故障排查 | "请您尝试以下步骤..." |
| `closing` | 结束语 | 结束会话时 | "感谢您的咨询，祝您生活愉快" |
| `custom` | 自定义 | 其他场景 | - |

**F3-5: 自定义分类**

管理员可以创建自定义分类：
- 分类名称（必填，最多20字符）
- 排序权重（数字越小越靠前）
- 分类描述（可选）

#### 3.2.3 快捷回复使用

**F3-6: 选择快捷回复**

**方式1：点击选择**
1. 坐席在聊天输入框上方看到"快捷回复"按钮
2. 点击展开快捷回复面板
3. 按分类浏览或搜索
4. 点击某个模板
5. 变量自动替换后插入输入框

**方式2：快捷键触发**
- 按下快捷键（如 Ctrl+1）
- 模板自动插入输入框

**方式3：关键词触发**
- 输入 `/` 触发命令模式
- 输入关键词，显示匹配的模板
- 按 Enter 选择

**UI设计要求**：
```
┌─────────────────────────────────────┐
│ 快捷回复 (125个)         [+新建]    │
├─────────────────────────────────────┤
│ [欢迎语] [售前] [售后] [物流] [技术] │
│ [搜索: 输入关键词...]                │
├─────────────────────────────────────┤
│ 📄 欢迎语                            │
│    您好{customer_name}，我是...     │
│    使用 45 次 | Ctrl+1              │
├─────────────────────────────────────┤
│ 📄 订单发货通知                      │
│    您的订单{order_id}已发货...      │
│    使用 23 次 | Ctrl+2              │
└─────────────────────────────────────┘
```

**F3-7: 变量替换逻辑**

插入模板时，系统自动替换变量：

**替换规则**：
1. 优先使用当前会话的客户数据
2. 如果数据缺失，保留变量占位符，由坐席手动修改
3. Shopify数据未集成前，订单相关变量保留占位符

**示例**：
```
模板: "您好{customer_name}，您的订单{order_id}已发货"

替换后:
- 客户昵称存在: "您好张三，您的订单{order_id}已发货"
- 订单号未获取: "您好张三，您的订单{order_id}已发货"（坐席手动填写）
```

#### 3.2.4 快捷回复管理

**F3-8: 编辑和删除**

**编辑操作**：
- 点击快捷回复右侧"编辑"按钮
- 修改标题、内容、分类、快捷键
- 保存后立即生效

**删除操作**：
- 点击"删除"按钮
- 确认删除提示："确定删除该快捷回复？此操作不可恢复"
- 删除后无法恢复

**权限控制**：
- 普通坐席：只能编辑/删除自己创建的
- 管理员：可以编辑/删除所有快捷回复

**F3-9: 使用统计**

**统计维度**：
- 每个模板的使用次数
- 每个坐席的使用频率
- 每个分类的使用占比
- 最受欢迎的模板 TOP 10

**统计展示**：
```
📊 快捷回复使用统计

本月使用次数: 1,256 次
平均响应速度提升: 45%

最常用模板:
1. 欢迎语 (156次)
2. 订单发货通知 (98次)
3. 物流查询回复 (87次)
```

### 3.3 数据模型

**快捷回复数据结构**：

```typescript
interface QuickReply {
  id: string                          // 唯一ID
  title: string                       // 标题
  content: string                     // 内容（包含变量占位符）
  category: QuickReplyCategory        // 分类
  variables: string[]                 // 使用的变量列表
  shortcut_key: string | null         // 快捷键（Ctrl+1~9）
  is_shared: boolean                  // 是否团队共享
  created_by: string                  // 创建者ID
  usage_count: number                 // 使用次数
  created_at: Date                    // 创建时间
  updated_at: Date                    // 更新时间
}

type QuickReplyCategory =
  | 'greeting'
  | 'pre_sales'
  | 'after_sales'
  | 'logistics'
  | 'technical'
  | 'closing'
  | 'custom'
```

**后端API设计**：

```
GET    /api/quick-replies                    # 获取列表
POST   /api/quick-replies                    # 创建
GET    /api/quick-replies/{id}               # 获取详情
PUT    /api/quick-replies/{id}               # 更新
DELETE /api/quick-replies/{id}               # 删除
POST   /api/quick-replies/{id}/use           # 使用追踪
GET    /api/quick-replies/stats              # 使用统计
```

**请求示例**：
```json
POST /api/quick-replies
{
  "title": "欢迎语",
  "content": "您好{customer_name}，我是{agent_name}，很高兴为您服务",
  "category": "greeting",
  "variables": ["customer_name", "agent_name"],
  "shortcut_key": "Ctrl+1",
  "is_shared": true
}
```

### 3.4 性能要求

**响应时间**：
- 获取快捷回复列表：< 200ms
- 变量替换：< 50ms
- 插入到输入框：< 100ms

**并发支持**：
- 支持10个坐席同时使用快捷回复
- Redis缓存共享模板（TTL 10分钟）

### 3.5 UI/UX设计要点

**快捷回复面板布局**：
```
┌──────────────────────────────────────┐
│ 快捷回复                [+新建] [✕] │
├──────────────────────────────────────┤
│ 分类: [全部▼] [欢迎语] [售前] [售后] │
│ 搜索: [________🔍]                   │
├──────────────────────────────────────┤
│ ┌────────────────────────────────┐   │
│ │ 📄 欢迎语             [编辑] [删] │
│ │ 您好{customer_name}，我是...    │
│ │ 使用 45 次 | Ctrl+1             │
│ └────────────────────────────────┘   │
│ ┌────────────────────────────────┐   │
│ │ 📄 订单发货通知       [编辑] [删] │
│ │ 您的订单{order_id}已发货...     │
│ │ 使用 23 次 | Ctrl+2             │
│ └────────────────────────────────┘   │
└──────────────────────────────────────┘
```

**创建/编辑对话框**：
```
┌──────────────────────────────────────┐
│ 新建快捷回复                    [✕] │
├──────────────────────────────────────┤
│ 标题: [___________________________]  │
│ 分类: [欢迎语 ▼]                    │
│ 内容:                                │
│ ┌────────────────────────────────┐  │
│ │                                 │  │
│ │ [插入变量▼] [预览]              │  │
│ └────────────────────────────────┘  │
│ 快捷键: [Ctrl+1 ▼] (可选)          │
│ 共享: □ 团队共享                    │
├──────────────────────────────────────┤
│               [取消] [保存]          │
└──────────────────────────────────────┘
```

### 3.6 验收标准

**功能验收**：
- [ ] 可创建快捷回复（标题、内容、分类、快捷键、共享）
- [ ] 支持8种预定义变量
- [ ] 支持7种预定义分类
- [ ] 可通过点击、快捷键、命令模式插入
- [ ] 变量自动替换正确
- [ ] 可编辑和删除快捷回复
- [ ] 权限控制正确（普通坐席 vs 管理员）
- [ ] 使用统计准确

**性能验收**：
- [ ] 列表加载 < 200ms
- [ ] 变量替换 < 50ms
- [ ] 支持10个坐席并发使用

**UI验收**：
- [ ] 快捷回复面板布局合理
- [ ] 创建对话框交互流畅
- [ ] 快捷键提示清晰
- [ ] 分类筛选正常

---

## 📋 模块4: 会话标签系统

### 4.1 功能概述

为会话添加标签，实现会话分类、统计分析和智能推荐，提升数据管理能力。

**参考对标**：
- 拼多多客服：支持自定义标签
- 有赞客服：支持标签统计报表

### 4.2 功能需求

#### 4.2.1 标签分类

**F4-1: 预定义标签体系**

| 标签分类 | 标签名称 | 颜色 | 使用场景 |
|---------|---------|------|---------|
| **咨询类型** | | | |
| | 产品咨询 | 蓝色 | 询问产品参数、规格 |
| | 价格咨询 | 绿色 | 询问价格、优惠 |
| | 物流咨询 | 橙色 | 询问物流、配送 |
| | 售后咨询 | 红色 | 退换货、维修 |
| **问题类型** | | | |
| | 产品质量问题 | 红色 | 质量缺陷、故障 |
| | 物流延迟 | 橙色 | 发货慢、物流慢 |
| | 服务态度 | 黄色 | 投诉坐席态度 |
| | 其他问题 | 灰色 | 其他问题 |
| **处理结果** | | | |
| | 已解决 | 绿色 | 问题已解决 |
| | 未解决 | 红色 | 问题未解决 |
| | 转工单 | 蓝色 | 转为工单处理 |
| | 无需处理 | 灰色 | 误触发、无效咨询 |
| **客户情绪** | | | |
| | 满意 | 绿色 | 客户满意 |
| | 一般 | 黄色 | 客户态度一般 |
| | 不满 | 橙色 | 客户不满意 |
| | 愤怒 | 红色 | 客户非常愤怒 |

**F4-2: 自定义标签**

管理员可以创建自定义标签：

**标签属性**：
| 字段 | 说明 | 示例 |
|-----|------|------|
| name | 标签名称 | "VIP客户" |
| category | 所属分类 | "客户类型" |
| color | 颜色（6种） | "red" / "blue" / "green" / "yellow" / "orange" / "gray" |
| description | 标签描述 | "累计消费>$500的客户" |
| auto_rules | 自动打标规则 | `{"field": "order_amount", "operator": ">", "value": 500}` |

**颜色规范**：
- 🔴 红色：严重、紧急、负面
- 🟠 橙色：警告、中等
- 🟡 黄色：提醒、注意
- 🟢 绿色：正常、成功、正面
- 🔵 蓝色：信息、中性
- ⚪ 灰色：其他、默认

#### 4.2.2 打标签操作

**F4-3: 手动打标签**

**操作流程**：
1. 坐席在会话详情页点击"添加标签"
2. 弹出标签选择器（按分类展示）
3. 点击选择标签（支持多选）
4. 标签立即添加到会话

**F4-4: 快捷打标**

在会话列表中支持快速打标：
- 右键点击会话 → "快速打标"
- 批量选择会话 → "批量打标"

**F4-5: 自动打标**

系统根据规则自动添加标签：

**自动规则示例**：
| 触发条件 | 自动添加标签 |
|---------|-------------|
| 对话内容包含"退货" | "售后咨询" + "退换货" |
| 对话内容包含"质量问题" | "产品质量问题" |
| 对话内容包含"投诉" | "服务态度" + "不满" |
| 会话时长 > 10分钟 | "复杂问题" |
| 客户为VIP | "VIP客户" |
| 转为工单 | "转工单" |

**自动打标时机**：
- 会话结束时
- 坐席释放会话时
- 创建工单时

**F4-6: 移除标签**

坐席可以移除不准确的标签：
- 点击标签右侧的"✕"按钮
- 确认移除

**权限要求**：
- 普通坐席：可添加/移除自己服务的会话标签
- 管理员：可添加/移除所有会话标签

#### 4.2.3 标签查询与筛选

**F4-7: 按标签筛选会话**

在会话列表中增加"标签筛选"：

**筛选方式**：
- 单标签筛选：显示包含该标签的所有会话
- 多标签筛选：显示同时包含所有标签的会话（AND逻辑）
- 标签排除：显示不包含某标签的会话

**UI设计**：
```
标签筛选: [产品咨询 ✕] [已解决 ✕] [+添加标签]
```

**F4-8: 标签搜索**

支持搜索标签：
- 输入关键词
- 显示匹配的标签
- 点击选择

#### 4.2.4 标签统计分析

**F4-9: 标签统计报表**

**统计维度**：
| 统计项 | 说明 | 用途 |
|-------|------|------|
| 标签使用频率 | 每个标签的使用次数 | 了解热门咨询类型 |
| 标签趋势 | 标签使用量的时间趋势 | 发现问题趋势 |
| 标签组合 | 常见的标签组合 | 发现关联问题 |
| 坐席标签分布 | 每个坐席打标分布 | 评估坐席工作质量 |

**报表示例**：
```
📊 本月标签统计

咨询类型分布:
- 产品咨询: 45% (456次)
- 物流咨询: 25% (256次)
- 售后咨询: 20% (203次)
- 价格咨询: 10% (98次)

问题类型分布:
- 产品质量问题: 35%
- 物流延迟: 40%
- 其他问题: 25%

处理结果:
- 已解决: 80%
- 转工单: 15%
- 未解决: 5%
```

**F4-10: 标签数据导出**

支持导出标签统计数据：
- 导出格式：Excel / CSV
- 导出字段：会话ID、标签列表、创建时间、坐席
- 导出权限：仅管理员

### 4.3 数据模型

**标签数据结构**：

```typescript
interface Tag {
  id: string                          // 标签ID
  name: string                        // 标签名称
  category: TagCategory               // 所属分类
  color: TagColor                     // 颜色
  description: string                 // 描述
  auto_rules: AutoTagRule | null      // 自动打标规则
  usage_count: number                 // 使用次数
  created_at: Date                    // 创建时间
  created_by: string                  // 创建者
}

type TagCategory =
  | 'inquiry_type'      // 咨询类型
  | 'problem_type'      // 问题类型
  | 'result_type'       // 处理结果
  | 'emotion_type'      // 客户情绪
  | 'custom'            // 自定义

type TagColor = 'red' | 'blue' | 'green' | 'yellow' | 'orange' | 'gray'

interface AutoTagRule {
  field: string                       // 匹配字段
  operator: 'contains' | '>' | '<' | '='  // 操作符
  value: string | number              // 匹配值
}

interface SessionTag {
  session_name: string                // 会话ID
  tag_id: string                      // 标签ID
  added_by: string                    // 添加者
  added_at: Date                      // 添加时间
  is_auto: boolean                    // 是否自动添加
}
```

**后端API设计**：

```
GET    /api/tags                              # 获取标签列表
POST   /api/tags                              # 创建标签
GET    /api/tags/{id}                         # 获取标签详情
PUT    /api/tags/{id}                         # 更新标签
DELETE /api/tags/{id}                         # 删除标签

POST   /api/sessions/{session_name}/tags     # 为会话添加标签
DELETE /api/sessions/{session_name}/tags/{tag_id}  # 移除标签
GET    /api/sessions/{session_name}/tags     # 获取会话标签

GET    /api/tags/stats                        # 标签统计
GET    /api/tags/export                       # 导出标签数据
```

**请求示例**：
```json
POST /api/sessions/session_123/tags
{
  "tag_ids": ["tag_001", "tag_002"],
  "is_auto": false
}
```

### 4.4 性能要求

**响应时间**：
- 获取标签列表：< 100ms
- 添加标签：< 200ms
- 标签筛选：< 300ms
- 自动打标：< 500ms

**并发支持**：
- 支持10个坐席同时打标签
- Redis缓存标签列表（TTL 5分钟）

### 4.5 UI/UX设计要点

**标签显示**：
```
┌─────────────────────────────────────┐
│ 会话: 张三 - 咨询退货问题            │
│                                      │
│ 标签: [产品咨询] [售后咨询] [已解决] │
│       [+添加标签]                    │
└─────────────────────────────────────┘
```

**标签选择器**：
```
┌──────────────────────────────────────┐
│ 添加标签                        [✕] │
├──────────────────────────────────────┤
│ 分类: [全部] [咨询] [问题] [结果]   │
│ 搜索: [________🔍]                   │
├──────────────────────────────────────┤
│ 咨询类型:                            │
│ [✓产品咨询] [ 价格咨询] [ 物流咨询] │
│                                      │
│ 问题类型:                            │
│ [ 产品质量问题] [✓物流延迟]         │
├──────────────────────────────────────┤
│               [取消] [确定]          │
└──────────────────────────────────────┘
```

**标签统计图表**：
使用 ECharts 饼图、柱状图展示标签分布。

### 4.6 验收标准

**功能验收**：
- [ ] 支持4种预定义标签分类（共15个标签）
- [ ] 可创建自定义标签
- [ ] 可手动添加/移除标签
- [ ] 支持快捷打标和批量打标
- [ ] 自动打标规则正确触发
- [ ] 可按标签筛选会话
- [ ] 标签统计报表准确
- [ ] 可导出标签数据（仅管理员）

**性能验收**：
- [ ] 标签列表加载 < 100ms
- [ ] 添加标签 < 200ms
- [ ] 标签筛选 < 300ms
- [ ] 自动打标 < 500ms

**UI验收**：
- [ ] 标签颜色符合规范
- [ ] 标签选择器交互流畅
- [ ] 标签统计图表正确显示
- [ ] 响应式布局

---

## 🔗 与其他模块的关系

**依赖关系**：
- **依赖**: Part1 的会话管理和筛选功能
- **被依赖**: L1-2 工单系统（工单可关联标签）、L3-1 数据分析（基于标签统计）

**数据流**：
```
坐席接入会话
  ↓
使用快捷回复（提升效率）
  ↓
会话结束
  ↓
手动/自动打标签
  ↓
标签统计分析
```

---

## 📊 开发优先级

### 第一阶段（P0 - 必须实现）
- [x] 快捷回复基础功能（创建、使用、管理）
- [x] 预定义变量替换
- [x] 标签基础功能（创建、添加、移除）
- [x] 预定义标签体系

### 第二阶段（P1 - 重要）
- [ ] 快捷键支持
- [ ] 命令模式（/ 触发）
- [ ] 自动打标规则
- [ ] 标签筛选

### 第三阶段（P2 - 优化）
- [ ] 使用统计报表
- [ ] 标签趋势分析
- [ ] 智能推荐模板
- [ ] 数据导出

---

## 🧪 测试要点

### 单元测试
- 变量替换逻辑
- 自动打标规则匹配
- 标签筛选查询

### 集成测试
- 快捷回复 + 变量替换
- 标签 + 会话筛选
- 权限控制（普通坐席 vs 管理员）

### 性能测试
- 100个快捷回复的加载性能
- 50个标签的筛选性能
- 10个坐席并发打标签

---

## 📝 实施注意事项

### 技术约束
1. **快捷回复组件复用**：前端已有 `QuickReplies.vue`，需要激活并扩展
2. **Redis TTL**：快捷回复和标签数据必须设置过期时间
3. **JWT权限**：快捷回复和标签管理需要 `require_agent()` 中间件
4. **变量替换安全性**：防止XSS攻击，对变量值进行HTML转义

### 开发建议
1. 先实现快捷回复基础功能，再实现快捷键
2. 先实现手动打标签，再实现自动打标
3. 使用 Pinia 状态管理，减少重复请求
4. 快捷回复和标签列表使用Redis缓存

### 数据持久化
- 快捷回复：存储在 Redis，TTL 30天
- 标签定义：存储在 Redis，TTL 永久（管理员删除才失效）
- 会话标签关联：存储在 Redis，TTL 7天

---

## 📚 参考资料

- **技术约束**: `prd/02_约束与原则/CONSTRAINTS_AND_PRINCIPLES.md`
- **API契约**: `prd/03_技术方案/api_contract.md`
- **前端组件**: `agent-workbench/src/components/QuickReplies.vue` (待激活)

---

**下一步**: 阅读 `L1-1-Part3_协作与工作台优化.md`

**文档维护者**: Claude Code
**最后更新**: 2025-01-26
