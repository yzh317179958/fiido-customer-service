# L4-1: 多语言实时翻译系统

> **文档编号**: L4-1
> **文档版本**: v1.0
> **优先级**: P0（跨境增强层 - 核心必备）
> **状态**: ❌ 待开发
> **创建时间**: 2025-01-27
> **最后更新**: 2025-01-27

---

## 📑 文档导航

- **上级文档**: [ENTERPRISE_EBIKE_SUPPORT_TASKS.md](./ENTERPRISE_EBIKE_SUPPORT_TASKS.md)
- **同级文档**:
  - 当前: L4-1 多语言实时翻译系统
  - 下一篇: L4-2-Part1 全渠道服务集成
- **依赖关系**: 依赖 L1-1 会话管理（消息流）

---

## 🎯 功能概述

### 涵盖模块

本文档包含多语言翻译系统的全部功能模块（不拆分）：

| 模块编号 | 模块名称 | 核心功能 |
|---------|---------|---------|
| **模块1** | 语言自动检测与识别 | 检测客户语言、识别置信度、语言切换 |
| **模块2** | 实时双向翻译引擎 | 客户→坐席翻译、坐席→客户翻译、异步处理 |
| **模块3** | 专业术语库管理 | E-bike术语、定制词典、翻译记忆 |
| **模块4** | 翻译质量优化 | 上下文理解、人工修正、质量评估 |

### 业务价值

**当前痛点**：
- ❌ 只支持英语客户，损失50%+非英语市场
- ❌ 坐席无法服务德语、法语、西班牙语客户
- ❌ 需要雇佣多语言坐席，人力成本高

**实现后收益**：
- 📈 市场覆盖率提升 **150%**（支持全球主要语言）
- 📈 坐席利用率提升 **200%**（一个坐席服务多语言客户）
- 📈 客户满意度提升 **60%**（母语沟通）
- 💰 人力成本降低 **40%**（无需多语言坐席）
- 📊 转化率提升 **35%**（消除语言障碍）

**Fiido 跨境电商场景**：
> **德国客户场景**：
> - 客户（德语）："Wie lange dauert die Lieferung nach München?"
> - 系统自动翻译给坐席（英语）："How long does delivery to Munich take?"
> - 坐席回复（英语）："Delivery to Munich typically takes 5-7 business days."
> - 系统自动翻译给客户（德语）："Die Lieferung nach München dauert in der Regel 5-7 Werktage."
> 
> **效果**：
> - 客户用母语沟通，体验优秀
> - 坐席用英语工作，无需学习德语
> - 双方都不知道中间有翻译，沟通无缝

---

## 📋 模块1: 语言自动检测与识别

### 1.1 功能概述

自动识别客户使用的语言，无需手动选择。

### 1.2 功能需求

#### F1-1: 自动语言检测

**检测时机**：
- 客户首次发送消息时自动检测
- 检测结果保存到客户画像
- 后续会话自动使用该语言

**检测算法**：
```
业务逻辑：
1. 接收客户消息文本
2. 调用语言检测API（Google Cloud Translation API / Azure Cognitive Services）
3. 获取检测结果：语言代码 + 置信度
4. IF 置信度 > 85%: 自动应用该语言
   ELSE: 显示语言选择器，让客户手动选择
5. 保存语言偏好到 customer_profile.language
```

**支持的语言列表**（覆盖Fiido主要市场）：

| 语言 | 语言代码 | 市场占比 | 优先级 |
|------|---------|---------|--------|
| 英语 | en | 40% | P0 |
| 德语 | de | 15% | P0 |
| 法语 | fr | 12% | P0 |
| 西班牙语 | es | 10% | P0 |
| 意大利语 | it | 8% | P1 |
| 荷兰语 | nl | 5% | P1 |
| 日语 | ja | 4% | P1 |
| 韩语 | ko | 3% | P1 |
| 中文简体 | zh-CN | 2% | P1 |
| 葡萄牙语 | pt | 1% | P2 |

#### F1-2: 语言切换功能

**用户端语言切换**：
- 客户可手动切换语言（下拉选择器）
- 切换后重新翻译历史消息（最近10条）
- 保存新语言偏好

**坐席端语言显示**：
- 显示客户使用的语言（图标 + 文字）
- 示例：🇩🇪 德语（置信度 98%）
- 可手动修正检测结果

#### F1-3: 多语言混用处理

**场景**：客户在对话中切换语言

```
业务逻辑：
1. 每条消息独立检测语言
2. IF 连续3条消息语言变化:
     显示提示："检测到您使用了{新语言}，是否切换？"
3. 客户确认后，更新语言偏好
```

### 1.3 数据模型

```typescript
// 语言检测结果
interface LanguageDetection {
  message_id: string
  detected_language: string      // ISO 639-1 语言代码
  confidence: number              // 0-100 置信度
  detection_time: Date
  detection_source: 'auto' | 'manual' | 'profile'
}

// 客户语言偏好
interface CustomerLanguagePreference {
  customer_id: string
  primary_language: string        // 主要语言
  fallback_language: 'en'         // 降级语言（默认英语）
  language_detection_history: LanguageDetection[]
  last_updated: Date
}
```

### 1.4 API设计

```
POST /api/translation/detect             # 检测语言
PUT  /api/customers/{id}/language        # 更新语言偏好
GET  /api/translation/supported-languages # 获取支持的语言列表
```

### 1.5 约束条件

- **不阻塞消息发送**：语言检测异步进行，不影响消息实时性
- **降级策略**：检测失败时默认使用英语
- **缓存策略**：客户语言偏好缓存60分钟

---

## 📋 模块2: 实时双向翻译引擎

### 2.1 功能概述

提供客户↔坐席的实时双向翻译，延迟 < 1秒。

### 2.2 功能需求

#### F2-1: 客户→坐席翻译

**翻译流程**：
```
业务逻辑：
1. 客户发送消息（原语言：德语）
2. 系统接收消息并保存原文
3. 异步调用翻译API，翻译为坐席语言（英语）
4. 坐席端显示：
   - 主显示：翻译后文本（英语）
   - 副显示：原文（德语，可折叠查看）
   - 翻译图标：🌐 表示已翻译
5. 保存翻译结果到数据库（原文 + 译文）
```

**性能要求**：
- 翻译延迟 < 800ms
- 批量消息翻译（≤5条/批次）
- 失败重试机制（最多3次）

#### F2-2: 坐席→客户翻译

**翻译流程**：
```
业务逻辑：
1. 坐席输入回复（英语）
2. 点击"发送"按钮
3. 系统翻译为客户语言（德语）
4. 客户端显示：翻译后文本（德语）
5. 坐席端显示：
   - 主显示：原文（英语）
   - 副显示：已发送的译文（德语，可查看）
```

**预览功能**：
- 坐席可预览翻译结果后再发送
- 可手动修正翻译错误
- 修正后的翻译加入翻译记忆库

#### F2-3: 双语显示模式

**坐席端UI设计**：
```
┌─────────────────────────────────────┐
│ 客户: Hans Schmidt  🇩🇪 德语        │
├─────────────────────────────────────┤
│ 对话记录                             │
│                                      │
│ 👤 客户 (10:30)                      │
│ "How long does delivery take?"      │
│ 🌐 [查看原文(DE): "Wie lange...]    │
│                                      │
│ 👨‍💼 坐席 (10:31)                    │
│ "Delivery typically takes 5-7 days."│
│ ✅ [已翻译发送]                      │
│                                      │
│ 👤 客户 (10:32)                      │
│ "What's the battery warranty?"      │
│ 🌐 [查看原文(DE): "Wie ist die...]  │
│                                      │
├─────────────────────────────────────┤
│ 回复框                               │
│ [The battery has a 2-year war...]   │
│                                      │
│ 💡 将翻译为德语发送给客户            │
│ [🔍 预览翻译] [发送]                │
└─────────────────────────────────────┘
```

**客户端UI设计**：
```
客户看到的（全部是德语）：
┌─────────────────────────────────────┐
│ Fiido Kundenservice                 │
├─────────────────────────────────────┤
│                                      │
│ 👤 Sie (10:30)                       │
│ "Wie lange dauert die Lieferung?"   │
│                                      │
│ 🤖 Kundenservice (10:31)             │
│ "Die Lieferung dauert in der Regel  │
│  5-7 Werktage."                      │
│                                      │
│ 👤 Sie (10:32)                       │
│ "Wie ist die Batteriegarantie?"     │
│                                      │
└─────────────────────────────────────┘
```

#### F2-4: 翻译失败处理

**降级策略**：
```
业务逻辑：
IF 翻译API失败:
  1. 重试3次（间隔1秒）
  2. 仍失败：
     - 坐席端：显示原文 + "⚠️ 翻译失败，请手动翻译"
     - 客户端：显示原文 + 语言提示
  3. 记录失败日志，告警运维团队
```

### 2.3 翻译引擎选择

**推荐方案**：
- **主引擎**：DeepL API（翻译质量最高，适合商业对话）
- **备用引擎**：Google Cloud Translation API（降级方案）
- **成本优化**：Azure Translator（大批量场景）

**API调用封装**：
```typescript
// 统一翻译接口
interface TranslationService {
  translate(text: string, sourceLang: string, targetLang: string): Promise<TranslationResult>
  
  // 支持多引擎切换
  engines: ['deepl', 'google', 'azure']
  
  // 自动降级
  fallback: true
}
```

### 2.4 性能优化

**缓存策略**：
- 常用短语缓存（"你好"、"谢谢"等）
- 缓存有效期：7天
- 缓存命中率目标：> 30%

**批量翻译**：
- 积累5条消息或500ms后批量翻译
- 减少API调用次数
- 降低成本

---

## 📋 模块3: 专业术语库管理

### 3.1 功能概述

建立E-bike行业专业术语库，确保翻译准确性。

### 3.2 功能需求

#### F3-1: E-bike专业术语库

**术语类别**：

| 类别 | 术语数量 | 示例 |
|-----|---------|------|
| 产品名称 | 50+ | Fiido D11, D21, X, L3 |
| 技术参数 | 100+ | 续航里程、电池容量、电机功率 |
| 功能特性 | 80+ | 踏板助力、纯电模式、智能变速 |
| 售后服务 | 60+ | 保修政策、退换货、维修服务 |
| 物流配送 | 40+ | 发货时间、运输方式、关税 |

**术语库示例**：
```json
{
  "term": "pedal assist",
  "category": "feature",
  "translations": {
    "de": "Tretunterstützung",
    "fr": "assistance au pédalage",
    "es": "asistencia al pedaleo",
    "it": "assistenza alla pedalata"
  },
  "context": "产品功能描述",
  "priority": "high"
}
```

#### F3-2: 定制词典管理

**管理功能**：
- 管理员可添加/编辑术语
- 术语优先级设置（高/中/低）
- 术语使用频率统计
- 批量导入/导出

**UI界面**：
```
┌─────────────────────────────────────┐
│ 专业术语库管理                       │
├─────────────────────────────────────┤
│ [搜索术语] [+ 添加术语]   [导入CSV] │
│                                      │
│ 类别筛选: [全部▼] [产品名称] ...    │
│                                      │
│ ┌─────────────────────────────────┐ │
│ │ pedal assist (踏板助力)          │ │
│ │ 德语: Tretunterstützung          │ │
│ │ 法语: assistance au pédalage     │ │
│ │ 使用次数: 245次                  │ │
│ │ [编辑] [删除]                    │ │
│ └─────────────────────────────────┘ │
│                                      │
│ ┌─────────────────────────────────┐ │
│ │ battery range (续航里程)         │ │
│ │ 德语: Batteriereichweite         │ │
│ │ 法语: autonomie de la batterie   │ │
│ │ 使用次数: 189次                  │ │
│ │ [编辑] [删除]                    │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

#### F3-3: 翻译记忆库

**功能说明**：
- 记录历史翻译结果
- 相同内容复用历史翻译
- 减少API调用，降低成本

**匹配逻辑**：
```
业务逻辑：
1. 接收待翻译文本
2. 计算文本哈希值
3. 查询翻译记忆库
4. IF 完全匹配（100%）: 直接返回历史翻译
5. ELSE IF 模糊匹配（> 80%）: 显示历史翻译供参考
6. ELSE: 调用翻译API，结果存入翻译记忆库
```

---

## 📋 模块4: 翻译质量优化

### 4.1 功能概述

通过上下文理解、人工修正、质量评估提升翻译准确度。

### 4.2 功能需求

#### F4-1: 上下文感知翻译

**上下文窗口**：
- 保留最近5轮对话历史
- 传递给翻译API作为上下文
- 提升多义词翻译准确性

**示例**：
```
上下文：
客户: "How much is the D11?"
坐席: "$1,099"
客户: "Does it come in black?"
         ↓
上下文提示翻译引擎："it" 指代 "D11"
准确翻译（德语）: "Gibt es das D11 in Schwarz?"
```

#### F4-2: 人工修正与反馈

**坐席修正功能**：
- 坐席可修正翻译错误
- 修正后的翻译加入术语库
- 修正记录用于优化翻译模型

**反馈收集**：
```
┌─────────────────────────────────────┐
│ 翻译: "Delivery takes 5-7 days"     │
│ 译文: "Die Lieferung dauert 5-7..."│
│                                      │
│ 翻译质量评分:                        │
│ ⭐⭐⭐⭐⭐ (5/5)                      │
│                                      │
│ [ ] 翻译有误，我要修正               │
│                                      │
│ [跳过] [提交反馈]                   │
└─────────────────────────────────────┘
```

#### F4-3: 翻译质量监控

**质量指标**：
- 翻译准确率（人工抽检）
- 翻译延迟统计
- 翻译失败率
- 坐席修正频率

**告警规则**：
- 翻译失败率 > 5%：邮件告警
- 平均延迟 > 1.5秒：优化提示
- 坐席修正率 > 10%：复核术语库

---

## 🔗 与其他模块的关系

**依赖关系**：
- **依赖**: L1-1 会话管理（消息流）
- **依赖**: L2-2 客户画像（语言偏好存储）
- **被依赖**: L4-2 全渠道（社交媒体多语言）
- **被依赖**: L2-3 知识库（多语言知识搜索）

**数据流**：
```
客户发送消息（德语）
  ↓
语言检测（模块1）
  ↓
翻译为英语（模块2）→ 使用术语库（模块3）
  ↓
坐席查看（双语显示）
  ↓
坐席回复（英语）
  ↓
翻译为德语（模块2）→ 上下文优化（模块4）
  ↓
客户收到（德语）
```

---

## 📊 开发优先级

### 第一阶段（P0 - 立即开发）
- [ ] 语言自动检测
- [ ] 客户→坐席翻译
- [ ] 坐席→客户翻译
- [ ] 支持5种核心语言（英/德/法/西/意）

### 第二阶段（P1 - 重要）
- [ ] E-bike专业术语库（100+术语）
- [ ] 翻译记忆库
- [ ] 翻译预览功能
- [ ] 支持10种语言

### 第三阶段（P2 - 优化）
- [ ] 上下文感知翻译
- [ ] 人工修正与反馈
- [ ] 翻译质量监控
- [ ] 模糊匹配推荐

---

## 🧪 测试要点

### 功能测试
- 10种语言检测准确性测试
- 翻译准确性人工评估（抽检100条）
- 术语库匹配测试
- 双向翻译一致性测试

### 性能测试
- 翻译延迟测试（目标 < 800ms）
- 100并发翻译压力测试
- 翻译记忆库命中率统计

### 边界测试
- 超长文本翻译（> 500字符）
- 多语言混用处理
- 翻译API失败降级

---

## 📝 实施注意事项

### 技术约束
1. **异步翻译**：翻译不能阻塞消息发送，采用异步处理
2. **降级策略**：翻译失败时显示原文，不影响业务
3. **成本控制**：使用缓存、批量翻译降低API调用
4. **数据安全**：客户消息加密传输，符合GDPR

### 成本估算
- DeepL API：$20/百万字符
- 预估月翻译量：500万字符
- 预估月成本：$100（缓存命中率30%后）

### Fiido 业务特点
- 技术产品，专业术语多，必须建立术语库
- 德语市场最大，优先保证德语翻译质量
- 客户询问频繁：续航、保修、物流，准备标准翻译

---

**文档维护者**: Claude Code
**最后更新**: 2025-01-27
