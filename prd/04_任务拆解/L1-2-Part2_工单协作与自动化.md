# L1-2-Part2: 工单协作与自动化功能需求

> **文档编号**: L1-2-Part2
> **文档版本**: v1.1
> **优先级**: P0（基础层 - 必须实现）
> **状态**: 🚧 开发中
> **创建时间**: 2025-01-27
> **最后更新**: 2025-11-25

> **最新进度同步（2025-11-25）**
> - ✅ 模块4：提供 `/api/tickets/{id}/comments`/`DELETE`/`GET`，支持内部评论、列表与指派历史
> - ✅ 模块5：已有 SLA 概览 `/api/tickets/sla-summary` 与告警 `/api/tickets/sla-alerts`
> - ⏳ 模块4：@提醒、附件、协作日志 UI 未完成
> - ⏳ 模块5：SLA 可视化、阈值配置仍缺失
> - ⏳ 模块6：自动化规则尚未启动

---

## 📑 文档导航

- **上级文档**: [ENTERPRISE_EBIKE_SUPPORT_TASKS.md](./ENTERPRISE_EBIKE_SUPPORT_TASKS.md)
- **同级文档**:
  - 上一篇: L1-2-Part1 工单核心功能
  - 当前: L1-2-Part2 工单协作与自动化
- **依赖关系**: 依赖 L1-2-Part1 的工单基础功能

---

## 🎯 Part 2 概述

### 涵盖模块

本文档包含工单系统增强的后三个模块：

| 模块编号 | 模块名称 | 核心功能 |
|---------|---------|---------|
| **模块4** | 工单协作功能 | 内部评论、@提醒、协作日志、附件共享 |
| **模块5** | SLA时效管理 | 响应时效、解决时效、超时预警、报表统计 |
| **模块6** | 工单自动化 | 自动分配规则、自动回复、工作流触发器 |

### 业务价值

**当前痛点**（v3.4.0）：
- ❌ 缺少内部协作功能：坐席之间无法讨论工单
- ❌ 缺少SLA管理：无法量化服务质量
- ❌ 缺少自动化规则：大量重复性工作
- ❌ 超时工单无预警：服务质量无法保障

**实现后收益**：
- 📈 复杂工单处理效率提升 **70%**（团队协作）
- 📈 SLA达成率提升至 **95%+**（时效管理）
- 📈 重复性工作减少 **60%**（自动化规则）
- 📊 客户满意度提升 **40%**（响应更及时）

---

## 📋 模块4: 工单协作功能

### 4.1 功能概述

支持坐席团队内部协作处理复杂工单，包括内部评论、@提醒、协作日志和附件共享。

**参考对标**：
- Zendesk：内部笔记和协作功能
- JIRA：强大的评论和@提醒系统
- Slack：团队协作体验

### 4.2 内部评论系统

#### 4.2.1 评论类型

**两种评论模式**：

| 评论类型 | 可见性 | 使用场景 | 示例 |
|---------|-------|---------|------|
| **公开回复** | 客户可见 | 回复客户问题 | "您好，电池已经为您更换" |
| **内部备注** | 仅坐席可见 | 团队内部沟通 | "客户情绪激动，建议主管介入" |

**UI设计**：

```
工单详情页 - 回复区域

┌─────────────────────────────────────────────────────┐
│  回复客户                                            │
│  ┌───────────────────────────────────────────────┐  │
│  │ 输入回复内容...                               │  │
│  │                                               │  │
│  └───────────────────────────────────────────────┘  │
│  📎 添加附件  😊 插入表情  📝 快捷回复              │
│                                                      │
│  ○ 公开回复（客户可见）                              │
│  ○ 内部备注（仅团队可见）                            │
│                                                      │
│  [取消]                              [发送回复]      │
└─────────────────────────────────────────────────────┘
```

#### 4.2.2 评论功能

**F4-1: 富文本编辑**

支持的格式：
- **粗体**、*斜体*、~~删除线~~
- 有序列表、无序列表
- 代码块（用于技术说明）
- 超链接
- 图片插入
- 表格

**F4-2: @提醒功能**

用法：
```
在评论中输入 @，弹出坐席列表
选择坐席：@张客服
发送后，张客服收到通知
```

通知内容：
```
🔔 @提醒
张客服在工单 TKT-20250127-001 中提到了你：
"@李客服 这个电池问题需要你帮忙看下技术方案"

[查看工单]
```

**F4-3: 评论引用**

点击评论右侧"引用"按钮：
```
> 李客服 10:30:
> 客户要求退款

我已经联系财务部门处理
```

#### 4.2.3 评论历史

**显示格式**：

```
┌─────────────────────────────────────────────────────┐
│  工单对话                                            │
├─────────────────────────────────────────────────────┤
│  🕐 2025-01-27 10:00                                │
│  👤 客户：张三                                       │
│  我的电池续航只有20公里，是不是有问题？              │
│                                                      │
│  🕐 2025-01-27 10:05                                │
│  👨‍💼 坐席：李客服                                     │
│  您好，请问您购买多久了？平时如何充电？              │
│                                                      │
│  🕐 2025-01-27 10:10                                │
│  🔒 内部备注：李客服                                 │
│  客户购买3个月，可能是充电方式不对                   │
│  @王技术 帮忙看下是否需要现场检测                    │
│                                                      │
│  🕐 2025-01-27 10:15                                │
│  🔒 内部备注：王技术                                 │
│  @李客服 建议先让客户做一次完整充放电测试            │
│                                                      │
│  🕐 2025-01-27 10:20                                │
│  👨‍💼 坐席：李客服                                     │
│  建议您先做一次完整充放电：骑到电量10%以下，         │
│  然后充满电（充电器绿灯亮），再测试续航              │
└─────────────────────────────────────────────────────┘
```

### 4.3 协作日志

#### 4.3.1 自动记录事件

系统自动记录以下操作：

| 事件类型 | 触发条件 | 日志示例 |
|---------|---------|---------|
| 工单创建 | 创建新工单 | "李客服 创建了工单" |
| 状态变更 | 修改工单状态 | "李客服 将状态从'待处理'改为'处理中'" |
| 优先级调整 | 修改优先级 | "王主管 将优先级从'中'调整为'高'" |
| 坐席分配 | 转派工单 | "李客服 将工单分配给 张客服" |
| 标签添加 | 添加标签 | "李客服 添加了标签 '电池问题'" |
| 客户回复 | 客户发送消息 | "客户 张三 回复了消息" |
| 附件上传 | 上传文件 | "李客服 上传了附件 '故障照片.jpg'" |
| 关联订单 | 关联Shopify订单 | "李客服 关联了订单 ORD123456" |

**日志格式**：

```
┌─────────────────────────────────────────────────────┐
│  协作日志                                            │
├─────────────────────────────────────────────────────┤
│  🕐 2025-01-27 09:00                                │
│  📋 李客服 创建了工单                                │
│                                                      │
│  🕐 2025-01-27 09:05                                │
│  👤 李客服 将工单分配给 张客服                       │
│  原因: 需要技术支持                                  │
│                                                      │
│  🕐 2025-01-27 09:10                                │
│  ⚠️ 张客服 将优先级从'中'调整为'高'                  │
│  原因: 客户为VIP客户                                 │
│                                                      │
│  🕐 2025-01-27 09:15                                │
│  🏷️ 张客服 添加了标签: 电池问题, VIP客户             │
│                                                      │
│  🕐 2025-01-27 10:00                                │
│  📎 张客服 上传了附件: 检测报告.pdf                  │
│                                                      │
│  🕐 2025-01-27 10:30                                │
│  ✅ 张客服 将状态从'处理中'改为'已解决'              │
└─────────────────────────────────────────────────────┘
```

### 4.4 附件管理

#### 4.4.1 支持的附件类型

| 文件类型 | 扩展名 | 大小限制 | 用途 |
|---------|-------|---------|------|
| 图片 | jpg, png, gif, webp | 10MB | 产品照片、故障截图 |
| 文档 | pdf, doc, docx | 20MB | 说明书、检测报告 |
| 表格 | xls, xlsx, csv | 10MB | 数据清单 |
| 视频 | mp4, mov | 50MB | 故障视频 |
| 压缩包 | zip, rar | 30MB | 批量文件 |

#### 4.4.2 附件上传

**UI交互**：

```
┌─────────────────────────────────────────────────────┐
│  上传附件                                            │
├─────────────────────────────────────────────────────┤
│  [拖拽文件到此处 或 点击选择]                        │
│                                                      │
│  已上传:                                             │
│  ┌─────────────────────────────────────┐            │
│  │ 📄 故障照片.jpg (2.3 MB)            │ [删除]     │
│  │ 👁️ 预览  📥 下载                     │            │
│  └─────────────────────────────────────┘            │
│                                                      │
│  ┌─────────────────────────────────────┐            │
│  │ 📋 检测报告.pdf (1.8 MB)            │ [删除]     │
│  │ 📥 下载                              │            │
│  └─────────────────────────────────────┘            │
│                                                      │
│  提示: 最多上传10个文件，总大小不超过100MB           │
└─────────────────────────────────────────────────────┘
```

#### 4.4.3 附件权限

**可见性控制**：

| 附件类型 | 客户可见 | 坐席可见 | 说明 |
|---------|---------|---------|------|
| 客户上传 | ✅ | ✅ | 客户上传的文件 |
| 公开回复附件 | ✅ | ✅ | 坐席在公开回复中上传 |
| 内部备注附件 | ❌ | ✅ | 坐席在内部备注中上传 |
| 系统文档 | ❌ | ✅ | 内部参考文档 |

---

## 📋 模块5: SLA时效管理

### 5.1 功能概述

实现服务水平协议（SLA）管理，量化服务质量，确保及时响应和解决客户问题。

**参考对标**：
- Zendesk：完善的SLA管理
- Freshdesk：SLA违规预警
- JIRA Service Desk：多级SLA策略

### 5.2 SLA指标定义

#### 5.2.1 核心指标

**首次响应时效（First Response Time, FRT）**

定义：从工单创建到坐席首次回复的时间

| 优先级 | 目标时效 | 警告阈值 | 违规阈值 |
|-------|---------|---------|---------|
| 紧急 | 10分钟 | 8分钟 | 10分钟 |
| 高 | 30分钟 | 25分钟 | 30分钟 |
| 中 | 2小时 | 1.5小时 | 2小时 |
| 低 | 8小时 | 6小时 | 8小时 |

**解决时效（Resolution Time, RT）**

定义：从工单创建到标记为"已解决"的时间

| 工单类型 | 优先级 | 目标时效 | 警告阈值 | 违规阈值 |
|---------|-------|---------|---------|---------|
| 售前咨询 | 高 | 4小时 | 3小时 | 4小时 |
| 售前咨询 | 中 | 1工作日 | 20小时 | 24小时 |
| 售后问题 | 紧急 | 8小时 | 6小时 | 8小时 |
| 售后问题 | 高 | 2工作日 | 36小时 | 48小时 |
| 售后问题 | 中 | 3工作日 | 60小时 | 72小时 |
| 投诉建议 | 高 | 1工作日 | 20小时 | 24小时 |

**工作时间定义**：
- 工作日：周一至周五
- 工作时间：9:00-18:00（中国时间 UTC+8）
- 节假日：不计入工作日（使用中国法定节假日）

#### 5.2.2 SLA状态

**工单SLA状态**：

| 状态 | 颜色标识 | 触发条件 | 显示位置 |
|-----|---------|---------|---------|
| 正常 | 🟢 绿色 | 时间充裕（<50%阈值） | 工单列表、详情页 |
| 警告 | 🟡 黄色 | 接近超时（50%-80%阈值） | 工单列表、详情页 |
| 紧急 | 🟠 橙色 | 即将超时（80%-100%阈值） | 工单列表、详情页、通知 |
| 违规 | 🔴 红色 | 已超时（>100%阈值） | 工单列表、详情页、通知、报表 |

### 5.3 SLA可视化

#### 5.3.1 工单列表显示

**SLA倒计时显示**：

```
工单列表

ID          标题        优先级  状态      SLA剩余时间
─────────────────────────────────────────────────────
TKT-001  电池续航问题    高    处理中    🟢 剩余 1小时20分
TKT-002  订单未收到      紧急  待处理    🟠 剩余 5分钟
TKT-003  退款申请        中    等待客户  🟡 剩余 30分钟
TKT-004  产品咨询        低    处理中    🟢 剩余 6小时
TKT-005  质量投诉        高    处理中    🔴 已超时 2小时
```

#### 5.3.2 工单详情页显示

```
┌─────────────────────────────────────────────────────┐
│  工单 TKT-20250127-002                              │
├─────────────────────────────────────────────────────┤
│  标题: 订单未收到                                    │
│  优先级: 🔴 紧急                                     │
│  状态: 待处理                                        │
│                                                      │
│  SLA时效监控                                         │
│  ┌───────────────────────────────────────────────┐  │
│  │ 首次响应 SLA                                  │  │
│  │ 目标: 10分钟                                  │  │
│  │ 已用: 5分钟                                   │  │
│  │ 剩余: 🟠 5分钟                                │  │
│  │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░ 80%                      │  │
│  └───────────────────────────────────────────────┘  │
│                                                      │
│  ┌───────────────────────────────────────────────┐  │
│  │ 解决时效 SLA                                  │  │
│  │ 目标: 8小时                                   │  │
│  │ 已用: 5分钟                                   │  │
│  │ 剩余: 🟢 7小时55分                            │  │
│  │ ▓░░░░░░░░░░░░░░░░░░░ 1%                       │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

#### 5.3.3 仪表盘统计

**SLA达成率仪表盘**：

```
┌─────────────────────────────────────────────────────┐
│  SLA达成率 - 本周                                    │
├─────────────────────────────────────────────────────┤
│  首次响应 SLA                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 92%            │
│  达成: 184次  违规: 16次  总计: 200次                │
│                                                      │
│  解决时效 SLA                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 88%                 │
│  达成: 132次  违规: 18次  总计: 150次                │
│                                                      │
│  违规工单分析                                        │
│  主要原因:                                           │
│  • 非工作时间工单积压 (40%)                          │
│  • 坐席人手不足 (30%)                                │
│  • 复杂技术问题 (20%)                                │
│  • 其他 (10%)                                        │
└─────────────────────────────────────────────────────┘
```

### 5.4 SLA预警与通知

#### 5.4.1 预警规则

**自动预警触发**：

| 预警级别 | 触发条件 | 通知对象 | 通知方式 |
|---------|---------|---------|---------|
| 一级预警 | 达到80%阈值 | 处理坐席 | 工作台弹窗、声音提示 |
| 二级预警 | 达到90%阈值 | 处理坐席、组长 | 工作台弹窗、邮件 |
| 三级预警 | 已违规 | 处理坐席、组长、主管 | 工作台通知、邮件、短信 |

**预警通知内容**：

```
🚨 SLA预警

工单: TKT-20250127-002
标题: 订单未收到
优先级: 紧急
状态: 待处理

首次响应 SLA: 剩余 2分钟 ⚠️
请立即处理此工单！

[立即处理]  [转派他人]
```

#### 5.4.2 违规后处理

**违规工单标记**：

- 工单列表显示🔴红色标签
- 工单详情页显示"SLA已违规"警告
- 自动记录违规原因
- 生成违规报告

**违规原因分类**：

| 原因分类 | 说明 | 示例 |
|---------|------|------|
| 坐席原因 | 坐席未及时处理 | "坐席忙于其他工单" |
| 系统原因 | 系统故障或通知延迟 | "SSE推送失败" |
| 客户原因 | 客户长时间未回复 | "等待客户补充信息超时" |
| 第三方原因 | 等待供应商/物流反馈 | "等待物流公司回复" |
| 不可抗力 | 节假日、非工作时间 | "春节期间人手不足" |

### 5.5 暂停SLA计时

#### 5.5.1 暂停场景

**允许暂停SLA的情况**：

1. **等待客户回复**
   - 状态切换为 `waiting_customer`
   - SLA计时暂停
   - 客户回复后恢复计时

2. **等待第三方**
   - 状态切换为 `waiting_vendor`
   - 等待供应商、物流方反馈
   - 收到反馈后恢复计时

3. **已解决待确认**
   - 状态切换为 `resolved`
   - 问题已解决，等待客户确认
   - SLA计时停止

**暂停记录**：

```
SLA暂停历史:

2025-01-27 10:00 - 10:30 (30分钟)
原因: 等待客户补充订单号
操作人: 李客服

2025-01-27 14:00 - 15:20 (1小时20分钟)
原因: 等待物流公司查询结果
操作人: 李客服

总暂停时间: 1小时50分钟
实际处理时间: 3小时10分钟
```

---

## 📋 模块6: 工单自动化

### 6.1 功能概述

通过自动化规则减少重复性工作，提升工单处理效率和准确性。

**参考对标**：
- Zendesk：强大的自动化规则引擎
- Freshdesk：工作流自动化
- Zapier：跨系统自动化集成

### 6.2 自动分配规则

#### 6.2.1 规则引擎

**规则结构**：

```
IF 触发条件
THEN 执行动作
```

**示例规则**：

**规则1: VIP客户优先分配**
```
规则名称: VIP客户优先
触发条件:
  - 工单创建
  AND 客户标签包含 "VIP"
执行动作:
  - 设置优先级为 "高"
  - 分配给 "VIP专属坐席组"
  - 发送通知给组长
```

**规则2: 按问题类型分配**
```
规则名称: 技术问题分配
触发条件:
  - 工单创建
  AND 问题分类为 "产品故障" 或 "技术支持"
执行动作:
  - 分配给 "技术支持组"
  - 添加标签 "需要技术支持"
```

**规则3: 工作负载均衡**
```
规则名称: 负载均衡
触发条件:
  - 工单创建
  AND 无匹配的专业坐席
执行动作:
  - 查询在线坐席
  - 按当前工单数排序
  - 分配给工单数最少的坐席
```

#### 6.2.2 规则配置界面

**管理员配置页面**：

```
┌─────────────────────────────────────────────────────┐
│  自动分配规则管理                                    │
├─────────────────────────────────────────────────────┤
│  [+ 新建规则]                                        │
│                                                      │
│  ┌───────────────────────────────────────────────┐  │
│  │ 🟢 规则1: VIP客户优先                        │  │
│  │ 优先级: 最高 (1)                             │  │
│  │ 触发: 工单创建 + 客户为VIP                   │  │
│  │ 动作: 设置优先级高 + 分配VIP组                │  │
│  │ 状态: ✅ 已启用                               │  │
│  │ 统计: 本月匹配 156次                         │  │
│  │                                               │  │
│  │ [编辑] [禁用] [删除] [查看日志]              │  │
│  └───────────────────────────────────────────────┘  │
│                                                      │
│  ┌───────────────────────────────────────────────┐  │
│  │ 🟢 规则2: 技术问题分配                       │  │
│  │ 优先级: 高 (2)                               │  │
│  │ 触发: 分类为"技术支持"                       │  │
│  │ 动作: 分配给技术组                           │  │
│  │ 状态: ✅ 已启用                               │  │
│  │ 统计: 本月匹配 89次                          │  │
│  │                                               │  │
│  │ [编辑] [禁用] [删除] [查看日志]              │  │
│  └───────────────────────────────────────────────┘  │
│                                                      │
│  ┌───────────────────────────────────────────────┐  │
│  │ ⚪ 规则3: 非工作时间留言                     │  │
│  │ 优先级: 中 (3)                               │  │
│  │ 触发: 工作时间之外创建                       │  │
│  │ 动作: 自动回复 + 次日分配                    │  │
│  │ 状态: ❌ 已禁用                               │  │
│  │                                               │  │
│  │ [编辑] [启用] [删除]                         │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

### 6.3 自动回复

#### 6.3.1 自动回复场景

**场景1: 非工作时间自动回复**

```
触发条件: 工作时间之外收到工单
自动回复内容:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
您好！感谢联系Fiido客服。

当前为非工作时间（工作时间：周一至周五 9:00-18:00）
您的工单已收到，我们将在工作时间内优先处理。

工单编号: {ticket_id}
预计响应时间: 明天 9:30 前

如有紧急问题，请拨打热线: 400-XXX-XXXX
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**场景2: 常见问题自动回复**

```
触发条件: 标题或内容包含关键词 "物流" "快递" "发货"
自动回复内容:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
关于物流查询：

1. 您可以在订单详情页查看物流信息
2. 物流追踪链接: [点击查询]
3. 一般发货后3-5个工作日送达

如仍有疑问，坐席将为您详细解答。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**场景3: 收到工单确认**

```
触发条件: 任何新工单创建
自动回复内容:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
您好！您的工单已成功创建。

工单编号: {ticket_id}
问题分类: {category}
优先级: {priority}
预计响应时间: {estimated_response_time}

坐席将尽快为您处理，请耐心等待。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 6.3.2 自动回复管理

**模板配置**：

```
┌─────────────────────────────────────────────────────┐
│  自动回复模板                                        │
├─────────────────────────────────────────────────────┤
│  模板名称: 非工作时间自动回复                        │
│                                                      │
│  触发条件:                                           │
│  ☑ 非工作时间（周一至周五 18:00-09:00）              │
│  ☑ 周末（周六、周日全天）                            │
│  ☑ 法定节假日                                        │
│                                                      │
│  回复内容:                                           │
│  ┌───────────────────────────────────────────────┐  │
│  │ 您好！感谢联系Fiido客服。                    │  │
│  │                                               │  │
│  │ 当前为非工作时间，您的工单已收到...           │  │
│  │                                               │  │
│  │ 可用变量:                                     │  │
│  │ {ticket_id} {customer_name} {next_work_time}  │  │
│  └───────────────────────────────────────────────┘  │
│                                                      │
│  延迟发送: 立即  ▼                                   │
│                                                      │
│  启用状态: ✅ 已启用                                  │
│                                                      │
│  [保存]  [测试发送]  [取消]                          │
└─────────────────────────────────────────────────────┘
```

### 6.4 工作流自动化

#### 6.4.1 状态自动流转

**流转规则**：

**规则1: 客户回复自动恢复**
```
触发: 状态为 "等待客户" 且客户发送消息
动作:
  1. 状态改为 "处理中"
  2. SLA恢复计时
  3. 通知处理坐席
```

**规则2: 超时自动关闭**
```
触发: 状态为 "已解决" 且超过7天无客户回复
动作:
  1. 状态改为 "已关闭"
  2. 添加备注 "自动关闭: 7天未收到客户反馈"
  3. 停止SLA计时
```

**规则3: 超时自动提醒**
```
触发: 状态为 "等待客户" 且超过48小时无回复
动作:
  1. 发送提醒邮件给客户
  2. 邮件内容: "您的工单 {ticket_id} 等待您的回复"
  3. 记录提醒日志
```

#### 6.4.2 标签自动添加

**自动打标规则**：

| 触发条件 | 自动添加标签 |
|---------|-------------|
| 工单包含"电池" | `#电池问题` |
| 工单包含"续航"、"没电" | `#续航问题` |
| 工单包含"发货"、"物流" | `#物流问题` |
| 客户为VIP | `#VIP客户` |
| 优先级为紧急 | `#紧急处理` |
| 超过SLA时效 | `#SLA违规` |
| 客户重复提交（同类问题） | `#重复问题` |

#### 6.4.3 自动升级

**升级规则**：

```
规则: 复杂问题自动升级
触发条件:
  - 工单处理中超过24小时
  AND 坐席添加了内部备注 "需要主管协助"
  OR 客户在评论中@主管

执行动作:
  1. 优先级提升一级（中→高，高→紧急）
  2. 通知主管
  3. 添加标签 "升级工单"
  4. 记录升级原因
```

### 6.5 自动化统计

#### 6.5.1 自动化效果报表

```
┌─────────────────────────────────────────────────────┐
│  自动化效果统计 - 本月                               │
├─────────────────────────────────────────────────────┤
│  自动分配:                                           │
│  • 总工单数: 1,250                                   │
│  • 自动分配: 980 (78.4%)                             │
│  • 手动分配: 270 (21.6%)                             │
│                                                      │
│  自动回复:                                           │
│  • 发送次数: 1,856                                   │
│  • 非工作时间: 680 (36.6%)                           │
│  • 常见问题: 1,176 (63.4%)                           │
│                                                      │
│  自动流转:                                           │
│  • 自动恢复处理: 320                                 │
│  • 自动关闭: 156                                     │
│  • 自动提醒: 89                                      │
│                                                      │
│  节省时间:                                           │
│  • 自动分配节省: 约 16.3 小时                        │
│  • 自动回复节省: 约 30.9 小时                        │
│  • 总节省时间: 约 47.2 小时                          │
└─────────────────────────────────────────────────────┘
```

---

## 🔧 技术实现要点

### 数据模型

**工单评论对象**：

```typescript
interface TicketComment {
  id: string                          // 评论ID
  ticket_id: string                   // 所属工单
  comment_type: "public" | "internal" // 评论类型
  content: string                     // 评论内容（支持Markdown）
  author_id: string                   // 作者ID
  author_name: string                 // 作者姓名
  author_type: "agent" | "customer"   // 作者类型
  mentions: string[]                  // @提到的坐席ID列表
  attachments: Attachment[]           // 附件列表
  created_at: Date                    // 创建时间
  edited_at: Date | null              // 编辑时间
  is_edited: boolean                  // 是否编辑过
}
```

**SLA配置对象**：

```typescript
interface SLAConfig {
  id: string                          // SLA规则ID
  name: string                        // 规则名称
  priority: string                    // 适用优先级
  ticket_type: string                 // 适用工单类型
  first_response_target: number       // 首次响应目标（分钟）
  resolution_target: number           // 解决时效目标（小时）
  warning_threshold: number           // 警告阈值（百分比）
  work_schedule: WorkSchedule         // 工作时间配置
  is_active: boolean                  // 是否启用
}
```

**自动化规则对象**：

```typescript
interface AutomationRule {
  id: string                          // 规则ID
  name: string                        // 规则名称
  priority: number                    // 优先级（数字越小越优先）
  trigger_event: string               // 触发事件
  conditions: Condition[]             // 触发条件（AND关系）
  actions: Action[]                   // 执行动作
  is_active: boolean                  // 是否启用
  execution_count: number             // 执行次数统计
  last_executed_at: Date | null       // 最后执行时间
}
```

### API接口

**新增接口清单**：

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/tickets/{id}/comments` | GET | 获取工单评论列表 |
| `/api/tickets/{id}/comments` | POST | 添加评论（公开/内部） |
| `/api/tickets/{id}/comments/{comment_id}` | PUT | 编辑评论 |
| `/api/tickets/{id}/comments/{comment_id}` | DELETE | 删除评论 |
| `/api/tickets/{id}/attachments` | POST | 上传附件 |
| `/api/tickets/{id}/attachments/{file_id}` | GET | 下载附件 |
| `/api/tickets/{id}/sla` | GET | 获取工单SLA状态 |
| `/api/tickets/sla/violations` | GET | 获取SLA违规列表 |
| `/api/tickets/sla/stats` | GET | 获取SLA统计报表 |
| `/api/automation/rules` | GET | 获取自动化规则列表 |
| `/api/automation/rules` | POST | 创建自动化规则 |
| `/api/automation/rules/{id}` | PUT | 更新自动化规则 |
| `/api/automation/rules/{id}/toggle` | POST | 启用/禁用规则 |
| `/api/automation/stats` | GET | 获取自动化统计 |

---

## ✅ 验收标准

### 模块4: 工单协作功能

- [ ] 支持公开回复和内部备注两种评论类型
- [ ] @提醒功能正常，被@坐席收到通知
- [ ] 评论支持富文本格式和引用
- [ ] 协作日志自动记录所有工单操作
- [ ] 附件上传/下载功能正常，支持多种文件类型
- [ ] 附件权限控制正确（内部备注附件客户不可见）

### 模块5: SLA时效管理

- [ ] SLA指标定义清晰，首次响应和解决时效分别计时
- [ ] 工单列表显示SLA倒计时和状态颜色
- [ ] SLA预警通知及时推送（80%、90%、100%阈值）
- [ ] 支持暂停SLA计时（等待客户、等待第三方）
- [ ] SLA违规工单自动标记和记录原因
- [ ] SLA统计报表准确显示达成率

### 模块6: 工单自动化

- [ ] 自动分配规则引擎正常运行
- [ ] 规则按优先级顺序执行
- [ ] 自动回复功能正常，支持多种场景
- [ ] 工作流自动流转规则正确执行
- [ ] 自动标签添加准确
- [ ] 自动化统计报表显示节省时间

---

## 📊 性能指标

| 指标 | 目标值 | 说明 |
|-----|-------|------|
| 评论加载速度 | < 300ms | 加载100条评论 |
| @提醒推送延迟 | < 1秒 | 从评论发送到通知 |
| SLA状态更新频率 | 每分钟 | 实时更新倒计时 |
| 自动化规则执行 | < 100ms | 单条规则匹配和执行 |
| 附件上传速度 | > 1MB/s | 10MB文件约10秒 |

---

## 📝 后续优化

- [ ] AI智能推荐回复内容（基于历史工单）
- [ ] 自动化规则可视化编辑器（拖拽式）
- [ ] SLA自定义配置（按客户、按产品）
- [ ] 工单模板与自动化规则联动
- [ ] 跨系统集成（Slack、钉钉通知）

---

**文档维护者**: Claude Code
**最后更新**: 2025-01-27
**下一篇**: [L2-1 Shopify订单集成](./L2-1_Shopify订单集成.md)
