# 人工接管功能验收标准文档

## 📋 文档信息

- **文档版本**: v1.0
- **创建时间**: 2025-11-21
- **依赖PRD**: PRD_COMPLETE_v3.0.md
- **验收范围**: 后端API、用户前端、坐席工作台

---

## 🎯 验收目标

确保人工接管功能完整可用、性能达标、用户体验良好，满足企业级生产环境要求。

---

## ✅ 功能验收标准

### 1. 后端API验收

#### 1.1 核心API功能

| API接口 | 验收项 | 通过标准 |
|---------|--------|----------|
| **POST /api/manual/escalate** | 触发人工升级 | 1. 返回200<br>2. 状态转为pending_manual<br>3. 升级信息正确记录<br>4. SSE事件正确推送 |
| **GET /api/sessions/{id}** | 获取会话状态 | 1. 返回完整会话信息<br>2. 历史消息完整<br>3. 状态正确 |
| **POST /api/sessions/{id}/takeover** | 坐席接入 | 1. 防抢单逻辑生效<br>2. 状态转为manual_live<br>3. 坐席信息正确分配<br>4. SSE事件推送 |
| **POST /api/manual/messages** | 人工消息写入 | 1. 消息正确保存<br>2. SSE实时推送<br>3. 角色验证正确 |
| **POST /api/sessions/{id}/release** | 释放会话 | 1. 状态恢复bot_active<br>2. 系统消息正确发送<br>3. 坐席信息清除 |
| **GET /api/sessions** | 会话列表 | 1. 分页正确<br>2. 过滤正确<br>3. 排序正确 |

#### 1.2 状态机验收

**测试场景1：正常流程**
```
bot_active → pending_manual → manual_live → bot_active
```

**验收标准**：
- [ ] 每次状态转换记录JSON日志
- [ ] 状态转换时间戳正确
- [ ] 状态转换通过validation检查
- [ ] 非法转换被正确拒绝

**测试场景2：并发接入（防抢单）**
```
pending_manual → (坐席A接入) → manual_live
                 (坐席B尝试接入) → 409 Conflict
```

**验收标准**：
- [ ] 坐席A成功接入，返回200
- [ ] 坐席B收到409错误，提示已被接入
- [ ] 会话只分配给坐席A
- [ ] 无数据竞争问题

**测试场景3：AI对话阻止**
```
状态: pending_manual 或 manual_live
用户: 尝试发送AI消息
结果: 返回409，提示人工接管中
```

**验收标准**：
- [ ] pending_manual状态下AI对话返回409
- [ ] manual_live状态下AI对话返回409
- [ ] 错误信息清晰明确
- [ ] 不影响人工消息发送

#### 1.3 监管引擎验收

**关键词触发测试**

| 输入 | 期望结果 |
|------|----------|
| "我要人工" | 触发升级，reason=keyword |
| "转人工客服" | 触发升级，reason=keyword |
| "我要投诉" | 触发升级，reason=keyword |
| "你好" | 不触发 |

**验收标准**：
- [ ] 所有关键词正确识别
- [ ] 不区分大小写
- [ ] 升级信息正确记录
- [ ] SSE事件正确推送

**AI失败触发测试**

| 场景 | 期望结果 |
|------|----------|
| AI连续回复"抱歉"2次 | 不触发 |
| AI连续回复"抱歉"3次 | 触发升级，reason=fail_loop |
| AI成功回复后重置 | 计数器归零 |

**验收标准**：
- [ ] 失败计数器正确累加
- [ ] 达到阈值触发升级
- [ ] 成功回复重置计数器
- [ ] 失败关键词可配置

**VIP用户测试**

| 场景 | 期望结果 |
|------|----------|
| VIP用户发送任意消息 | 立即触发升级，reason=vip |
| 普通用户 | 不触发 |

**验收标准**：
- [ ] VIP标识正确识别
- [ ] 优先级最高（覆盖其他规则）
- [ ] 升级信息包含VIP标识

#### 1.4 SSE推送验收

**推送时机测试**

| 事件 | SSE推送内容 |
|------|-------------|
| 用户触发升级 | status_change事件 |
| 坐席接入 | status_change + manual_message(系统消息) |
| 坐席发送消息 | manual_message(agent) |
| 坐席释放 | manual_message(系统) + status_change |

**验收标准**：
- [ ] 所有事件正确推送
- [ ] 推送延迟 < 100ms
- [ ] 事件格式符合规范
- [ ] 不丢失消息

**连接稳定性测试**

| 场景 | 期望行为 |
|------|----------|
| 长时间无消息 | 连接保持活跃 |
| 网络断开重连 | 自动恢复连接 |
| 并发连接 | 各会话独立推送 |

**验收标准**：
- [ ] 连接保持30分钟+
- [ ] 重连后不丢失消息
- [ ] 100+并发连接正常

---

### 2. 用户前端验收

#### 2.1 UI组件验收

**状态指示器**

| 状态 | 显示文本 | 颜色 | 图标 |
|------|----------|------|------|
| bot_active | "AI服务中" | 绿色 | 🤖 |
| pending_manual | "等待人工接入..." | 黄色（闪烁） | ⏳ |
| manual_live | "人工客服 - {名称}" | 蓝色 | 👤 |

**验收标准**：
- [ ] 状态文本正确显示
- [ ] 颜色符合设计规范
- [ ] 动画效果流畅
- [ ] 响应式布局正常

**转人工按钮**

| 场景 | 按钮状态 |
|------|----------|
| bot_active | 可点击 |
| pending_manual | 禁用 |
| manual_live | 禁用 |

**验收标准**：
- [ ] 点击后正确调用API
- [ ] 成功后显示确认提示
- [ ] 失败后显示错误提示
- [ ] 禁用状态视觉反馈明确

**人工消息渲染**

| 消息角色 | 头像 | 背景色 | 标签 |
|---------|------|--------|------|
| assistant | AI头像 | 白色 | 无 |
| agent | 坐席图标 | 浅蓝色 | "人工" |
| system | 无 | 灰色分隔线 | 无 |

**验收标准**：
- [ ] 不同角色视觉区分明显
- [ ] 坐席名称正确显示
- [ ] 系统消息样式特殊
- [ ] Markdown渲染正确

#### 2.2 交互流程验收

**流程1：用户主动转人工**

1. 用户点击"转人工"按钮
2. 状态变为"等待人工接入..."
3. 输入框禁用，显示等待提示
4. 坐席接入后状态变为"人工客服 - {名称}"
5. 收到系统消息"客服【{名称}】已接入"
6. 输入框恢复，可以发送消息
7. 坐席释放后状态恢复"AI服务中"
8. 收到系统消息"人工服务已结束，AI 助手已接管"

**验收标准**：
- [ ] 每步状态转换正确
- [ ] UI反馈及时清晰
- [ ] 消息显示完整
- [ ] 无卡顿和错误

**流程2：关键词自动触发**

1. 用户输入"我要人工"
2. AI回复后自动触发升级
3. 状态变为"等待人工接入..."
4. 后续流程同流程1

**验收标准**：
- [ ] 关键词触发不影响当前对话
- [ ] 状态转换自然流畅
- [ ] 用户感知明确

**流程3：历史回填**

1. 用户打开聊天面板
2. 自动加载历史消息
3. 显示历史对话（AI、用户、坐席）
4. 状态正确恢复
5. 可以继续对话

**验收标准**：
- [ ] 历史消息完整加载
- [ ] 消息顺序正确
- [ ] 角色标识正确
- [ ] 加载速度 < 2s

#### 2.3 异常处理验收

| 异常场景 | 期望行为 |
|---------|----------|
| API调用失败 | 显示友好错误提示 |
| SSE连接断开 | 自动重连 |
| 网络超时 | 显示"连接中断"提示 |
| 服务器错误 | 显示"服务暂时不可用" |

**验收标准**：
- [ ] 所有错误有友好提示
- [ ] 不显示技术错误信息
- [ ] 提供重试机制
- [ ] 不影响已加载内容

---

### 3. 坐席工作台验收

#### 3.1 登录功能

**正常登录**

| 输入 | 期望结果 |
|------|----------|
| 有效坐席ID + 姓名 | 登录成功，跳转工作台 |
| 空坐席ID | 提示"请输入坐席ID" |
| 空姓名 | 提示"请输入姓名" |

**验收标准**：
- [ ] 登录成功后保存会话
- [ ] 刷新页面保持登录状态
- [ ] 登出后清除会话

#### 3.2 会话队列

**列表展示**

| 字段 | 显示内容 |
|------|----------|
| 用户昵称 | 显示昵称，VIP标识 |
| 最后消息 | 预览前50字 |
| 等待时长 | 实时更新（如"等待2分30秒"） |
| 升级原因 | 显示原因标签 |
| 严重程度 | 颜色区分（high=红色，low=黄色） |

**验收标准**：
- [ ] 所有字段正确显示
- [ ] 实时更新（10秒刷新）
- [ ] 排序正确（等待时长倒序）
- [ ] VIP会话置顶

**状态筛选**

| 标签 | 显示会话 |
|------|----------|
| 待接入 | pending_manual |
| 进行中 | manual_live且assigned_agent=当前坐席 |
| 已完成 | 今日已释放的会话 |

**验收标准**：
- [ ] 筛选正确无遗漏
- [ ] 数量统计正确
- [ ] 切换响应快速

#### 3.3 接入操作

**正常接入**

1. 点击待接入会话
2. 显示会话详情（历史消息）
3. 点击"接入"按钮
4. 状态变为进行中
5. 用户端收到"客服已接入"提示

**验收标准**：
- [ ] 接入成功率 > 99%
- [ ] 响应时间 < 1s
- [ ] 用户端实时收到通知
- [ ] 会话从"待接入"移到"进行中"

**抢单冲突**

| 场景 | 期望行为 |
|------|----------|
| 坐席A先接入 | 成功 |
| 坐席B后接入 | 提示"会话已被坐席【A】接入" |
| 坐席B看到的列表 | 该会话消失 |

**验收标准**：
- [ ] 冲突提示清晰
- [ ] 不出现数据不一致
- [ ] 列表自动更新

#### 3.4 聊天功能

**消息发送**

| 输入 | 期望结果 |
|------|----------|
| 普通文本 | 发送成功，用户端实时收到 |
| 多行文本 | 格式保持 |
| 特殊字符 | 正确显示（不转义） |
| 空消息 | 发送按钮禁用 |

**验收标准**：
- [ ] 消息实时发送
- [ ] 用户端延迟 < 500ms
- [ ] 消息不丢失
- [ ] 格式正确保持

**快捷短语**

| 操作 | 期望结果 |
|------|----------|
| 点击快捷短语 | 内容插入输入框 |
| 编辑后发送 | 正常发送 |

**验收标准**：
- [ ] 插入正确
- [ ] 光标位置合理
- [ ] 支持5+常用短语

#### 3.5 释放操作

**正常释放**

1. 点击"结束服务"按钮
2. 确认对话框
3. 确认后释放会话
4. 状态恢复bot_active
5. 用户端收到系统消息

**验收标准**：
- [ ] 释放成功率 100%
- [ ] 用户端实时收到通知
- [ ] 会话从"进行中"移除
- [ ] AI对话正常恢复

#### 3.6 SSE 实时推送验收 ⭐ **v2.3.9 新增** (2025-11-25)

**功能概述**：
- 替代 5秒轮询机制
- 混合策略：30秒轻量级轮询（检测新会话）+ SSE实时推送（当前选中会话）
- 性能目标：网络请求减少 83%，消息推送延迟 < 100ms

**技术实现验收**

| 验收项 | 验收标准 |
|--------|----------|
| **FetchSSE 类** | 1. 支持 POST 请求（符合约束18.2）<br>2. 正确解析 SSE 格式（data: {...}\n\n）<br>3. AbortController 正确取消连接<br>4. TextDecoder 正确解码流数据 |
| **混合监听策略** | 1. 30秒轻量级轮询正常执行<br>2. 选中会话时建立 SSE 连接<br>3. 未选中会话时不建立 SSE<br>4. 初始加载完成后再启动监听 |
| **自动切换连接** | 1. watch 正确监听 selectedSession 变化<br>2. 切换会话时断开旧连接<br>3. 切换会话时建立新连接<br>4. 控制台日志显示切换过程 |
| **自动重连** | 1. 连接失败后 3秒自动重连<br>2. 重连次数无上限<br>3. 只在 isMonitoring=true 时重连<br>4. 只重连当前选中的会话 |
| **资源清理** | 1. stopMonitoring 清除轮询定时器<br>2. stopMonitoring 断开 SSE 连接<br>3. 组件卸载时调用 stopMonitoring<br>4. 无内存泄漏 |

**SSE 事件处理验收**

| 事件类型 | 触发时机 | 前端行为 | 验收标准 |
|---------|---------|----------|----------|
| `status_change` | 会话状态变化 | 刷新会话列表+详情 | 1. 收到事件后 < 500ms 完成刷新<br>2. 状态正确更新<br>3. 不重复刷新 |
| `manual_message` | 人工消息到达 | 刷新会话详情 | 1. 消息实时显示<br>2. 坐席信息正确<br>3. 时间戳正确 |
| `message` | AI 消息 | 忽略 | 1. 不触发任何操作<br>2. 不打印日志 |
| `done` | 流完成标记 | 无操作 | 1. 不触发任何操作 |
| `error` | 错误事件 | 打印错误日志 | 1. 错误信息输出到控制台<br>2. 不中断连接 |

**性能验收标准**

| 性能指标 | 目标值 | 验收方法 |
|---------|--------|----------|
| **SSE 推送延迟** | < 100ms | 1. 后端发送时间戳 → 前端接收时间戳<br>2. 测试10次取平均值 |
| **轮询间隔** | 30秒 | 1. 观察控制台日志时间间隔<br>2. 使用 DevTools Network 验证请求间隔 |
| **网络请求减少** | 83% | 1. 对比5秒轮询（720次/小时）<br>2. 验证30秒轮询（120次/小时） |
| **SSE 连接数** | 1个/坐席 | 1. 验证同时只有1个 SSE 连接<br>2. 切换会话时旧连接正确断开 |
| **重连间隔** | 3秒 | 1. 断开连接后测量重连时间<br>2. 控制台日志显示重连尝试 |

**功能场景测试**

| 场景 | 操作步骤 | 期望结果 |
|------|---------|----------|
| **初始加载** | 1. 打开坐席工作台<br>2. 登录成功 | 1. 控制台显示"🚀 启动实时监听"<br>2. 30秒后显示"🔄 轮询刷新会话列表 (30s)" |
| **选择会话** | 1. 点击一个待接入会话<br>2. 查看控制台 | 1. 显示"🔄 切换监听会话: null → {session_name}"<br>2. 显示"✅ SSE 连接已建立: {session_name}" |
| **状态变化推送** | 1. 坐席接入会话<br>2. 观察前端变化 | 1. 控制台显示"📨 收到 SSE 消息: status_change"<br>2. 会话列表自动刷新<br>3. 无手动刷新 |
| **消息推送** | 1. 用户发送消息<br>2. 观察坐席端 | 1. 控制台显示"📨 收到 SSE 消息: manual_message"<br>2. 会话详情自动更新<br>3. 新消息实时显示 |
| **会话切换** | 1. 切换到另一个会话<br>2. 查看控制台 | 1. 旧连接断开<br>2. 新连接建立<br>3. 无内存泄漏 |
| **断网重连** | 1. 断开网络<br>2. 等待3秒<br>3. 恢复网络 | 1. 控制台显示连接错误<br>2. 3秒后自动重连<br>3. 重连成功后继续推送 |
| **离开页面** | 1. 关闭标签页或跳转 | 1. 控制台显示"⏹️ 停止实时监听"<br>2. 定时器清除<br>3. SSE 连接断开 |

**浏览器兼容性验收**

| 浏览器 | 版本 | 验收结果 |
|--------|------|----------|
| Chrome | 最新版 | 1. FetchSSE 正常工作<br>2. ReadableStream 支持<br>3. AbortController 支持 |
| Firefox | 最新版 | 同上 |
| Safari | 最新版 | 同上 |
| Edge | 最新版 | 同上 |

**错误处理验收**

| 错误场景 | 期望行为 | 验收标准 |
|---------|---------|----------|
| 后端未启动 | 连接失败 | 1. 打印错误日志<br>2. 3秒后重试<br>3. 不影响轮询 |
| SSE 流中断 | 自动重连 | 1. 检测到中断<br>2. 3秒后重连<br>3. 重连成功恢复推送 |
| JSON 解析失败 | 忽略该消息 | 1. 打印解析错误<br>2. 继续处理后续消息<br>3. 不中断连接 |
| 会话不存在 | 返回 404 | 1. 控制台显示错误<br>2. 断开该会话 SSE<br>3. 不影响其他功能 |

**向后兼容性验收**

| 验收项 | 验收标准 |
|--------|----------|
| **不修改后端** | 1. 后端核心逻辑未改变<br>2. 复用现有 SSE 队列机制<br>3. 不添加新的后端接口 |
| **降级方案** | 1. SSE 失败时轮询仍能工作<br>2. 用户端不受影响<br>3. 基本功能正常 |
| **用户端无影响** | 1. 用户端前端不需要修改<br>2. 用户体验无变化 |

**文档完整性验收**

| 文档 | 验收项 | 验收标准 |
|------|--------|----------|
| **约束18** | CONSTRAINTS_AND_PRINCIPLES.md | 1. 包含 18.1-18.8 完整约束<br>2. 代码示例清晰<br>3. 生产检查清单完整 |
| **API 规范** | api_contract.md | 1. SSE 事件类型详细说明<br>2. 连接生命周期流程图<br>3. 性能指标定义 |
| **完成报告** | docs/坐席工作台SSE实时推送完成报告_2025-11-25.md | 1. 功能概述清晰<br>2. 实现细节完整<br>3. 验证清单齐全 |

**验收结果**：✅ **已完成** (v2.3.9, 2025-11-25)

---

## 🎯 性能验收标准

### 1. 响应时间

| 操作 | 目标 | 可接受 |
|------|------|--------|
| API调用响应 | < 100ms | < 200ms |
| SSE推送延迟 | < 50ms | < 100ms |
| 页面加载 | < 1s | < 2s |
| 历史回填 | < 1s | < 2s |
| 状态转换 | < 200ms | < 500ms |

**验收方法**：
- 使用 Chrome DevTools Network Tab 测量
- 进行10次测试取平均值
- 在正常网络环境下测试

### 2. 并发性能

| 指标 | 目标 | 测试方法 |
|------|------|----------|
| 并发用户数 | 100+ | Apache Bench / JMeter |
| 并发坐席数 | 10+ | 多浏览器同时登录 |
| SSE并发连接 | 100+ | 压力测试工具 |
| 数据库查询 | < 50ms | 慢查询日志 |

**验收标准**：
- [ ] 100并发用户无明显延迟
- [ ] 10坐席同时在线正常
- [ ] 无数据竞争问题
- [ ] CPU使用率 < 70%

### 3. 稳定性

| 场景 | 目标 | 测试方法 |
|------|------|----------|
| 长时间运行 | 24小时无崩溃 | 连续运行测试 |
| 内存泄漏 | 无明显增长 | 内存监控 |
| SSE连接 | 30分钟+保持 | 长连接测试 |
| 错误恢复 | 自动恢复 | 故障注入测试 |

**验收标准**：
- [ ] 24小时运行无崩溃
- [ ] 内存使用稳定 ( < 1GB)
- [ ] SSE连接稳定
- [ ] 服务自动恢复

---

## 🔒 安全验收标准

### 1. 认证授权

| 测试项 | 验收标准 |
|--------|----------|
| JWT Token验证 | 未登录返回401 |
| 坐席权限 | 只能访问自己的会话 |
| Token过期 | 自动跳转登录 |
| 密码加密 | 不存储明文（如有） |

**验收方法**：
```bash
# 测试未授权访问
curl -X GET http://localhost:8000/api/sessions

# 测试过期Token
curl -X GET http://localhost:8000/api/sessions \
  -H "Authorization: Bearer expired_token"

# 测试跨坐席访问
# 坐席A尝试访问坐席B的会话
```

### 2. 输入验证

| 输入 | 期望结果 |
|------|----------|
| XSS脚本 | 自动转义 |
| SQL注入 | 参数化查询阻止 |
| 超长文本 | 截断/拒绝 |
| 特殊字符 | 正确处理 |

**验收标准**：
- [ ] 所有输入经过验证
- [ ] HTML标签自动转义
- [ ] 消息长度限制（如5000字）
- [ ] 无SQL注入漏洞

### 3. 数据保护

| 测试项 | 验收标准 |
|--------|----------|
| 敏感信息加密 | JWT payload无敏感数据 |
| 日志脱敏 | 不记录密码/token |
| HTTPS强制 | 生产环境强制HTTPS |
| CORS配置 | 白名单限制 |

**验收标准**：
- [ ] 无明文存储敏感信息
- [ ] 日志中无敏感数据
- [ ] CORS配置正确
- [ ] 生产环境启用HTTPS

---

## 📊 用户体验验收

### 1. 易用性

| 评估项 | 标准 |
|--------|------|
| 学习成本 | 新用户5分钟内上手 |
| 操作步骤 | 核心操作 ≤ 3步 |
| 错误提示 | 清晰友好，无技术术语 |
| 帮助文档 | 提供完整使用说明 |

**验收方法**：
- 邀请5名测试用户试用
- 记录操作时间和错误率
- 收集用户反馈

### 2. 视觉设计

| 评估项 | 标准 |
|--------|------|
| 色彩一致性 | 符合设计规范 |
| 字体大小 | 可读性良好 |
| 按钮尺寸 | 易于点击 |
| 响应式布局 | 移动端适配 |

**验收标准**：
- [ ] 设计稿还原度 > 95%
- [ ] 移动端体验良好
- [ ] 无视觉错位
- [ ] 动画流畅不卡顿

### 3. 可访问性

| 评估项 | 标准 |
|--------|------|
| 键盘导航 | 支持Tab键切换 |
| 屏幕阅读器 | 关键元素有aria标签 |
| 颜色对比度 | 符合WCAG 2.0标准 |
| 文字大小 | 支持浏览器缩放 |

**验收标准**：
- [ ] 键盘可完成所有操作
- [ ] 屏幕阅读器可正常使用
- [ ] 对比度检测通过
- [ ] 200%缩放下可用

---

## 🧪 测试用例清单

### 1. 端到端测试场景

#### 场景1：完整人工接管流程
```gherkin
Feature: 完整人工接管流程
  作为一名用户
  我想要在需要时转接人工客服
  以便获得更专业的服务

  Scenario: 用户主动转人工
    Given 用户打开聊天窗口
    And 当前状态为"AI服务中"
    When 用户点击"转人工"按钮
    Then 状态变为"等待人工接入..."
    And 输入框显示等待提示

    When 坐席接入会话
    Then 状态变为"人工客服 - {坐席名}"
    And 用户收到系统消息"客服已接入"

    When 坐席发送消息"您好"
    Then 用户实时收到消息
    And 消息显示为人工消息样式

    When 用户回复"你好"
    Then 坐席实时收到消息

    When 坐席点击"结束服务"
    Then 状态恢复为"AI服务中"
    And 用户收到系统消息"人工服务已结束"
```

#### 场景2：关键词自动触发
```gherkin
  Scenario: 关键词自动触发人工
    Given 用户正在与AI对话
    When 用户输入"我要人工"
    Then AI回复后自动触发升级
    And 状态变为"等待人工接入..."
    And 后续流程同场景1
```

#### 场景3：坐席并发接入
```gherkin
  Scenario: 多坐席同时接入（防抢单）
    Given 有一个待接入会话
    When 坐席A点击"接入"
    And 坐席B同时点击"接入"
    Then 只有一个坐席接入成功
    And 另一个坐席收到"已被接入"提示
    And 会话只分配给成功的坐席
```

### 2. 自动化测试脚本

**Playwright E2E测试示例**

```typescript
// tests/e2e/manual-takeover.spec.ts

import { test, expect } from '@playwright/test'

test('完整人工接管流程', async ({ page, context }) => {
  // 用户端
  await page.goto('http://localhost:5173')

  // 1. 打开聊天
  await page.click('[data-testid="chat-button"]')
  await expect(page.locator('[data-testid="status-bar"]'))
    .toContainText('AI服务中')

  // 2. 点击转人工
  await page.click('[data-testid="menu-button"]')
  await page.click('[data-testid="escalate-button"]')
  await page.click('button:has-text("确定")')

  // 3. 验证状态变化
  await expect(page.locator('[data-testid="status-bar"]'))
    .toContainText('等待人工接入', { timeout: 5000 })

  // 4. 打开坐席工作台
  const agentPage = await context.newPage()
  await agentPage.goto('http://localhost:5174/agent')

  // 5. 坐席登录
  await agentPage.fill('[data-testid="agent-id"]', 'agent_001')
  await agentPage.fill('[data-testid="agent-name"]', '小王')
  await agentPage.click('[data-testid="login-button"]')

  // 6. 接入会话
  await agentPage.click('[data-testid="session-card"]:first-child')
  await agentPage.click('[data-testid="takeover-button"]')

  // 7. 验证用户端状态
  await expect(page.locator('[data-testid="status-bar"]'))
    .toContainText('人工客服 - 小王', { timeout: 5000 })

  // 8. 坐席发送消息
  await agentPage.fill('[data-testid="message-input"]', '您好，我是小王')
  await agentPage.click('[data-testid="send-button"]')

  // 9. 验证用户端收到消息
  await expect(page.locator('[data-testid="message-agent"]'))
    .toContainText('您好，我是小王', { timeout: 3000 })

  // 10. 坐席释放会话
  await agentPage.click('[data-testid="release-button"]')
  await agentPage.click('button:has-text("确定")')

  // 11. 验证状态恢复
  await expect(page.locator('[data-testid="status-bar"]'))
    .toContainText('AI服务中', { timeout: 5000 })

  // 12. 验证系统消息
  await expect(page.locator('[data-testid="message-system"]'))
    .toContainText('人工服务已结束')
})
```

---

## 📋 验收检查清单

### 阶段一：后端验收

- [ ] **API功能**
  - [ ] 所有接口返回正确的HTTP状态码
  - [ ] 响应格式符合规范
  - [ ] 错误处理完善
  - [ ] API文档与实现一致

- [ ] **状态机**
  - [ ] 所有状态转换逻辑正确
  - [ ] 非法转换被正确拒绝
  - [ ] 状态转换记录日志
  - [ ] 并发场景无数据竞争

- [ ] **监管引擎**
  - [ ] 关键词检测正确
  - [ ] AI失败检测正确
  - [ ] VIP用户识别正确
  - [ ] 优先级判断正确

- [ ] **SSE推送**
  - [ ] 所有事件正确推送
  - [ ] 推送延迟 < 100ms
  - [ ] 连接稳定性良好
  - [ ] 不丢失消息

### 阶段二：用户前端验收

- [ ] **UI组件**
  - [ ] 状态指示器正确显示
  - [ ] 转人工按钮功能正常
  - [ ] 人工消息样式正确
  - [ ] 响应式布局正常

- [ ] **交互流程**
  - [ ] 转人工流程完整
  - [ ] 历史回填正常
  - [ ] 输入控制正确
  - [ ] 错误处理友好

- [ ] **性能体验**
  - [ ] 页面加载 < 2s
  - [ ] 操作响应迅速
  - [ ] 无明显卡顿
  - [ ] 动画流畅

### 阶段三：坐席工作台验收

- [ ] **登录功能**
  - [ ] 登录成功跳转
  - [ ] 会话保持正常
  - [ ] 登出清除状态

- [ ] **会话队列**
  - [ ] 列表正确显示
  - [ ] 实时更新正常
  - [ ] 筛选功能正确
  - [ ] 排序逻辑正确

- [ ] **接入操作**
  - [ ] 接入成功率高
  - [ ] 防抢单逻辑正确
  - [ ] 状态同步正常

- [ ] **聊天功能**
  - [ ] 消息实时收发
  - [ ] 快捷短语可用
  - [ ] 历史消息完整

- [ ] **释放操作**
  - [ ] 释放流程正常
  - [ ] 状态恢复正确
  - [ ] 用户端实时通知

### 阶段四：整体验收

- [ ] **端到端测试**
  - [ ] 所有场景测试通过
  - [ ] E2E自动化测试通过
  - [ ] 无遗留严重bug

- [ ] **性能测试**
  - [ ] 响应时间达标
  - [ ] 并发性能达标
  - [ ] 稳定性测试通过

- [ ] **安全测试**
  - [ ] 认证授权正确
  - [ ] 输入验证完善
  - [ ] 无安全漏洞

- [ ] **用户体验**
  - [ ] 易用性良好
  - [ ] 视觉设计达标
  - [ ] 可访问性符合标准

---

## 🎯 验收流程

### 1. 开发自测

**责任人**: 开发者
**时间**: 功能开发完成后

**检查项**:
- [ ] 单元测试通过
- [ ] 代码审查通过
- [ ] 本地功能测试通过
- [ ] 提交详细测试报告

### 2. 集成测试

**责任人**: 测试工程师
**时间**: 提交测试环境后

**检查项**:
- [ ] API集成测试通过
- [ ] 前后端联调通过
- [ ] 数据流验证通过
- [ ] 记录测试日志

### 3. 端到端测试

**责任人**: QA团队
**时间**: 集成测试通过后

**检查项**:
- [ ] E2E测试脚本执行通过
- [ ] 主要场景手动验证通过
- [ ] 兼容性测试通过
- [ ] 提交测试报告

### 4. 性能测试

**责任人**: 性能测试团队
**时间**: E2E测试通过后

**检查项**:
- [ ] 响应时间测试通过
- [ ] 并发性能测试通过
- [ ] 稳定性测试通过
- [ ] 提交性能报告

### 5. 安全审计

**责任人**: 安全团队
**时间**: 性能测试通过后

**检查项**:
- [ ] 安全扫描通过
- [ ] 渗透测试通过
- [ ] 合规性检查通过
- [ ] 提交安全报告

### 6. 用户验收

**责任人**: 产品经理 + 业务方
**时间**: 所有测试通过后

**检查项**:
- [ ] 功能符合需求
- [ ] 用户体验良好
- [ ] 业务流程顺畅
- [ ] 签署验收报告

---

## 📊 验收报告模板

```markdown
# 人工接管功能验收报告

## 基本信息
- 项目名称: Fiido智能客服 - 人工接管功能
- 验收版本: v3.0
- 验收时间: YYYY-MM-DD
- 验收人员: XXX
- 验收环境: 测试环境

## 验收结果概览
- 总测试项: XX项
- 通过项: XX项
- 失败项: XX项
- 通过率: XX%
- 综合评定: 通过/不通过

## 功能验收详情

### 后端API
| 测试项 | 结果 | 备注 |
|--------|------|------|
| POST /api/manual/escalate | ✅ 通过 | - |
| GET /api/sessions/{id} | ✅ 通过 | - |
| ... | ... | ... |

### 用户前端
| 测试项 | 结果 | 备注 |
|--------|------|------|
| 状态指示器 | ✅ 通过 | - |
| 转人工按钮 | ✅ 通过 | - |
| ... | ... | ... |

### 坐席工作台
| 测试项 | 结果 | 备注 |
|--------|------|------|
| 登录功能 | ✅ 通过 | - |
| 会话队列 | ✅ 通过 | - |
| ... | ... | ... |

## 性能测试结果
- API响应时间: XX ms (目标: < 200ms)
- SSE推送延迟: XX ms (目标: < 100ms)
- 页面加载时间: XX s (目标: < 2s)
- 并发用户数: XX (目标: 100+)

## 发现问题清单
| 问题ID | 严重程度 | 问题描述 | 状态 |
|--------|---------|---------|------|
| BUG-001 | 高 | XXX | 已修复 |
| BUG-002 | 中 | XXX | 待修复 |

## 验收结论
- 功能完整性: 符合/不符合
- 性能指标: 达标/不达标
- 安全性: 合格/不合格
- 用户体验: 良好/一般/差

## 验收意见
[填写验收意见]

## 签署
- 验收人: ___________  日期: ___________
- 产品经理: ___________  日期: ___________
- 业务方: ___________  日期: ___________
```

---

**文档维护者**: Claude Code
**最后更新**: 2025-11-21
**文档版本**: v1.0
**状态**: ✅ 已完成
