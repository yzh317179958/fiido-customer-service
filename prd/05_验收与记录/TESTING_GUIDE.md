# Fiido 智能客服系统 - 测试流程规范

> 版本: v1.0.0 | 更新时间: 2025-11-23

---

## 一、测试环境准备

### 1.1 启动服务

```bash
# 1. 启动后端服务
cd /home/yzh/AI客服/鉴权
python3 backend.py

# 2. 启动用户端前端 (新终端)
cd /home/yzh/AI客服/鉴权/frontend
npm run dev
# 访问: http://localhost:5173

# 3. 启动坐席工作台 (新终端)
cd /home/yzh/AI客服/鉴权/agent-workbench
npm run dev
# 访问: http://localhost:5174
```

### 1.2 测试账号

| 角色 | 账号 | 密码 | 用途 |
|------|------|------|------|
| 坐席1 | agent_001 | 123456 | 主测试坐席 |
| 坐席2 | agent_002 | 123456 | 转接测试 |
| 坐席3 | agent_003 | 123456 | 并发测试 |

---

## 二、功能开发测试流程

### 2.1 开发完成后必做步骤

```
1. 单元测试 → 2. 回归测试 → 3. 手动验证 → 4. 边界测试
```

### 2.2 回归测试脚本

每次功能开发完成后，**必须运行**回归测试：

```bash
cd /home/yzh/AI客服/鉴权
./tests/regression_test.sh
```

**预期结果**: 12/12 测试全部通过

### 2.3 测试报告记录

每次测试后记录：
- 测试时间
- 测试环境
- 通过/失败数量
- 失败原因（如有）

---

## 三、核心场景测试用例

### 3.1 AI 对话测试

**目的**: 验证基础 AI 对话功能正常

**步骤**:
1. 打开用户端 http://localhost:5173
2. 发送消息："你好"
3. 等待 AI 回复
4. 发送产品问题："D11 价格多少？"
5. 验证回复包含产品信息

**预期结果**:
- [ ] 消息发送成功，显示在对话框
- [ ] AI 在 5 秒内返回回复
- [ ] 回复内容与问题相关
- [ ] 状态栏显示"AI 服务中"（绿色）

**异常检查**:
- 网络断开时应显示错误提示
- 超时时应有重试机制

---

### 3.2 人工升级测试

**目的**: 验证用户主动请求人工和关键词触发

#### 3.2.1 主动请求人工

**步骤**:
1. 用户端发送："转人工"
2. 或点击"人工客服"按钮

**预期结果**:
- [ ] 状态变为 `pending_manual`
- [ ] 状态栏显示"等待人工接入"（橙色）
- [ ] 显示等待动画
- [ ] 后续 AI 对话被阻止

#### 3.2.2 关键词触发

**触发关键词**: `人工, 真人, 客服, 投诉, 无法解决`

**步骤**:
1. 发送包含关键词的消息
2. 观察状态变化

**预期结果**: 同上

---

### 3.3 坐席接入测试

**目的**: 验证坐席接入会话和消息收发

**步骤**:
1. 用户端触发人工升级
2. 坐席工作台登录 (agent_001)
3. 在"待接入"列表找到会话
4. 点击"接入"按钮
5. 发送消息给用户
6. 用户端回复消息

**预期结果**:
- [ ] 坐席工作台显示待接入会话
- [ ] 接入后状态变为 `manual_live`
- [ ] 用户端显示"客服【xxx】已接入"
- [ ] 双向消息实时显示
- [ ] 用户端状态栏显示"人工服务中"（蓝色）

**API 验证**:
```bash
# 查看会话状态
curl http://localhost:8000/api/sessions/{session_name}
```

---

### 3.4 会话释放测试

**目的**: 验证结束人工服务恢复 AI

**步骤**:
1. 在人工服务状态下
2. 坐席点击"结束服务"
3. 确认释放

**预期结果**:
- [ ] 状态变为 `bot_active`
- [ ] 用户端显示"人工服务已结束，AI 助手已接管"
- [ ] 用户可以继续与 AI 对话
- [ ] 状态栏恢复绿色

---

### 3.5 会话转接测试

**目的**: 验证坐席间会话转接

**步骤**:
1. 坐席1 (agent_001) 接入会话
2. 点击"转接"按钮
3. 选择目标坐席 (agent_002)
4. 填写转接原因
5. 确认转接
6. 坐席2 登录查看

**预期结果**:
- [ ] 转接成功提示
- [ ] 用户端显示转接系统消息
- [ ] 坐席2 工作台出现该会话
- [ ] 坐席1 工作台会话消失
- [ ] assigned_agent 更新为坐席2

**API 验证**:
```bash
curl -X POST http://localhost:8000/api/sessions/{session_name}/transfer \
  -H "Content-Type: application/json" \
  -d '{
    "from_agent_id": "agent_001",
    "to_agent_id": "agent_002",
    "to_agent_name": "技术支持-小李",
    "reason": "专业问题转接"
  }'
```

---

### 3.6 防抢单测试

**目的**: 验证同一会话不能被多人接入

**步骤**:
1. 用户触发人工升级
2. 坐席1 和 坐席2 同时尝试接入
3. 观察结果

**预期结果**:
- [ ] 只有一个坐席接入成功
- [ ] 另一个收到 409 错误
- [ ] 错误信息显示"会话已被坐席【xxx】接入"

---

### 3.7 非工作时间测试

**目的**: 验证非工作时间邮件通知

**配置修改** (临时测试):
```python
# src/shift_config.py
# 将工作时间改为当前时间之外
```

**步骤**:
1. 修改工作时间配置
2. 用户请求人工
3. 检查邮件发送

**预期结果**:
- [ ] 返回 `is_in_shift: false`
- [ ] 邮件发送成功
- [ ] 状态保持 `bot_active`（不转人工）
- [ ] 用户可继续 AI 对话

---

### 3.8 快捷短语测试

**目的**: 验证坐席快捷短语功能

**步骤**:
1. 坐席接入会话
2. 点击快捷短语按钮
3. 选择分类
4. 点击短语
5. 发送

**预期结果**:
- [ ] 短语面板正常显示
- [ ] 分类切换正常
- [ ] 搜索过滤正常
- [ ] 点击后填入输入框
- [ ] 发送成功

---

### 3.9 会话隔离测试

**目的**: 验证不同用户会话完全隔离

**步骤**:
1. 浏览器A 打开用户端，发送消息
2. 浏览器B（或无痕模式）打开用户端，发送消息
3. 检查两个会话的 conversation_id

**预期结果**:
- [ ] 两个会话有不同的 session_id
- [ ] conversation_id 不同
- [ ] 对话历史完全隔离
- [ ] 一个触发人工不影响另一个

---

### 3.10 SSE 实时推送测试 ⭐ **v2.3.9 新增** (2025-11-25)

**目的**: 验证坐席工作台 SSE 实时推送功能

#### 3.10.1 基础连接测试

**步骤**:
1. 打开坐席工作台 http://localhost:5175
2. 登录坐席账号 (admin/admin123)
3. 打开浏览器开发者工具 (F12)
4. 切换到 Console 标签页
5. 观察控制台日志

**预期结果**:
- [ ] 控制台显示 "🚀 启动实时监听"
- [ ] 30秒后显示 "🔄 轮询刷新会话列表 (30s)"
- [ ] 轮询间隔保持 30秒（观察日志时间戳）
- [ ] 无错误日志

**验证检查**:
```bash
# 检查 Network 标签页
# 应该看到:
# - /api/sessions 请求间隔 30秒
# - 无 /api/chat/stream 连接（未选中会话时）
```

---

#### 3.10.2 会话选择与 SSE 建立

**步骤**:
1. 在坐席工作台选择一个待接入会话
2. 观察控制台日志和 Network 标签页

**预期结果**:
- [ ] 控制台显示 "🔄 切换监听会话: null → {session_name}"
- [ ] 控制台显示 "🔌 建立 SSE 监听: {session_name}"
- [ ] 控制台显示 "✅ SSE 连接已建立: {session_name}"
- [ ] Network 标签显示 `/api/chat/stream` 连接（Type: text/event-stream）
- [ ] 连接状态为 Pending（长连接）

**API 验证**:
```bash
# 查看 SSE 连接详情
# Network → /api/chat/stream → Headers
# Request Method: POST
# Content-Type: application/json
# Response: text/event-stream
```

---

#### 3.10.3 状态变化推送测试

**步骤**:
1. 坐席工作台选中一个 pending_manual 会话
2. 点击"接入"按钮
3. 观察控制台日志和界面变化

**预期结果**:
- [ ] 控制台显示 "📨 收到 SSE 消息: status_change"
- [ ] 会话列表自动刷新（从"待接入"移到"进行中"）
- [ ] 会话详情自动更新（状态变为 manual_live）
- [ ] 无需手动刷新页面

**性能验证**:
```javascript
// 在控制台手动测量延迟
console.time('status_change_latency')
// 点击接入
// 观察日志: 📨 收到 SSE 消息: status_change
console.timeEnd('status_change_latency')
// 期望: < 500ms
```

---

#### 3.10.4 消息推送测试

**步骤**:
1. 用户端发送消息到人工服务中的会话
2. 坐席工作台观察控制台和界面

**预期结果**:
- [ ] 控制台显示 "📨 收到 SSE 消息: manual_message"
- [ ] 会话详情区域自动显示新消息
- [ ] 消息内容正确
- [ ] 时间戳正确
- [ ] 延迟 < 100ms

**API 验证**:
```bash
# 发送测试消息
curl -X POST http://localhost:8000/api/manual/messages \
  -H "Content-Type: application/json" \
  -d '{
    "session_name": "test_session",
    "role": "user",
    "content": "测试实时推送"
  }'

# 观察坐席工作台是否实时收到
```

---

#### 3.10.5 会话切换测试

**步骤**:
1. 选择会话 A
2. 等待 SSE 连接建立（观察日志）
3. 选择会话 B
4. 观察控制台日志

**预期结果**:
- [ ] 控制台显示 "🔄 切换监听会话: {session_A} → {session_B}"
- [ ] 会话 A 的 SSE 连接断开
- [ ] 会话 B 的 SSE 连接建立
- [ ] Network 标签只显示 1 个 SSE 连接（会话 B）
- [ ] 无内存泄漏

**Network 验证**:
```bash
# 在 Network 标签页:
# - 会话 A 的 /api/chat/stream 状态变为 "canceled"
# - 会话 B 的 /api/chat/stream 状态为 "pending"
```

---

#### 3.10.6 自动重连测试

**步骤**:
1. 选择一个会话，建立 SSE 连接
2. 在后端停止服务（Ctrl+C）
3. 观察控制台日志
4. 3秒后重启后端服务
5. 观察控制台日志

**预期结果**:
- [ ] 连接断开时控制台显示错误日志
- [ ] 3秒后控制台显示 "🔄 尝试重连..."
- [ ] 后端恢复后 SSE 自动重连
- [ ] 重连成功后控制台显示 "✅ SSE 连接已建立"
- [ ] 实时推送恢复正常

**手动测试验证**:
```bash
# 1. 断开后端
# 观察控制台: ❌ SSE 连接失败

# 2. 等待 3秒
# 观察控制台: 应显示重连尝试

# 3. 恢复后端
python3 backend.py

# 4. 观察控制台: ✅ SSE 连接已建立
```

---

#### 3.10.7 资源清理测试

**步骤**:
1. 登录坐席工作台，选择会话
2. 打开 Chrome DevTools → Memory 标签
3. 拍摄内存快照（Snapshot 1）
4. 切换多个会话 10 次
5. 关闭所有会话
6. 拍摄内存快照（Snapshot 2）
7. 对比两个快照

**预期结果**:
- [ ] 定时器数量无增长（Snapshot 2 ≈ Snapshot 1）
- [ ] SSE 连接正确释放
- [ ] 内存增长 < 5MB（正常范围）
- [ ] 无内存泄漏警告

**离开页面测试**:
```bash
# 步骤:
# 1. 选中会话（建立 SSE）
# 2. 刷新页面或关闭标签页
# 3. 观察控制台最后一条日志

# 预期结果:
# - 控制台显示 "⏹️ 停止实时监听"
# - 定时器清除
# - SSE 连接断开
```

---

#### 3.10.8 性能压力测试

**场景1: 多会话快速切换**

**步骤**:
1. 坐席工作台有 10+ 待接入会话
2. 快速切换会话（每秒切换 1 次）
3. 持续 30 秒
4. 观察性能

**预期结果**:
- [ ] 页面无卡顿
- [ ] CPU 使用率 < 50%
- [ ] 内存稳定，无持续增长
- [ ] SSE 连接切换正常

**场景2: 长时间连接**

**步骤**:
1. 选择一个会话
2. 保持连接 30 分钟
3. 每 5 分钟发送一条测试消息
4. 观察连接稳定性

**预期结果**:
- [ ] SSE 连接保持活跃
- [ ] 消息实时推送正常
- [ ] 无自动断开
- [ ] 轮询继续执行（30秒间隔）

---

#### 3.10.9 浏览器兼容性测试

**测试浏览器**: Chrome, Firefox, Safari, Edge (最新版)

**步骤**:
1. 在每个浏览器中打开坐席工作台
2. 执行上述所有测试场景
3. 观察功能和性能

**预期结果**:
- [ ] Chrome: 完全支持
- [ ] Firefox: 完全支持
- [ ] Safari: 完全支持
- [ ] Edge: 完全支持
- [ ] 无浏览器特定错误

---

#### 3.10.10 错误场景测试

**场景1: 后端未启动**

```bash
# 1. 停止后端
# 2. 打开坐席工作台
# 预期: 连接失败，3秒后重试
```

**场景2: 会话不存在**

```bash
# 1. 选择一个会话
# 2. 后端删除该会话
# 3. SSE 尝试连接
# 预期: 返回 404，控制台显示错误，不影响其他功能
```

**场景3: JSON 解析错误**

```bash
# 模拟后端返回无效 JSON
# 预期: 打印解析错误，继续处理后续消息，不中断连接
```

---

#### 3.10.11 性能对比测试

**对比指标**: SSE 实时推送 vs 5秒轮询

| 指标 | 5秒轮询 | SSE 实时推送 | 测量方法 |
|------|---------|-------------|----------|
| 网络请求频率 | 12次/分钟 | 2次/分钟 | Network 标签统计 1 分钟内请求数 |
| 消息推送延迟 | 平均 2.5秒 | < 100ms | 后端发送时间戳 → 前端接收时间戳 |
| CPU 使用率 | ~ | ~ | Chrome Task Manager 观察 |
| 内存占用 | ~ | ~ | Memory 标签对比 |

**测试脚本**:
```bash
# 统计网络请求
# 1. 打开 Network 标签
# 2. 清除记录
# 3. 观察 1 分钟
# 4. 统计 /api/sessions 请求数

# 5秒轮询: 预期 12 次
# SSE + 30秒轮询: 预期 2 次
# 节省: 83%
```

---

#### 3.10.12 文档验证测试

**验证清单**:

| 文档 | 验证项 | 状态 |
|------|--------|------|
| **约束18** | 包含 18.1-18.8 完整约束 | [ ] |
| **API 规范** | SSE 事件类型详细说明 | [ ] |
| **完成报告** | 功能概述、实现细节、验证清单 | [ ] |
| **代码注释** | FetchSSE 类注释完整 | [ ] |
| **README** | 更新 v2.3.9 版本历史 | [ ] |

---

#### 3.10.13 回归测试清单

**SSE 功能上线前必测**:

- [ ] 核心功能：Coze API 调用正常（健康检查通过）
- [ ] 核心功能：AI 对话功能正常
- [ ] 核心功能：会话隔离正常
- [ ] SSE 连接：初始加载建立成功
- [ ] SSE 连接：会话切换自动切换
- [ ] SSE 连接：自动重连正常
- [ ] SSE 连接：资源清理正常
- [ ] SSE 事件：status_change 推送正常
- [ ] SSE 事件：manual_message 推送正常
- [ ] 性能：轮询间隔 30秒
- [ ] 性能：推送延迟 < 100ms
- [ ] 性能：无内存泄漏
- [ ] 兼容性：Chrome 正常
- [ ] 兼容性：Firefox 正常
- [ ] 文档：约束18 已添加
- [ ] 文档：API 规范已更新

---

### 测试报告模板

```markdown
## SSE 实时推送功能测试报告

**测试日期**: YYYY-MM-DD
**测试人员**: [姓名]
**测试环境**:
- 浏览器: Chrome 120
- 操作系统: Ubuntu 22.04
- 后端版本: v2.3.9

### 测试结果汇总

| 测试场景 | 测试用例数 | 通过数 | 失败数 | 通过率 |
|---------|----------|--------|--------|--------|
| 基础连接 | 4 | 4 | 0 | 100% |
| SSE 事件 | 5 | 5 | 0 | 100% |
| 会话切换 | 5 | 5 | 0 | 100% |
| 自动重连 | 5 | 5 | 0 | 100% |
| 资源清理 | 4 | 4 | 0 | 100% |
| 性能测试 | 6 | 6 | 0 | 100% |
| 兼容性 | 4 | 4 | 0 | 100% |
| **总计** | **33** | **33** | **0** | **100%** |

### 性能数据

| 指标 | 实测值 | 目标值 | 结果 |
|------|--------|--------|------|
| SSE 推送延迟 | 85ms | < 100ms | ✅ 通过 |
| 轮询间隔 | 30s | 30s | ✅ 通过 |
| 网络请求减少 | 83% | 83% | ✅ 通过 |
| 内存增长 | 2.3MB | < 5MB | ✅ 通过 |

### 发现问题

[无]

### 测试结论

SSE 实时推送功能完全符合设计要求，通过所有测试用例，建议上线。
```

---

## 四、API 测试命令速查

### 4.1 健康检查
```bash
curl http://localhost:8000/api/health
```

### 4.2 获取会话列表
```bash
# 所有会话
curl "http://localhost:8000/api/sessions"

# 待接入会话
curl "http://localhost:8000/api/sessions?status=pending_manual"

# 服务中会话
curl "http://localhost:8000/api/sessions?status=manual_live"
```

### 4.3 获取统计信息
```bash
curl http://localhost:8000/api/sessions/stats
```

### 4.4 人工升级
```bash
curl -X POST http://localhost:8000/api/manual/escalate \
  -H "Content-Type: application/json" \
  -d '{"session_name": "test_session", "reason": "user_request"}'
```

### 4.5 坐席接入
```bash
curl -X POST http://localhost:8000/api/sessions/{session_name}/takeover \
  -H "Content-Type: application/json" \
  -d '{"agent_id": "agent_001", "agent_name": "测试坐席"}'
```

### 4.6 发送人工消息
```bash
curl -X POST http://localhost:8000/api/manual/messages \
  -H "Content-Type: application/json" \
  -d '{
    "session_name": "test_session",
    "role": "agent",
    "content": "您好，有什么可以帮您？",
    "agent_info": {"agent_id": "agent_001", "agent_name": "测试坐席"}
  }'
```

### 4.7 释放会话
```bash
curl -X POST http://localhost:8000/api/sessions/{session_name}/release \
  -H "Content-Type: application/json" \
  -d '{"agent_id": "agent_001", "reason": "resolved"}'
```

### 4.8 工作时间状态
```bash
curl http://localhost:8000/api/shift/status
```

---

## 五、边界条件测试

### 5.1 异常输入测试

| 测试项 | 输入 | 预期结果 |
|--------|------|----------|
| 空消息 | "" | 阻止发送 |
| 超长消息 | 10000字符 | 截断或提示 |
| 特殊字符 | `<script>alert(1)</script>` | 转义显示 |
| 表情符号 | 😀🎉 | 正常显示 |

### 5.2 并发测试

| 场景 | 预期结果 |
|------|----------|
| 多用户同时请求人工 | 各自独立排队 |
| 多坐席同时接入同一会话 | 只有一个成功 |
| 高频消息发送 | 正常处理或限流 |

### 5.3 网络异常测试

| 场景 | 预期结果 |
|------|----------|
| 后端服务重启 | 前端显示重连提示 |
| 网络断开 | 消息发送失败提示 |
| 请求超时 | 显示超时错误 |

---

## 六、测试检查清单

### 6.1 功能开发完成检查

- [ ] 回归测试全部通过 (12/12)
- [ ] 新功能手动测试通过
- [ ] API 返回格式正确
- [ ] 错误处理完善
- [ ] 日志输出正常
- [ ] 无 console 错误

### 6.2 发布前检查

- [ ] 所有核心场景测试通过
- [ ] 边界条件测试通过
- [ ] 性能测试通过
- [ ] 安全检查通过
- [ ] 文档更新完成

---

## 七、常见问题排查

### 7.1 后端启动失败

```bash
# 检查端口占用
lsof -i :8000

# 检查环境变量
cat .env

# 检查依赖
pip3 list | grep -E "fastapi|coze"
```

### 7.2 前端连接失败

```bash
# 检查后端是否运行
curl http://localhost:8000/api/health

# 检查 CORS 配置
# backend.py 中 allow_origins
```

### 7.3 会话状态异常

```bash
# 查看会话详情
curl http://localhost:8000/api/sessions/{session_name}

# 查看后端日志
# 搜索 session_name 相关日志
```

### 7.4 SSE 消息不推送

检查:
1. 浏览器 Network 面板是否有 SSE 连接
2. 后端日志是否有 "SSE 推送" 输出
3. session_name 是否匹配

---

## 八、测试数据清理

```bash
# 重启后端会清空内存中的会话数据
# 如需保留，检查 SESSION_STATE_BACKUP_FILE 配置
```

---

## 附录：测试用例模板

```markdown
### 测试用例: [用例名称]

**ID**: TC-XXX
**优先级**: P0/P1/P2
**前置条件**:
- 条件1
- 条件2

**测试步骤**:
1. 步骤1
2. 步骤2
3. 步骤3

**预期结果**:
- [ ] 结果1
- [ ] 结果2

**实际结果**:
- 通过/失败
- 备注

**测试人员**:
**测试时间**:
```
