# Fiido æ™ºèƒ½å®¢æœç³»ç»Ÿ - Claude å¼€å‘æŒ‡ä»¤

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Coze API çš„æ™ºèƒ½å®¢æœç³»ç»Ÿï¼ŒåŒ…å«ç”¨æˆ·ç«¯ã€åå¸­å·¥ä½œå°å’Œåç«¯æœåŠ¡ã€‚

---

## ğŸ”´ å¿…è¯»æ–‡æ¡£ï¼ˆå¼€å‘å‰å¿…é¡»å…¨éƒ¨é˜…è¯»ï¼‰

**å¼€å‘ä»»ä½•åŠŸèƒ½å‰ï¼Œå¿…é¡»é˜…è¯»ä»¥ä¸‹æ‰€æœ‰æ–‡æ¡£ï¼Œä¸€ä¸ªéƒ½ä¸èƒ½è½ä¸‹ï¼š**

### 1. çº¦æŸä¸åŸåˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œå¿…é¡»é¦–å…ˆé˜…è¯»ï¼‰

- `prd/02_çº¦æŸä¸åŸåˆ™/CONSTRAINTS_AND_PRINCIPLES.md` - æ ¸å¿ƒçº¦æŸä¸å¼€å‘åŸåˆ™
- `prd/02_çº¦æŸä¸åŸåˆ™/TECHNICAL_CONSTRAINTS.md` - æŠ€æœ¯çº¦æŸè¯¦ç»†è¯´æ˜
- `prd/02_çº¦æŸä¸åŸåˆ™/coze.md` - Coze API ä½¿ç”¨çº¦æŸå’Œè§„èŒƒ

### 2. å…¨å±€æŒ‡å¯¼

- `prd/01_å…¨å±€æŒ‡å¯¼/prd.md` - ä¸»PRDæ–‡æ¡£ï¼Œç³»ç»Ÿéœ€æ±‚å®šä¹‰å’Œå¼€å‘æµç¨‹è§„èŒƒ
- `prd/01_å…¨å±€æŒ‡å¯¼/PRD_COMPLETE_v3.0.md` - å®Œæ•´ç‰ˆPRDï¼Œè¯¦ç»†åŠŸèƒ½è§„æ ¼
- `prd/01_å…¨å±€æŒ‡å¯¼/README.md` - é¡¹ç›®æ¦‚è¿°å’Œå¿«é€Ÿå…¥é—¨

### 3. æŠ€æœ¯æ–¹æ¡ˆ

- `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/TECHNICAL_SOLUTION_v1.0.md` - æŠ€æœ¯æ¶æ„æ–¹æ¡ˆ
- `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/api_contract.md` - API æ¥å£å¥‘çº¦æ–‡æ¡£

### 4. ä»»åŠ¡æ‹†è§£

- `prd/04_ä»»åŠ¡æ‹†è§£/IMPLEMENTATION_TASKS_v1.0.md` - æ€»ä½“ä»»åŠ¡æ‹†è§£
- `prd/04_ä»»åŠ¡æ‹†è§£/backend_tasks.md` - åç«¯å¼€å‘ä»»åŠ¡
- `prd/04_ä»»åŠ¡æ‹†è§£/frontend_client_tasks.md` - ç”¨æˆ·ç«¯å‰ç«¯ä»»åŠ¡
- `prd/04_ä»»åŠ¡æ‹†è§£/agent_workbench_tasks.md` - åå¸­å·¥ä½œå°ä»»åŠ¡
- `prd/04_ä»»åŠ¡æ‹†è§£/admin_management_tasks.md` - ç®¡ç†å‘˜åŠŸèƒ½ä»»åŠ¡æ‹†è§£ â­ æ–°å¢
- `prd/04_ä»»åŠ¡æ‹†è§£/email_and_monitoring_tasks.md` - é‚®ä»¶å’Œç›‘æ§ä»»åŠ¡

### 5. éªŒæ”¶ä¸è®°å½•

- `prd/05_éªŒæ”¶ä¸è®°å½•/ACCEPTANCE_CRITERIA_v1.0.md` - è¯¦ç»†éªŒæ”¶æ ‡å‡†
- `prd/05_éªŒæ”¶ä¸è®°å½•/TESTING_GUIDE.md` - æµ‹è¯•æµç¨‹è§„èŒƒ
- `prd/05_éªŒæ”¶ä¸è®°å½•/implementation_notes.md` - å®æ–½è¿‡ç¨‹ç¬”è®°
- `prd/05_éªŒæ”¶ä¸è®°å½•/PRD_REVIEW.md` - PRD è¯„å®¡è®°å½•
- `prd/05_éªŒæ”¶ä¸è®°å½•/DOCUMENTATION_SUMMARY.md` - æ–‡æ¡£æ€»ç»“

### 6. ä¼ä¸šéƒ¨ç½²

- `prd/06_ä¼ä¸šéƒ¨ç½²/ENTERPRISE_DEPLOYMENT_PRD.md` - ä¼ä¸šçº§éƒ¨ç½²éœ€æ±‚ï¼ˆç‹¬ç«‹ç«™éƒ¨ç½²ï¼‰
- `prd/06_ä¼ä¸šéƒ¨ç½²/DEPLOYMENT_TASKS.md` - éƒ¨ç½²å¼€å‘ä»»åŠ¡æ‹†è§£

**âš ï¸ é‡è¦ï¼šå¼€å‘å‰å¿…é¡»ä½¿ç”¨ Read å·¥å…·é˜…è¯»ä¸Šè¿°æ‰€æœ‰æ–‡æ¡£ï¼Œç¡®ä¿å®Œå…¨ç†è§£é¡¹ç›®çº¦æŸå’Œè§„èŒƒåå†å¼€å§‹ç¼–ç ã€‚**

---

## ğŸš¨ æ ¸å¿ƒé“å¾‹ï¼ˆå¿…é¡»éµå®ˆï¼Œä¸å¯è¿åï¼‰

### é“å¾‹ 1: ä¸å¯ä¿®æ”¹çš„æ ¸å¿ƒæ¥å£

ä»¥ä¸‹æ¥å£æ˜¯ç³»ç»ŸåŸºçŸ³ï¼Œ**ä¸¥ç¦ä¿®æ”¹å…¶æ ¸å¿ƒé€»è¾‘**ï¼š

```
ğŸ”´ ä¸å¯ä¿®æ”¹:
- POST /api/chat              (åŒæ­¥AIå¯¹è¯)
- POST /api/chat/stream       (æµå¼AIå¯¹è¯)
- POST /api/conversation/new  (åˆ›å»ºä¼šè¯)
```

**å…è®¸çš„æ“ä½œ**:

- âœ… åœ¨è°ƒç”¨å‰æ·»åŠ å‰ç½®æ£€æŸ¥ï¼ˆå¦‚çŠ¶æ€æ£€æŸ¥ï¼‰
- âœ… åœ¨è¿”å›åæ·»åŠ åç½®å¤„ç†ï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰
- âŒ **ç¦æ­¢**ä¿®æ”¹ Coze API è°ƒç”¨æ–¹å¼
- âŒ **ç¦æ­¢**ä¿®æ”¹è¿”å›çš„æ•°æ®ç»“æ„
- âŒ **ç¦æ­¢**ä¿®æ”¹ payload çš„å¿…éœ€å­—æ®µæ ¼å¼

### é“å¾‹ 2: Coze API è°ƒç”¨è§„èŒƒ

#### å¿…é¡»ä½¿ç”¨ SSE æµå¼å“åº”

```python
# âœ… æ­£ç¡® - ä½¿ç”¨ stream() æ–¹æ³•
with http_client.stream('POST', url, json=payload, headers=headers) as response:
    for line in response.iter_lines():
        # è§£æSSEæµ

# âŒ é”™è¯¯ - Cozeè¿”å›çš„æ˜¯SSEæµ,ä¸æ˜¯JSON!
response = http_client.post(...)
data = response.json()
```

#### å¿…é¡»ä»é¡¶å±‚æå–å­—æ®µ

```python
# âœ… æ­£ç¡®
event_data = json.loads(data_content)
if event_data.get("type") == "answer":
    content = event_data["content"]

# âŒ é”™è¯¯ - Cozeä¸è¿”å›åµŒå¥—ç»“æ„
content = event_data["message"]["content"]
```

#### å¿…éœ€çš„è¯·æ±‚å‚æ•°

```python
payload = {
    "workflow_id": WORKFLOW_ID,      # å¿…éœ€
    "app_id": APP_ID,                # å¿…éœ€
    "session_name": session_id,      # å¿…éœ€ - ä¼šè¯éš”ç¦»
    "additional_messages": [...],    # å¿…éœ€
    "conversation_id": conv_id,      # å¯é€‰(å¤šè½®å¯¹è¯éœ€è¦)
}
```

### é“å¾‹ 3: OAuth + JWT é‰´æƒæœºåˆ¶

```python
# âœ… æ­£ç¡® - ä½¿ç”¨ token_manager
access_token = token_manager.get_access_token(
    session_name=session_id  # å¿…é¡»åŒ…å«session_nameå®ç°éš”ç¦»
)

# âŒ é”™è¯¯ - ç¡¬ç¼–ç Token
access_token = "hardcoded_token"

# âŒ é”™è¯¯ - æ‰€æœ‰ç”¨æˆ·å…±ç”¨ä¸€ä¸ªToken
access_token = token_manager.get_access_token()  # ç¼ºå°‘session_name!
```

### é“å¾‹ 4: ä¼šè¯éš”ç¦»æœºåˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼šåŸºäº `session_name` å®ç°ä¼šè¯éš”ç¦»ï¼Œconversation_id ç”± Coze è‡ªåŠ¨ç®¡ç†

**æ ¸å¿ƒåŸç†** (è¯¦è§ `docs/process/ä¼šè¯éš”ç¦»å®ç°æ€»ç»“.md`):

1. âœ… **é¦–æ¬¡å¯¹è¯ä¸ä¼  conversation_id**ï¼Œç”± Coze è‡ªåŠ¨ç”Ÿæˆ
2. âœ… **åç»­å¯¹è¯ä¼ å…¥ç›¸åŒçš„ conversation_id** ç»´æŒä¸Šä¸‹æ–‡
3. âœ… **éªŒè¯æ ‡å‡†**: ä¸åŒ session_name è·å¾—ä¸åŒçš„ conversation_id

```python
# âœ… æ­£ç¡®æ–¹å¼ - Coze è‡ªåŠ¨ç®¡ç† conversation_id
@app.post("/api/chat")
async def chat(request: ChatRequest):
    session_id = request.user_id or generate_user_id()

    # è·å–å¸¦ session_name çš„ JWT Token
    access_token = token_manager.get_access_token(session_name=session_id)

    # ä»ç¼“å­˜è·å– conversation_idï¼ˆå¦‚æœæœ‰ï¼‰
    conversation_id = conversation_cache.get(session_id)

    # æ„å»º API payload
    payload = {
        "workflow_id": WORKFLOW_ID,
        "app_id": APP_ID,
        "session_name": session_id,  # â† å…³é”®ï¼ä¼šè¯éš”ç¦»æ ¸å¿ƒ
        "parameters": {"USER_INPUT": request.message}
    }

    # é¦–æ¬¡å¯¹è¯ä¸ä¼  conversation_idï¼Œåç»­å¯¹è¯æ‰ä¼ 
    if conversation_id:
        payload["conversation_id"] = conversation_id

    # è°ƒç”¨ Coze API
    response = httpx.post(url, json=payload, headers=headers)

    # ä¿å­˜ Coze è¿”å›çš„ conversation_id
    if not conversation_id and returned_conversation_id:
        conversation_cache[session_id] = returned_conversation_id

# âŒ é”™è¯¯æ–¹å¼ - æ‰‹åŠ¨ç”Ÿæˆ conversation_id
conversation_id = f"conv_{uuid.uuid4()}"  # ç¦æ­¢ï¼

# âŒ é”™è¯¯æ–¹å¼ - ä¾èµ–é¦–æ¬¡å¯¹è¯è‡ªåŠ¨ç”Ÿæˆä½†ä¸ä¿å­˜
# é—®é¢˜ï¼šä¼šå¯¼è‡´æ¯æ¬¡å¯¹è¯éƒ½ç”Ÿæˆæ–° conversation_idï¼Œæ— æ³•ç»´æŒä¸Šä¸‹æ–‡
```

**æµ‹è¯•éªŒè¯** (ä½¿ç”¨ `tests/test_session_isolation.py`):

```bash
# æ­£ç¡®çš„ä¼šè¯éš”ç¦»æµ‹è¯•æµç¨‹
# 1. ç”¨æˆ· A é¦–æ¬¡å¯¹è¯ï¼ˆä¸ä¼  conversation_idï¼‰
POST /api/chat {"message": "æˆ‘æ˜¯ç”¨æˆ·A", "user_id": "session_a"}
# å“åº”: {"conversation_id": "7576537373...", "message": "..."}

# 2. ç”¨æˆ· B é¦–æ¬¡å¯¹è¯ï¼ˆä¸ä¼  conversation_idï¼‰
POST /api/chat {"message": "æˆ‘æ˜¯ç”¨æˆ·B", "user_id": "session_b"}
# å“åº”: {"conversation_id": "7576539408...", "message": "..."}  â† ä¸åŒï¼

# 3. ç”¨æˆ· A ç¬¬äºŒè½®ï¼ˆä¼ å…¥ conversation_idï¼‰
POST /api/chat {"message": "æˆ‘æ˜¯è°?", "user_id": "session_a", "conversation_id": "7576537373..."}
# å“åº”: åº”è¯¥å›ç­”"ä½ æ˜¯ç”¨æˆ·A"ï¼Œè¯æ˜ä¸Šä¸‹æ–‡ç»´æŒæˆåŠŸ

# éªŒè¯: conversation_id ä¸åŒ âœ…
```

**å…³é”®çº¦æŸ**:

- âŒ ç¦æ­¢æ‰‹åŠ¨ç”Ÿæˆ conversation_id
- âŒ ç¦æ­¢ä¿®æ”¹ conversation_id ç®¡ç†é€»è¾‘
- âœ… å¿…é¡»ä¿å­˜ Coze è¿”å›çš„ conversation_id
- âœ… å¿…é¡»åœ¨ JWT å’Œ API payload ä¸­éƒ½ä¼ å…¥ session_name

### é“å¾‹ 5: çŠ¶æ€æœºçº¦æŸ

```
bot_active â†’ pending_manual â†’ manual_live â†’ bot_active
```

- çŠ¶æ€è½¬æ¢å¿…é¡»æŒ‰é¡ºåºï¼Œä¸å¯è·³è·ƒ
- äººå·¥æ¥ç®¡æœŸé—´**å¿…é¡»é˜»æ­¢ AI å¯¹è¯**ï¼ˆè¿”å› 409ï¼‰
- `conversation_id` ç”± Coze è‡ªåŠ¨ç”Ÿæˆï¼Œ**ç¦æ­¢æ‰‹åŠ¨åˆ›å»º**

---

## ğŸ“‹ å¼€å‘æµç¨‹è§„èŒƒ

### é˜¶æ®µ1: å¼€å‘å‰å®¡æŸ¥

**åœ¨å¼€å§‹ä»»ä½•æ–°åŠŸèƒ½å¼€å‘ä¹‹å‰ï¼Œå¿…é¡»å®Œæˆ**ï¼š

#### 1.1 å…¨æ–°åŠŸèƒ½æ–¹æ¡ˆæ–‡æ¡£è¦æ±‚ â­ **å¼ºåˆ¶æ‰§è¡Œ**

**è§¦å‘æ¡ä»¶**ï¼šå¼€å‘å…¨æ–°çš„æ¨¡å—åŠŸèƒ½æ—¶ï¼ˆä¸åŒ…æ‹¬å°æ”¹åŠ¨æˆ–å¯¹åŸæœ‰åŠŸèƒ½çš„æ”¹å–„ï¼‰

**å¼ºåˆ¶è¦æ±‚**ï¼š

- âœ… **å¿…é¡»å…ˆç¼–å†™è¯¦ç»†çš„å®æ–½æ–¹æ¡ˆæ–‡æ¡£**ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
  1. **ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Ÿ** - å½“å‰é—®é¢˜åˆ†æï¼Œç”¨å®é™…åœºæ™¯æ¼”ç¤º
  2. **æŠ€æœ¯åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ** - æ¸…æ™°è§£é‡Šå·¥ä½œåŸç†å’Œæ ¸å¿ƒæ¦‚å¿µ
  3. **éœ€è¦ä»€ä¹ˆå·¥å…·å’Œé…ç½®ï¼Ÿ** - è¯¦ç»†çš„å®‰è£…æ­¥éª¤å’Œé…ç½®è¯´æ˜
  4. **å¦‚ä½•å®ç°ï¼Ÿ** - å®Œæ•´çš„å®æ–½æ­¥éª¤ï¼ŒåŒ…å«ä»£ç ç¤ºä¾‹
  5. **æœ€ç»ˆæ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿ** - Before/After å¯¹æ¯”ï¼ŒéªŒè¯æ ‡å‡†
  6. **å®æ–½æ—¶é—´ä¼°ç®—** - å„é˜¶æ®µè€—æ—¶é¢„ä¼°
  7. **å¸¸è§é—®é¢˜ FAQ** - é¢„è§æ€§é—®é¢˜è§£ç­”

**æ–‡æ¡£å­˜æ”¾ä½ç½®**ï¼š`docs/{åŠŸèƒ½åç§°}_å®æ–½æ–¹æ¡ˆè¯¦è§£.md`

**å¼€å‘æµç¨‹**ï¼š

1. ç”¨æˆ·æå‡ºå…¨æ–°åŠŸèƒ½éœ€æ±‚
2. Claude ç¼–å†™è¯¦ç»†æ–¹æ¡ˆæ–‡æ¡£ï¼ˆä¸å¼€å§‹å¼€å‘ï¼‰
3. ç”¨æˆ·é˜…è¯»å¹¶ç¡®è®¤ç†è§£
4. ç”¨æˆ·æ˜ç¡®ç¡®è®¤åï¼ŒClaude å¼€å§‹å®æ–½

**ç¤ºä¾‹**ï¼šRedis æ•°æ®æŒä¹…åŒ– â†’ å…ˆåˆ›å»º `docs/Redisæ•°æ®æŒä¹…åŒ–å®æ–½æ–¹æ¡ˆè¯¦è§£.md`

**ä¾‹å¤–æƒ…å†µ**ï¼š

- ç”¨æˆ·æ˜ç¡®è¯´"ä¸ç”¨å†™æ–¹æ¡ˆæ–‡æ¡£"æ—¶å¯è·³è¿‡
- å¯¹åŸæœ‰åŠŸèƒ½çš„å°æ”¹åŠ¨ã€bug ä¿®å¤ä¸éœ€è¦
- ç”¨æˆ·æ˜ç¡®è¯´"ç«‹å³å¼€å§‹å¼€å‘"å¯è·³è¿‡

---

#### 1.2 å¼€å‘è¿›åº¦ç®¡ç†è¦æ±‚ â­ **å¼ºåˆ¶æ‰§è¡Œ**

**è§¦å‘æ¡ä»¶**ï¼šä»»ä½•æ¨¡å—å¼€å‘ï¼ˆæ–°åŠŸèƒ½ã€ä¼˜åŒ–ã€Bugä¿®å¤ï¼‰

**å¼ºåˆ¶è¦æ±‚**ï¼š

1. **è¿›åº¦æŸ¥è¯¢è§„èŒƒ**

   - æŸ¥è¯¢å¼€å‘è¿›åº¦æ—¶ï¼Œ**ä¼˜å…ˆä» `prd/04_ä»»åŠ¡æ‹†è§£/` æ–‡ä»¶å¤¹ä¸‹æœç´¢**
   - æ¯ä¸ªæ¨¡å—å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ `.md` æ–‡ä»¶
   - æ–‡ä»¶å‘½åæ ¼å¼ï¼š`{æ¨¡å—åç§°}_tasks.md`
2. **ä»»åŠ¡æ‹†è§£æ–‡ä»¶ç»“æ„è¦æ±‚**

æ¯ä¸ªä»»åŠ¡æ‹†è§£æ–‡ä»¶å¿…é¡»åŒ…å«ä»¥ä¸‹ç« èŠ‚ï¼š

```markdown
# {æ¨¡å—åç§°}åŠŸèƒ½éœ€æ±‚æ–‡æ¡£ä¸ä»»åŠ¡æ‹†è§£

> æ–‡æ¡£ç‰ˆæœ¬: v{ç‰ˆæœ¬å·}
> çŠ¶æ€: âœ… P0 å·²å®Œæˆ / âš ï¸ P0 å¼€å‘ä¸­ / âŒ P0 å¾…å¼€å‘
> æ›´æ–°æ—¶é—´: YYYY-MM-DD

## 1. åŠŸèƒ½åˆ—è¡¨

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | ä¼˜å…ˆçº§ | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|--------|---------|--------|------|---------|
| {æ¨¡å—}-01 | åŠŸèƒ½åç§° | P0 | âœ… å·²å®Œæˆ | 2025-11-25 |
| {æ¨¡å—}-02 | åŠŸèƒ½åç§° | P1 | âš ï¸ å¼€å‘ä¸­ | - |
| {æ¨¡å—}-03 | åŠŸèƒ½åç§° | P2 | âŒ å¾…å¼€å‘ | - |

## 2. å½“å‰æ¨¡å—å¼€å‘è¿›åº¦

**æ€»ä½“è¿›åº¦**: 60% (P0: 100%, P1: 50%, P2: 0%)

**å½“å‰é˜¶æ®µ**: P1 å¼€å‘ä¸­

**æœ€è¿‘æ›´æ–°**:
- 2025-11-25: å®Œæˆ P0 åŠŸèƒ½ï¼Œå¼€å§‹ P1 å¼€å‘
- 2025-11-24: åˆ›å»ºæ¨¡å—ï¼Œå®ŒæˆæŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

## 3. æŠ€æœ¯æ–¹æ¡ˆï¼ˆåŒæ­¥åˆ° prd/03_æŠ€æœ¯æ–¹æ¡ˆ/ï¼‰

## 4. çº¦æŸä¸åŸåˆ™ï¼ˆåŒæ­¥åˆ° prd/02_çº¦æŸä¸åŸåˆ™/ï¼‰

## 5. API æ¥å£ï¼ˆåŒæ­¥åˆ° prd/03_æŠ€æœ¯æ–¹æ¡ˆ/api_contract.mdï¼‰

## 6. éªŒæ”¶æ ‡å‡†
```

3. **åŒæ­¥æ›´æ–°è¦æ±‚**

å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¿…é¡»åŒæ­¥æ›´æ–°ä»¥ä¸‹æ–‡ä»¶ï¼š


| æ›´æ–°å†…å®¹   | åŒæ­¥ä½ç½®                                                                       |
| ---------- | ------------------------------------------------------------------------------ |
| æŠ€æœ¯æ–¹æ¡ˆ   | `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/{æ¨¡å—åç§°}_solution.md` æˆ–é›†æˆåˆ° `TECHNICAL_SOLUTION_v1.0.md` |
| çº¦æŸä¸åŸåˆ™ | `prd/02_çº¦æŸä¸åŸåˆ™/CONSTRAINTS_AND_PRINCIPLES.md` (æ·»åŠ æ–°çº¦æŸ)                 |
| API æ¥å£   | `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/api_contract.md` (æ·»åŠ æ–°æ¥å£)                                 |
| ä»»åŠ¡è¿›åº¦   | `prd/04_ä»»åŠ¡æ‹†è§£/{æ¨¡å—åç§°}_tasks.md` (æ›´æ–°çŠ¶æ€å’Œè¿›åº¦)                         |

4. **å¼€å‘å®Œæˆåå¼ºåˆ¶æ›´æ–°**

æ¯æ¬¡å®Œæˆå¼€å‘åï¼Œ**å¿…é¡»æ›´æ–°å¼€å‘è¿›åº¦**ï¼š

```bash
# å¿…é¡»æ‰§è¡Œçš„æ›´æ–°
1. æ›´æ–° prd/04_ä»»åŠ¡æ‹†è§£/{æ¨¡å—åç§°}_tasks.md
   - ä¿®æ”¹åŠŸèƒ½çŠ¶æ€ï¼ˆå¾…å¼€å‘ â†’ å¼€å‘ä¸­ â†’ å·²å®Œæˆï¼‰
   - æ›´æ–°å®Œæˆæ—¶é—´
   - æ›´æ–°æ€»ä½“è¿›åº¦ç™¾åˆ†æ¯”

2. å¦‚æœ‰æ–°å¢çº¦æŸï¼Œæ›´æ–° prd/02_çº¦æŸä¸åŸåˆ™/CONSTRAINTS_AND_PRINCIPLES.md

3. å¦‚æœ‰æ–°å¢APIï¼Œæ›´æ–° prd/03_æŠ€æœ¯æ–¹æ¡ˆ/api_contract.md

4. æäº¤å¹¶æ¨é€åˆ° GitHub ä»“åº“ï¼ŒåŒ…å«è¿›åº¦æ›´æ–°
```

**ç¤ºä¾‹**ï¼š

```markdown
# ç®¡ç†å‘˜åŠŸèƒ½å¼€å‘å®Œæˆ v3.1.3

æ›´æ–°å†…å®¹ï¼š
- âœ… P0 åŠŸèƒ½å…¨éƒ¨å®Œæˆï¼ˆåå¸­CRUDã€æƒé™æ§åˆ¶ï¼‰
- âœ… P1 åŠŸèƒ½å…¨éƒ¨å®Œæˆï¼ˆä¿®æ”¹å¯†ç ã€ä¿®æ”¹èµ„æ–™ï¼‰
- ğŸ“„ æ›´æ–° admin_management_tasks.md è¿›åº¦ä¸º 100%
- ğŸ“„ æ·»åŠ çº¦æŸ19-21åˆ° CONSTRAINTS_AND_PRINCIPLES.md
- ğŸ“„ æ·»åŠ 7ä¸ªæ–°APIåˆ° api_contract.md
```

5. **æ£€æŸ¥æ¸…å•**

å¼€å‘å®Œæˆåï¼Œæ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ]  `prd/04_ä»»åŠ¡æ‹†è§£/{æ¨¡å—åç§°}_tasks.md` çŠ¶æ€å·²æ›´æ–°
- [ ]  æ–°å¢çº¦æŸå·²å†™å…¥ `prd/02_çº¦æŸä¸åŸåˆ™/`
- [ ]  æ–°å¢APIå·²å†™å…¥ `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/api_contract.md`
- [ ]  **æ–°åŠŸèƒ½æµ‹è¯•è„šæœ¬å·²åˆ›å»ºå¹¶éªŒè¯é€šè¿‡** â­ æ–°å¢
- [ ]  **æµ‹è¯•å·²é›†æˆåˆ° `tests/regression_test.sh`** â­ æ–°å¢
- [ ]  **å›å½’æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆåŒ…æ‹¬æ–°å¢æµ‹è¯•ï¼‰** â­ æ›´æ–°
- [ ]  Git commit å®Œæˆå¹¶å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œcommit message åŒ…å«è¿›åº¦ä¿¡æ¯
- [ ]  æäº¤å¹¶æ›´æ–°ä»“åº“çš„mainåˆ†æ”¯ï¼Œå¹¶ä¸”æ‰“ä¸Štagæ ‡ç­¾å‘å¸ƒä¸€ä¸ªå°ç‰ˆæœ¬

---

#### 1.3 çº¦æŸæ–‡æ¡£å®¡æŸ¥æ¸…å•

- [ ]  é˜…è¯» `prd/02_çº¦æŸä¸åŸåˆ™/CONSTRAINTS_AND_PRINCIPLES.md`
- [ ]  é˜…è¯» `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/TECHNICAL_SOLUTION_v1.0.md`
- [ ]  ç¡®è®¤æ–°åŠŸèƒ½æ˜¯å¦æ¶‰åŠ Coze API è°ƒç”¨
- [ ]  ç¡®è®¤æ–°åŠŸèƒ½æ˜¯å¦ä¼šä¿®æ”¹ç°æœ‰æ¥å£
- [ ]  æ£€æŸ¥æ˜¯å¦å¼•å…¥æ–°çš„å¤–éƒ¨ä¾èµ–

#### 1.3 åŸºçº¿éªŒè¯

```bash
# åœ¨å¼€å§‹å¼€å‘å‰ï¼Œè¿è¡ŒåŸºçº¿æµ‹è¯•ç¡®ä¿å½“å‰ç³»ç»Ÿæ­£å¸¸
./tests/regression_test.sh
# é¢„æœŸ: 12/12 é€šè¿‡ï¼Œå¦åˆ™ä¸å¾—å¼€å§‹æ–°åŠŸèƒ½å¼€å‘
```

#### 1.4 è®¾è®¡å®¡æŸ¥

- [ ]  æ–°åŠŸèƒ½æ˜¯å¦éµå¾ª"å‰ç½®æ£€æŸ¥ + åç½®å¤„ç†"æ¨¡å¼ï¼Ÿ
- [ ]  æ–°åŠŸèƒ½å¤±è´¥æ—¶æ˜¯å¦ä¼šå½±å“æ ¸å¿ƒ AI å¯¹è¯ï¼Ÿï¼ˆå¿…é¡»æ˜¯"å¦"ï¼‰
- [ ]  æ˜¯å¦éœ€è¦æ·»åŠ æ–°çš„çº¦æŸæ¡æ¬¾ï¼Ÿ

### é˜¶æ®µ2: å¼€å‘ä¸­çº¦æŸ

#### 2.1 ä»£ç å®ç°æ£€æŸ¥æ¸…å•

- [ ]  æ–°å¢ä»£ç æ˜¯å¦éµå¾ªç°æœ‰ä»£ç é£æ ¼ï¼Ÿ
- [ ]  æ˜¯å¦æ·»åŠ äº†å……è¶³çš„é”™è¯¯å¤„ç†ï¼Ÿ
- [ ]  æ–°åŠŸèƒ½å¤±è´¥æ—¶æ˜¯å¦ä¼šé˜»å¡æ ¸å¿ƒåŠŸèƒ½ï¼Ÿï¼ˆä¸åº”é˜»å¡ï¼‰
- [ ]  æ˜¯å¦æ·»åŠ äº†ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼Ÿ
- [ ]  æ•æ„Ÿä¿¡æ¯æ˜¯å¦å·²è„±æ•ï¼Ÿ

#### 2.2 æ­£ç¡®çš„æ‰©å±•æ¨¡å¼

```python
# âœ… æ­£ç¡® - å‰ç½®æ£€æŸ¥ï¼Œä¸ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
@app.post("/api/chat")
async def chat(request: ChatRequest):
    # ã€æ–°å¢ã€‘å‰ç½®æ£€æŸ¥
    if session_state.status in [PENDING_MANUAL, MANUAL_LIVE]:
        raise HTTPException(status_code=409, detail="MANUAL_IN_PROGRESS")

    # åŸæœ‰ Coze API è°ƒç”¨é€»è¾‘ï¼ˆå®Œå…¨ä¸åŠ¨ï¼‰
    access_token = token_manager.get_access_token(session_name=session_id)
    # ...
```

#### 2.3 ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯• â­ **å¼ºåˆ¶æ‰§è¡Œ**

**åœ¨å®ŒæˆåŠŸèƒ½å¼€å‘åï¼Œç«‹å³ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼š

1. **åˆ›å»ºæµ‹è¯•è„šæœ¬**
   ```bash
   # å‘½åè§„èŒƒ: tests/test_{åŠŸèƒ½åç§°}.sh æˆ– tests/test_{åŠŸèƒ½åç§°}.py

   # ç¤ºä¾‹ï¼š
   tests/test_admin_apis.sh           # ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•
   tests/test_customer_profile.sh     # å®¢æˆ·ç”»åƒæµ‹è¯•
   tests/test_session_tags.sh         # ä¼šè¯æ ‡ç­¾æµ‹è¯•
   ```

2. **æµ‹è¯•è„šæœ¬è¦æ±‚**
   - âœ… è¦†ç›–æ–°åŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒAPI
   - âœ… åŒ…å«æ­£å¸¸åœºæ™¯æµ‹è¯•ï¼ˆHappy Pathï¼‰
   - âœ… åŒ…å«å¼‚å¸¸åœºæ™¯æµ‹è¯•ï¼ˆé”™è¯¯å¤„ç†ã€è¾¹ç•Œæ¡ä»¶ï¼‰
   - âœ… éªŒè¯è¿”å›æ•°æ®æ ¼å¼ã€å­—æ®µå®Œæ•´æ€§å’ŒçŠ¶æ€ç 
   - âœ… æµ‹è¯•æƒé™æ§åˆ¶ï¼ˆå¦‚é€‚ç”¨ï¼‰
   - âœ… è¾“å‡ºæ¸…æ™°çš„æµ‹è¯•ç»“æœï¼ˆâœ… PASS / âŒ FAILï¼‰
   - âœ… æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æœ‰æ˜ç¡®çš„æè¿°

3. **æµ‹è¯•ç¤ºä¾‹æ¨¡æ¿**
   ```bash
   #!/bin/bash
   # tests/test_example_feature.sh

   BASE_URL="http://localhost:8000"
   PASSED=0
   FAILED=0

   # æµ‹è¯•1: æ­£å¸¸åœºæ™¯
   echo "æµ‹è¯•1: åˆ›å»ºèµ„æº - æ­£å¸¸åœºæ™¯"
   RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BASE_URL/api/resource" \
     -H "Content-Type: application/json" \
     -d '{"name": "test"}')

   HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
   BODY=$(echo "$RESPONSE" | head -n-1)

   if [ "$HTTP_CODE" -eq 200 ]; then
       echo "âœ… PASS - çŠ¶æ€ç æ­£ç¡®"
       ((PASSED++))
   else
       echo "âŒ FAIL - é¢„æœŸ200ï¼Œå®é™…$HTTP_CODE"
       ((FAILED++))
   fi

   # æµ‹è¯•2: å¼‚å¸¸åœºæ™¯
   echo "æµ‹è¯•2: åˆ›å»ºèµ„æº - ç¼ºå°‘å¿…éœ€å­—æ®µ"
   # ... æµ‹è¯•é€»è¾‘

   # è¾“å‡ºæ€»ç»“
   echo "========================================"
   echo "æ€»æµ‹è¯•: $((PASSED + FAILED))"
   echo "é€šè¿‡: $PASSED"
   echo "å¤±è´¥: $FAILED"

   if [ $FAILED -eq 0 ]; then
       exit 0
   else
       exit 1
   fi
   ```

4. **ç‹¬ç«‹éªŒè¯æµ‹è¯•**
   ```bash
   # è¿è¡Œæ–°åŠŸèƒ½æµ‹è¯•è„šæœ¬
   chmod +x tests/test_{åŠŸèƒ½åç§°}.sh
   ./tests/test_{åŠŸèƒ½åç§°}.sh
   # é¢„æœŸ: æ‰€æœ‰æµ‹è¯•é€šè¿‡
   ```

5. **é›†æˆåˆ°å›å½’æµ‹è¯• â­ å…³é”®æ­¥éª¤**

   **å¼ºåˆ¶è¦æ±‚**ï¼šæµ‹è¯•é€šè¿‡åï¼Œå¿…é¡»å°†æ–°åŠŸèƒ½æµ‹è¯•é›†æˆåˆ° `tests/regression_test.sh`

   ```bash
   # ç¼–è¾‘ tests/regression_test.sh
   # åœ¨é€‚å½“ä½ç½®æ·»åŠ æ–°åŠŸèƒ½æµ‹è¯•

   # ç¤ºä¾‹ï¼š
   echo "æµ‹è¯• 15: å®¢æˆ·ç”»åƒåŠŸèƒ½"
   bash tests/test_customer_profile.sh
   if [ $? -eq 0 ]; then
       echo "âœ… å®¢æˆ·ç”»åƒåŠŸèƒ½æµ‹è¯•é€šè¿‡"
       ((passed++))
   else
       echo "âŒ å®¢æˆ·ç”»åƒåŠŸèƒ½æµ‹è¯•å¤±è´¥"
       ((failed++))
   fi
   ((total++))
   ```

6. **æ›´æ–°æµ‹è¯•è®¡æ•°**
   ```bash
   # æ›´æ–°å›å½’æµ‹è¯•è„šæœ¬ä¸­çš„é¢„æœŸæµ‹è¯•æ€»æ•°
   # ä¾‹å¦‚ï¼šä» 12/12 æ›´æ–°ä¸º 13/13
   ```

### é˜¶æ®µ3: å¼€å‘åéªŒè¯

#### 3.1 æ–°åŠŸèƒ½æµ‹è¯• â­ **å¼ºåˆ¶æ‰§è¡Œ**

**éªŒè¯åœ¨é˜¶æ®µ2ç¼–å†™çš„æµ‹è¯•è„šæœ¬æ˜¯å¦å®Œæ•´ä¸”é€šè¿‡**ï¼š

1. **ç‹¬ç«‹è¿è¡Œæ–°åŠŸèƒ½æµ‹è¯•**
   ```bash
   # è¿è¡Œæ–°åŠŸèƒ½æµ‹è¯•è„šæœ¬
   chmod +x tests/test_{åŠŸèƒ½åç§°}.sh
   ./tests/test_{åŠŸèƒ½åç§°}.sh
   # é¢„æœŸ: æ‰€æœ‰æµ‹è¯•é€šè¿‡
   ```

2. **æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡**
   - âœ… æ˜¯å¦è¦†ç›–äº†æ‰€æœ‰æ–°å¢çš„APIç«¯ç‚¹ï¼Ÿ
   - âœ… æ˜¯å¦åŒ…å«æ­£å¸¸åœºæ™¯å’Œå¼‚å¸¸åœºæ™¯ï¼Ÿ
   - âœ… æ˜¯å¦æµ‹è¯•äº†æƒé™æ§åˆ¶ï¼ˆå¦‚é€‚ç”¨ï¼‰ï¼Ÿ
   - âœ… æ˜¯å¦éªŒè¯äº†è¿”å›æ•°æ®æ ¼å¼ï¼Ÿ

3. **é›†æˆåˆ°å›å½’æµ‹è¯• â­ å…³é”®æ­¥éª¤**

   **å¼ºåˆ¶è¦æ±‚**ï¼šæµ‹è¯•é€šè¿‡åï¼Œå¿…é¡»å°†æ–°åŠŸèƒ½æµ‹è¯•é›†æˆåˆ° `tests/regression_test.sh`

   ```bash
   # ç¼–è¾‘ tests/regression_test.sh
   # åœ¨é€‚å½“ä½ç½®æ·»åŠ æ–°åŠŸèƒ½æµ‹è¯•

   # ç¤ºä¾‹ï¼š
   echo "æµ‹è¯• 15: å®¢æˆ·ç”»åƒåŠŸèƒ½"
   bash tests/test_customer_profile.sh
   if [ $? -eq 0 ]; then
       echo "âœ… å®¢æˆ·ç”»åƒåŠŸèƒ½æµ‹è¯•é€šè¿‡"
       ((passed++))
   else
       echo "âŒ å®¢æˆ·ç”»åƒåŠŸèƒ½æµ‹è¯•å¤±è´¥"
       ((failed++))
   fi
   ((total++))
   ```

4. **æ›´æ–°æµ‹è¯•è®¡æ•°**
   ```bash
   # æ›´æ–°å›å½’æµ‹è¯•è„šæœ¬ä¸­çš„é¢„æœŸæµ‹è¯•æ€»æ•°
   # ä¾‹å¦‚ï¼šä» 12/12 æ›´æ–°ä¸º 13/13
   ```

#### 3.2 å›å½’æµ‹è¯•éªŒè¯

```bash
# å¿…é¡»è¿è¡Œå®Œæ•´å›å½’æµ‹è¯•
cd /home/yzh/AIå®¢æœ/é‰´æƒ
./tests/regression_test.sh
# é¢„æœŸ: æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆåŒ…æ‹¬æ–°å¢çš„åŠŸèƒ½æµ‹è¯•ï¼‰
```

**éªŒè¯è¦æ±‚**ï¼š

1. æ ¸å¿ƒå¯¹è¯åŠŸèƒ½ä¸å—å½±å“
2. ä¼šè¯éš”ç¦»æœºåˆ¶å®Œæ•´
3. é”™è¯¯éš”ç¦»ï¼šæ–°åŠŸèƒ½å¼‚å¸¸ä¸å¯¼è‡´æ ¸å¿ƒåŠŸèƒ½å¤±è´¥
4. **æ–°åŠŸèƒ½æµ‹è¯•å·²é›†æˆåˆ°å›å½’æµ‹è¯•ä¸­** â­ å…³é”®è¦æ±‚

#### 3.3 æ–‡æ¡£ä¸ä»£ç æäº¤æ£€æŸ¥

- [ ] æ–°åŠŸèƒ½æµ‹è¯•è„šæœ¬å·²åˆ›å»ºå¹¶éªŒè¯é€šè¿‡ï¼ˆåœ¨é˜¶æ®µ2å®Œæˆï¼‰
- [ ] æµ‹è¯•è„šæœ¬å·²é›†æˆåˆ° `tests/regression_test.sh`
- [ ] å›å½’æµ‹è¯•æ€»æ•°å·²æ›´æ–°
- [ ] å›å½’æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æµ‹è¯•ç»“æœå·²è®°å½•åˆ° `prd/05_éªŒæ”¶ä¸è®°å½•/implementation_notes.md`
- [ ] `prd/04_ä»»åŠ¡æ‹†è§£/{æ¨¡å—åç§°}_tasks.md` çŠ¶æ€å·²æ›´æ–°
- [ ] æ–°å¢çº¦æŸå·²å†™å…¥ `prd/02_çº¦æŸä¸åŸåˆ™/`
- [ ] æ–°å¢APIå·²å†™å…¥ `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/api_contract.md`
- [ ] Git commit å®Œæˆå¹¶å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œcommit message åŒ…å«è¿›åº¦ä¿¡æ¯
- [ ] æäº¤å¹¶æ›´æ–°ä»“åº“çš„mainåˆ†æ”¯ï¼Œå¹¶ä¸”æ‰“ä¸Štagæ ‡ç­¾å‘å¸ƒä¸€ä¸ªå°ç‰ˆæœ¬

---

## âœ… å…è®¸çš„æ‰©å±•æ–¹å‘

ä»¥ä¸‹åŠŸèƒ½**å®Œå…¨è‡ªç”±è®¾è®¡**ï¼Œä¸å— Coze å¹³å°é™åˆ¶ï¼š

### 1. ä¼šè¯çŠ¶æ€ç®¡ç† (`src/session_state.py`)

- å¯è‡ªç”±å®šä¹‰çŠ¶æ€æšä¸¾
- å¯æ·»åŠ ä»»æ„å­—æ®µ
- å¯è‡ªå®šä¹‰æ•°æ®æ¨¡å‹

### 2. ç›‘ç®¡å¼•æ“ (`src/regulator.py`)

- å…³é”®è¯æ£€æµ‹è§„åˆ™
- AI å¤±è´¥è®¡æ•°é€»è¾‘
- è‡ªåŠ¨å‡çº§è§¦å‘æ¡ä»¶

### 3. æ–°å¢ API æ¥å£

- äººå·¥æ¥ç®¡ç›¸å…³æ¥å£
- ç»Ÿè®¡æŸ¥è¯¢æ¥å£
- åå¸­ç®¡ç†æ¥å£

### 4. SSE äº‹ä»¶æ‰©å±•

- å¯æ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹ï¼ˆå¦‚ `type:'manual_message'`ï¼‰
- ä¸å¾—æ›¿æ¢æ ¸å¿ƒ AI å¯¹è¯çš„ SSE æµ

---

## é¡¹ç›®ç»“æ„

```
/home/yzh/AIå®¢æœ/é‰´æƒ/
â”œâ”€â”€ backend.py              # åç«¯ä¸»æœåŠ¡
â”œâ”€â”€ src/                    # åç«¯æ¨¡å—
â”‚   â”œâ”€â”€ session_state.py    # ä¼šè¯çŠ¶æ€æœº
â”‚   â”œâ”€â”€ regulator.py        # ç›‘ç®¡å¼•æ“
â”‚   â”œâ”€â”€ shift_config.py     # å·¥ä½œæ—¶é—´é…ç½®
â”‚   â”œâ”€â”€ email_service.py    # é‚®ä»¶æœåŠ¡
â”‚   â””â”€â”€ oauth_token_manager.py  # Tokenç®¡ç†
â”œâ”€â”€ frontend/               # ç”¨æˆ·ç«¯ Vue é¡¹ç›®
â”œâ”€â”€ agent-workbench/        # åå¸­å·¥ä½œå° Vue é¡¹ç›®
â”œâ”€â”€ prd/                    # PRD æ–‡æ¡£
â”‚   â””â”€â”€ INDEX.md            # æ–‡æ¡£ç´¢å¼•
â””â”€â”€ tests/                  # æµ‹è¯•è„šæœ¬
    â””â”€â”€ regression_test.sh  # å›å½’æµ‹è¯•
```

---

## å¸¸ç”¨å‘½ä»¤

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åç«¯
python3 backend.py
# è®¿é—®: http://localhost:8000
# APIæ–‡æ¡£: http://localhost:8000/docs

# å¯åŠ¨ç”¨æˆ·ç«¯
cd frontend && npm run dev
# è®¿é—®: http://localhost:5173 (æœ¬åœ°)
# è®¿é—®: http://192.168.x.x:5173 (å±€åŸŸç½‘)

# å¯åŠ¨åå¸­å·¥ä½œå°
cd agent-workbench && npm run dev
# è®¿é—®: http://localhost:5174 (æœ¬åœ°ï¼Œå¿…é¡»æ˜¯5174ç«¯å£)
# è®¿é—®: http://192.168.x.x:5174 (å±€åŸŸç½‘)
# é»˜è®¤è´¦å·: admin/admin123, agent001/agent123
```

### ç«¯å£ç®¡ç†è§„èŒƒ â­ **å¼ºåˆ¶éµå®ˆ**

**æ ‡å‡†ç«¯å£é…ç½®**ï¼ˆä¸å¾—éšæ„æ›´æ”¹ï¼‰ï¼š

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| åç«¯ API | 8000 | FastAPI åç«¯æœåŠ¡ |
| ç”¨æˆ·ç«¯ | 5173 | å®¢æˆ·èŠå¤©ç•Œé¢ |
| åå¸­å·¥ä½œå° | 5174 | åå¸­ç®¡ç†ç³»ç»Ÿï¼ˆå¿…é¡»ï¼‰ |

**å¯åŠ¨å‰æ£€æŸ¥**ï¼š

```bash
# æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ
lsof -i :5174

# å¦‚æœç«¯å£è¢«å ç”¨ï¼Œæ¸…é™¤æ—§è¿›ç¨‹
pkill -f "agent-workbench.*vite"

# ç­‰å¾…è¿›ç¨‹é€€å‡º
sleep 2

# ç¡®è®¤ç«¯å£å·²é‡Šæ”¾
lsof -i :5174 || echo "âœ… ç«¯å£ 5174 å·²é‡Šæ”¾"

# é‡æ–°å¯åŠ¨å‰ç«¯
cd agent-workbench && npm run dev
```

**å¼ºåˆ¶è¦æ±‚**ï¼š
- âœ… åå¸­å·¥ä½œå°å¿…é¡»è¿è¡Œåœ¨ 5174 ç«¯å£
- âœ… å¦‚æœç«¯å£è¢«å ç”¨ï¼Œå¿…é¡»å…ˆæ¸…é™¤æ—§è¿›ç¨‹
- âŒ ç¦æ­¢è®© Vite è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–ç«¯å£ï¼ˆ5175ã€5176ç­‰ï¼‰
- âŒ ç¦æ­¢ä¿®æ”¹ claude.md ä¸­çš„æ ‡å‡†ç«¯å£é…ç½®

### å®Œæ•´æœåŠ¡è®¿é—®åœ°å€


| æœåŠ¡       | æœ¬åœ°åœ°å€                   | å±€åŸŸç½‘åœ°å€                   | è¯´æ˜         |
| ---------- | -------------------------- | ---------------------------- | ------------ |
| åç«¯API    | http://localhost:8000      | http://192.168.x.x:8000      | FastAPIåç«¯  |
| APIæ–‡æ¡£    | http://localhost:8000/docs | http://192.168.x.x:8000/docs | Swagger UI   |
| ç”¨æˆ·ç«¯     | http://localhost:5173      | http://192.168.x.x:5173      | Vueå‰ç«¯      |
| åå¸­å·¥ä½œå° | http://localhost:5174      | http://192.168.x.x:5174      | åå¸­ç®¡ç†ç³»ç»Ÿ |

### â­ å‰ç«¯ API åœ°å€é…ç½®è§„èŒƒï¼ˆå¼ºåˆ¶éµå®ˆï¼‰

**æ‰€æœ‰å‰ç«¯é¡¹ç›®ä¸­çš„ API è°ƒç”¨å¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ï¼Œç¦æ­¢ç¡¬ç¼–ç åœ°å€ï¼**

#### æ­£ç¡®åšæ³• âœ…

```javascript
// åœ¨ç»„ä»¶é¡¶éƒ¨å£°æ˜ API_BASEï¼ˆç´§éš import ä¹‹åï¼‰
const API_BASE = import.meta.env.VITE_API_BASE || 'http://localhost:8000'

// ä½¿ç”¨ API_BASE è°ƒç”¨æ¥å£
const response = await fetch(`${API_BASE}/api/quick-replies`, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
```

#### é”™è¯¯åšæ³• âŒ

```javascript
// âŒ é”™è¯¯ - ç¡¬ç¼–ç åœ°å€
const response = await fetch('http://localhost:8000/api/quick-replies', ...)

// âŒ é”™è¯¯ - ç›´æ¥ä½¿ç”¨ localhost
const response = await fetch(`http://localhost:8000/api/${endpoint}`, ...)
```

#### ç¯å¢ƒå˜é‡é…ç½®

åœ¨å‰ç«¯é¡¹ç›®çš„ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```bash
# agent-workbench/.env
VITE_API_BASE=http://localhost:8000

# frontend/.env
VITE_API_BASE=http://localhost:8000
```

**æ³¨æ„**ï¼š
- ä½¿ç”¨ Vite çš„ç¯å¢ƒå˜é‡å¿…é¡»ä»¥ `VITE_` å¼€å¤´
- æ‰€æœ‰ API è°ƒç”¨å¿…é¡»ä½¿ç”¨ `${API_BASE}` æ‹¼æ¥è·¯å¾„
- ç¦æ­¢åœ¨ä»»ä½•åœ°æ–¹ç¡¬ç¼–ç  `http://localhost:8000`
- å‚è€ƒ `Dashboard.vue` çš„å®ç°æ¨¡å¼

### æµ‹è¯•å‘½ä»¤

```bash
# å›å½’æµ‹è¯•
./tests/regression_test.sh

# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/health

# ä¼šè¯ç»Ÿè®¡
curl http://localhost:8000/api/sessions/stats
```

---

## ç¯å¢ƒå˜é‡ (.env)

å…³é”®é…ç½®ï¼š

- `COZE_WORKFLOW_ID` - å·¥ä½œæµID
- `COZE_APP_ID` - åº”ç”¨ID
- `COZE_OAUTH_CLIENT_ID` - OAuthå®¢æˆ·ç«¯ID
- `REGULATOR_KEYWORDS` - äººå·¥æ¥ç®¡è§¦å‘å…³é”®è¯
- `REGULATOR_FAIL_THRESHOLD` - AIè¿ç»­å¤±è´¥é˜ˆå€¼
- `JWT_SECRET_KEY` - JWTå¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼‰ â­ v3.1+

---

## ğŸ” åå¸­è®¤è¯ä¸æƒé™çº¦æŸ â­ **å¼ºåˆ¶éµå®ˆ** (v3.1+)

### æ ¸å¿ƒçº¦æŸ

#### çº¦æŸ19: å­—æ®µçº§è®¿é—®æ§åˆ¶ â­ **æ–°å¢ v3.1.3**

**å¼ºåˆ¶è¦æ±‚**ï¼š

1. **åå¸­åªèƒ½ä¿®æ”¹è‡ªå·±çš„ name å’Œ avatar_url**

```python
# âœ… æ­£ç¡® - åªå…è®¸ä¿®æ”¹éæ•æ„Ÿå­—æ®µ
@app.put("/api/agent/profile")
async def update_profile(
    request: UpdateProfileRequest,  # åªåŒ…å« name å’Œ avatar_url
    agent: Dict = Depends(require_agent)
):
    # åªæ›´æ–°å…è®¸çš„å­—æ®µ
    if request.name is not None:
        current_agent.name = request.name
    if request.avatar_url is not None:
        current_agent.avatar_url = request.avatar_url

# âŒ é”™è¯¯ - å…è®¸ä¿®æ”¹æ•æ„Ÿå­—æ®µ
request_data = request.dict()
for key, value in request_data.items():
    setattr(current_agent, key, value)  # å¯èƒ½ä¿®æ”¹ role, max_sessions ç­‰
```

**ç¦æ­¢ä¿®æ”¹çš„å­—æ®µ**ï¼š

- `role` - è§’è‰²ï¼ˆadmin/agentï¼‰
- `username` - ç”¨æˆ·å
- `max_sessions` - æœ€å¤§ä¼šè¯æ•°
- `status` - åå¸­çŠ¶æ€
- `created_at` - åˆ›å»ºæ—¶é—´
- `last_login` - æœ€åç™»å½•æ—¶é—´
- `password_hash` - å¯†ç å“ˆå¸Œ

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š

- å…è®¸ä¿®æ”¹ï¼š`name` (1-50å­—ç¬¦), `avatar_url` (URLå­—ç¬¦ä¸²)
- è‡³å°‘éœ€è¦æä¾›ä¸€ä¸ªå­—æ®µ
- è¿”å› 400 å¦‚æœè¯·æ±‚ä½“ä¸ºç©º

#### çº¦æŸ20: å¯†ç ä¿®æ”¹å®‰å…¨æ€§ â­ **æ–°å¢ v3.1.2**

**å¼ºåˆ¶è¦æ±‚**ï¼š

1. **ä¸‰é‡éªŒè¯æœºåˆ¶**

```python
# âœ… æ­£ç¡® - å®Œæ•´çš„å¯†ç ä¿®æ”¹æµç¨‹
@app.post("/api/agent/change-password")
async def change_password(request: ChangePasswordRequest, agent: Dict = Depends(require_agent)):
    # éªŒè¯1: æ—§å¯†ç æ­£ç¡®æ€§
    if not PasswordHasher.verify_password(request.old_password, current_agent.password_hash):
        raise HTTPException(400, "OLD_PASSWORD_INCORRECT: æ—§å¯†ç ä¸æ­£ç¡®")

    # éªŒè¯2: æ–°å¯†ç å¼ºåº¦ï¼ˆè‡³å°‘8å­—ç¬¦ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰
    if not validate_password(request.new_password):
        raise HTTPException(400, "INVALID_PASSWORD: å¯†ç å¿…é¡»è‡³å°‘8ä¸ªå­—ç¬¦ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—")

    # éªŒè¯3: æ–°æ—§å¯†ç ä¸èƒ½ç›¸åŒ
    if PasswordHasher.verify_password(request.new_password, current_agent.password_hash):
        raise HTTPException(400, "PASSWORD_SAME: æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ")

# âŒ é”™è¯¯ - ç¼ºå°‘éªŒè¯
current_agent.password_hash = PasswordHasher.hash_password(request.new_password)  # ä¸éªŒè¯æ—§å¯†ç ï¼
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š

- æœ€å°å¯†ç é•¿åº¦ï¼š8 å­—ç¬¦
- å¿…é¡»åŒ…å«ï¼šå­—æ¯ + æ•°å­—
- ç¦æ­¢ï¼šæ–°æ—§å¯†ç ç›¸åŒ
- Tokenæœ‰æ•ˆæ€§ï¼šä¿®æ”¹å¯†ç åæ—§Tokenä»æœ‰æ•ˆï¼ˆç›´åˆ°è¿‡æœŸï¼‰

#### çº¦æŸ21: JWT æƒé™åˆ†çº§

**å¼ºåˆ¶è¦æ±‚**ï¼š

1. **ä¸‰çº§æƒé™æ¨¡å‹**

```python
# âœ… æ­£ç¡® - ä½¿ç”¨æƒé™ä¸­é—´ä»¶
@app.get("/api/agents")  # ç®¡ç†å‘˜åŠŸèƒ½
async def get_agents(admin: Dict = Depends(require_admin)):
    pass

@app.post("/api/agent/change-password")  # ä»»ä½•ç™»å½•ç”¨æˆ·
async def change_password(agent: Dict = Depends(require_agent)):
    pass

# ç”¨æˆ·ç«¯ API æ— éœ€è®¤è¯
@app.post("/api/chat")
async def chat(request: ChatRequest):
    pass

# âŒ é”™è¯¯ - æ··ç”¨æƒé™
@app.get("/api/agents")
async def get_agents(agent: Dict = Depends(require_agent)):  # åº”è¯¥ç”¨ require_admin!
    pass
```

**æƒé™çº§åˆ«**ï¼š


| æƒé™              | é€‚ç”¨å¯¹è±¡     | å…¸å‹API                             |
| ----------------- | ------------ | ----------------------------------- |
| `æ— éœ€è®¤è¯`        | ç”¨æˆ·ç«¯å‰ç«¯   | `/api/chat`, `/api/manual/escalate` |
| `require_agent()` | ä»»ä½•ç™»å½•åå¸­ | ä¿®æ”¹å¯†ç ã€ä¿®æ”¹èµ„æ–™ã€ä¼šè¯æŸ¥è¯¢        |
| `require_admin()` | ç®¡ç†å‘˜       | åå¸­CRUDã€å¯†ç é‡ç½®ã€æƒé™ç®¡ç†        |

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š

- Tokenè¿‡æœŸæ—¶é—´ï¼š1å°æ—¶ï¼ˆAccess Tokenï¼‰
- Refresh Tokenï¼š7å¤©
- 401 é”™è¯¯ï¼šTokenæ— æ•ˆæˆ–è¿‡æœŸ
- 403 é”™è¯¯ï¼šæƒé™ä¸è¶³ï¼ˆå¦‚æ™®é€šåå¸­è®¿é—®ç®¡ç†å‘˜APIï¼‰

---

## âŒ ç¦æ­¢äº‹é¡¹

1. **ä¸è¦ä¿®æ”¹** `.env` ä¸­çš„ Coze å‡­è¯
2. **ä¸è¦åˆ é™¤** ä»»ä½•ç°æœ‰çš„ API ç«¯ç‚¹
3. **ä¸è¦ä¿®æ”¹** Coze API çš„è°ƒç”¨æ–¹å¼å’Œè¿”å›è§£æ
4. **ä¸è¦ç»•è¿‡** token_manager ç›´æ¥ç”Ÿæˆ Token
5. **ä¸è¦ä½¿ç”¨** WebSocket æ›¿æ¢ SSE æµå¼å“åº”
6. **ä¸è¦è·³è¿‡** å›å½’æµ‹è¯•å°±æäº¤ä»£ç 
7. **ä¸è¦åœ¨** äººå·¥æ¥ç®¡æœŸé—´å…è®¸ AI å¯¹è¯
8. **ä¸è¦å…è®¸** åå¸­ä¿®æ”¹è‡ªå·±çš„ roleã€usernameã€max_sessions ç­‰æ•æ„Ÿå­—æ®µ â­ v3.1.3
9. **ä¸è¦è·³è¿‡** æ—§å¯†ç éªŒè¯ç›´æ¥ä¿®æ”¹å¯†ç  â­ v3.1.2
10. **ä¸è¦æ··ç”¨** JWT æƒé™çº§åˆ«ï¼ˆå¦‚ç”¨ require_agent ä¿æŠ¤ç®¡ç†å‘˜ APIï¼‰â­ v3.1

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

å®Œæ•´æ–‡æ¡£ç»“æ„è§ `prd/INDEX.md`

```
prd/
â”œâ”€â”€ 01_å…¨å±€æŒ‡å¯¼/     # ç³»ç»Ÿéœ€æ±‚å’ŒæŒ‡å¯¼
â”œâ”€â”€ 02_çº¦æŸä¸åŸåˆ™/   # æŠ€æœ¯çº¦æŸï¼ˆæœ€é‡è¦)
â”œâ”€â”€ 03_æŠ€æœ¯æ–¹æ¡ˆ/     # æ¶æ„å’ŒAPI
â”œâ”€â”€ 04_ä»»åŠ¡æ‹†è§£/     # å¼€å‘ä»»åŠ¡
â””â”€â”€ 05_éªŒæ”¶ä¸è®°å½•/   # æµ‹è¯•å’ŒéªŒæ”¶
```

---

## ğŸ¢ ä¼ä¸šç”Ÿäº§ç¯å¢ƒè¦æ±‚ â­ **å¼ºåˆ¶éµå®ˆ**

### æ ¸å¿ƒåŸåˆ™

åœ¨æ‰€æœ‰åç»­å¼€å‘ä¸­ï¼Œ**å¿…é¡»å……åˆ†è€ƒè™‘ä¼ä¸šå®é™…ä½¿ç”¨å’Œç”Ÿäº§ç¯å¢ƒä¸‹çš„åˆç†å¹¶å‘æ€§å’Œå®æ—¶æ€§**ã€‚

---

### 1. å¹¶å‘æ€§è¦æ±‚ (Concurrency)

#### 1.1 è¿æ¥æ± ç®¡ç†

**å¼ºåˆ¶è¦æ±‚**ï¼š

```python
# âœ… æ­£ç¡® - ä½¿ç”¨è¿æ¥æ± é™åˆ¶å¹¶å‘è¿æ¥æ•°
redis_pool = redis.ConnectionPool(
    host='localhost',
    port=6379,
    max_connections=50,          # æœ€å¤§è¿æ¥æ•°
    socket_timeout=5.0,          # è¶…æ—¶è®¾ç½®
    socket_connect_timeout=5.0,
    socket_keepalive=True
)

# âŒ é”™è¯¯ - æ— é™åˆ¶åˆ›å»ºè¿æ¥
for i in range(1000):
    redis_client = redis.Redis(host='localhost')  # å¯èƒ½è€—å°½è¿æ¥æ•°
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š

- Redis è¿æ¥æ± ï¼š50 è¿æ¥ï¼ˆæ”¯æŒ 100+ å¹¶å‘ç”¨æˆ·ï¼‰
- HTTP å®¢æˆ·ç«¯è¿æ¥æ± ï¼š100 è¿æ¥
- æ•°æ®åº“è¿æ¥æ± ï¼š20-50 è¿æ¥

#### 1.2 è¯·æ±‚é€Ÿç‡é™åˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼š

```python
# âœ… æ­£ç¡® - å®ç°é€Ÿç‡é™åˆ¶
from fastapi_limiter import FastAPILimiter
from fastapi_limiter.depends import RateLimiter

@app.post("/api/chat")
@limiter.limit("20/minute")  # æ¯åˆ†é’Ÿæœ€å¤š20æ¬¡è¯·æ±‚
async def chat(request: ChatRequest):
    pass

# âŒ é”™è¯¯ - æ— é€Ÿç‡é™åˆ¶ï¼Œå¯èƒ½è¢«æ¶æ„æ”»å‡»
@app.post("/api/chat")
async def chat(request: ChatRequest):
    pass  # ä»»æ„é¢‘ç‡è°ƒç”¨
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š

- æ™®é€šç”¨æˆ·ï¼š20 è¯·æ±‚/åˆ†é’Ÿ
- VIP ç”¨æˆ·ï¼š100 è¯·æ±‚/åˆ†é’Ÿ
- åå¸­è´¦å·ï¼šæ— é™åˆ¶ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰

#### 1.3 å¹¶å‘ SSE è¿æ¥ç®¡ç†

**å¼ºåˆ¶è¦æ±‚**ï¼š

```python
# âœ… æ­£ç¡® - é™åˆ¶æ¯ä¸ªç”¨æˆ·çš„ SSE è¿æ¥æ•°
MAX_SSE_PER_USER = 3  # æ¯ä¸ªç”¨æˆ·æœ€å¤š3ä¸ªå¹¶å‘ SSE è¿æ¥

sse_connections: dict[str, int] = {}  # {session_id: connection_count}

@app.post("/api/chat/stream")
async def chat_stream(request: ChatRequest):
    session_id = request.user_id

    # æ£€æŸ¥å¹¶å‘è¿æ¥æ•°
    if sse_connections.get(session_id, 0) >= MAX_SSE_PER_USER:
        raise HTTPException(429, "Too many concurrent connections")

    sse_connections[session_id] = sse_connections.get(session_id, 0) + 1
    try:
        # SSE æµå¼å“åº”
        yield ...
    finally:
        sse_connections[session_id] -= 1

# âŒ é”™è¯¯ - æ— é™åˆ¶ SSE è¿æ¥ï¼Œå¯èƒ½å¯¼è‡´èµ„æºè€—å°½
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š

- æ¯ä¸ªç”¨æˆ·æœ€å¤š 3 ä¸ªå¹¶å‘ SSE è¿æ¥
- å…¨å±€æœ€å¤§ SSE è¿æ¥æ•°ï¼š1000ï¼ˆæ ¹æ®æœåŠ¡å™¨èµ„æºè°ƒæ•´ï¼‰
- è¶…æ—¶è‡ªåŠ¨æ–­å¼€ï¼š5 åˆ†é’Ÿæ— æ´»åŠ¨

#### 1.4 æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦é™åˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼š

```python
# âœ… æ­£ç¡® - é™åˆ¶é˜Ÿåˆ—é•¿åº¦
if session_id not in sse_queues:
    sse_queues[session_id] = asyncio.Queue(maxsize=100)  # æœ€å¤š100æ¡æ¶ˆæ¯

try:
    sse_queues[session_id].put_nowait(message)
except asyncio.QueueFull:
    logger.warning(f"SSE é˜Ÿåˆ—å·²æ»¡: {session_id}")
    # ä¸¢å¼ƒæœ€æ—§çš„æ¶ˆæ¯
    sse_queues[session_id].get_nowait()
    sse_queues[session_id].put_nowait(message)

# âŒ é”™è¯¯ - æ— é™åˆ¶é˜Ÿåˆ—ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
sse_queues[session_id] = asyncio.Queue()  # æ— é™å¤§å°
```

---

### 2. å®æ—¶æ€§è¦æ±‚ (Real-Time Performance)

#### 2.1 SSE ä¼˜äºè½®è¯¢

**å¼ºåˆ¶è¦æ±‚**ï¼šæ‰€æœ‰å®æ—¶æ›´æ–°å¿…é¡»ä½¿ç”¨ SSEï¼Œç¦æ­¢ä½¿ç”¨çŸ­è½®è¯¢

```typescript
// âœ… æ­£ç¡® - ä½¿ç”¨ SSE å®æ—¶æ¨é€
const eventSource = new EventSource(`/api/chat/stream`)
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data)
  // å®æ—¶æ›´æ–° UI
}

// âŒ é”™è¯¯ - ä½¿ç”¨è½®è¯¢ï¼Œå»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹
setInterval(async () => {
  const response = await fetch('/api/sessions/stats')
  // æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡
}, 5000)
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

- SSE æ¨é€å»¶è¿Ÿï¼š< 100ms
- 5ç§’è½®è¯¢å»¶è¿Ÿï¼šå¹³å‡ 2.5ç§’
- èµ„æºæ¶ˆè€—ï¼šSSE èŠ‚çœ 80% ç½‘ç»œè¯·æ±‚

#### 2.2 æ¶ˆæ¯æ¨é€å»¶è¿Ÿè¦æ±‚

**å¼ºåˆ¶è¦æ±‚**ï¼š

```python
# âœ… æ­£ç¡® - ç«‹å³æ¨é€æ¶ˆæ¯ï¼Œä¸ç¼“å†²
@app.post("/api/manual/messages")
async def manual_message(request: dict):
    session_name = request.get("session_name")

    # ä¿å­˜æ¶ˆæ¯åˆ°å­˜å‚¨
    await session_store.save(session_state)

    # ã€å…³é”®ã€‘ç«‹å³æ¨é€åˆ° SSE é˜Ÿåˆ—ï¼Œä¸ç­‰å¾…æ‰¹å¤„ç†
    if session_name in sse_queues:
        await sse_queues[session_name].put({
            "type": "manual_message",
            "content": request.get("content"),
            "timestamp": time.time()
        })
        # ç›®æ ‡å»¶è¿Ÿ: < 50ms

# âŒ é”™è¯¯ - æ‰¹é‡æ¨é€ï¼Œå»¶è¿Ÿé«˜
messages_buffer = []
async def flush_messages():
    while True:
        await asyncio.sleep(1)  # æ¯ç§’æ‰¹é‡æ¨é€ä¸€æ¬¡
        for msg in messages_buffer:
            await push_sse(msg)
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š

- äººå·¥æ¶ˆæ¯æ¨é€å»¶è¿Ÿï¼š< 100msï¼ˆä»å‘é€åˆ°ç”¨æˆ·æ”¶åˆ°ï¼‰
- çŠ¶æ€å˜åŒ–é€šçŸ¥å»¶è¿Ÿï¼š< 50ms
- AI å“åº”æµå¼æ¨é€ï¼šå®æ—¶é€å­—æ˜¾ç¤ºï¼Œ< 50ms é¦–å­—å»¶è¿Ÿ

#### 2.3 å‰ç«¯å“åº”æ€§èƒ½

**å¼ºåˆ¶è¦æ±‚**ï¼š

```typescript
// âœ… æ­£ç¡® - ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§é‡æ¶ˆæ¯
import { VirtualList } from 'vue-virtual-scroller'

// è¶…è¿‡100æ¡æ¶ˆæ¯æ—¶å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
<VirtualList
  :items="messages"
  :item-height="80"
  v-if="messages.length > 100"
>
  <template v-slot="{ item }">
    <ChatMessage :message="item" />
  </template>
</VirtualList>

// âŒ é”™è¯¯ - ç›´æ¥æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯ï¼Œå¡é¡¿
<div v-for="msg in messages" :key="msg.id">
  <ChatMessage :message="msg" />
</div>  <!-- 1000æ¡æ¶ˆæ¯ä¼šå¯¼è‡´ä¸¥é‡å¡é¡¿ -->
```

**æ€§èƒ½ç›®æ ‡**ï¼š

- æ¶ˆæ¯åˆ—è¡¨æ»šåŠ¨å¸§ç‡ï¼š60 FPS
- æ–°æ¶ˆæ¯è¿½åŠ å»¶è¿Ÿï¼š< 16msï¼ˆä¸€å¸§ï¼‰
- æ”¯æŒæ¶ˆæ¯æ•°ï¼š10,000+ æ¡ä¸å¡é¡¿

#### 2.4 Coze API è¶…æ—¶è®¾ç½®

**å¼ºåˆ¶è¦æ±‚**ï¼š

```python
# âœ… æ­£ç¡® - è®¾ç½®åˆç†çš„è¶…æ—¶
HTTP_TIMEOUT = httpx.Timeout(
    connect=5.0,   # è¿æ¥è¶…æ—¶ 5ç§’
    read=30.0,     # è¯»å–è¶…æ—¶ 30ç§’ï¼ˆCoze AI å“åº”å¯èƒ½è¾ƒæ…¢ï¼‰
    write=10.0,    # å†™å…¥è¶…æ—¶ 10ç§’
    pool=10.0      # è¿æ¥æ± è¶…æ—¶ 10ç§’
)

http_client = httpx.Client(timeout=HTTP_TIMEOUT)

# âŒ é”™è¯¯ - æ— è¶…æ—¶é™åˆ¶ï¼Œå¯èƒ½æ°¸ä¹…é˜»å¡
http_client = httpx.Client()  # é»˜è®¤æ— è¶…æ—¶
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š

- Coze API è¿æ¥è¶…æ—¶ï¼š5ç§’
- Coze API è¯»å–è¶…æ—¶ï¼š30ç§’ï¼ˆAI ç”Ÿæˆéœ€è¦æ—¶é—´ï¼‰
- å†…éƒ¨ API è¶…æ—¶ï¼š10ç§’
- SSE ä¿æ´»é—´éš”ï¼š30ç§’å‘é€å¿ƒè·³

---

### 3. èµ„æºé™åˆ¶ä¸ç›‘æ§

#### 3.1 å†…å­˜é™åˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼š

```python
# âœ… æ­£ç¡® - Redis å†…å­˜é™åˆ¶
# redis.conf
maxmemory 512mb
maxmemory-policy allkeys-lru  # å†…å­˜æ»¡æ—¶åˆ é™¤æœ€å°‘ä½¿ç”¨çš„ key

# âœ… æ­£ç¡® - ä¼šè¯æ•°æ® TTL
REDIS_SESSION_TTL = 86400  # 24 å°æ—¶è‡ªåŠ¨è¿‡æœŸ

# âŒ é”™è¯¯ - æ— é™åˆ¶å­˜å‚¨
redis.set(key, value)  # æ°¸ä¹…ä¿ç•™ï¼Œæœ€ç»ˆè€—å°½å†…å­˜
```

#### 3.2 æ€§èƒ½ç›‘æ§

**å¼ºåˆ¶è¦æ±‚**ï¼š

```python
# âœ… æ­£ç¡® - è®°å½•æ…¢è¯·æ±‚
@app.middleware("http")
async def log_slow_requests(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    duration = time.time() - start_time

    if duration > 1.0:  # è¶…è¿‡1ç§’å‘Šè­¦
        logger.warning(
            f"æ…¢è¯·æ±‚: {request.method} {request.url.path} "
            f"è€—æ—¶ {duration:.2f}s"
        )

    return response
```

**ç›‘æ§æŒ‡æ ‡**ï¼š

- API å“åº”æ—¶é—´ï¼šP50 < 200ms, P99 < 1s
- SSE è¿æ¥æ•°ï¼šå®æ—¶ç›‘æ§
- Redis å†…å­˜ä½¿ç”¨ç‡ï¼š< 80%
- CPU ä½¿ç”¨ç‡ï¼š< 70%ï¼ˆç•™æœ‰ä½™é‡ï¼‰

---

### 4. ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•

**æ¯æ¬¡éƒ¨ç½²å‰å¿…é¡»éªŒè¯**ï¼š

#### 4.1 å¹¶å‘æ€§æ£€æŸ¥

- [ ]  Redis è¿æ¥æ± å¤§å°æ˜¯å¦é…ç½®ï¼Ÿï¼ˆå»ºè®® 50ï¼‰
- [ ]  HTTP å®¢æˆ·ç«¯æ˜¯å¦ä½¿ç”¨è¿æ¥æ± ï¼Ÿ
- [ ]  SSE è¿æ¥æ•°æ˜¯å¦æœ‰é™åˆ¶ï¼Ÿï¼ˆå»ºè®®æ¯ç”¨æˆ· 3 ä¸ªï¼‰
- [ ]  æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦æœ‰é•¿åº¦é™åˆ¶ï¼Ÿï¼ˆå»ºè®® 100ï¼‰
- [ ]  æ˜¯å¦å®ç°äº†é€Ÿç‡é™åˆ¶ï¼Ÿ

#### 4.2 å®æ—¶æ€§æ£€æŸ¥

- [ ]  æ˜¯å¦ä½¿ç”¨ SSE æ›¿ä»£è½®è¯¢ï¼Ÿ
- [ ]  æ¶ˆæ¯æ¨é€æ˜¯å¦ç«‹å³æ‰§è¡Œï¼ˆä¸æ‰¹å¤„ç†ï¼‰ï¼Ÿ
- [ ]  è¶…æ—¶é…ç½®æ˜¯å¦åˆç†ï¼Ÿï¼ˆè¿æ¥ 5sï¼Œè¯»å– 30sï¼‰
- [ ]  å‰ç«¯æ˜¯å¦ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼Ÿï¼ˆ> 100 æ¡æ¶ˆæ¯ï¼‰
- [ ]  æ˜¯å¦æœ‰æ€§èƒ½ç›‘æ§ï¼Ÿ

#### 4.3 å‹åŠ›æµ‹è¯•

```bash
# 1. å¹¶å‘ç”¨æˆ·æµ‹è¯• - 100 ä¸ªå¹¶å‘ç”¨æˆ·
ab -n 1000 -c 100 http://localhost:8000/api/health

# 2. SSE è¿æ¥æµ‹è¯• - 50 ä¸ªå¹¶å‘ SSE è¿æ¥
for i in {1..50}; do
  curl -N http://localhost:8000/api/chat/stream &
done

# 3. ç›‘æ§èµ„æºä½¿ç”¨
watch -n 1 'redis-cli INFO memory | grep used_memory_human'
```

**é€šè¿‡æ ‡å‡†**ï¼š

- 100 å¹¶å‘ç”¨æˆ·ï¼šå¹³å‡å“åº”æ—¶é—´ < 500ms
- 50 å¹¶å‘ SSEï¼šæ— è¿æ¥æ‹’ç»
- Redis å†…å­˜ï¼š< 80% ä½¿ç”¨ç‡
- æ— é”™è¯¯æ—¥å¿—

---

### 5. å…¸å‹åœºæ™¯æ€§èƒ½è¦æ±‚


| åœºæ™¯             | å¹¶å‘è¦æ±‚               | å®æ—¶æ€§è¦æ±‚           |
| ---------------- | ---------------------- | -------------------- |
| **ç”¨æˆ·å‘é€æ¶ˆæ¯** | æ”¯æŒ 100+ å¹¶å‘         | AI å“åº”å»¶è¿Ÿ < 2s     |
| **åå¸­æ¥å…¥ä¼šè¯** | æ”¯æŒ 10 ä¸ªåå¸­åŒæ—¶æ“ä½œ | çŠ¶æ€å˜åŒ–é€šçŸ¥ < 50ms  |
| **äººå·¥æ¶ˆæ¯æ¨é€** | æ”¯æŒ 50+ å¹¶å‘ä¼šè¯      | æ¶ˆæ¯æ¨é€å»¶è¿Ÿ < 100ms |
| **ä¼šè¯åˆ—è¡¨åˆ·æ–°** | æ”¯æŒ 10 ä¸ªåå¸­åŒæ—¶æŸ¥è¯¢ | ä½¿ç”¨ SSE è‡ªåŠ¨æ›´æ–°    |
| **å†å²æ¶ˆæ¯åŠ è½½** | æ”¯æŒ 1000+ æ¡æ¶ˆæ¯      | é¦–å±æ¸²æŸ“ < 500ms     |

---

### 6. è¿è§„åæœ

**ä¸éµå®ˆå¹¶å‘æ€§å’Œå®æ—¶æ€§è¦æ±‚å°†å¯¼è‡´**ï¼š

ğŸ”´ **å¹¶å‘æ€§é—®é¢˜**ï¼š

- è¿æ¥æ± è€—å°½ â†’ æœåŠ¡ä¸å¯ç”¨
- æ— é€Ÿç‡é™åˆ¶ â†’ è¢« DDoS æ”»å‡»
- å†…å­˜æº¢å‡º â†’ ç³»ç»Ÿå´©æºƒ

ğŸ”´ **å®æ—¶æ€§é—®é¢˜**ï¼š

- ä½¿ç”¨è½®è¯¢ â†’ å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹
- æ— è¶…æ—¶è®¾ç½® â†’ è¯·æ±‚æ°¸ä¹…é˜»å¡
- æ¶ˆæ¯æ‰¹å¤„ç† â†’ ç”¨æˆ·ä½“éªŒå·®

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-27
**æ–‡æ¡£ç‰ˆæœ¬**: v1.4 â­ å°†è‡ªåŠ¨åŒ–æµ‹è¯•çº³å…¥å¼€å‘æµç¨‹ï¼ˆé˜¶æ®µ2ï¼‰ï¼Œå¼ºåˆ¶è¦æ±‚æµ‹è¯•é›†æˆåˆ°å›å½’æµ‹è¯•
