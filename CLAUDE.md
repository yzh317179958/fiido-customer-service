# Fiido æ™ºèƒ½å®¢æœç³»ç»Ÿ - Claude å¼€å‘æŒ‡ä»¤

## é¡¹ç›®æ¦‚è¿°
è¿™æ˜¯ä¸€ä¸ªåŸºäº Coze API çš„æ™ºèƒ½å®¢æœç³»ç»Ÿï¼ŒåŒ…å«ç”¨æˆ·ç«¯ã€åå¸­å·¥ä½œå°å’Œåç«¯æœåŠ¡ã€‚

---

## ğŸ”´ å¿…è¯»æ–‡æ¡£ï¼ˆå¼€å‘å‰å¿…é¡»å…¨éƒ¨é˜…è¯»ï¼‰

**å¼€å‘ä»»ä½•åŠŸèƒ½å‰ï¼Œå¿…é¡»é˜…è¯»ä»¥ä¸‹æ‰€æœ‰æ–‡æ¡£ï¼Œä¸€ä¸ªéƒ½ä¸èƒ½è½ä¸‹ï¼š**

### 1. çº¦æŸä¸åŸåˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œå¿…é¡»é¦–å…ˆé˜…è¯»ï¼‰
- `prd/02_çº¦æŸä¸åŸåˆ™/CONSTRAINTS_AND_PRINCIPLES.md` - æ ¸å¿ƒçº¦æŸä¸å¼€å‘åŸåˆ™
- `prd/02_çº¦æŸä¸åŸåˆ™/TECHNICAL_CONSTRAINTS.md` - æŠ€æœ¯çº¦æŸè¯¦ç»†è¯´æ˜
- `prd/02_çº¦æŸä¸åŸåˆ™/coze.md` - Coze API ä½¿ç”¨çº¦æŸå’Œè§„èŒƒ

### 2. å…¨å±€æŒ‡å¯¼
- `prd/01_å…¨å±€æŒ‡å¯¼/prd.md` - ä¸»PRDæ–‡æ¡£ï¼Œç³»ç»Ÿéœ€æ±‚å®šä¹‰å’Œå¼€å‘æµç¨‹è§„èŒƒ
- `prd/01_å…¨å±€æŒ‡å¯¼/PRD_COMPLETE_v3.0.md` - å®Œæ•´ç‰ˆPRDï¼Œè¯¦ç»†åŠŸèƒ½è§„æ ¼
- `prd/01_å…¨å±€æŒ‡å¯¼/README.md` - é¡¹ç›®æ¦‚è¿°å’Œå¿«é€Ÿå…¥é—¨

### 3. æŠ€æœ¯æ–¹æ¡ˆ
- `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/TECHNICAL_SOLUTION_v1.0.md` - æŠ€æœ¯æ¶æ„æ–¹æ¡ˆ
- `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/api_contract.md` - API æ¥å£å¥‘çº¦æ–‡æ¡£

### 4. ä»»åŠ¡æ‹†è§£
- `prd/04_ä»»åŠ¡æ‹†è§£/IMPLEMENTATION_TASKS_v1.0.md` - æ€»ä½“ä»»åŠ¡æ‹†è§£
- `prd/04_ä»»åŠ¡æ‹†è§£/backend_tasks.md` - åç«¯å¼€å‘ä»»åŠ¡
- `prd/04_ä»»åŠ¡æ‹†è§£/frontend_client_tasks.md` - ç”¨æˆ·ç«¯å‰ç«¯ä»»åŠ¡
- `prd/04_ä»»åŠ¡æ‹†è§£/agent_workbench_tasks.md` - åå¸­å·¥ä½œå°ä»»åŠ¡
- `prd/04_ä»»åŠ¡æ‹†è§£/admin_management_tasks.md` - ç®¡ç†å‘˜åŠŸèƒ½ä»»åŠ¡æ‹†è§£ â­ æ–°å¢
- `prd/04_ä»»åŠ¡æ‹†è§£/email_and_monitoring_tasks.md` - é‚®ä»¶å’Œç›‘æ§ä»»åŠ¡

### 5. éªŒæ”¶ä¸è®°å½•
- `prd/05_éªŒæ”¶ä¸è®°å½•/ACCEPTANCE_CRITERIA_v1.0.md` - è¯¦ç»†éªŒæ”¶æ ‡å‡†
- `prd/05_éªŒæ”¶ä¸è®°å½•/TESTING_GUIDE.md` - æµ‹è¯•æµç¨‹è§„èŒƒ
- `prd/05_éªŒæ”¶ä¸è®°å½•/implementation_notes.md` - å®æ–½è¿‡ç¨‹ç¬”è®°
- `prd/05_éªŒæ”¶ä¸è®°å½•/PRD_REVIEW.md` - PRD è¯„å®¡è®°å½•
- `prd/05_éªŒæ”¶ä¸è®°å½•/DOCUMENTATION_SUMMARY.md` - æ–‡æ¡£æ€»ç»“

### 6. ä¼ä¸šéƒ¨ç½²
- `prd/06_ä¼ä¸šéƒ¨ç½²/ENTERPRISE_DEPLOYMENT_PRD.md` - ä¼ä¸šçº§éƒ¨ç½²éœ€æ±‚ï¼ˆç‹¬ç«‹ç«™éƒ¨ç½²ï¼‰
- `prd/06_ä¼ä¸šéƒ¨ç½²/DEPLOYMENT_TASKS.md` - éƒ¨ç½²å¼€å‘ä»»åŠ¡æ‹†è§£

**âš ï¸ é‡è¦ï¼šå¼€å‘å‰å¿…é¡»ä½¿ç”¨ Read å·¥å…·é˜…è¯»ä¸Šè¿°æ‰€æœ‰æ–‡æ¡£ï¼Œç¡®ä¿å®Œå…¨ç†è§£é¡¹ç›®çº¦æŸå’Œè§„èŒƒåå†å¼€å§‹ç¼–ç ã€‚**

---

## ğŸš¨ æ ¸å¿ƒé“å¾‹ï¼ˆå¿…é¡»éµå®ˆï¼Œä¸å¯è¿åï¼‰

### é“å¾‹ 1: ä¸å¯ä¿®æ”¹çš„æ ¸å¿ƒæ¥å£

ä»¥ä¸‹æ¥å£æ˜¯ç³»ç»ŸåŸºçŸ³ï¼Œ**ä¸¥ç¦ä¿®æ”¹å…¶æ ¸å¿ƒé€»è¾‘**ï¼š

```
ğŸ”´ ä¸å¯ä¿®æ”¹:
- POST /api/chat              (åŒæ­¥AIå¯¹è¯)
- POST /api/chat/stream       (æµå¼AIå¯¹è¯)
- POST /api/conversation/new  (åˆ›å»ºä¼šè¯)
```

**å…è®¸çš„æ“ä½œ**:
- âœ… åœ¨è°ƒç”¨å‰æ·»åŠ å‰ç½®æ£€æŸ¥ï¼ˆå¦‚çŠ¶æ€æ£€æŸ¥ï¼‰
- âœ… åœ¨è¿”å›åæ·»åŠ åç½®å¤„ç†ï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰
- âŒ **ç¦æ­¢**ä¿®æ”¹ Coze API è°ƒç”¨æ–¹å¼
- âŒ **ç¦æ­¢**ä¿®æ”¹è¿”å›çš„æ•°æ®ç»“æ„
- âŒ **ç¦æ­¢**ä¿®æ”¹ payload çš„å¿…éœ€å­—æ®µæ ¼å¼

### é“å¾‹ 2: Coze API è°ƒç”¨è§„èŒƒ

#### å¿…é¡»ä½¿ç”¨ SSE æµå¼å“åº”
```python
# âœ… æ­£ç¡® - ä½¿ç”¨ stream() æ–¹æ³•
with http_client.stream('POST', url, json=payload, headers=headers) as response:
    for line in response.iter_lines():
        # è§£æSSEæµ

# âŒ é”™è¯¯ - Cozeè¿”å›çš„æ˜¯SSEæµ,ä¸æ˜¯JSON!
response = http_client.post(...)
data = response.json()
```

#### å¿…é¡»ä»é¡¶å±‚æå–å­—æ®µ
```python
# âœ… æ­£ç¡®
event_data = json.loads(data_content)
if event_data.get("type") == "answer":
    content = event_data["content"]

# âŒ é”™è¯¯ - Cozeä¸è¿”å›åµŒå¥—ç»“æ„
content = event_data["message"]["content"]
```

#### å¿…éœ€çš„è¯·æ±‚å‚æ•°
```python
payload = {
    "workflow_id": WORKFLOW_ID,      # å¿…éœ€
    "app_id": APP_ID,                # å¿…éœ€
    "session_name": session_id,      # å¿…éœ€ - ä¼šè¯éš”ç¦»
    "additional_messages": [...],    # å¿…éœ€
    "conversation_id": conv_id,      # å¯é€‰(å¤šè½®å¯¹è¯éœ€è¦)
}
```

### é“å¾‹ 3: OAuth + JWT é‰´æƒæœºåˆ¶

```python
# âœ… æ­£ç¡® - ä½¿ç”¨ token_manager
access_token = token_manager.get_access_token(
    session_name=session_id  # å¿…é¡»åŒ…å«session_nameå®ç°éš”ç¦»
)

# âŒ é”™è¯¯ - ç¡¬ç¼–ç Token
access_token = "hardcoded_token"

# âŒ é”™è¯¯ - æ‰€æœ‰ç”¨æˆ·å…±ç”¨ä¸€ä¸ªToken
access_token = token_manager.get_access_token()  # ç¼ºå°‘session_name!
```

### é“å¾‹ 4: ä¼šè¯éš”ç¦»æœºåˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼šæ¯ä¸ªæ–°ä¼šè¯å¿…é¡»é¢„å…ˆè°ƒç”¨ `/api/conversation/new` åˆ›å»ºç‹¬ç«‹çš„ `conversation_id`

```python
# âŒ é”™è¯¯ - ç›´æ¥å‘é€æ¶ˆæ¯ä¼šå¯¼è‡´ä¼šè¯éš”ç¦»å¤±è´¥
POST /api/chat {"message": "ä½ å¥½", "user_id": "session_a"}

# âœ… æ­£ç¡® - é¢„å…ˆåˆ›å»º conversation
POST /api/conversation/new {"session_id": "session_a"}
# å“åº”: {"conversation_id": "xxx"}

POST /api/chat {
  "message": "ä½ å¥½",
  "user_id": "session_a",
  "conversation_id": "xxx"
}
```

### é“å¾‹ 5: çŠ¶æ€æœºçº¦æŸ

```
bot_active â†’ pending_manual â†’ manual_live â†’ bot_active
```

- çŠ¶æ€è½¬æ¢å¿…é¡»æŒ‰é¡ºåºï¼Œä¸å¯è·³è·ƒ
- äººå·¥æ¥ç®¡æœŸé—´**å¿…é¡»é˜»æ­¢ AI å¯¹è¯**ï¼ˆè¿”å› 409ï¼‰
- `conversation_id` ç”± Coze è‡ªåŠ¨ç”Ÿæˆï¼Œ**ç¦æ­¢æ‰‹åŠ¨åˆ›å»º**

---

## ğŸ“‹ å¼€å‘æµç¨‹è§„èŒƒ

### é˜¶æ®µ1: å¼€å‘å‰å®¡æŸ¥

**åœ¨å¼€å§‹ä»»ä½•æ–°åŠŸèƒ½å¼€å‘ä¹‹å‰ï¼Œå¿…é¡»å®Œæˆ**ï¼š

#### 1.1 å…¨æ–°åŠŸèƒ½æ–¹æ¡ˆæ–‡æ¡£è¦æ±‚ â­ **å¼ºåˆ¶æ‰§è¡Œ**

**è§¦å‘æ¡ä»¶**ï¼šå¼€å‘å…¨æ–°çš„æ¨¡å—åŠŸèƒ½æ—¶ï¼ˆä¸åŒ…æ‹¬å°æ”¹åŠ¨æˆ–å¯¹åŸæœ‰åŠŸèƒ½çš„æ”¹å–„ï¼‰

**å¼ºåˆ¶è¦æ±‚**ï¼š
- âœ… **å¿…é¡»å…ˆç¼–å†™è¯¦ç»†çš„å®æ–½æ–¹æ¡ˆæ–‡æ¡£**ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
  1. **ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Ÿ** - å½“å‰é—®é¢˜åˆ†æï¼Œç”¨å®é™…åœºæ™¯æ¼”ç¤º
  2. **æŠ€æœ¯åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ** - æ¸…æ™°è§£é‡Šå·¥ä½œåŸç†å’Œæ ¸å¿ƒæ¦‚å¿µ
  3. **éœ€è¦ä»€ä¹ˆå·¥å…·å’Œé…ç½®ï¼Ÿ** - è¯¦ç»†çš„å®‰è£…æ­¥éª¤å’Œé…ç½®è¯´æ˜
  4. **å¦‚ä½•å®ç°ï¼Ÿ** - å®Œæ•´çš„å®æ–½æ­¥éª¤ï¼ŒåŒ…å«ä»£ç ç¤ºä¾‹
  5. **æœ€ç»ˆæ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿ** - Before/After å¯¹æ¯”ï¼ŒéªŒè¯æ ‡å‡†
  6. **å®æ–½æ—¶é—´ä¼°ç®—** - å„é˜¶æ®µè€—æ—¶é¢„ä¼°
  7. **å¸¸è§é—®é¢˜ FAQ** - é¢„è§æ€§é—®é¢˜è§£ç­”

**æ–‡æ¡£å­˜æ”¾ä½ç½®**ï¼š`docs/{åŠŸèƒ½åç§°}_å®æ–½æ–¹æ¡ˆè¯¦è§£.md`

**å¼€å‘æµç¨‹**ï¼š
1. ç”¨æˆ·æå‡ºå…¨æ–°åŠŸèƒ½éœ€æ±‚
2. Claude ç¼–å†™è¯¦ç»†æ–¹æ¡ˆæ–‡æ¡£ï¼ˆä¸å¼€å§‹å¼€å‘ï¼‰
3. ç”¨æˆ·é˜…è¯»å¹¶ç¡®è®¤ç†è§£
4. ç”¨æˆ·æ˜ç¡®ç¡®è®¤åï¼ŒClaude å¼€å§‹å®æ–½

**ç¤ºä¾‹**ï¼šRedis æ•°æ®æŒä¹…åŒ– â†’ å…ˆåˆ›å»º `docs/Redisæ•°æ®æŒä¹…åŒ–å®æ–½æ–¹æ¡ˆè¯¦è§£.md`

**ä¾‹å¤–æƒ…å†µ**ï¼š
- ç”¨æˆ·æ˜ç¡®è¯´"ä¸ç”¨å†™æ–¹æ¡ˆæ–‡æ¡£"æ—¶å¯è·³è¿‡
- å¯¹åŸæœ‰åŠŸèƒ½çš„å°æ”¹åŠ¨ã€bug ä¿®å¤ä¸éœ€è¦
- ç”¨æˆ·æ˜ç¡®è¯´"ç«‹å³å¼€å§‹å¼€å‘"å¯è·³è¿‡

---

#### 1.2 çº¦æŸæ–‡æ¡£å®¡æŸ¥æ¸…å•
- [ ] é˜…è¯» `prd/02_çº¦æŸä¸åŸåˆ™/CONSTRAINTS_AND_PRINCIPLES.md`
- [ ] é˜…è¯» `prd/03_æŠ€æœ¯æ–¹æ¡ˆ/TECHNICAL_SOLUTION_v1.0.md`
- [ ] ç¡®è®¤æ–°åŠŸèƒ½æ˜¯å¦æ¶‰åŠ Coze API è°ƒç”¨
- [ ] ç¡®è®¤æ–°åŠŸèƒ½æ˜¯å¦ä¼šä¿®æ”¹ç°æœ‰æ¥å£
- [ ] æ£€æŸ¥æ˜¯å¦å¼•å…¥æ–°çš„å¤–éƒ¨ä¾èµ–

#### 1.3 åŸºçº¿éªŒè¯
```bash
# åœ¨å¼€å§‹å¼€å‘å‰ï¼Œè¿è¡ŒåŸºçº¿æµ‹è¯•ç¡®ä¿å½“å‰ç³»ç»Ÿæ­£å¸¸
./tests/regression_test.sh
# é¢„æœŸ: 12/12 é€šè¿‡ï¼Œå¦åˆ™ä¸å¾—å¼€å§‹æ–°åŠŸèƒ½å¼€å‘
```

#### 1.4 è®¾è®¡å®¡æŸ¥
- [ ] æ–°åŠŸèƒ½æ˜¯å¦éµå¾ª"å‰ç½®æ£€æŸ¥ + åç½®å¤„ç†"æ¨¡å¼ï¼Ÿ
- [ ] æ–°åŠŸèƒ½å¤±è´¥æ—¶æ˜¯å¦ä¼šå½±å“æ ¸å¿ƒ AI å¯¹è¯ï¼Ÿï¼ˆå¿…é¡»æ˜¯"å¦"ï¼‰
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ æ–°çš„çº¦æŸæ¡æ¬¾ï¼Ÿ

### é˜¶æ®µ2: å¼€å‘ä¸­çº¦æŸ

#### 2.1 ä»£ç å®ç°æ£€æŸ¥æ¸…å•
- [ ] æ–°å¢ä»£ç æ˜¯å¦éµå¾ªç°æœ‰ä»£ç é£æ ¼ï¼Ÿ
- [ ] æ˜¯å¦æ·»åŠ äº†å……è¶³çš„é”™è¯¯å¤„ç†ï¼Ÿ
- [ ] æ–°åŠŸèƒ½å¤±è´¥æ—¶æ˜¯å¦ä¼šé˜»å¡æ ¸å¿ƒåŠŸèƒ½ï¼Ÿï¼ˆä¸åº”é˜»å¡ï¼‰
- [ ] æ˜¯å¦æ·»åŠ äº†ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼Ÿ
- [ ] æ•æ„Ÿä¿¡æ¯æ˜¯å¦å·²è„±æ•ï¼Ÿ

#### 2.2 æ­£ç¡®çš„æ‰©å±•æ¨¡å¼
```python
# âœ… æ­£ç¡® - å‰ç½®æ£€æŸ¥ï¼Œä¸ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
@app.post("/api/chat")
async def chat(request: ChatRequest):
    # ã€æ–°å¢ã€‘å‰ç½®æ£€æŸ¥
    if session_state.status in [PENDING_MANUAL, MANUAL_LIVE]:
        raise HTTPException(status_code=409, detail="MANUAL_IN_PROGRESS")

    # åŸæœ‰ Coze API è°ƒç”¨é€»è¾‘ï¼ˆå®Œå…¨ä¸åŠ¨ï¼‰
    access_token = token_manager.get_access_token(session_name=session_id)
    # ...
```

### é˜¶æ®µ3: å¼€å‘åéªŒè¯

```bash
# å¿…é¡»è¿è¡Œå›å½’æµ‹è¯•
cd /home/yzh/AIå®¢æœ/é‰´æƒ
./tests/regression_test.sh
# é¢„æœŸ: 12/12 é€šè¿‡
```

**éªŒè¯è¦æ±‚**ï¼š
1. æ ¸å¿ƒå¯¹è¯åŠŸèƒ½ä¸å—å½±å“
2. ä¼šè¯éš”ç¦»æœºåˆ¶å®Œæ•´
3. é”™è¯¯éš”ç¦»ï¼šæ–°åŠŸèƒ½å¼‚å¸¸ä¸å¯¼è‡´æ ¸å¿ƒåŠŸèƒ½å¤±è´¥

---

## âœ… å…è®¸çš„æ‰©å±•æ–¹å‘

ä»¥ä¸‹åŠŸèƒ½**å®Œå…¨è‡ªç”±è®¾è®¡**ï¼Œä¸å— Coze å¹³å°é™åˆ¶ï¼š

### 1. ä¼šè¯çŠ¶æ€ç®¡ç† (`src/session_state.py`)
- å¯è‡ªç”±å®šä¹‰çŠ¶æ€æšä¸¾
- å¯æ·»åŠ ä»»æ„å­—æ®µ
- å¯è‡ªå®šä¹‰æ•°æ®æ¨¡å‹

### 2. ç›‘ç®¡å¼•æ“ (`src/regulator.py`)
- å…³é”®è¯æ£€æµ‹è§„åˆ™
- AI å¤±è´¥è®¡æ•°é€»è¾‘
- è‡ªåŠ¨å‡çº§è§¦å‘æ¡ä»¶

### 3. æ–°å¢ API æ¥å£
- äººå·¥æ¥ç®¡ç›¸å…³æ¥å£
- ç»Ÿè®¡æŸ¥è¯¢æ¥å£
- åå¸­ç®¡ç†æ¥å£

### 4. SSE äº‹ä»¶æ‰©å±•
- å¯æ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹ï¼ˆå¦‚ `type:'manual_message'`ï¼‰
- ä¸å¾—æ›¿æ¢æ ¸å¿ƒ AI å¯¹è¯çš„ SSE æµ

---

## é¡¹ç›®ç»“æ„

```
/home/yzh/AIå®¢æœ/é‰´æƒ/
â”œâ”€â”€ backend.py              # åç«¯ä¸»æœåŠ¡
â”œâ”€â”€ src/                    # åç«¯æ¨¡å—
â”‚   â”œâ”€â”€ session_state.py    # ä¼šè¯çŠ¶æ€æœº
â”‚   â”œâ”€â”€ regulator.py        # ç›‘ç®¡å¼•æ“
â”‚   â”œâ”€â”€ shift_config.py     # å·¥ä½œæ—¶é—´é…ç½®
â”‚   â”œâ”€â”€ email_service.py    # é‚®ä»¶æœåŠ¡
â”‚   â””â”€â”€ oauth_token_manager.py  # Tokenç®¡ç†
â”œâ”€â”€ frontend/               # ç”¨æˆ·ç«¯ Vue é¡¹ç›®
â”œâ”€â”€ agent-workbench/        # åå¸­å·¥ä½œå° Vue é¡¹ç›®
â”œâ”€â”€ prd/                    # PRD æ–‡æ¡£
â”‚   â””â”€â”€ INDEX.md            # æ–‡æ¡£ç´¢å¼•
â””â”€â”€ tests/                  # æµ‹è¯•è„šæœ¬
    â””â”€â”€ regression_test.sh  # å›å½’æµ‹è¯•
```

---

## å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨åç«¯
python3 backend.py

# å¯åŠ¨ç”¨æˆ·ç«¯
cd frontend && npm run dev

# å¯åŠ¨åå¸­å·¥ä½œå°
cd agent-workbench && npm run dev

# å›å½’æµ‹è¯•
./tests/regression_test.sh

# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/health

# ä¼šè¯ç»Ÿè®¡
curl http://localhost:8000/api/sessions/stats
```

---

## ç¯å¢ƒå˜é‡ (.env)

å…³é”®é…ç½®ï¼š
- `COZE_WORKFLOW_ID` - å·¥ä½œæµID
- `COZE_APP_ID` - åº”ç”¨ID
- `COZE_OAUTH_CLIENT_ID` - OAuthå®¢æˆ·ç«¯ID
- `REGULATOR_KEYWORDS` - äººå·¥æ¥ç®¡è§¦å‘å…³é”®è¯
- `REGULATOR_FAIL_THRESHOLD` - AIè¿ç»­å¤±è´¥é˜ˆå€¼

---

## âŒ ç¦æ­¢äº‹é¡¹

1. **ä¸è¦ä¿®æ”¹** `.env` ä¸­çš„ Coze å‡­è¯
2. **ä¸è¦åˆ é™¤** ä»»ä½•ç°æœ‰çš„ API ç«¯ç‚¹
3. **ä¸è¦ä¿®æ”¹** Coze API çš„è°ƒç”¨æ–¹å¼å’Œè¿”å›è§£æ
4. **ä¸è¦ç»•è¿‡** token_manager ç›´æ¥ç”Ÿæˆ Token
5. **ä¸è¦ä½¿ç”¨** WebSocket æ›¿æ¢ SSE æµå¼å“åº”
6. **ä¸è¦è·³è¿‡** å›å½’æµ‹è¯•å°±æäº¤ä»£ç 
7. **ä¸è¦åœ¨** äººå·¥æ¥ç®¡æœŸé—´å…è®¸ AI å¯¹è¯

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

å®Œæ•´æ–‡æ¡£ç»“æ„è§ `prd/INDEX.md`

```
prd/
â”œâ”€â”€ 01_å…¨å±€æŒ‡å¯¼/     # ç³»ç»Ÿéœ€æ±‚å’ŒæŒ‡å¯¼
â”œâ”€â”€ 02_çº¦æŸä¸åŸåˆ™/   # æŠ€æœ¯çº¦æŸï¼ˆæœ€é‡è¦)
â”œâ”€â”€ 03_æŠ€æœ¯æ–¹æ¡ˆ/     # æ¶æ„å’ŒAPI
â”œâ”€â”€ 04_ä»»åŠ¡æ‹†è§£/     # å¼€å‘ä»»åŠ¡
â””â”€â”€ 05_éªŒæ”¶ä¸è®°å½•/   # æµ‹è¯•å’ŒéªŒæ”¶
```

---

## ğŸ¢ ä¼ä¸šç”Ÿäº§ç¯å¢ƒè¦æ±‚ â­ **å¼ºåˆ¶éµå®ˆ**

### æ ¸å¿ƒåŸåˆ™

åœ¨æ‰€æœ‰åç»­å¼€å‘ä¸­ï¼Œ**å¿…é¡»å……åˆ†è€ƒè™‘ä¼ä¸šå®é™…ä½¿ç”¨å’Œç”Ÿäº§ç¯å¢ƒä¸‹çš„åˆç†å¹¶å‘æ€§å’Œå®æ—¶æ€§**ã€‚

---

### 1. å¹¶å‘æ€§è¦æ±‚ (Concurrency)

#### 1.1 è¿æ¥æ± ç®¡ç†

**å¼ºåˆ¶è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡® - ä½¿ç”¨è¿æ¥æ± é™åˆ¶å¹¶å‘è¿æ¥æ•°
redis_pool = redis.ConnectionPool(
    host='localhost',
    port=6379,
    max_connections=50,          # æœ€å¤§è¿æ¥æ•°
    socket_timeout=5.0,          # è¶…æ—¶è®¾ç½®
    socket_connect_timeout=5.0,
    socket_keepalive=True
)

# âŒ é”™è¯¯ - æ— é™åˆ¶åˆ›å»ºè¿æ¥
for i in range(1000):
    redis_client = redis.Redis(host='localhost')  # å¯èƒ½è€—å°½è¿æ¥æ•°
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š
- Redis è¿æ¥æ± ï¼š50 è¿æ¥ï¼ˆæ”¯æŒ 100+ å¹¶å‘ç”¨æˆ·ï¼‰
- HTTP å®¢æˆ·ç«¯è¿æ¥æ± ï¼š100 è¿æ¥
- æ•°æ®åº“è¿æ¥æ± ï¼š20-50 è¿æ¥

#### 1.2 è¯·æ±‚é€Ÿç‡é™åˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡® - å®ç°é€Ÿç‡é™åˆ¶
from fastapi_limiter import FastAPILimiter
from fastapi_limiter.depends import RateLimiter

@app.post("/api/chat")
@limiter.limit("20/minute")  # æ¯åˆ†é’Ÿæœ€å¤š20æ¬¡è¯·æ±‚
async def chat(request: ChatRequest):
    pass

# âŒ é”™è¯¯ - æ— é€Ÿç‡é™åˆ¶ï¼Œå¯èƒ½è¢«æ¶æ„æ”»å‡»
@app.post("/api/chat")
async def chat(request: ChatRequest):
    pass  # ä»»æ„é¢‘ç‡è°ƒç”¨
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š
- æ™®é€šç”¨æˆ·ï¼š20 è¯·æ±‚/åˆ†é’Ÿ
- VIP ç”¨æˆ·ï¼š100 è¯·æ±‚/åˆ†é’Ÿ
- åå¸­è´¦å·ï¼šæ— é™åˆ¶ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰

#### 1.3 å¹¶å‘ SSE è¿æ¥ç®¡ç†

**å¼ºåˆ¶è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡® - é™åˆ¶æ¯ä¸ªç”¨æˆ·çš„ SSE è¿æ¥æ•°
MAX_SSE_PER_USER = 3  # æ¯ä¸ªç”¨æˆ·æœ€å¤š3ä¸ªå¹¶å‘ SSE è¿æ¥

sse_connections: dict[str, int] = {}  # {session_id: connection_count}

@app.post("/api/chat/stream")
async def chat_stream(request: ChatRequest):
    session_id = request.user_id

    # æ£€æŸ¥å¹¶å‘è¿æ¥æ•°
    if sse_connections.get(session_id, 0) >= MAX_SSE_PER_USER:
        raise HTTPException(429, "Too many concurrent connections")

    sse_connections[session_id] = sse_connections.get(session_id, 0) + 1
    try:
        # SSE æµå¼å“åº”
        yield ...
    finally:
        sse_connections[session_id] -= 1

# âŒ é”™è¯¯ - æ— é™åˆ¶ SSE è¿æ¥ï¼Œå¯èƒ½å¯¼è‡´èµ„æºè€—å°½
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š
- æ¯ä¸ªç”¨æˆ·æœ€å¤š 3 ä¸ªå¹¶å‘ SSE è¿æ¥
- å…¨å±€æœ€å¤§ SSE è¿æ¥æ•°ï¼š1000ï¼ˆæ ¹æ®æœåŠ¡å™¨èµ„æºè°ƒæ•´ï¼‰
- è¶…æ—¶è‡ªåŠ¨æ–­å¼€ï¼š5 åˆ†é’Ÿæ— æ´»åŠ¨

#### 1.4 æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦é™åˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡® - é™åˆ¶é˜Ÿåˆ—é•¿åº¦
if session_id not in sse_queues:
    sse_queues[session_id] = asyncio.Queue(maxsize=100)  # æœ€å¤š100æ¡æ¶ˆæ¯

try:
    sse_queues[session_id].put_nowait(message)
except asyncio.QueueFull:
    logger.warning(f"SSE é˜Ÿåˆ—å·²æ»¡: {session_id}")
    # ä¸¢å¼ƒæœ€æ—§çš„æ¶ˆæ¯
    sse_queues[session_id].get_nowait()
    sse_queues[session_id].put_nowait(message)

# âŒ é”™è¯¯ - æ— é™åˆ¶é˜Ÿåˆ—ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
sse_queues[session_id] = asyncio.Queue()  # æ— é™å¤§å°
```

---

### 2. å®æ—¶æ€§è¦æ±‚ (Real-Time Performance)

#### 2.1 SSE ä¼˜äºè½®è¯¢

**å¼ºåˆ¶è¦æ±‚**ï¼šæ‰€æœ‰å®æ—¶æ›´æ–°å¿…é¡»ä½¿ç”¨ SSEï¼Œç¦æ­¢ä½¿ç”¨çŸ­è½®è¯¢

```typescript
// âœ… æ­£ç¡® - ä½¿ç”¨ SSE å®æ—¶æ¨é€
const eventSource = new EventSource(`/api/chat/stream`)
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data)
  // å®æ—¶æ›´æ–° UI
}

// âŒ é”™è¯¯ - ä½¿ç”¨è½®è¯¢ï¼Œå»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹
setInterval(async () => {
  const response = await fetch('/api/sessions/stats')
  // æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡
}, 5000)
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
- SSE æ¨é€å»¶è¿Ÿï¼š< 100ms
- 5ç§’è½®è¯¢å»¶è¿Ÿï¼šå¹³å‡ 2.5ç§’
- èµ„æºæ¶ˆè€—ï¼šSSE èŠ‚çœ 80% ç½‘ç»œè¯·æ±‚

#### 2.2 æ¶ˆæ¯æ¨é€å»¶è¿Ÿè¦æ±‚

**å¼ºåˆ¶è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡® - ç«‹å³æ¨é€æ¶ˆæ¯ï¼Œä¸ç¼“å†²
@app.post("/api/manual/messages")
async def manual_message(request: dict):
    session_name = request.get("session_name")

    # ä¿å­˜æ¶ˆæ¯åˆ°å­˜å‚¨
    await session_store.save(session_state)

    # ã€å…³é”®ã€‘ç«‹å³æ¨é€åˆ° SSE é˜Ÿåˆ—ï¼Œä¸ç­‰å¾…æ‰¹å¤„ç†
    if session_name in sse_queues:
        await sse_queues[session_name].put({
            "type": "manual_message",
            "content": request.get("content"),
            "timestamp": time.time()
        })
        # ç›®æ ‡å»¶è¿Ÿ: < 50ms

# âŒ é”™è¯¯ - æ‰¹é‡æ¨é€ï¼Œå»¶è¿Ÿé«˜
messages_buffer = []
async def flush_messages():
    while True:
        await asyncio.sleep(1)  # æ¯ç§’æ‰¹é‡æ¨é€ä¸€æ¬¡
        for msg in messages_buffer:
            await push_sse(msg)
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š
- äººå·¥æ¶ˆæ¯æ¨é€å»¶è¿Ÿï¼š< 100msï¼ˆä»å‘é€åˆ°ç”¨æˆ·æ”¶åˆ°ï¼‰
- çŠ¶æ€å˜åŒ–é€šçŸ¥å»¶è¿Ÿï¼š< 50ms
- AI å“åº”æµå¼æ¨é€ï¼šå®æ—¶é€å­—æ˜¾ç¤ºï¼Œ< 50ms é¦–å­—å»¶è¿Ÿ

#### 2.3 å‰ç«¯å“åº”æ€§èƒ½

**å¼ºåˆ¶è¦æ±‚**ï¼š
```typescript
// âœ… æ­£ç¡® - ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§é‡æ¶ˆæ¯
import { VirtualList } from 'vue-virtual-scroller'

// è¶…è¿‡100æ¡æ¶ˆæ¯æ—¶å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
<VirtualList
  :items="messages"
  :item-height="80"
  v-if="messages.length > 100"
>
  <template v-slot="{ item }">
    <ChatMessage :message="item" />
  </template>
</VirtualList>

// âŒ é”™è¯¯ - ç›´æ¥æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯ï¼Œå¡é¡¿
<div v-for="msg in messages" :key="msg.id">
  <ChatMessage :message="msg" />
</div>  <!-- 1000æ¡æ¶ˆæ¯ä¼šå¯¼è‡´ä¸¥é‡å¡é¡¿ -->
```

**æ€§èƒ½ç›®æ ‡**ï¼š
- æ¶ˆæ¯åˆ—è¡¨æ»šåŠ¨å¸§ç‡ï¼š60 FPS
- æ–°æ¶ˆæ¯è¿½åŠ å»¶è¿Ÿï¼š< 16msï¼ˆä¸€å¸§ï¼‰
- æ”¯æŒæ¶ˆæ¯æ•°ï¼š10,000+ æ¡ä¸å¡é¡¿

#### 2.4 Coze API è¶…æ—¶è®¾ç½®

**å¼ºåˆ¶è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡® - è®¾ç½®åˆç†çš„è¶…æ—¶
HTTP_TIMEOUT = httpx.Timeout(
    connect=5.0,   # è¿æ¥è¶…æ—¶ 5ç§’
    read=30.0,     # è¯»å–è¶…æ—¶ 30ç§’ï¼ˆCoze AI å“åº”å¯èƒ½è¾ƒæ…¢ï¼‰
    write=10.0,    # å†™å…¥è¶…æ—¶ 10ç§’
    pool=10.0      # è¿æ¥æ± è¶…æ—¶ 10ç§’
)

http_client = httpx.Client(timeout=HTTP_TIMEOUT)

# âŒ é”™è¯¯ - æ— è¶…æ—¶é™åˆ¶ï¼Œå¯èƒ½æ°¸ä¹…é˜»å¡
http_client = httpx.Client()  # é»˜è®¤æ— è¶…æ—¶
```

**ç”Ÿäº§ç¯å¢ƒåŸºå‡†å€¼**ï¼š
- Coze API è¿æ¥è¶…æ—¶ï¼š5ç§’
- Coze API è¯»å–è¶…æ—¶ï¼š30ç§’ï¼ˆAI ç”Ÿæˆéœ€è¦æ—¶é—´ï¼‰
- å†…éƒ¨ API è¶…æ—¶ï¼š10ç§’
- SSE ä¿æ´»é—´éš”ï¼š30ç§’å‘é€å¿ƒè·³

---

### 3. èµ„æºé™åˆ¶ä¸ç›‘æ§

#### 3.1 å†…å­˜é™åˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡® - Redis å†…å­˜é™åˆ¶
# redis.conf
maxmemory 512mb
maxmemory-policy allkeys-lru  # å†…å­˜æ»¡æ—¶åˆ é™¤æœ€å°‘ä½¿ç”¨çš„ key

# âœ… æ­£ç¡® - ä¼šè¯æ•°æ® TTL
REDIS_SESSION_TTL = 86400  # 24 å°æ—¶è‡ªåŠ¨è¿‡æœŸ

# âŒ é”™è¯¯ - æ— é™åˆ¶å­˜å‚¨
redis.set(key, value)  # æ°¸ä¹…ä¿ç•™ï¼Œæœ€ç»ˆè€—å°½å†…å­˜
```

#### 3.2 æ€§èƒ½ç›‘æ§

**å¼ºåˆ¶è¦æ±‚**ï¼š
```python
# âœ… æ­£ç¡® - è®°å½•æ…¢è¯·æ±‚
@app.middleware("http")
async def log_slow_requests(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    duration = time.time() - start_time

    if duration > 1.0:  # è¶…è¿‡1ç§’å‘Šè­¦
        logger.warning(
            f"æ…¢è¯·æ±‚: {request.method} {request.url.path} "
            f"è€—æ—¶ {duration:.2f}s"
        )

    return response
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- API å“åº”æ—¶é—´ï¼šP50 < 200ms, P99 < 1s
- SSE è¿æ¥æ•°ï¼šå®æ—¶ç›‘æ§
- Redis å†…å­˜ä½¿ç”¨ç‡ï¼š< 80%
- CPU ä½¿ç”¨ç‡ï¼š< 70%ï¼ˆç•™æœ‰ä½™é‡ï¼‰

---

### 4. ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•

**æ¯æ¬¡éƒ¨ç½²å‰å¿…é¡»éªŒè¯**ï¼š

#### 4.1 å¹¶å‘æ€§æ£€æŸ¥
- [ ] Redis è¿æ¥æ± å¤§å°æ˜¯å¦é…ç½®ï¼Ÿï¼ˆå»ºè®® 50ï¼‰
- [ ] HTTP å®¢æˆ·ç«¯æ˜¯å¦ä½¿ç”¨è¿æ¥æ± ï¼Ÿ
- [ ] SSE è¿æ¥æ•°æ˜¯å¦æœ‰é™åˆ¶ï¼Ÿï¼ˆå»ºè®®æ¯ç”¨æˆ· 3 ä¸ªï¼‰
- [ ] æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦æœ‰é•¿åº¦é™åˆ¶ï¼Ÿï¼ˆå»ºè®® 100ï¼‰
- [ ] æ˜¯å¦å®ç°äº†é€Ÿç‡é™åˆ¶ï¼Ÿ

#### 4.2 å®æ—¶æ€§æ£€æŸ¥
- [ ] æ˜¯å¦ä½¿ç”¨ SSE æ›¿ä»£è½®è¯¢ï¼Ÿ
- [ ] æ¶ˆæ¯æ¨é€æ˜¯å¦ç«‹å³æ‰§è¡Œï¼ˆä¸æ‰¹å¤„ç†ï¼‰ï¼Ÿ
- [ ] è¶…æ—¶é…ç½®æ˜¯å¦åˆç†ï¼Ÿï¼ˆè¿æ¥ 5sï¼Œè¯»å– 30sï¼‰
- [ ] å‰ç«¯æ˜¯å¦ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼Ÿï¼ˆ> 100 æ¡æ¶ˆæ¯ï¼‰
- [ ] æ˜¯å¦æœ‰æ€§èƒ½ç›‘æ§ï¼Ÿ

#### 4.3 å‹åŠ›æµ‹è¯•
```bash
# 1. å¹¶å‘ç”¨æˆ·æµ‹è¯• - 100 ä¸ªå¹¶å‘ç”¨æˆ·
ab -n 1000 -c 100 http://localhost:8000/api/health

# 2. SSE è¿æ¥æµ‹è¯• - 50 ä¸ªå¹¶å‘ SSE è¿æ¥
for i in {1..50}; do
  curl -N http://localhost:8000/api/chat/stream &
done

# 3. ç›‘æ§èµ„æºä½¿ç”¨
watch -n 1 'redis-cli INFO memory | grep used_memory_human'
```

**é€šè¿‡æ ‡å‡†**ï¼š
- 100 å¹¶å‘ç”¨æˆ·ï¼šå¹³å‡å“åº”æ—¶é—´ < 500ms
- 50 å¹¶å‘ SSEï¼šæ— è¿æ¥æ‹’ç»
- Redis å†…å­˜ï¼š< 80% ä½¿ç”¨ç‡
- æ— é”™è¯¯æ—¥å¿—

---

### 5. å…¸å‹åœºæ™¯æ€§èƒ½è¦æ±‚

| åœºæ™¯ | å¹¶å‘è¦æ±‚ | å®æ—¶æ€§è¦æ±‚ |
|------|---------|-----------|
| **ç”¨æˆ·å‘é€æ¶ˆæ¯** | æ”¯æŒ 100+ å¹¶å‘ | AI å“åº”å»¶è¿Ÿ < 2s |
| **åå¸­æ¥å…¥ä¼šè¯** | æ”¯æŒ 10 ä¸ªåå¸­åŒæ—¶æ“ä½œ | çŠ¶æ€å˜åŒ–é€šçŸ¥ < 50ms |
| **äººå·¥æ¶ˆæ¯æ¨é€** | æ”¯æŒ 50+ å¹¶å‘ä¼šè¯ | æ¶ˆæ¯æ¨é€å»¶è¿Ÿ < 100ms |
| **ä¼šè¯åˆ—è¡¨åˆ·æ–°** | æ”¯æŒ 10 ä¸ªåå¸­åŒæ—¶æŸ¥è¯¢ | ä½¿ç”¨ SSE è‡ªåŠ¨æ›´æ–° |
| **å†å²æ¶ˆæ¯åŠ è½½** | æ”¯æŒ 1000+ æ¡æ¶ˆæ¯ | é¦–å±æ¸²æŸ“ < 500ms |

---

### 6. è¿è§„åæœ

**ä¸éµå®ˆå¹¶å‘æ€§å’Œå®æ—¶æ€§è¦æ±‚å°†å¯¼è‡´**ï¼š

ğŸ”´ **å¹¶å‘æ€§é—®é¢˜**ï¼š
- è¿æ¥æ± è€—å°½ â†’ æœåŠ¡ä¸å¯ç”¨
- æ— é€Ÿç‡é™åˆ¶ â†’ è¢« DDoS æ”»å‡»
- å†…å­˜æº¢å‡º â†’ ç³»ç»Ÿå´©æºƒ

ğŸ”´ **å®æ—¶æ€§é—®é¢˜**ï¼š
- ä½¿ç”¨è½®è¯¢ â†’ å»¶è¿Ÿé«˜ã€èµ„æºæµªè´¹
- æ— è¶…æ—¶è®¾ç½® â†’ è¯·æ±‚æ°¸ä¹…é˜»å¡
- æ¶ˆæ¯æ‰¹å¤„ç† â†’ ç”¨æˆ·ä½“éªŒå·®

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-25
**æ–‡æ¡£ç‰ˆæœ¬**: v1.1 â­ æ–°å¢ä¼ä¸šç”Ÿäº§ç¯å¢ƒè¦æ±‚
